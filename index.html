<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ููุตุฉ ุงูุชุญููู ุงูุฐูู โ ุซุงูููุฉ ุงููุนููุจู</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--moe:#0f7a66;--ink:#0e2f2c;--ring:#d6efe9;--lite:#e8f4f1;--bg:#f7fbfa;--bad:#e11d48;--warn:#f59e0b;--acc:#1d4ed8;--deep:#043c39}
*{box-sizing:border-box}
body{font-family:'Tajawal',system-ui,Arial;background:linear-gradient(180deg,#fff 0%,var(--bg) 100%);color:var(--ink);margin:0}
header img{width:100%;height:140px;object-fit:cover;display:block}
.shell{max-width:1300px;margin:auto;padding:14px}
.grid{display:grid;grid-template-columns:2fr 1fr;gap:12px}
@media(max-width:1100px){.grid{grid-template-columns:1fr}}
.card{background:#fff;border:1px solid var(--ring);border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:12px}
.card h3{margin:4px 0 8px;color:var(--moe)}
.small{font-size:12px;color:#567}
.flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{background:var(--moe);color:#fff;border:none;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer}
.btn.ghost{background:#fff;color:#0a3d36;border:1.6px solid var(--moe)}
.btn.warn{background:var(--warn)} .btn.bad{background:var(--bad)} .btn.acc{background:var(--acc)}
.input{display:flex;flex-direction:column;gap:4px}
.input input[type="number"]{width:80px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border:1px solid var(--ring);padding:8px;text-align:right;vertical-align:top}
.table th{background:var(--lite);color:var(--moe)}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.kpi{border:1px solid var(--ring);border-radius:12px;padding:10px;text-align:center}
.kpi .v{font-size:20px;font-weight:800}
.badge{padding:2px 8px;border-radius:999px;font-size:11px;color:#fff;background:var(--bad)}
.gauge{height:14px;background:#eee;border-radius:999px;overflow:hidden}
.gauge>div{height:100%;background:linear-gradient(90deg,#ef4444,#f59e0b,#10b981);width:0%}
.drop{border:2px dashed var(--ring);border-radius:14px;padding:14px;display:flex;align-items:center;gap:10px;background:linear-gradient(180deg,#fff,#f8fbfa);cursor:pointer}
.drop.on{background:#eef7f5}
.lens{width:44px;height:44px;border-radius:50%;background:var(--deep);color:#fff;display:grid;place-items:center;font-weight:800;box-shadow:0 6px 16px rgba(0,0,0,.12)}
.stat{font-size:12px;color:#345}
.notice{display:none;background:#fff7d6;color:#7a4d00;padding:10px 14px;border-bottom:2px solid #f7d382;text-align:center}
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.25);display:none;align-items:center;justify-content:center;z-index:99}
.spin{width:58px;height:58px;border-radius:50%;border:6px solid #fff;border-top-color:transparent;animation:sp 1s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:120}
.wiz{background:#fff;border:1px solid var(--ring);border-radius:16px;box-shadow:0 12px 30px rgba(0,0,0,.22);padding:16px;max-width:720px;width:95%}
footer{color:#567;text-align:center;font-size:12px;margin:14px 0}
canvas{max-width:100%}
</style>

<!-- ููุชุจุงุช -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.worker.min.js"></script>
<script>if(window.pdfjsLib){pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.worker.min.js"}</script>
<script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
<header>
  <!-- ุตูุฑุฉ ูุงููุฉ ููููุฏุฑ ููุท: ุถุน logo.png ุจุฌูุงุฑ ุงูููู -->
  <img src="logo.png" alt="ุดุนุงุฑ" onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/thumb/6/69/Ministry_of_Education_Logo.svg/2048px-Ministry_of_Education_Logo.svg.png'">
</header>

<div class="notice" id="serverNotice">ูุนูู OCR/PDF ุงูุชุญ ุงูุตูุญุฉ ุนุจุฑ ุฎุงุฏู ูุญูู (Live Server) ูููุณ file://</div>

<div class="shell">
  <div class="grid">
    <section class="card">
      <h3>ูุคุดุฑ ุงููุฏุฑุณุฉ ุงูุนุงู (School Index)</h3>
      <div class="gauge"><div id="schoolGauge"></div></div>
      <div class="small" style="margin-top:6px">ุงูุตูุบุฉ: ูุฌุงุญ (60%) + ููุชุงุฒ (20%) + ุชูุงุฒู ูุฌูุงุช (20%).</div>
    </section>

    <aside class="card">
      <h3>ุนุฏุณุฉ ุงูุงุณุชูุฑุงุฏ (ูุจุชูุฑุฉ)</h3>
      <label class="drop" id="dz1">
        <div class="lens">ูก</div>
        <div><div><strong>ุงูููู (ุงููุชุฑุฉ 1)</strong> โ Excel/CSV ุงูุฃูุถู (ูุฏุนู PDF/Word/ุตูุฑ)</div><div class="stat" id="stat1">ูู ูุชู ุงุฎุชูุงุฑ ููู</div></div>
        <input id="f1" type="file" hidden accept=".xlsx,.xls,.csv,.pdf,.doc,.docx,.txt,image/*">
      </label>
      <label class="drop" id="dz2" style="margin-top:8px">
        <div class="lens">ูข</div>
        <div><div><strong>ุงูููู (ุงููุชุฑุฉ 2)</strong> ุงุฎุชูุงุฑู ููููุงุฑูุฉ</div><div class="stat" id="stat2">ูู ูุชู ุงุฎุชูุงุฑ ููู</div></div>
        <input id="f2" type="file" hidden accept=".xlsx,.xls,.csv,.pdf,.doc,.docx,.txt,image/*">
      </label>
      <div class="flex" style="margin-top:10px">
        <button class="btn" id="analyze">๐ ุชุดุบูู ุงูุชุญููู</button>
        <button class="btn ghost" id="demo">๐ ูููุฐุฌ CSV</button>
      </div>
      <hr>
      <h3>ุฎูุงุฑุงุช ุงูุชุญููู</h3>
      <div class="flex">
        <div class="input"><label>% ุญุฏ ุงูุถุนูู</label><input id="thWeak" type="number" value="20" min="0" max="100"></div>
        <div class="input"><label>ูุชูุณุท ุฃูู ูู</label><input id="thAvg" type="number" value="75" min="0" max="100"></div>
        <div class="input"><label>โค CV%</label><input id="thCV" type="number" value="18" min="0" max="100"></div>
        <div class="input"><label>โค Std</label><input id="thStd" type="number" value="12" min="0" max="100"></div>
      </div>
      <div class="flex" style="margin-top:8px">
        <button class="btn warn" id="mkPlan">๐งญ ุชูููุฏ ุฎุทุฉ SMART</button>
        <button class="btn acc" id="expX">๐งพ ุชุตุฏูุฑ Excel</button>
        <button class="btn ghost" id="savePdf">๐ ุญูุธ PDF</button>
        <button class="btn bad" id="reset">โป๏ธ ุฅุนุงุฏุฉ ุถุจุท</button>
      </div>
    </aside>
  </div>

  <section class="card">
    <h3>ุงููุคุดุฑุงุช ุงูุฑุฆูุณูุฉ (KPIs)</h3>
    <div class="kpis" id="kpis"></div>

    <h3 style="margin-top:8px">ุงูุฑุณูู ุงูุชุญููููุฉ</h3>
    <div class="flex" style="justify-content:space-between;align-items:center">
      <div class="flex">
        <label class="small">ุงูุตู:</label><select id="grade"><option value="all">ุฌููุน ุงูุตููู</option></select>
        <label class="small">ุงููุงุฏุฉ:</label><select id="subject"><option value="all">ุฌููุน ุงูููุงุฏ</option></select>
        <label class="small">ุงูููุท:</label><select id="chartType"><option value="bar">ุฃุนูุฏุฉ</option><option value="radar">ุฑุงุฏุงุฑ</option></select>
      </div>
    </div>
    <canvas id="chart" height="260" style="margin-top:8px"></canvas>
    <canvas id="radar" height="260" style="display:none;margin-top:8px"></canvas>
  </section>

  <section class="card">
    <h3>ุฎุฑูุทุฉ ุงููุฌูุงุช + ุงูุชุดุฎูุต ุงูุฐูู</h3>
    <table class="table">
      <thead><tr>
        <th>ุงูุตู</th><th>ุงููุงุฏุฉ</th><th>ุนุฏุฏ</th><th>ูุชูุณุท</th><th>% ุถุนูู</th><th>% ููุชุงุฒ</th><th>CV%</th><th>Std</th><th>ุงูุชุดุฎูุต</th>
      </tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </section>

  <section class="card" id="planCard">
    <div class="flex" style="justify-content:space-between;align-items:center">
      <h3>ุฎุทุฉ ุงูุชุญุณูู Auto-SMART (ูุฑุชุจุทุฉ ุฎูุงุฑุฒูููุง ุจุงูุชุญููู)</h3>
      <div class="gauge" style="width:280px"><div id="schoolGauge2"></div></div>
    </div>
    <table class="table" id="planTbl">
      <thead><tr><th>#</th><th>ุงููุฌุงู/ุงููุงุฏุฉ</th><th>ุงููุฏู (SMART)</th><th>ุงููุตู</th><th>ุงูุฃุณุงุจูุน</th><th>ุงูุฅุฌุฑุงุก</th><th>ุงููุณุคูู</th><th>ุงููุคุดุฑ</th><th>ุงูุดูุงูุฏ</th></tr></thead>
      <tbody id="planBody"></tbody>
    </table>
  </section>
</div>

<!-- ุณุงุญุฑ ุชุนููู ุงูุฃุนูุฏุฉ -->
<div class="modal" id="wiz">
  <div class="wiz">
    <h3 style="margin:4px 0 10px;color:var(--moe)">ูุนุงูุฌ ุชุนููู ุงูุฃุนูุฏุฉ (ุงูููู ูุง ูุชุจุน ูุณููุงุช ููุงุณูุฉ)</h3>
    <div class="small">ุงุฎุชุฑ ุงูุฃุนูุฏุฉ ุงูุชู ุชูุซู: <strong>ุงูุตู</strong> | <strong>ุงููุงุฏุฉ</strong> | <strong>ุงูุฏุฑุฌุฉ</strong> (0โ100)</div>
    <div id="wizBody" class="flex" style="margin:8px 0"></div>
    <div class="small" id="wizPreview"></div>
    <div class="flex" style="justify-content:flex-end;margin-top:8px">
      <button class="btn ghost" id="wizCancel">ุฅูุบุงุก</button>
      <button class="btn" id="wizOK">ูุชุงุจุนุฉ</button>
    </div>
  </div>
</div>

<div id="overlay"><div class="spin"></div></div>
<footer>ยฉ ุซุงูููุฉ ุงููุนููุจู ุงูุซุงูููุฉ ุจุงูุฎุจุฑ โ ูกูคูคูงูู | ูุงุฆุฏ ุงููุฏุฑุณุฉ: ููุฏ ุญุงูุฏ ุงูุฒูุฑุงูู</footer>

<script>
const $=s=>document.querySelector(s);
const showBusy=on=>{ $('#overlay').style.display=on?'flex':'none' };
if(location.protocol==='file:') $('#serverNotice').style.display='block';
const { jsPDF } = window.jspdf || {};

// ุฃุฑูุงู ุนุฑุจูุฉ/ูุงุฑุณูุฉ โ ูุงุชูููุฉ
const AR='ููกูขูฃูคูฅูฆูงูจูฉ', FA='ฐฑฒณดตถทธน';
function toLatinDigits(s){return String(s??'').replace(/[\u0660-\u0669]/g,c=>AR.indexOf(c)).replace(/[\u06F0-\u06F9]/g,c=>FA.indexOf(c)).replace(/[\u200f\u200e\u202a-\u202c]/g,'')}
const tidy = v => toLatinDigits(String(v??'').trim());
function pickNum(v){const s=tidy(v).replace(',', '.');const m=s.match(/(-?\d{1,3}(?:\.\d+)?)/);if(!m)return NaN;const x=+m[1];if(/%|ูช/.test(s))return Math.max(0,Math.min(100,x));return (x>=0&&x<=100)?x:NaN}
const pct=(n,d)=>d?+(100*n/d).toFixed(2):0;
function mean(a){return a.length?a.reduce((s,x)=>s+x,0)/a.length:0}
function stddev(a){if(a.length<2)return 0;const m=mean(a);const v=a.reduce((s,x)=>s+(x-m)*(x-m),0)/(a.length-1);return Math.sqrt(v)}
function quantile(a,q){const s=[...a].sort((x,y)=>x-y);if(!s.length)return NaN;const p=(s.length-1)*q;const b=Math.floor(p),r=p-b;return s[b]+((s[b+1]??s[b])-s[b])*(r||0)}
function skewness(a){if(a.length<3)return 0;const m=mean(a),sd=stddev(a)||1,n=a.length;return (n/((n-1)*(n-2)))*a.reduce((s,x)=>s+Math.pow((x-m)/sd,3),0)}

// ุนุฏุณุฉ ุงูุณุญุจ/ุงูุฅููุงุช
function wireDrop(dz,input,stat){
  ['dragover','dragenter'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();dz.classList.add('on')}));
  ['dragleave','dragend','drop'].forEach(ev=>dz.addEventListener(ev,()=>dz.classList.remove('on')));
  dz.addEventListener('click',()=>input.click());
  input.addEventListener('change',()=>{stat.textContent=input.files[0]?input.files[0].name:'ูู ูุชู ุงุฎุชูุงุฑ ููู'});
  dz.addEventListener('drop',e=>{e.preventDefault();input.files=e.dataTransfer.files;stat.textContent=input.files[0]?input.files[0].name:'ูู ูุชู ุงุฎุชูุงุฑ ููู'});
}

// ===== ุงูุชุดุงู ุงูุฃุนูุฏุฉ ุงูุฐูู + ุงูุณุงุญุฑ =====
const KEY_GRADE = /(ุงูุตู|ุงูุดุนุจุฉ|ุงููุณุชูู|grade|level|class|group)/i;
const KEY_SUBJ  = /(ุงููุงุฏุฉ|ุงูููุฑุฑ|subject|course|material|curriculum)/i;
const KEY_SCORE = /(ุงูุฏุฑุฌุฉ|score|mark|percent|percentage|result|final|total)/i;

function scoreHeader(text, type){
  const t=tidy(text).toLowerCase();
  if(!t) return 0;
  const m = type==='g'?KEY_GRADE:(type==='s'?KEY_SUBJ:KEY_SCORE);
  let sc = m.test(t)?3:0;
  if(/name|student|ุฑูู/.test(t)) sc-=2; // ุงุณุชุจุนุงุฏ ุฃุนูุฏุฉ ุงูุฃุณูุงุก/ุงูุฃุฑูุงู
  return sc;
}

function guessMap(headers, rows){
  // ููุงุณ ุงุญุชูุงููุฉ "ุฏุฑุฌุฉ" ุจุงููุธุฑ ููููู ุงูุนุฏุฏูุฉ 0-100
  const nRows = Math.min(rows.length, 80);
  const numericScore = headers.map((_,ci)=>{
    let hits=0,cnt=0;
    for(let r=1;r<nRows;r++){const v=pickNum(rows[r][ci]); if(!isNaN(v)){cnt++; if(v>=0&&v<=100) hits++;}}
    return cnt?hits/cnt:0;
  });
  let g=-1,s=-1,sc=-1, bestG=-1,bestS=-1,bestC=-1;
  headers.forEach((h,i)=>{
    const sg=scoreHeader(h,'g'); if(sg>bestG){bestG=sg; g=i}
    const ss=scoreHeader(h,'s'); if(ss>bestS){bestS=ss; s=i}
    const cs=scoreHeader(h,'c') + (numericScore[i]>0.6?3:0); if(cs>bestC){bestC=cs; sc=i}
  });
  return {grade:g, subject:s, score:sc};
}

function showWizard(headers){
  return new Promise(res=>{
    const opts=(sel)=>headers.map((h,i)=>`<option value="${i}" ${sel===i?'selected':''}>${h||('ุนููุฏ '+(i+1))}</option>`).join('');
    $('#wizBody').innerHTML = `
      <div class="input"><label>ุงูุตู</label><select id="mGrade">${opts(0)}</select></div>
      <div class="input"><label>ุงููุงุฏุฉ</label><select id="mSubject">${opts(1)}</select></div>
      <div class="input"><label>ุงูุฏุฑุฌุฉ</label><select id="mScore">${opts(2)}</select></div>`;
    $('#wiz').style.display='flex';
    $('#wizOK').onclick=()=>{ $('#wiz').style.display='none'; res({grade:+mGrade.value, subject:+mSubject.value, score:+mScore.value}) };
    $('#wizCancel').onclick=()=>{ $('#wiz').style.display='none'; res(null) };
  });
}

// ===== ูุฑุงุกุฉ ูู ุงูุฃููุงุน =====
async function parseXlsxOrCsv(file){
  const wb=XLSX.read(await file.arrayBuffer(),{type:'array'});
  const sheet=wb.SheetNames[0];
  const rows=XLSX.utils.sheet_to_json(wb.Sheets[sheet],{header:1,defval:''}).filter(r=>r.some(c=>String(c).trim()!==''));
  if(!rows.length) return [];

  // ุฅูุฌุงุฏ ุตู ุงูุนูุงููู ุงูุฃูุถู
  let hdr=0,best=-1;
  for(let i=0;i<Math.min(rows.length,30);i++){
    const row=rows[i].map(tidy);
    const sc = row.reduce((s,c)=>s+scoreHeader(c,'g')+scoreHeader(c,'s')+scoreHeader(c,'c'),0) + (row.some(c=>/\d/.test(String(c)))?0:-1);
    if(sc>best){best=sc;hdr=i}
  }

  const headers=rows[hdr].map(tidy);
  let map = guessMap(headers, rows);

  // ูุญุงููุฉ ุงุณุชุฎุฑุงุฌ ุฃูููุฉ
  let out = [];
  const pushWith = (m)=>{
    for(let i=hdr+1;i<rows.length;i++){
      const r=rows[i]; const G=tidy(r[m.grade]); const S=tidy(r[m.subject]); const X=pickNum(r[m.score]);
      if(G && S && !isNaN(X)) out.push({grade:G,subject:S,score:X});
    }
  };
  pushWith(map);

  // ุฅู ูุงูุช ููููุฉ ููุนูู ุงูุณุงุญุฑ
  if(out.length<3){
    const manual = await showWizard(headers);
    if(!manual) return [];
    out=[]; pushWith(manual);
  }
  return out;
}

async function parsePdf(file){
  try{
    const pdf=await pdfjsLib.getDocument({data:await file.arrayBuffer()}).promise;
    let text=''; const max=Math.min(pdf.numPages,6);
    for(let p=1;p<=max;p++){const pg=await pdf.getPage(p);const tc=await pg.getTextContent();text+=' '+tc.items.map(i=>i.str).join(' ')}
    text=tidy(text);
    const out=[], re=/(ุฃูู ุซุงููู|ุซุงูู ุซุงููู|ุซุงูุซ ุซุงููู).*?(?:ูุงุฏุฉ|ุงููุงุฏุฉ|subject|course)[:\s]*([\u0600-\u06FFA-Za-z\s]+?).*?(?:ุงูุฏุฑุฌุฉ|ุฏุฑุฌุฉ|%|percent|mark|score)[:\s]*(\d{1,3})/gi;
    let m; while((m=re.exec(text))){ out.push({grade:m[1],subject:m[2].trim(),score:+m[3]}) }
    if(out.length) return out;
  }catch(e){}
  // OCR ูุตูุญุชูู ููุท ูุชุณุฑูุน ุงูุฃุฏุงุก
  const pdf=await pdfjsLib.getDocument({data:await file.arrayBuffer()}).promise;
  let ocr=''; const max=Math.min(pdf.numPages,2);
  for(let p=1;p<=max;p++){const pg=await pdf.getPage(p);const vp=pg.getViewport({scale:2});const c=document.createElement('canvas');c.width=vp.width;c.height=vp.height;await pg.render({canvasContext:c.getContext('2d'),viewport:vp}).promise;const {data}=await Tesseract.recognize(c.toDataURL(),'ara+eng');ocr+=' '+(data.text||'')}
  const t=tidy(ocr), out=[], rx=/(ุฃูู ุซุงููู|ุซุงูู ุซุงููู|ุซุงูุซ ุซุงููู).*?(?:ูุงุฏุฉ|ุงููุงุฏุฉ|subject|course)[:\s]*([\u0600-\u06FFA-Za-z\s]+?).*?(?:ุงูุฏุฑุฌุฉ|ุฏุฑุฌุฉ|%|percent|mark|score)[:\s]*(\d{1,3})/gi;
  let m; while((m=rx.exec(t))){ out.push({grade:m[1],subject:m[2].trim(),score:+m[3]}) }
  return out;
}
async function parseWordOrTxt(file){
  const ext=file.name.split('.').pop().toLowerCase();
  let text='';
  if(ext==='txt'){ text=new TextDecoder().decode(await file.arrayBuffer()); }
  else{ const res=await window.mammoth.extractRawText({arrayBuffer:await file.arrayBuffer()}); text=res.value||''; }
  text=tidy(text);
  const out=[], re=/(ุฃูู ุซุงููู|ุซุงูู ุซุงููู|ุซุงูุซ ุซุงููู).*?(?:ูุงุฏุฉ|ุงููุงุฏุฉ|subject|course)[:\s]*([\u0600-\u06FFA-Za-z\s]+?).*?(?:ุงูุฏุฑุฌุฉ|ุฏุฑุฌุฉ|%|percent|mark|score)[:\s]*(\d{1,3})/gi;
  let m; while((m=re.exec(text))){ out.push({grade:m[1],subject:m[2].trim(),score:+m[3]}) }
  return out;
}
async function parseImage(file){
  const r=await Tesseract.recognize(file,'ara+eng'); const t=tidy(r.data.text||'');
  const out=[], re=/(ุฃูู ุซุงููู|ุซุงูู ุซุงููู|ุซุงูุซ ุซุงููู).*?(?:ูุงุฏุฉ|ุงููุงุฏุฉ|subject|course)[:\s]*([\u0600-\u06FFA-Za-z\s]+?).*?(?:ุงูุฏุฑุฌุฉ|ุฏุฑุฌุฉ|%|percent|mark|score)[:\s]*(\d{1,3})/gi;
  let m; while((m=re.exec(t))){ out.push({grade:m[1],subject:m[2].trim(),score:+m[3]}) }
  return out;
}
async function parseAny(file){
  const ext=(file.name.split('.').pop()||'').toLowerCase();
  if(['xlsx','xls','csv'].includes(ext)) return await parseXlsxOrCsv(file);
  if(ext==='pdf') return await parsePdf(file);
  if(['doc','docx','txt'].includes(ext)) return await parseWordOrTxt(file);
  if(['png','jpg','jpeg','webp'].includes(ext)) return await parseImage(file);
  try{ return await parseXlsxOrCsv(file) }catch{return []}
}

// ===== ุงูุชุญููู ูุงูุฑุณูู =====
let rowsAll=[], summary=[], chartObj=null, radarObj=null;

function buildSummary(rows){
  const M=new Map();
  rows.forEach(r=>{const k=r.grade+'||'+r.subject; if(!M.has(k))M.set(k,{grade:r.grade,subject:r.subject,scores:[]}); M.get(k).scores.push(r.score)});
  return [...M.values()].map(o=>{
    const s=o.scores, n=s.length, avg=+mean(s).toFixed(2), med=+quantile(s,0.5).toFixed(2);
    const sd=+stddev(s).toFixed(2), cv=+(sd/(avg||1)*100).toFixed(2), sk=+skewness(s).toFixed(2);
    const poor=s.filter(x=>x<60).length, exc=s.filter(x=>x>=90).length;
    return {grade:o.grade,subject:o.subject,count:n,avg,med,sd,cv,sk,
      poor, excellent:exc, poorPct:pct(poor,n), excellentPct:pct(exc,n)};
  });
}
function schoolIndex(summ){
  if(!summ.length) return 0;
  const total=summ.reduce((a,b)=>a+b.count,0);
  const pass=summ.reduce((a,b)=>a+(b.count-b.poor),0);
  const exc =summ.reduce((a,b)=>a+b.excellent,0);
  const passPct=pct(pass,total), exPct=pct(exc,total);
  const balanced= 100 - Math.min(100,(summ.filter(s=>s.poorPct>25).length/summ.length)*100);
  return Math.round(passPct*0.6 + exPct*0.2 + balanced*0.2);
}
function renderKPIs(rows){
  const k=$('#kpis'); k.innerHTML='';
  const total=rows.length, pass=rows.filter(r=>r.score>=60).length, exc=rows.filter(r=>r.score>=90).length;
  const avg= total? (rows.reduce((a,b)=>a+b.score,0)/total).toFixed(2):0;
  [['ุนุฏุฏ ุงูุณุฌูุงุช',total],['ูุชูุณุท ุงูุฏุฑุฌุงุช',avg],['ูุณุจุฉ ุงููุฌุงุญ',pct(pass,total)+'%'],['ูุณุจุฉ ุงูููุชุงุฒ',pct(exc,total)+'%']]
    .forEach(([n,v])=>{const d=document.createElement('div');d.className='kpi';d.innerHTML=`<div class="v">${v}</div><div class="small">${n}</div>`;k.appendChild(d)});
}
function fillFilters(rows){
  const gs=[...new Set(rows.map(r=>r.grade))].sort();
  const ss=[...new Set(rows.map(r=>r.subject))].sort();
  grade.innerHTML='<option value="all">ุฌููุน ุงูุตููู</option>'+gs.map(x=>`<option>${x}</option>`).join('');
  subject.innerHTML='<option value="all">ุฌููุน ุงูููุงุฏ</option>'+ss.map(x=>`<option>${x}</option>`).join('');
}
function renderTables(){
  const g=grade.value, s=subject.value, minW=+thWeak.value, avgCut=+thAvg.value, maxCV=+thCV.value, maxStd=+thStd.value;
  const tb=$('#tbody'); tb.innerHTML='';
  summary.filter(x=>(g==='all'||x.grade===g)&&(s==='all'||x.subject===s))
    .sort((a,b)=>a.grade.localeCompare(b.grade,'ar')||a.subject.localeCompare(b.subject,'ar'))
    .forEach(x=>{
      const need = (x.poorPct>=minW) || (x.avg<avgCut) || (x.cv>=maxCV) || (x.sd>=maxStd) || (x.excellentPct>=95 && x.cv<=5);
      const note = need ? 'ุนูุงุฌ ุชูุงุถูู/ูุฑุงุฌุนุฉ ุฃุฏูุงุช/ุชูุงูุฒ' : 'ูุชูุงุฒู โ ุงุณุชูุฑ ูู ููุงู ุงูุฃุฏุงุก ูุงูุฃุณุฆูุฉ ุงูุนููุง';
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${x.grade}</td><td>${x.subject}</td><td>${x.count}</td><td>${x.avg}</td>
        <td>${x.poorPct}%</td><td>${x.excellentPct}%</td><td>${x.cv}</td><td>${x.sd}</td>
        <td>${need?'<span class="badge">ุชุญุชุงุฌ ูุชุงุจุนุฉ</span>':''} ${note}</td>`;
      tb.appendChild(tr);
    });
}
function renderCharts(){
  const g=grade.value, s=subject.value, type=chartType.value;
  const filtered=summary.filter(x=>(g==='all'||x.grade===g)&&(s==='all'||x.subject===s));
  const labels=filtered.map(x=>x.grade+' โ '+x.subject), avgs=filtered.map(x=>x.avg), spreads=filtered.map(x=>x.sd);
  if(chartObj) chartObj.destroy(); if(radarObj) radarObj.destroy();
  if(type==='bar'){ $('#radar').style.display='none'; $('#chart').style.display='block';
    chartObj=new Chart($('#chart'),{type:'bar',data:{labels,datasets:[{label:'ุงููุชูุณุท',data:avgs},{label:'ุงูุงูุญุฑุงู ุงููุนูุงุฑู',data:spreads}]},options:{plugins:{legend:{position:'bottom'}},scales:{y:{min:0,max:100}}}});
  }else{ $('#chart').style.display='none'; $('#radar').style.display='block';
    radarObj=new Chart($('#radar'),{type:'radar',data:{labels,datasets:[
      {label:'% ุถุนูู',data:filtered.map(x=>x.poorPct)},
      {label:'% ููุชุงุฒ',data:filtered.map(x=>x.excellentPct)},
      {label:'CV %',data:filtered.map(x=>x.cv)}
    ]},options:{plugins:{legend:{position:'bottom'}},scales:{r:{min:0,max:100}}}});
  }
}
function renderGauge(){
  const idx=schoolIndex(summary);
  $('#schoolGauge').style.width=idx+'%';
  $('#schoolGauge2').style.width=idx+'%';
  $('#schoolGauge').title='ูุคุดุฑ ุงููุฏุฑุณุฉ: '+idx+'%';
}

// ===== ุฎุทุฉ Auto-SMART =====
function buildPlan(){
  const minW=+thWeak.value, avgCut=+thAvg.value, maxCV=+thCV.value, maxStd=+thStd.value;
  const ordered=[...summary].sort((a,b)=>{
    const ka=(a.poorPct>=minW?3:0)+(a.cv>=maxCV?2:0)+((a.excellentPct>=95&&a.cv<=5)?1:0);
    const kb=(b.poorPct>=minW?3:0)+(b.cv>=maxCV?2:0)+((b.excellentPct>=95&&b.cv<=5)?1:0);
    return kb-ka || (b.poorPct-a.poorPct) || (b.cv-a.cv);
  }).slice(0,12);
  const rows=ordered.map((x,i)=>{
    let ุงููุฏู,ุงูุฅุฌุฑุงุก,ุงููุณุคูู,ุงููุคุดุฑ,ุงูุดูุงูุฏ,ุงููุตู,ุงูุฃุณุงุจูุน;
    if(x.poorPct>=minW || x.avg<avgCut){
      ุงููุฏู=`ุฎูุถ ุงูุถุนูู ูู ${x.subject} (${x.grade}) ูู ${x.poorPct}% ุฅูู โค ${Math.max(0,Math.floor(x.poorPct-10))}% ูุฑูุน ุงููุชูุณุท ุฅูู โฅ ${Math.max(75,Math.ceil(x.avg+5))}%`;
      ุงูุฅุฌุฑุงุก='ุชุดุฎูุต ุฃุณุจูุนู + ูุฌููุนุงุช ุนูุงุฌ ุชูุงุถูู + ุจูู ุฃุณุฆูุฉ ูุนูุงุฑูุฉ + ุงุฎุชุจุงุฑ ูุตูุฑ';
      ุงููุณุคูู='ูุงุฆุฏ ููุงุชุฌ ุงูุชุนูู + ูุนูู ุงููุงุฏุฉ'; ุงููุคุดุฑ='% ุถุนู ุดูุฑู / ูุชูุณุท ุงููุญุฏุฉ / ุญุถูุฑ ุงูุนูุงุฌ';
      ุงูุดูุงูุฏ='ููุงุฐุฌ ุชุดุฎูุตุ ุฎุทุท ุนูุงุฌุ ุฃุนูุงู ุทูุงุจ ูุจู/ุจุนุฏุ ุชูุงุตู ููู ุงูุฃูุฑ'; ุงููุตู='ุงูุฃูู'; ุงูุฃุณุงุจูุน='3โ10';
    }else if(x.excellentPct>=95 && x.cv<=5){
      ุงููุฏู=`ุฑูุน ููุงู ุงูุฃุฏุงุก ูุงูุฃุณุฆูุฉ ุงูุนููุง ูู ${x.subject} (${x.grade}) ุฅูู โฅ 40% ูุน ุจูุงุก ุงููุชูุณุท โฅ ${Math.ceil(x.avg)}%`;
      ุงูุฅุฌุฑุงุก='ููุงู ุฃุฏุงุก ุนููุง Rubrics + ูุดุฑูุนุงุช ูุตูุฑุฉ + ุงูุชุญุงูุงุช ุชูุงุถููุฉ ุงููุณุชููุงุช';
      ุงููุณุคูู='ูุฌูุฉ ุงูุชุนููู ูุงูุชุนููู'; ุงููุคุดุฑ='% ุฃุณุฆูุฉ ุนููุง / % ููุงู ุฃุฏุงุก'; ุงูุดูุงูุฏ='ููุงุฐุฌ ุจููุฏุ Rubricsุ ููุชุฌุงุช ุทูุงุจ'; ุงููุตู='ุงูุซุงูู'; ุงูุฃุณุงุจูุน='6โ12';
    }else if(x.cv>=maxCV || x.sd>=maxStd){
      ุงููุฏู=`ุฎูุถ CV ูู ${x.subject} (${x.grade}) ูู ${x.cv}% ุฅูู โค ${Math.max(10,Math.ceil(x.cv-6))}% ูุน ุงูุญูุงุธ ุนูู ูุชูุณุท โฅ ${Math.ceil(x.avg)}%`;
      ุงูุฅุฌุฑุงุก='ุชูุญูุฏ ุฌุฏุงูู ุงูููุงุตูุงุช + ุจููู ุฃุณุฆูุฉ ูุนูุงุฑูุฉ + ูุนุงูุฑุฉ ูุตุญูุญูู + ูุฑุงุฌุนุฉ ุฃุฏูุงุช ุงูุชูููู';
      ุงููุณุคูู='ููุงุฏุฉ ุงููุณู + ูุนููู ุงููุงุฏุฉ'; ุงููุคุดุฑ='CV ุดูุฑู / Std / ูุชุงุฆุฌ ูุนูุงุฑูุฉ ูุตูุฑุฉ'; ุงูุดูุงูุฏ='ุฌุฏุงูู ููุงุตูุงุชุ ุชูุงุฑูุฑ ูุนุงูุฑุฉ'; ุงููุตู='ุงูุฃูู'; ุงูุฃุณุงุจูุน='4โ9';
    }else{
      ุงููุฏู=`ุงูุญูุงุธ ุนูู ุงูุชูุงุฒู ูุฑูุน ูุชูุณุท ${x.subject} (${x.grade}) ุฅูู โฅ ${Math.max(85,Math.ceil(x.avg+3))}%`;
      ุงูุฅุฌุฑุงุก='ุงุณุชุฑุงุชูุฌูุงุช ูุดุทุฉ + ุชุนูู ุชุนุงููู + ุฅุซุฑุงุก ุงููุชููุฒูู + ุฏุนู ุงููุชูุณุทูู';
      ุงููุณุคูู='ุงููุนูู + ุงููุฑุดุฏ ุงูุฃูุงุฏููู'; ุงููุคุดุฑ='ูุชูุณุท ุงููุญุฏุฉ / % ุฃุณุฆูุฉ ุนููุง / ุฑุถุง ุงูุทูุจุฉ';
      ุงูุดูุงูุฏ='ุฎุทุฉ ุฏุฑุณุ ุฃุฏูุงุช ุชููููุ ุชูุงุฑูุฑ ุฑุถุง'; ุงููุตู='ุงูุซุงูู'; ุงูุฃุณุงุจูุน='3โ8';
    }
    return `<tr><td>${i+1}</td><td>${x.grade} โ ${x.subject}</td><td>${ุงููุฏู}</td><td>${ุงููุตู}</td><td>${ุงูุฃุณุงุจูุน}</td><td>${ุงูุฅุฌุฑุงุก}</td><td>${ุงููุณุคูู}</td><td>${ุงููุคุดุฑ}</td><td>${ุงูุดูุงูุฏ}</td></tr>`;
  }).join('');
  $('#planBody').innerHTML=rows||'<tr><td colspan="9" style="text-align:center">ุญููู ุงูุจูุงูุงุช ุฃูููุง</td></tr>';
}

// ===== ุชุตุฏูุฑ =====
async function savePDF(nodeSelector, filename){
  const node=(typeof nodeSelector==='string')?document.querySelector(nodeSelector):nodeSelector;
  const canvas=await html2canvas(node,{scale:2,background:'#ffffff',useCORS:true,allowTaint:false});
  const img=canvas.toDataURL('image/png'); const pdf=new jsPDF('p','pt','a4');
  const pw=pdf.internal.pageSize.getWidth(), ph=pdf.internal.pageSize.getHeight(); const r=Math.min(pw/canvas.width,ph/canvas.height);
  pdf.addImage(img,'PNG',(pw-canvas.width*r)/2,(ph-canvas.height*r)/2,canvas.width*r,canvas.height*r); pdf.save(filename);
}
function exportPlanExcel(){
  const rows=[['#','ุงููุฌุงู/ุงููุงุฏุฉ','ุงููุฏู (SMART)','ุงููุตู','ุงูุฃุณุงุจูุน','ุงูุฅุฌุฑุงุก','ุงููุณุคูู','ุงููุคุดุฑ','ุงูุดูุงูุฏ']];
  document.querySelectorAll('#planBody tr').forEach(tr=>rows.push([...tr.children].map(td=>td.innerText)));
  const ws=XLSX.utils.aoa_to_sheet(rows), wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'ุฎุทุฉ ุงูุชุญุณูู'); XLSX.writeFile(wb,'ุฎุทุฉ-ุชุญุณูู-ุงููุนููุจู.xlsx');
}

// ===== ุฑุจุท ุงูุฃุญุฏุงุซ =====
window.addEventListener('DOMContentLoaded', ()=>{
  wireDrop($('#dz1'), $('#f1'), $('#stat1'));
  wireDrop($('#dz2'), $('#f2'), $('#stat2'));

  $('#demo').onclick=()=>{
    const csv=`ุงูุตู,ุงููุงุฏุฉ,ุงูุฏุฑุฌุฉ
ุฃูู ุซุงููู,ุฑูุงุถูุงุช,55
ุฃูู ุซุงููู,ุฑูุงุถูุงุช,72
ุซุงูู ุซุงููู,ููููุงุก,91
ุซุงูุซ ุซุงููู,ูุบุฉ ุนุฑุจูุฉ,84
ุซุงูุซ ุซุงููู,ูุบุฉ ุนุฑุจูุฉ,63`;
    const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8'}));a.download='ูููุฐุฌ-ูุชุงุฆุฌ.csv';a.click();
  };

  $('#analyze').onclick=async()=>{
    const f1=$('#f1').files[0], f2=$('#f2').files[0];
    if(!f1 && !f2){ alert('ูุถูุงู ุงุฎุชุฑ ููููุง ูุงุญุฏูุง ุนูู ุงูุฃูู'); return; }
    showBusy(true);
    try{
      rowsAll=[];
      if(f1) rowsAll.push(...await parseAny(f1));
      if(f2) rowsAll.push(...await parseAny(f2));
      if(!rowsAll.length){ alert('ูุง ุชูุฌุฏ ุณุฌูุงุช ุตุงูุญุฉ. ุงูุฑุฌุงุก ุงุณุชุฎุฏุงู ุงูุณุงุญุฑ ุนูุฏ ุธููุฑู ูุชุนููู ุงูุฃุนูุฏุฉ ุงูุตุญูุญุฉ.'); return; }
      summary=buildSummary(rowsAll);
      renderKPIs(rowsAll); fillFilters(rowsAll); renderCharts(); renderTables(); renderGauge();
      alert('ุชู ุงูุชุญููู ุจูุฌุงุญ โ');
    }catch(e){ console.error(e); alert('ุชุนุฐุฑ ุงูุชุญููู: '+(e.message||e)); }
    finally{ showBusy(false); }
  };

  $('#mkPlan').onclick=()=>{ buildPlan(); renderGauge(); document.querySelector('#planCard').scrollIntoView({behavior:'smooth'}); };
  $('#expX').onclick=exportPlanExcel;
  $('#savePdf').onclick=()=>savePDF(document.body,'Dashboard-ุงููุนููุจู.pdf');
  $('#reset').onclick=()=>{ rowsAll=[];summary=[]; if(chartObj)chartObj.destroy(); if(radarObj)radarObj.destroy(); $('#kpis').innerHTML=''; $('#tbody').innerHTML=''; $('#planBody').innerHTML=''; grade.innerHTML='<option value="all">ุฌููุน ุงูุตููู</option>'; subject.innerHTML='<option value="all">ุฌููุน ุงูููุงุฏ</option>'; renderGauge(); alert('ุชูุช ุฅุนุงุฏุฉ ุงูุถุจุท'); };
  ['grade','subject','chartType','thWeak','thAvg','thCV','thStd'].forEach(id=>document.getElementById(id).addEventListener('change',()=>{ renderCharts(); renderTables(); buildPlan(); }));
});
</script>
</body>
</html>
