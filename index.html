<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>منصة التحليل والتحسين المدرسي – ثانوية اليعقوبي</title>

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

<style>
:root{
  --moe:#0b7e88; --ink:#06353b; --bg:#f5f8f8;
  --muted:#7a9aa0; --ok:#e8fff5; --okb:#13b38a;
  --bad:#fff3f3; --badb:#ef4444; --card:#ffffff;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:'Tajawal',sans-serif}
a{color:#145; text-decoration:none}
a:hover{text-decoration:underline}

/* ====== Responsive single block ====== */
.page{max-width:1200px;margin:0 auto;padding:10px 14px}

/* ====== Header (image only) ====== */
.header{
  width:100%; aspect-ratio: 7/1.6; /* يضمن الظهور لكل الشاشات */
  background:#053840 url('logo.png') center/contain no-repeat;
  border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,.12);
  margin:10px auto;
}

/* ====== Top controls ====== */
.controls{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;padding:10px}
.btn{background:var(--moe);color:#fff;border:0;border-radius:10px;padding:10px 16px;font-weight:700;cursor:pointer;box-shadow:0 6px 16px rgba(11,126,136,.2)}
.btn.light{background:#e8f3f4;color:#06353b}
.btn:hover{filter:brightness(.95)}

/* ====== Grid ====== */
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}
.card{background:var(--card);border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.08);padding:16px;position:relative}
.card h2{margin:0 0 6px;color:var(--moe);font-size:22px}
.kpi{display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:14px}
.progress{height:10px;background:#e6efef;border-radius:999px;overflow:hidden;margin:8px 0}
.bar{height:100%;background:#2aa897}
.small{font-size:12px;color:#567}

/* ====== Detail area ====== */
.detail{display:none;margin-top:12px;border-top:1px dashed #e1ecec;padding-top:12px}
.titleRow{display:flex;align-items:center;gap:10px;justify-content:space-between}
.titleRow h3{margin:0;color:#06353b}
.titleRow .donutWrap{width:110px}  /* الدائرة العلوية فقط */
.subgrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;margin-top:8px}
.subCard{background:#f7fbfb;border:1px solid #e6efef;border-radius:12px;padding:10px}

/* ====== Detailed table per field ====== */
.tableWrap{margin-top:12px}
table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden}
thead th{background:#0f6f79;color:#fff;padding:10px;font-weight:700}
tbody td{padding:10px;border-bottom:1px solid #eef3f3;vertical-align:top}
tbody tr:last-child td{border-bottom:0}
.badge{padding:2px 8px;border-radius:99px;background:#e6efef;color:#246;font-size:12px}
.row-ok{background:var(--ok)}
.row-bad{background:var(--bad)}
.level{font-weight:700}
.actionsRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}

/* ====== Evidence modal ====== */
.modal{position:fixed;inset:0;background:rgba(2,52,59,.6);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:9999}
.sheet{width:min(920px,96vw);max-height:92vh;overflow:auto;background:#fff;border-radius:16px;box-shadow:0 12px 40px rgba(0,0,0,.35);padding:16px}
.sheet h4{margin:0 0 8px}
.row{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.row label{font-size:12px;color:#345}
input[type=text],input[type=date],select{border:1px solid #d7e7e7;border-radius:8px;padding:8px;width:100%}
.sheet .close{position:sticky;top:0;margin-bottom:8px;background:#e8eff0;border:0;color:#034;padding:6px 10px;border-radius:8px;cursor:pointer;font-weight:700}

/* ====== Print in popup (A4) ====== */
@media print{ .no-print{display:none !important} }

/* Footer */
.footer{padding:18px 10px;text-align:center;color:#7a9aa0}
</style>
</head>
<body>

<div class="page">

  <!-- Header (image only) -->
  <div class="header" aria-label="Ministry of Education"></div>

  <div class="controls">
    <button class="btn" id="btnAnalyze">تحليل شامل 🔎</button>
    <button class="btn" id="btnFullReport">تقرير شامل PDF 📘</button>
    <button class="btn" id="btnFullPlan">خطة تحسين شاملة PDF 🗂️</button>
  </div>

  <div id="dashboard" class="grid"></div>

  <div class="footer">© 1447 هـ – ثانوية اليعقوبي – منصة التحليل والتحسين المدرسي</div>
</div>

<!-- ===== Evidence Modal ===== -->
<div class="modal" id="eviModal" aria-hidden="true">
  <div class="sheet">
    <button class="close" id="eviClose">✕ إغلاق</button>
    <h4>إضافة شاهد</h4>
    <div class="row" style="margin-bottom:8px">
      <div><label>الوصف</label><input id="eviText" type="text" placeholder="مثال: تقرير زيارة مشرف .."/></div>
      <div><label>الفصل الدراسي</label>
        <select id="eviTerm">
          <option value="الأول">الأول</option><option value="الثاني">الثاني</option><option value="الثالث">الثالث</option>
        </select>
      </div>
      <div><label>اليوم</label>
        <select id="eviDay">
          <option>الأحد</option><option>الإثنين</option><option>الثلاثاء</option><option>الأربعاء</option><option>الخميس</option>
        </select>
      </div>
      <div><label>الأسبوع (هجري)</label>
        <select id="eviWeek"></select>
      </div>
    </div>
    <div class="row">
      <div><label>التاريخ (هجري أم القرى)</label><input id="eviHijri" type="text" placeholder="1447/03/01"/></div>
      <div><label>إرفاق رابط (PDF/صورة)</label><input id="eviLink" type="text" placeholder="https://...pdf"/></div>
      <div style="grid-column: span 2"><label>لمن يخص الشاهد</label>
        <input id="eviOwner" type="text" placeholder="المجال/المؤشر/الإجراء سيملأ تلقائياً" disabled />
      </div>
    </div>
    <div class="actionsRow">
      <button class="btn" id="eviSave">حفظ الشاهد</button>
      <button class="btn light" id="eviCancel">إلغاء</button>
    </div>
    <div class="small">* تُسحب الشواهد تلقائياً للتقارير وخطط التحسين، ويمكن فتح الرابط في نافذة منبثقة للطباعة.</div>
  </div>
</div>

<script>
/* =========== قاعدة بيانات مختصرة (قابلة للتوسعة) =========== */

/* أسابيع هجري – أمثلة (يمكن استبدالها بقائمة أدق لاحقاً) */
const WEEKS = [
  {id:'1447/02/18', name:'عودة الهيئة الإدارية — 1447/02/18'},
  {id:'1447/02/23', name:'عودة المعلمين — 1447/02/23'},
  {id:'1447/03/01', name:'بداية العام الدراسي — 1447/03/01'},
  {id:'1447/04/01', name:'إجازة اليوم الوطني — 1447/04/01'},
  {id:'1447/05/30', name:'إجازة الخريف (بداية) — 1447/05/30'},
  {id:'1447/06/08', name:'إجازة الخريف (نهاية) — 1447/06/08'}
];

/* مؤشر المستوى */
function levelOf(v){
  if(v>=90) return {txt:'ممتاز', cls:'badge', color:'#10b981'};
  if(v>=75) return {txt:'متقدم', cls:'badge', color:'#2aa897'};
  if(v>=60) return {txt:'متوسط', cls:'badge', color:'#f59e0b'};
  return {txt:'منخفض', cls:'badge', color:'#ef4444'};
}
const fmt = v => Number(v).toFixed(2);

/* بيانات المجالات (قيم 2024/2025) + مؤشرات فرعية لدائرة العلوية */
const fields = {
  management:   { name:'الإدارة المدرسية',   v2024:75.50, v2025:75.50, subs:[
    { id:'plans', name:'التخطيط', v:54.00 },
    { id:'lead',  name:'قيادة العملية التعليمية', v:72.75 },
    { id:'soc',   name:'المجتمع المدرسي', v:57.25 },
    { id:'dev',   name:'التطوير المؤسسي', v:60.25 }
  ]},
  teaching:     { name:'التعليم والتعلم',     v2024:80.75, v2025:81.50, subs:[
    { id:'learnassess', name:'تقويم التعلم', v:82.75 },
    { id:'learnexp',    name:'بناء خبرات التعلم', v:76.75 }
  ]},
  learning:     { name:'نواتج التعلم',        v2024:78.50, v2025:78.50, subs:[
    { id:'achievement', name:'التحصيل التعليمي', v:80.25 },
    { id:'devsoc',      name:'التطور الشخصي والصحي والاجتماعي', v:86.25 }
  ]},
  environment:  { name:'البيئة المدرسية',     v2024:64.00, v2025:62.25, subs:[
    { id:'safety',      name:'الأمن والسلامة', v:79.25 },
    { id:'building',    name:'المبنى المدرسي', v:71.50 }
  ]}
};

/* الجداول التفصيلية (نماذج مقتضبة – ضع كل جدولك هنا) */
const detailed = {
  management: [
    {level:'ممتاز', perf:94.50, indicator:'تلتزم المدرسة بقواعد السلامة والانضباط وتتابع تطبيقها باستمرار.', improve:'تعزيز نشر القيم والقدوة وربطها بالشراكة المجتمعية.', evidence:'لوحات السلوك – تقارير الانضباط – منصة الانضباط', tag:'ok'},
    {level:'مرتفع', perf:90.25, indicator:'تعمل المدرسة على تهيئة بيئة مدرسية آمنة وتجهيزها.', improve:'تفعيل نظام تتبع صيانة مرافق المدرسة وتوثيق الأعمال.', evidence:'تقارير الصيانة – صور الأعمال – محاضر الإنجاز', tag:'ok'},
    {level:'جيد جدًا', perf:85.25, indicator:'تتابع المدرسة تنفيذ خطتها التشغيلية وتطورها.', improve:'تطوير لوحة متابعة إلكترونية أسبوعية لمؤشرات الإنجاز.', evidence:'سجلات تنفيذية – نماذج متابعة – تقارير أداء', tag:'ok'},
    {level:'جيد', perf:70.25, indicator:'تقل فاعلية تفعيل الأنظمة الداعمة للتحسين.', improve:'تصميم روزنامة رقمية ذكية وجدولة مهام الفرق.', evidence:'سجلات رقمية – تقارير تشغيلية – سجلات فريق', tag:'bad'}
  ],
  teaching: [
    {level:'ممتاز', perf:99.25, indicator:'تقدم المدرسة برامج إثرائية نوعية للمعلمين', improve:'استمرار التدريب وفق الاحتياجات المهنية وتوثيق أثره.', evidence:'خطط تدريب – نماذج تقييم الأثر – تقارير زيارات صفية', tag:'ok'},
    {level:'مرتفع', perf:93.25, indicator:'ينتقي المعلمون أدوات تقويم تحقق نواتج التعلم.', improve:'تحليل نتائج التقويم بشكل دوري ووضع خطط علاجية.', evidence:'سجلات تحليل نتائج – خطط علاج – أدوات تقويم', tag:'ok'},
    {level:'جيد', perf:76.75, indicator:'تحتاج المدرسة إلى تطوير التنوع في أساليب التعلم.', improve:'تصميم أنشطة تعلم نشطة ومهام أصيلة مرتبطة بالحياة.', evidence:'ملفات مشاريع – منتج تعلم – محاضر تقييم', tag:'bad'}
  ],
  learning: [
    {level:'ممتاز', perf:96.75, indicator:'يظهر المتعلمون اعتزازاً بقيمهم وهويتهم الوطنية.', improve:'تعزيز ربط الأنشطة بالقيم الوطنية عبر المنصات.', evidence:'منتجات طلابية – صور فعاليات – تقارير الهوية', tag:'ok'},
    {level:'جيد جدًا', perf:91.75, indicator:'يظهر المتعلمون اتجاهات إيجابية نحو ذواتهم.', improve:'تنفيذ برنامج «أنا أصلح» لتنمية الثقة بالنفس.', evidence:'صور برامج – تقارير تقييم – نتائج استبيانات', tag:'ok'},
    {level:'جيد', perf:82.94, indicator:'يحقق المتعلمون نتائج متفاوتة في الاختبارات.', improve:'تحليل النتائج المنخفضة ووضع خطط تحسين فردية.', evidence:'تحليل نتائج – خطط علاج – متابعة فردية', tag:'bad'}
  ],
  environment: [
    {level:'ممتاز', perf:97.50, indicator:'تعمل المدرسة على تهيئة وصيانة جميع مرافق المبنى.', improve:'استحداث سجل رقمي للصيانة الوقائية وتحديد خطة دورية.', evidence:'تقارير الصيانة – صور الأعمال – محاضر الإنجاز', tag:'ok'},
    {level:'جيد', perf:73.25, indicator:'تتلمَّس المدرسة ملاءمة بيئة التعلم للمتعلمين بشكل متوسط.', improve:'تطوير البيئة الصفية بالألوان التعليمية والجلـسات التفاعلية.', evidence:'صور الفصول – استبيانات رضا – تقارير إشرافية', tag:'bad'},
    {level:'متوسط', perf:62.50, indicator:'توفر المدرسة وسائل الإضاءة والتهوية بما يحقق بيئة صحية.', improve:'تحسين الإضاءة في الفصول القديمة وصيانة أجهزة التهوية.', evidence:'تقارير فنية – صور الصيانة – متابعة المرافق', tag:'bad'}
  ]
};

/* ===== التخزين المحلي للشواهد ===== */
const STORE='yaqoubi_evidence_1447';
const mem=JSON.parse(localStorage.getItem(STORE)||'{}');
function saveMem(){ localStorage.setItem(STORE, JSON.stringify(mem)); }

/* تجهيز قائمة الأسابيع */
const eviWeekSel=document.getElementById('eviWeek');
WEEKS.forEach(w=>{ const o=document.createElement('option'); o.value=w.id;o.textContent=w.name; eviWeekSel.appendChild(o); });

/* ========= رسم لوحة المجالات ========= */
function renderDashboard(){
  const dash=document.getElementById('dashboard'); dash.innerHTML='';
  Object.entries(fields).forEach(([key,f])=>{
    const lvl=levelOf(f.v2025);
    const card=document.createElement('div'); card.className='card'; card.id=`card-${key}`;
    card.innerHTML=`
      <h2>${f.name}</h2>
      <div class="kpi"><span>2024: ${fmt(f.v2024)}% → 2025: ${fmt(f.v2025)}%</span>
        <span class="badge" style="background:${lvl.color}22;color:${lvl.color}">${lvl.txt}</span></div>
      <div class="progress"><div class="bar" style="width:${Math.max(2,f.v2025)}%"></div></div>
      <div class="titleRow">
        <h3 class="small">اضغط لعرض التحليل التفصيلي</h3>
        <div class="donutWrap"><canvas id="donut-${key}" height="120"></canvas></div>
      </div>
      <div class="detail" id="detail-${key}"></div>
    `;
    card.addEventListener('click', (e)=>{
      // لا نغلق عند ضغط الأزرار داخل التفصيل
      if(e.target.closest('button') || e.target.closest('a') || e.target.closest('input') || e.target.closest('select')) return;
      toggleDetail(key);
    });
    dash.appendChild(card);

    // دائرة علوية فقط
    const ctx=document.getElementById(`donut-${key}`).getContext('2d');
    new Chart(ctx,{type:'doughnut',
      data:{labels:f.subs.map(s=>s.name),datasets:[{data:f.subs.map(s=>s.v),backgroundColor:['#2aa897','#5d9ed6','#f1ad5b','#7ac6b7','#91a7ff','#a5d8a6']}]},
      options:{plugins:{legend:{display:false}},cutout:'70%'}
    });
  });
}

/* ======= فتح تفاصيل المجال ======= */
function toggleDetail(key){
  const dash=document.getElementById('dashboard');
  Array.from(dash.children).forEach(c=>{ if(c.id!==`card-${key}`) c.style.display='none'; });
  const f=fields[key]; const box=document.getElementById(`detail-${key}`);
  const open=box.style.display==='block';
  if(open){ box.style.display='none'; Array.from(dash.children).forEach(c=>c.style.display=''); return; }

  // عنوان وملخص ودونت علوية (الموجودة بالفعل أعلى البطاقة)
  // الشبكة الصغيرة للبطاقات الفرعية (صغّرت الدوائر كي تكون منسّقة)
  const subsHtml = f.subs.map(s=>`
    <div class="subCard">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>${s.name}</strong>
        <span class="badge" style="background:${levelOf(s.v).color}22;color:${levelOf(s.v).color}">${fmt(s.v)}%</span>
      </div>
      <div class="small">مستوى المؤشر الفرعي لهذا المجال</div>
    </div>`).join('');

  // جدول المجال التفصيلي
  const rows = (detailed[key]||[]).map((r,i)=>{
    const rowCls = r.tag==='bad' ? 'row-bad' : (r.tag==='ok' ? 'row-ok':'');
    const rowKey = `${key}::${i}`;
    const evis = (mem[rowKey]||[]).map((e,j)=>(
      `<div class="small">• ${e.hijri} – ${e.text} — <a href="${e.link}" target="_blank">ملف الشاهد</a></div>`
    )).join('');
    return `<tr class="${rowCls}">
      <td class="level">${r.level}</td>
      <td>${fmt(r.perf)}%</td>
      <td>${r.indicator}</td>
      <td>${r.improve}</td>
      <td>
        <div>${r.evidence}</div>
        ${evis?`<div style="margin-top:6px">${evis}</div>`:''}
        <div class="actionsRow">
          <button class="btn light" onclick="openEvidence('${key}',${i})">إضافة شاهد +</button>
          <button class="btn" onclick="openFieldReport('${key}')">تقرير المجال PDF</button>
          <button class="btn" onclick="openFieldPlan('${key}')">خطة تحسين المجال PDF</button>
        </div>
      </td>
    </tr>`;
  }).join('');

  box.innerHTML=`
    <div class="subgrid">${subsHtml}</div>
    <div class="tableWrap">
      <table>
        <thead>
          <tr><th>المستوى</th><th>نسبة الأداء</th><th>المؤشر</th><th>مقترحات التحسين</th><th>الشواهد</th></tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
      <div class="actionsRow" style="justify-content:flex-end;margin-top:10px">
        <button class="btn light" onclick="resetView()">رجوع إلى جميع المجالات ↩︎</button>
      </div>
    </div>`;
  box.style.display='block';
}

function resetView(){
  const dash=document.getElementById('dashboard');
  Array.from(dash.children).forEach(c=>c.style.display='');
  document.querySelectorAll('.detail').forEach(d=>d.style.display='none');
}

/* ===== نافذة الشواهد ===== */
let currentEvi = { key:'', idx:0 };
function openEvidence(fieldKey, rowIdx){
  currentEvi={key:fieldKey, idx:rowIdx};
  document.getElementById('eviOwner').value = `${fields[fieldKey].name} — بند ${rowIdx+1}`;
  document.getElementById('eviText').value='';
  document.getElementById('eviHijri').value=todayHijri();
  document.getElementById('eviLink').value='';
  document.getElementById('eviTerm').value='الأول';
  document.getElementById('eviDay').value='الأحد';
  document.getElementById('eviWeek').value=WEEKS[2].id;
  document.getElementById('eviModal').style.display='flex';
}
function closeEvidence(){ document.getElementById('eviModal').style.display='none'; }

document.getElementById('eviClose').onclick=closeEvidence;
document.getElementById('eviCancel').onclick=closeEvidence;
document.getElementById('eviSave').onclick=function(){
  const text=document.getElementById('eviText').value.trim();
  const term=document.getElementById('eviTerm').value;
  const day=document.getElementById('eviDay').value;
  const week=document.getElementById('eviWeek').value;
  const hijri=document.getElementById('eviHijri').value.trim() || todayHijri();
  const link=document.getElementById('eviLink').value.trim();
  if(!text && !link){ alert('أدخل وصف الشاهد أو رابط الملف'); return; }

  const k=`${currentEvi.key}::${currentEvi.idx}`;
  mem[k]=mem[k]||[];
  mem[k].push({text,term,day,week,hijri,link,ts:Date.now()});
  saveMem();
  closeEvidence();
  // إعادة فتح التفصيل لتحديث القائمة
  toggleDetail(currentEvi.key); toggleDetail(currentEvi.key);
};

/* ======= تاريخ هجري ======= */
function todayHijri(){
  try{
    // أم القرى/التقويم الإسلامي
    const fmt=new Intl.DateTimeFormat('ar-SA-u-ca-islamic', {year:'numeric',month:'2-digit',day:'2-digit'});
    return fmt.format(new Date()).replace(/\s/g,'');
  }catch(e){ return '1447/--/--'; }
}

/* ===== توليد رأس التقرير/الخطة ===== */
function reportHeaderHTML(){
  return `
  <div style="display:grid;grid-template-columns:1fr 160px 1fr;align-items:center;gap:14px;margin-bottom:10px">
    <div style="text-align:left;line-height:1.6;font-weight:700;color:#0b7e88">
      <div>المملكة العربية السعودية</div>
      <div>وزارة التعليم</div>
      <div>الإدارة العامة للتعليم بالمنطقة الشرقية</div>
      <div>ثانوية اليعقوبي</div>
    </div>
    <div style="text-align:center"><img src="وزارة التعليم.png" alt="MoE" style="height:84px"/></div>
    <div style="text-align:right;font-weight:700">اليوم/التاريخ (هجري): ${todayHijri()}</div>
  </div>`;
}

/* ===== فتح نافذة وطباعة ===== */
function openDocWindow(title, contentHTML, filename){
  const w=window.open('', '_blank');
  if(!w){ alert('تعرّض هذه الصفحة: فضلاً اسمح بالنوافذ المنبثقة.'); return; }
  const docHTML=`
  <!DOCTYPE html><html lang="ar" dir="rtl">
  <head><meta charset="utf-8"/><title>${title}</title>
  <style>
    body{font-family:'Tajawal',sans-serif;margin:18px;background:#fff;color:#06353b}
    h2{margin:8px 0;color:#0b7e88}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    thead th{background:#0f6f79;color:#fff;padding:8px}
    td{padding:8px;border:1px solid #e7eff0;vertical-align:top}
    .row-ok{background:#e8fff5}.row-bad{background:#fff3f3}
    .btn{padding:8px 12px;border:1px solid #0b7e88;border-radius:8px;background:#0b7e88;color:#fff;cursor:pointer;margin-left:6px}
    .toolbar{position:sticky;top:0;background:#fff;padding:6px 0;margin:6px 0;border-bottom:1px dashed #e1ecec}
    @media print{.toolbar{display:none}}
  </style></head>
  <body>
    ${reportHeaderHTML()}
    ${contentHTML}
    <div class="toolbar no-print">
      <button class="btn" onclick="window.print()">طباعة</button>
      <button class="btn" onclick="window.close()">إغلاق</button>
    </div>
  </body></html>`;
  w.document.open(); w.document.write(docHTML); w.document.close();
}

/* ===== التقارير ===== */
function buildFieldReportHTML(key){
  const f=fields[key]; const lvl=levelOf(f.v2025);
  const list = (detailed[key]||[]).map((r,i)=>{
    const rowKey=`${key}::${i}`;
    const evis=(mem[rowKey]||[]).map(e=>`<div>• ${e.hijri} — ${e.text}${e.link?` — <a href='${e.link}' target='_blank'>ملف</a>`:''}</div>`).join('');
    const cls=r.tag==='bad'?'row-bad':(r.tag==='ok'?'row-ok':'');
    return `<tr class="${cls}"><td>${r.level}</td><td>${fmt(r.perf)}%</td><td>${r.indicator}</td><td>${r.improve}</td><td>${r.evidence}${evis?`<div style="margin-top:6px">${evis}</div>`:''}</td></tr>`;
  }).join('');
  return `
  <h2>تقرير المجال: ${f.name}</h2>
  <div>الأداء 2024: ${fmt(f.v2024)}% — الأداء 2025: ${fmt(f.v2025)}% — المستوى: ${lvl.txt}</div>
  <table><thead><tr><th>المستوى</th><th>نسبة الأداء</th><th>المؤشر</th><th>مقترحات التحسين</th><th>الشواهد</th></tr></thead>
  <tbody>${list}</tbody></table>`;
}
function buildFieldPlanHTML(key){
  // استنباط إجراءات مختصرة من الجداول
  const rows=(detailed[key]||[]).map((r,i)=>({
    action:r.improve, week:WEEKS[2].id, kpi:r.indicator.slice(0,60)+'…', ev:r.evidence
  }));
  const tr=rows.map(r=>`<tr><td>${r.action}</td><td>${r.week}</td><td>${r.kpi}</td><td>${r.ev}</td></tr>`).join('');
  return `<h2>خطة تحسين المجال: ${fields[key].name}</h2>
  <table><thead><tr><th>الإجراء</th><th>الأسبوع (هجري)</th><th>المؤشر</th><th>الشواهد</th></tr></thead><tbody>${tr}</tbody></table>`;
}
async function openFieldReport(key){ openDocWindow('تقرير المجال', buildFieldReportHTML(key), `report_${key}.pdf`); }
async function openFieldPlan(key){ openDocWindow('خطة تحسين المجال', buildFieldPlanHTML(key), `plan_${key}.pdf`); }

/* ===== تقارير/خطط شاملة ===== */
function buildComprehensive(kind){
  const title=(kind==='plan')?'الخطة التحسينية الشاملة — ثانوية اليعقوبي':'التقرير الشامل — ثانوية اليعقوبي';
  const list=Object.keys(fields).map(k=>`<li><strong>${fields[k].name}:</strong> 2024 ${fmt(fields[k].v2024)}% → 2025 ${fmt(fields[k].v2025)}%</li>`).join('');
  const block = (kind==='plan')
    ? `<table><thead><tr><th>المجال</th><th>أبرز الإجراءات</th></tr></thead><tbody>${
        Object.keys(fields).map(k=>`<tr><td>${fields[k].name}</td><td>${(detailed[k]||[]).slice(0,3).map(r=>r.improve).join(' — ')}</td></tr>`).join('')
      }</tbody></table>`
    : `<ul>${list}</ul>`;
  return `<h2>${title}</h2>${block}`;
}
function exportComprehensive(kind){
  openDocWindow(kind==='plan'?'الخطة الشاملة':'التقرير الشامل', buildComprehensive(kind), (kind==='plan'?'plan_all':'report_all')+'.pdf');
}

/* روابط الأزرار */
document.getElementById('btnAnalyze').addEventListener('click', renderDashboard);
document.getElementById('btnFullReport').addEventListener('click', ()=>exportComprehensive('report'));
document.getElementById('btnFullPlan').addEventListener('click', ()=>exportComprehensive('plan'));

/* تشغيل أولي */
renderDashboard();
</script>
</body>
</html>
