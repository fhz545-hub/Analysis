<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ููุตุฉ ุงูุชุญููู ูุงูุชุญุณูู ุงููุคุณุณู โ ุซุงูููุฉ ุงููุนููุจู</title>

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --moe:#0b7e88; --ink:#02343b; --bg:#f5f8f8;
  --muted:#7a9aa0; --ok:#35bfa3; --warn:#ffb347; --bad:#ff4d4d;
  --card:#ffffff; --line:#e6efef;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:'Tajawal',sans-serif}

/* Header image */
.header{width:100%;height:260px;overflow:hidden;background:#013a40}
.header img{width:100%;height:100%;object-fit:cover;display:block}

/* Controls */
.controls{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;padding:14px}
.btn{background:var(--moe);color:#fff;border:0;border-radius:10px;padding:10px 18px;font-weight:700;cursor:pointer;box-shadow:0 6px 16px rgba(11,126,136,.2)}
.btn.secondary{background:#1f6e7a}
.btn:hover{filter:brightness(.95)}
.btn.icon{display:inline-flex;align-items:center;gap:8px}

/* Grid */
.container{max-width:1200px;margin:0 auto;padding:10px 14px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px}
.card{background:var(--card);border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.08);padding:16px;position:relative}
.card h2{margin:0 0 6px;color:var(--moe)}
.kpi{display:flex;justify-content:space-between;align-items:center;color:var(--muted)}
.progress{height:12px;background:#e6efef;border-radius:999px;overflow:hidden;margin:8px 0}
.bar{height:100%}
.badge{padding:2px 8px;border-radius:99px;background:#e6efef;color:#246;font-size:12px}
.small{font-size:12px;color:#567}
.actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}

/* Detail view */
.detail{display:none;margin-top:12px;border-top:1px dashed #e1ecec;padding-top:10px}
.detail h3{margin:0 0 8px}
.subgrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:14px}
.sub{background:#f7fbfb;border:1px solid #e6efef;border-radius:12px;padding:12px}
.sub .hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.levelTag{font-weight:700;color:#345}

/* Evidence */
.evi{display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-top:8px}
.evi input[type=text], .evi select{border:1px solid #d7e7e7;border-radius:8px;padding:6px}
.link{color:#0b7e88;text-decoration:none}
.link:hover{text-decoration:underline}

/* Modal (evidence preview / add) */
.modal{position:fixed;inset:0;background:rgba(2,52,59,.55);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:9999}
.modal .sheet{width:min(860px,92vw);max-height:90vh;overflow:auto;background:#fff;border-radius:14px;box-shadow:0 16px 40px rgba(0,0,0,.35);padding:16px;position:relative}
.modal .close{position:absolute;top:10px;left:10px;border:0;background:#e8eff0;color:#034;padding:6px 10px;border-radius:8px;cursor:pointer;font-weight:700}

/* Footer */
.footer{padding:16px;text-align:center;color:#7a9aa0}

/* report/plan tab (A4) */
@media print { .no-print{display:none} }
</style>
</head>
<body>

<!-- Header image only (ุถุน ูููู ุจุงุณู logo.png ูู ููุณ ุงููุฌูุฏ) -->
<div class="header"><img src="logo.png" alt="Header"></div>

<div class="controls">
  <button class="btn" id="btnAnalyze">๐ ุชุญููู ุดุงูู</button>
  <button class="btn secondary" id="btnFullReport">๐ ุชูุฑูุฑ ุดุงูู</button>
  <button class="btn secondary" id="btnFullPlan">๐๏ธ ุฎุทุฉ ุชุญุณูู ุดุงููุฉ</button>
</div>

<div class="container">
  <div id="dashboard" class="grid"></div>
</div>

<!-- Evidence modal -->
<div class="modal" id="eviModal">
  <div class="sheet" id="eviSheet">
    <button class="close" onclick="hideModal()">โ ุฅุบูุงู</button>
    <h3 style="margin-top:0;color:#0b7e88">ุฅุถุงูุฉ/ุงุณุชุนุฑุงุถ ุงูุดูุงูุฏ</h3>
    <div id="eviBody"></div>
  </div>
</div>

<div class="footer">ยฉ 1447 ูู โ ุซุงูููุฉ ุงููุนููุจู โ ููุตุฉ ุงูุชุญููู ูุงูุชุญุณูู ุงููุคุณุณู</div>

<script>
/* ========== ุฅุนุฏุงุฏุงุช ุนุงูุฉ ========== */
const STORE = 'yaqoubi_improve_1447';
const mem   = JSON.parse(localStorage.getItem(STORE)||'{}');
function saveMem(){ localStorage.setItem(STORE, JSON.stringify(mem)); }
function todayHijri(){
  try{
    const fmt = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', {year:'numeric', month:'numeric', day:'numeric'});
    return fmt.format(new Date());
  }catch(e){ return '1447/โ/โ'; }
}
const levelOf = v => (v>=90?{txt:'ุชูููุฒ',color:'#10b981'}:v>=75?{txt:'ุชูุฏูู',color:'#35bfa3'}:v>=50?{txt:'ุงูุทูุงู',color:'#ffb347'}:{txt:'ุชููุฆุฉ',color:'#ff4d4d'});
const fmt = n => Number(n).toFixed(2);

/* ========== ุชูููู (ูุฌุฑู) ูุฎุชุตุฑ ููุฑุจุท ุงูุฒููู ========== */
const calendarHijri = [
  { h:'1447/02/18', label:'ุนูุฏุฉ ุงูููุฆุฉ ุงูุฅุฏุงุฑูุฉ' },
  { h:'1447/02/23', label:'ุนูุฏุฉ ุงููุนูููู' },
  { h:'1447/03/01', label:'ุจุฏุงูุฉ ุงูุนุงู ุงูุฏุฑุงุณู' },
  { h:'1447/04/01', label:'ุฅุฌุงุฒุฉ ุงูููู ุงููุทูู' },
  { h:'1447/06/20', label:'ุฅุฌุงุฒุฉ ุฅุถุงููุฉ' },
  { h:'1447/07/20', label:'ุฅุฌุงุฒุฉ ููุชุตู ุงูุนุงู' },
  { h:'1447/09/05', label:'ููู ุงูุชุฃุณูุณ' },
  { h:'1447/09/17', label:'ุจุฏุงูุฉ ุฅุฌุงุฒุฉ ุงููุทุฑ' },
  { h:'1447/12/05', label:'ุจุฏุงูุฉ ุฅุฌุงุฒุฉ ุงูุฃุถุญู' },
];

/* ========== ุจูุงูุงุช ุงููุฌุงูุงุช + ุชูุตูู ุงููุณุชููุงุช/ุงููุคุดุฑุงุช ==========
   โ ุงูููู ูุฃุฎูุฐุฉ ููููููุฉ ุจุงูุญุฏ ุงูุฃุฏูู ูุชุนูู ููุฑูุง.
   โ ุฒูุฏ ุงููุคุดุฑุงุช ููุง ุชุดุงุก ุนูู ููุณ ุงููุณู. */
const fields = {
  management: {
    name:'ุงูุฅุฏุงุฑุฉ ุงููุฏุฑุณูุฉ', v2024:75.50, v2025:75.50,
    subs:[
      {code:'1-1-1-1', title:'ุชุถุน ุงููุฏุฑุณุฉ ุฎุทุฉ ุชุดุบูููุฉ ูุชูุงููุฉ ุงูุนูุงุตุฑ ููู ุฃูุฏุงู ุชุทููุฑูุฉ ูุญุฏุฏุฉ', score:81.75, level:'ุชูุฏูู',
        improve:['ููุญุฉ ูุชุงุจุนุฉ ุฃุณุจูุนูุฉ ููุฎุทุฉ ุงูุชุดุบูููุฉ','ูุคุดุฑุงุช ุฅูุฌุงุฒ ููู ูุณู','ุงุฌุชูุงุน ุชุญุณููู ุดูุฑู'],
      },
      {code:'2-1-1-1', title:'ูุชุงุฆุฌ ุงููุฏุฑุณุฉ ุชูููุฏ ุชูููุฐูุง ุฎุทุชูุง ูุชุทููุฑูุง ุจูุง ูุถูู ุชุญููู ุฃูุฏุงููุง', score:72.00, level:'ุงูุทูุงู',
        improve:['ุชุบุฐูุฉ ุฑุงุฌุนุฉ ุฏูุฑูุฉ','ุฅุนุงุฏุฉ ุชูุฒูุน ุงูุฃุฏูุงุฑ','ุชูุงุฑูุฑ ุฅูุฌุงุฒ ูุฎุชุตุฑุฉ'],
      },
      {code:'1-4-1-1', title:'ุชุดุฌุน ุงููุฏุฑุณุฉ ููุณูุจููุง ููุญุตูู ุนูู ุงูุฑุฎุตุฉ ุงูููููุฉ', score:63.00, level:'ุชููุฆุฉ',
        improve:['ุจุฑุงูุฌ ุฏุนู ุงูุฑุฎุตุฉ','ุชุญููุฒุงุช','ุฎุทุท ูุฑุฏูุฉ'],
      },
      {code:'4-1-4-1', title:'ุชููุฐ ุงููุฏุฑุณุฉ ุฎุทุฉ ูุชุญุณูู ูุชุงุฆุฌ ุงูุชูููู ุงููุฏุฑุณู', score:70.00, level:'ุงูุทูุงู',
        improve:['ุชุญููู ูุฌูุงุช','ุฅุฌุฑุงุกุงุช ูุตูุฑุฉ ุงูุฃุฌู','ูุชุงุจุนุฉ ุฃุณุจูุนูุฉ'],
      },
    ]
  },
  teaching: {
    name:'ุงูุชุนููู ูุงูุชุนูู', v2024:80.75, v2025:81.50,
    subs:[
      {code:'1-1-1-2', title:'ุชููุฑ ุงููุฏุฑุณุฉ ูุฑุตูุง ูุชูุงูุฆุฉ ููุชุนูู ูุฐูู ุงูุฅุนุงูุฉ ูุงูููููุจูู', score:76.75, level:'ุชูุฏูู',
        improve:['ุชูููู ุงูุฃูุดุทุฉ','ูููุงุช ุชูุฏู','ูุชุงุจุนุฉ ูุฑูุฉ'],
      },
      {code:'2-1-1-2', title:'ุชุฏุนู ุงููุฏุฑุณุฉ ุจูุงุก ุงููููุฌ ูุชุญููู ููุงุชุฌ ุงูุชุนูู ุงููุณุชูุฏูุฉ', score:97.75, level:'ุชูููุฒ',
        improve:['ุฎุฑุงุฆุท ุชุนูู','ููููุฉ ุงูุชูููู ุงูุจูุงุฆู','ูุตุงุฏุฑ ุฅุซุฑุงุฆูุฉ'],
      },
      {code:'4-1-1-2', title:'ุชูุนูู ุงููุฏุฑุณุฉ ุงูุชุนูู ุงูุฅููุชุฑููู', score:79.25, level:'ุชูุฏูู',
        improve:['ุญุตุต ูุชุฒุงููุฉ','ูููุงุช ุฑูููุฉ','ุชูุงุฑูุฑ ููุตุฉ'],
      }
    ]
  },
  learning: {
    name:'ููุงุชุฌ ุงูุชุนูู', v2024:78.50, v2025:78.50,
    subs:[
      {code:'1-1-1-3', title:'ูุญูู ุงููุชุนูููู ูุชุงุฆุฌ ูุชูุฏูุฉ ูู ุงูุงุฎุชุจุงุฑุงุช ุงูุชุญุตูููุฉ', score:79.04, level:'ุชูุฏูู',
        improve:['ุจููู ุฃุณุฆูุฉ','ุงุฎุชุจุงุฑุงุช ูุตูุฑุฉ ุฃุณุจูุนูุฉ','ุชุญููู ููุฑู'],
      },
      {code:'2-1-1-3', title:'ูุญูู ุงููุชุนูููู ูุชุงุฆุฌ ูุชูุฏูุฉ ูู ุงูุงุฎุชุจุงุฑุงุช ุงููุทููุฉ', score:82.94, level:'ุชูุฏูู',
        improve:['ููุงุฐุฌ ูุทููุฉ','ูุญุงูุงุฉ','ุชุฏุฑูุจ ุนูู ููุงุฑุงุช ุงูุงุฎุชุจุงุฑ'],
      },
      {code:'7-1-2-3', title:'ูุธูุฑ ุงููุชุนูููู ุงุนุชุฒุงุฒุงู ุจููููู ููููุชูู ุงููุทููุฉ', score:91.75, level:'ุชูููุฒ',
        improve:['ูุดุงุฑูุน ูุทููุฉ','ููุงุณุจุงุช ูุทููุฉ','ุฅูุชุงุฌุงุช ุทูุงุจูุฉ'],
      }
    ]
  },
  environment: {
    name:'ุงูุจูุฆุฉ ุงููุฏุฑุณูุฉ', v2024:64.00, v2025:62.25,
    subs:[
      {code:'1-1-1-4', title:'ุชูุธูู ูุจูู ุงููุฏุฑุณุฉ ููุงุฆู ูุฃุนุฏุงุฏ ุงููุนูููู ูุงููุฑุญูุฉ', score:73.25, level:'ุงูุทูุงู',
        improve:['ุฅุนุงุฏุฉ ุชูุฒูุน ุงููุงุนุงุช','ูุฎุงุฑุฌ ุทูุงุฑุฆ','ุฎุฑุงุฆุท ุณูุงูุฉ'],
      },
      {code:'1-2-4-4', title:'ุชููุฑ ุงููุฏุฑุณุฉ ูุฏุงุฎู ููุฎุงุฑุฌ ุขููุฉ ููุชุทูุจุงุช ุงูุฃูู ูุงูุณูุงูุฉ', score:64.00, level:'ุชููุฆุฉ',
        improve:['ูุณุงุฑุงุช ุฅุฎูุงุก','ููุญุงุช ุณูุงูุฉ','ุญูุงุฆุจ ุฅุณุนุงู'],
      },
      {code:'3-1-2-4', title:'ุชุญุงูุธ ุงููุฏุฑุณุฉ ุนูู ูุธุงูุฉ ุงููุจูู', score:79.50, level:'ุชูุฏูู',
        improve:['ุฌุฏุงูู ูุธุงูุฉ','ูุฑุงูุจุฉ ููููุฉ','ุชูุนูุฉ ุณููููุฉ'],
      }
    ]
  }
};

/* ========== ุฑุณู ููุญุฉ ุงููุฌุงูุงุช ========== */
function renderDashboard(){
  const dash = document.getElementById('dashboard'); dash.innerHTML='';
  Object.entries(fields).forEach(([key,f])=>{
    const lvl=levelOf(f.v2025);
    const card=document.createElement('div'); card.className='card'; card.id=`card-${key}`;
    card.innerHTML=`
      <h2>${f.name}</h2>
      <div class="kpi"><span>2024: ${fmt(f.v2024)}% โ 2025: ${fmt(f.v2025)}%</span><span class="badge">${lvl.txt}</span></div>
      <div class="progress"><div class="bar" style="width:${Math.max(2,f.v2025)}%;background:${lvl.color}"></div></div>
      <canvas id="donut-${key}" height="150"></canvas>
      <div class="actions">
        <button class="btn" onclick="toggleDetail('${key}')">ุนุฑุถ ุงูุชูุตูู</button>
        <button class="btn secondary" onclick="openFieldReport('${key}')">๐งพ ุชูุฑูุฑ ุงููุฌุงู</button>
        <button class="btn secondary" onclick="openFieldPlan('${key}')">๐ก ุฎุทุฉ ุชุญุณูู ุงููุฌุงู</button>
      </div>
      <div class="detail" id="detail-${key}"></div>
    `;
    dash.appendChild(card);

    const ctx = document.getElementById(`donut-${key}`).getContext('2d');
    new Chart(ctx,{type:'doughnut',
      data:{labels:['2024','2025'],datasets:[{data:[f.v2024,f.v2025],backgroundColor:['#dfecec',lvl.color]}]},
      options:{plugins:{legend:{position:'bottom'}},cutout:'65%'}
    });
  });
}

/* ========== ูุชุญ ุชูุงุตูู ุงููุฌุงู (ูุฎูู ุงูุจููุฉ ูููุธูุฑ ุงูุชูุตูู ุงููุงูู) ========== */
function toggleDetail(key){
  const dash=document.getElementById('dashboard');
  Array.from(dash.children).forEach(c=>{ if(c.id!==`card-${key}`) c.style.display='none'; });
  const f=fields[key];
  const box=document.getElementById(`detail-${key}`);
  const opened=box.style.display==='block';
  if(opened){ resetView(); return; }

  // ุฅุฎูุงุก ุงูุฏุงุฆุฑุฉ ุงููุจูุฑุฉ ููุฐุง ุงููุฌุงู ูุชุญููููุง ููููู
  const donut = document.querySelector(`#card-${key} canvas`);
  if(donut){ donut.height=90; donut.style.marginTop='-4px'; }

  const rows=f.subs.map(s=>{
    const lvl = levelOf(s.score);
    const keyE = `${key}__${s.code}`;
    const evis = (mem.evidence?.[keyE]||[]).map(e=>(
      `<li class="small">โข ${e.week} โ ${e.text||''}${e.fileName?` โ <a class="link" href="${e.fileUrl||'#'}" target="_blank">${e.fileName}</a>`:''}</li>`
    )).join('');
    return `
      <div class="sub">
        <div class="hdr">
          <div><span class="levelTag">${s.code}</span> โ <strong>${s.title}</strong></div>
          <span class="badge" style="background:${lvl.color}22;color:${lvl.color}">${lvl.txt} โ ${fmt(s.score)}%</span>
        </div>
        <div class="small" style="margin:6px 0 10px;border-top:1px dashed var(--line);padding-top:8px">
          ููุชุฑุญุงุช ุงูุชุญุณูู: ${s.improve.join(' โข ')}
        </div>
        <div class="evi">
          <input type="text" id="in-${key}-${s.code}" placeholder="ุฃุถู ุดุงูุฏ/ุฅุฌุฑุงุก ูุฎุชุตุฑโฆ"/>
          <select id="wk-${key}-${s.code}">
            ${calendarHijri.map(c=>`<option value="${c.h}">${c.h} โ ${c.label}</option>`).join('')}
          </select>
          <input type="file" id="file-${key}-${s.code}" accept="application/pdf,image/*"/>
          <button class="btn" onclick="addEvidence('${key}','${s.code}')">ุฅุถุงูุฉ ุดุงูุฏ</button>
          <button class="btn secondary" onclick="showEvidence('${key}','${s.code}','${s.title}')">ุงุณุชุนุฑุงุถ ุงูุดูุงูุฏ</button>
        </div>
        <ul id="evilist-${key}-${s.code}" style="margin:8px 0 0">${evis || '<li class="small">ูุง ููุฌุฏ ุดูุงูุฏ ุจุนุฏ</li>'}</ul>
      </div>`;
  }).join('');

  box.innerHTML=`
    <h3 style="color:#0b7e88">ุงูุชุญููู ุงูุชูุตููู โ ${f.name}</h3>
    <div class="subgrid">${rows}</div>
    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" onclick="openFieldReport('${key}')">๐งพ ุชูุฑูุฑ ุงููุฌุงู</button>
      <button class="btn" onclick="openFieldPlan('${key}')">๐ก ุฎุทุฉ ุชุญุณูู ุงููุฌุงู</button>
      <button class="btn secondary" onclick="resetView()">๐ ุฑุฌูุน ูุฌููุน ุงููุฌุงูุงุช</button>
    </div>
  `;
  box.style.display='block';
}
function resetView(){
  const dash=document.getElementById('dashboard');
  Array.from(dash.children).forEach(c=>c.style.display='');
  document.querySelectorAll('.detail').forEach(d=>d.style.display='none');
}

/* ========== ุงูุดูุงูุฏ (ุญูุธ/ุงุณุชุนุฑุงุถ) ========== */
async function addEvidence(fieldKey, code){
  const textEl=document.getElementById(`in-${fieldKey}-${code}`);
  const text=textEl?textEl.value.trim():'';
  const week=document.getElementById(`wk-${fieldKey}-${code}`)?.value || '';
  const fileInput=document.getElementById(`file-${fieldKey}-${code}`);

  let fileName='', fileUrl='', fileData='';
  if(fileInput?.files?.[0]){
    const f=fileInput.files[0]; fileName=f.name;
    fileData=await new Promise((res,rej)=>{const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f);});
    try{ fileUrl=URL.createObjectURL(fileInput.files[0]); }catch(e){}
  }
  if(!text && !fileName) return;

  mem.evidence = mem.evidence || {};
  const k = `${fieldKey}__${code}`;
  mem.evidence[k] = mem.evidence[k] || [];
  mem.evidence[k].push({text,week,fileName,fileUrl,fileData,ts:Date.now()});
  saveMem();

  const ul=document.getElementById(`evilist-${fieldKey}-${code}`);
  if(ul){
    const li=document.createElement('li'); li.className='small';
    li.innerHTML=`โข ${week} โ ${text||''} ${fileName?`โ <a class='link' href='${fileUrl||"#"}' target='_blank'>${fileName}</a>`:''}`;
    ul.appendChild(li);
  }
  if(textEl) textEl.value='';
  if(fileInput) fileInput.value='';
}
function showEvidence(fieldKey, code, title){
  const list = mem.evidence?.[`${fieldKey}__${code}`]||[];
  const box  = document.getElementById('eviBody');
  box.innerHTML = `
    <div class="small" style="margin-bottom:8px;color:#0b7e88"><strong>ุงููุฌุงู:</strong> ${fields[fieldKey].name} โ <strong>ุงููุคุดุฑ:</strong> ${title} โ <strong>ุงูููุฏ:</strong> ${code}</div>
    ${list.length?'<ol style="padding-right:18px">'+list.map(e=>`
      <li style="margin:6px 0">
        ${e.week} โ ${e.text||''}
        ${e.fileName?` โ <a class="link" href="${e.fileUrl||'#'}" target="_blank">${e.fileName}</a>`:''}
      </li>`).join('')+'</ol>':'<div class="small">ูุง ุชูุฌุฏ ุดูุงูุฏ ุจุนุฏ.</div>'}
    <div style="margin-top:10px" class="no-print">
      <button class="btn" onclick="window.print()">๐จ๏ธ ุทุจุงุนุฉ</button>
    </div>
  `;
  document.getElementById('eviModal').style.display='flex';
}
function hideModal(){ document.getElementById('eviModal').style.display='none'; }

/* ========== ุชุจููุจ ุฌุฏูุฏ ูุทุจุงุนุฉ ุชูุฑูุฑ/ุฎุทุฉ ========== */
function openPrintTab(title, bodyHTML){
  const w = window.open('', '_blank');
  const hijri = todayHijri();
  w.document.write(`
    <!doctype html><html lang="ar" dir="rtl"><head>
    <meta charset="utf-8"><title>${title}</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
      body{font-family:'Tajawal',sans-serif;color:#123;margin:18px}
      .header{border:1px solid #e9f1f1;border-radius:12px;padding:10px 12px;margin-bottom:12px}
      .rwrap{display:grid;grid-template-columns:1fr 140px 1fr;align-items:center;gap:14px}
      .left{text-align:left}.center{text-align:center}.right{text-align:right}
      .stack{line-height:1.6;font-weight:700;color:#0b7e88}
      img.logo{height:78px}
      h1{margin:10px 0 12px;color:#0b7e88;text-align:center}
      table{width:100%;border-collapse:collapse}
      th,td{border:1px solid #ddd;padding:6px}
      .muted{color:#5b7080}
      .printbar{display:flex;gap:8px;justify-content:center;margin:8px 0 16px}
      @media print{.printbar{display:none}}
    </style></head><body>
      <div class="header">
        <div class="rwrap">
          <div class="left">
            <div class="stack" style="text-align:center">
              <div>ุงูููููุฉ ุงูุนุฑุจูุฉ ุงูุณุนูุฏูุฉ</div>
              <div>ูุฒุงุฑุฉ ุงูุชุนููู</div>
              <div>ุงูุฅุฏุงุฑุฉ ุงูุนุงูุฉ ููุชุนููู ุจุงูููุทูุฉ ุงูุดุฑููุฉ</div>
              <div>ูุฏุฑุณุฉ ุงููุนููุจู ุงูุซุงูููุฉ</div>
            </div>
          </div>
          <div class="center"><img class="logo" src="ูุฒุงุฑุฉ ุงูุชุนููู.png"></div>
          <div class="right"><strong>${hijri}</strong></div>
        </div>
      </div>
      <h1>${title}</h1>
      <div class="printbar"><button onclick="window.print()">๐จ๏ธ ุทุจุงุนุฉ/ุญูุธ PDF</button></div>
      ${bodyHTML}
    </body></html>
  `);
  w.document.close();
}

/* ========== ุจูุงุก ูุญุชูู ุชูุฑูุฑ/ุฎุทุฉ ุงููุฌุงู/ุงูุดุงูู ========== */
function fieldSectionHTML(key){
  const f=fields[key];
  const items=f.subs.map(s=>{
    const lvl=levelOf(s.score);
    const k = `${key}__${s.code}`;
    const evis=(mem.evidence?.[k]||[]).map(e=>`${e.week} โ ${e.text||''}${e.fileName?` โ ${e.fileName}`:''}`).join(' | ') || 'โ';
    return `<tr>
      <td>${s.code}</td>
      <td>${s.title}</td>
      <td>${fmt(s.score)}% (${lvl.txt})</td>
      <td>${evis}</td>
      <td>${s.improve.join('ุ ')}</td>
    </tr>`;
  }).join('');
  return `
    <h2 style="color:#0b7e88;margin:10px 0">${f.name}</h2>
    <div class="muted" style="margin-bottom:6px">ุงูุฃุฏุงุก: 2024 ${fmt(f.v2024)}% โ 2025 ${fmt(f.v2025)}%</div>
    <table>
      <thead><tr><th>ุงูููุฏ</th><th>ุงููุคุดุฑ</th><th>ุงูุฏุฑุฌุฉ</th><th>ุงูุดูุงูุฏ</th><th>ููุชุฑุญุงุช ุงูุชุญุณูู</th></tr></thead>
      <tbody>${items}</tbody>
    </table>
  `;
}
function openFieldReport(key){
  const html = fieldSectionHTML(key);
  openPrintTab('ุชูุฑูุฑ ุงููุฌุงู โ '+fields[key].name, html);
}
function openFieldPlan(key){
  const f=fields[key];
  const rows=f.subs.map(s=>{
    const target = 90;
    const gap = Math.max(0, target - s.score).toFixed(2);
    const week = calendarHijri[2]?.h || todayHijri();
    return `<tr>
      <td>${s.title}</td>
      <td>${s.code}</td>
      <td>${gap}%</td>
      <td>${week}</td>
      <td>${s.improve.join('ุ ')}</td>
      <td>ุดูุงูุฏ ุงูุชูููุฐ (ุฑูุงุจุท/ููุงุฐุฌ/ุตูุฑ)</td>
    </tr>`;
  }).join('');
  const html = `
    <div class="muted" style="margin-bottom:6px">ุงููุฏู ุงูุนุงู: ุจููุบ ูุณุชูู โุชูููุฒ โฅ 90%โ ูู ูุฐุง ุงููุฌุงู.</div>
    <table>
      <thead><tr><th>ุงูุฅุฌุฑุงุก</th><th>ุงูููุฏ</th><th>ูุฌูุฉ ุงููุคุดุฑ</th><th>ุงูุฅุทุงุฑ ุงูุฒููู (ูุฌุฑู)</th><th>ุฎุทูุงุช ุงูุชูููุฐ</th><th>ุงูุดูุงูุฏ ุงููุชููุนุฉ</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
  openPrintTab('ุฎุทุฉ ุชุญุณูู ุงููุฌุงู โ '+f.name, html);
}
function openFull(kind){
  const title = kind==='plan' ? 'ุงูุฎุทุฉ ุงูุชุญุณูููุฉ ุงูุดุงููุฉ โ ุซุงูููุฉ ุงููุนููุจู' : 'ุงูุชูุฑูุฑ ุงูุดุงูู โ ุซุงูููุฉ ุงููุนููุจู';
  const list = Object.keys(fields).map(k=>{
    const f=fields[k];
    return `<li><strong>${f.name}:</strong> 2024 ${fmt(f.v2024)}% โ 2025 ${fmt(f.v2025)}%</li>`;
  }).join('');
  const body = `<ul>${list}</ul>` + Object.keys(fields).map(k=>fieldSectionHTML(k)).join('<hr/>');
  openPrintTab(title, body);
}

/* ========== ุฑุจุท ุฃุฒุฑุงุฑ ุงููุงุฌูุฉ ========== */
document.getElementById('btnAnalyze').addEventListener('click', renderDashboard);
document.getElementById('btnFullReport').addEventListener('click', ()=>openFull('report'));
document.getElementById('btnFullPlan').addEventListener('click', ()=>openFull('plan'));

/* ุจุฏุงูุฉ ุงูุชุดุบูู */
renderDashboard();
</script>
</body>
</html>
