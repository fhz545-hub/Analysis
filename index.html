<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ù„ÙˆØ­Ø© Ù‚ÙŠØ§Ø¯Ø© Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙˆØ®Ø·Ø© Ø§Ù„ØªØ­Ø³ÙŠÙ† â€“ Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ Ø¨Ø§Ù„Ø®Ø¨Ø± (Ù¡Ù¤Ù¤Ù§Ù‡Ù€)</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800&display=swap" rel="stylesheet">
<!-- Ù…ÙƒØªØ¨Ø§Øª -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.worker.min.js"></script>
<script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment-hijri@2.3.1/moment-hijri.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<style>
:root{--moe:#0f7a66;--ink:#123b37;--muted:#5d7a75;--ring:#d6efe9;--lite:#e8f4f1;--grid:#f6fbfa;--bad:#e11d48;--warn:#f59e0b;--ok:#0ea5a0;--good:#107c68;--accent:#1d4ed8}
*{box-sizing:border-box}
body{font-family:'Tajawal',system-ui,Arial;background:linear-gradient(180deg,#fff 0%,#f7fbfa 100%);color:var(--ink);margin:0}
header{position:sticky;top:0;background:#fff;border-bottom:3px solid var(--moe);z-index:9}
.hdr{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:12px;padding:14px 18px}
.h-left{font-size:13px;color:var(--muted)}
.h-center{color:var(--moe);font-weight:800;font-size:20px;text-align:center}
.h-right{text-align:left}
.btn{background:var(--moe);color:#fff;border:none;border-radius:12px;padding:8px 14px;margin:2px 0 2px 6px;cursor:pointer;font-family:'Tajawal';font-weight:700}
.btn.ghost{background:#fff;color:var(--moe);border:1px solid var(--moe)}
.btn.warn{background:var(--warn)}
.btn.accent{background:var(--accent)}
.container{max-width:1300px;margin:auto;padding:18px}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
.card{background:#fff;border:1px solid var(--ring);border-radius:16px;box-shadow:0 6px 20px rgba(15,122,102,.06);padding:14px}
.card h3{margin:0 0 8px 0;color:var(--moe);font-size:18px}
.small{font-size:12px;color:#567}
.note{background:#f0fbf8;border:1px dashed var(--ring);padding:10px;border-radius:12px;color:#356}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border:1px solid var(--ring);padding:8px;text-align:right;vertical-align:top}
.table th{background:var(--lite);color:var(--moe)}
.kpis{grid-column:1/-1;display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.kpi{display:flex;flex-direction:column;align-items:center;padding:12px;border:1px solid var(--ring);border-radius:16px}
.kpi .ring{width:96px;height:96px}
.kpi .v{font-weight:800;font-size:20px}
.kpi .lbl{font-size:12px;color:#567;text-align:center}
.badge{padding:2px 8px;border-radius:999px;font-size:11px;color:#fff}
.bad{background:var(--bad)}.warn{background:var(--warn)}.ok{background:var(--ok)}.good{background:var(--good)}
.flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.controls{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.input{display:flex;flex-direction:column;gap:4px}
.input input,.input select,.input textarea{border:1px solid var(--ring);border-radius:12px;padding:8px}
.two{grid-column:1/-1;display:grid;grid-template-columns:2fr 1fr;gap:14px}
.pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--ring);background:#fff;font-size:12px;margin:2px}
.status{font-weight:800}
.tag{padding:2px 8px;border-radius:8px;background:#eef7f5;border:1px solid var(--ring);font-size:12px;margin-left:6px}
.footer{text-align:center;color:#567;font-size:13px;margin:22px 0}
@media (max-width:1100px){.kpis{grid-template-columns:repeat(2,1fr)}.two{grid-template-columns:1fr}.controls{grid-template-columns:1fr}}
.dropzone{border:2px dashed var(--ring);border-radius:16px;padding:16px 20px;min-width:260px;cursor:pointer;background:linear-gradient(180deg,#fff,#f7fbfa)}
.dropzone.on{background:#eef7f5}
.dropzone .dz-main{font-weight:800;color:var(--moe)}
.dropzone .dz-sub{color:#567}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:99}
.a4{width:794px;height:1123px;background:#fff;border-radius:12px;overflow:auto;box-shadow:0 20px 50px rgba(0,0,0,.25);padding:28px}
.a4 .govhdr{text-align:center;line-height:1.4;margin-bottom:12px}
.a4 h2{margin:6px 0 12px 0;color:var(--moe)}
.a4 .meta{display:flex;gap:12px;justify-content:center;font-size:12px;color:#555}
.a4 .seal{width:56px;height:56px;border-radius:50%;border:2px solid var(--moe);display:inline-block}
.modal .actions{display:flex;gap:8px;justify-content:center;margin-top:8px}
.hide-for-capture{visibility:hidden !important}
</style>
</head>
<body>
<header>
  <div class="hdr">
    <div class="h-left">ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ… â€“ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø¨Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø±Ù‚ÙŠØ© â€“ <strong>Ù‚Ø·Ø§Ø¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø¨Ø§Ù„Ø®Ø¨Ø±</strong></div>
    <div class="h-center">Ù„ÙˆØ­Ø© Ù‚ÙŠØ§Ø¯Ø© Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙˆØ®Ø·Ø© Ø§Ù„ØªØ­Ø³ÙŠÙ† â€“ <strong>Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ Ø¨Ø§Ù„Ø®Ø¨Ø±</strong></div>
    <div class="h-right">
      <button class="btn" id="btnPDF">ğŸ“„ Ø­ÙØ¸ PDF</button>
      <button class="btn ghost" id="btnReset">â™»ï¸ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·</button>
    </div>
  </div>
</header>

<main class="container">
  <!-- Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª -->
  <section class="card">
    <h3>Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„ (PDF / Excel / Word / CSV / ØµÙˆØ±)</h3>
    <div class="flex" style="justify-content:space-between;align-items:center">
      <label id="dropper" class="dropzone">
        <input id="fileInput" type="file" multiple accept=".pdf,.xlsx,.xls,.csv,.doc,.docx,.txt,image/*" hidden/>
        <div class="dz-main">ğŸ“ Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„ÙØ§Øª Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯</div>
        <div class="dz-sub small">PDF / Word / Excel / CSV / ØµÙˆØ±</div>
      </label>
      <div class="flex">
        <button class="btn" id="btnAnalyze">ğŸ” ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª</button>
        <button class="btn accent" id="btnAnalyzeEval">ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ</button>
        <button class="btn ghost" id="btnAnalyzeResults2">ğŸ§® ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ù‚Ø±Ø±Ø§Øª</button>
        <button class="btn ghost" id="btnResultsA4">ğŸ–¨ï¸ ØªÙ‚Ø±ÙŠØ± A4 â€“ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ù‚Ø±Ø±Ø§Øª</button>
        <button class="btn ghost" id="btnEvalA4">ğŸ–¨ï¸ ØªÙ‚Ø±ÙŠØ± A4 â€“ Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ</button>
        <button class="btn ghost" id="btnSample">â¬‡ï¸ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©</button>
      </div>
    </div>
    <div class="note">ØªØµÙ†ÙŠÙ Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙŠÙÙ‚Ø³Ù‘Ù… Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø¥Ù„Ù‰ Ø£Ø±Ø¨Ø¹ ÙØ¦Ø§Øª: <strong>Ø¶Ø¹ÙŠÙ &lt; 60</strong> Â· <strong>Ø¬ÙŠØ¯ 60â€“79</strong> Â· <strong>Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§ 80â€“89</strong> Â· <strong>Ù…Ù…ØªØ§Ø² 90â€“100</strong>. ÙƒÙ…Ø§ ØªÙÙˆÙØ³ÙÙ… Ø§Ù„Ù…Ø§Ø¯Ø© "<strong>ØªØ­ØªØ§Ø¬ Ù†Ø¸Ø± ÙÙŠ Ø§Ù„ÙØ±ÙˆÙ‚ Ø§Ù„ÙØ±Ø¯ÙŠØ©</strong>" Ø¥Ø°Ø§ ØªØ¬Ø§ÙˆØ²Øª Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ù…ØªØ§Ø² <strong>95Ùª</strong> (Ø§Ø­ØªÙ…Ø§Ù„ Ø¶Ø¹Ù Ø§Ù„ØªÙ…Ø§ÙŠØ²/Ø§Ù„ØªØ­Ø¯ÙŠ). ØµÙŠØºØ© Ø£Ø¹Ù…Ø¯Ø© Ù…Ù‚ØªØ±Ø­Ø©: <strong>Ø§Ù„ØµÙ</strong> | <strong>Ø§Ù„Ù…Ø§Ø¯Ø©</strong> | <strong>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</strong> | <strong>Ø§Ù„Ø¯Ø±Ø¬Ø©</strong> (0â€“100).</div>
  </section>

  <!-- Ø¨Ø·Ø§Ù‚Ø© Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ -->
  <section class=\"card\" id=\"evalSection\" style=\"display:none\">
    <h3>Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ (2024 / 2025)</h3>
    <table class=\"table\" id=\"evalTable\">
      <thead>
        <tr>
          <th>Ø§Ù„Ù…Ø¬Ø§Ù„ / Ø§Ù„Ù…Ø¤Ø´Ø±</th>
          <th>2024</th>
          <th>2025</th>
          <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</th>
        </tr>
      </thead>
      <tbody id=\"evalBody\"></tbody>
    </table>
  </section>

  <!-- Ù…Ø¤Ø´Ø±Ø§Øª Ø¹Ø§Ù…Ø© -->
  <section class="kpis" id="kpiGrid"></section>

  <section class="two">
    <div class="card">
      <div class="flex" style="justify-content:space-between;align-items:center">
        <h3>Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø­Ø³Ø¨ Ø§Ù„ØµÙ/Ø§Ù„Ù…Ø§Ø¯Ø©</h3>
        <div class="flex">
          <label class="small">Ø§Ù„ØµÙ:</label>
          <select id="gradeSelect">
            <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</option>
            <option value="Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ">Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ</option>
            <option value="Ø«Ø§Ù†ÙŠ Ø«Ø§Ù†ÙˆÙŠ">Ø«Ø§Ù†ÙŠ Ø«Ø§Ù†ÙˆÙŠ</option>
            <option value="Ø«Ø§Ù„Ø« Ø«Ø§Ù†ÙˆÙŠ">Ø«Ø§Ù„Ø« Ø«Ø§Ù†ÙˆÙŠ</option>
          </select>
          <label class="small">Ø§Ù„Ù…Ø§Ø¯Ø©:</label>
          <select id="subjectSelect"><option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯</option></select>
          <label class="small">Ù†Ù…Ø· Ø§Ù„Ø±Ø³Ù…:</label>
          <select id="chartType">
            <option value="bar">Ø£Ø¹Ù…Ø¯Ø© (Ù…ÙˆØ§Ø¯)</option>
            <option value="radar">Ø±Ø§Ø¯Ø§Ø± (ØªØµÙ†ÙŠÙ Ø§Ù„Ø£Ø¯Ø§Ø¡)</option>
          </select>
        </div>
      </div>
      <canvas id="mainChart" height="260"></canvas>
      <canvas id="radarChart" height="260" style="display:none"></canvas>
    </div>
    <div class="card">
      <h3>Ù…ÙØ±Ø´Ù‘Ø­ Ø³Ø±ÙŠØ¹</h3>
      <div class="controls">
        <div class="input"><label>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ø¹ÙŠÙ (%)</label><input type="number" id="minWeak" value="20" min="0" max="100"></div>
        <div class="input"><label>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© (Ù…ØªÙˆØ³Ø· &lt;)</label><input type="number" id="avgCut" value="75" min="0" max="100"></div>
      </div>
      <div class="flex" style="margin-top:8px">
        <button class="btn warn" id="btnFlag">ğŸš© ÙˆØ³Ù… Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©</button>
        <button class="btn accent" id="btnImprove">ğŸ› ï¸ ØªÙˆÙ„ÙŠØ¯ Ø®Ø·Ø© ØªØ­Ø³ÙŠÙ† Ø¹Ø§Ø¬Ù„Ø©</button>
      </div>
      <p class="small">ÙŠØ¹ØªÙ…Ø¯ Ø§Ù„ÙˆØ³Ù… Ø¹Ù„Ù‰: (<span class="pill">% Ø¶Ø¹ÙŠÙ â‰¥ Ø§Ù„Ø¹ØªØ¨Ø©</span> Ø£Ùˆ <span class="pill">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø§Ø¯Ø© &lt; Ø§Ù„Ø¹ØªØ¨Ø©</span>)ØŒ ÙƒÙ…Ø§ ÙŠÙØ¹ÙØ¯Ù‘ Ø¨Ù†Ø¯Ù‹Ø§ Ø®Ø§ØµÙ‹Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª <span class="pill">% Ù…Ù…ØªØ§Ø² â‰¥ 95%</span> (Ø§Ù„ÙØ±ÙˆÙ‚ Ø§Ù„ÙØ±Ø¯ÙŠØ©).</p>
    </div>
  </section>

  <!-- Ø¬Ø¯ÙˆÙ„ ØªØ­Ù„ÙŠÙ„ ØªÙØµÙŠÙ„ÙŠ -->
  <section class="card">
    <h3>ØªØ­Ù„ÙŠÙ„ ØªÙØµÙŠÙ„ÙŠ Ø­Ø³Ø¨ Ø§Ù„ØµÙ ÙˆØ§Ù„Ù…Ø§Ø¯Ø©</h3>
    <table class="table" id="summaryTable">
      <thead>
        <tr>
          <th>Ø§Ù„ØµÙ</th>
          <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
          <th>Ø§Ù„Ø¹Ø¯Ù‘Ø¯</th>
          <th>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø©</th>
          <th>Ø¶Ø¹ÙŠÙ (&lt;60)</th>
          <th>Ø¬ÙŠØ¯ (60â€“79)</th>
          <th>Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§ (80â€“89)</th>
          <th>Ù…Ù…ØªØ§Ø² (90â€“100)</th>
          <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø°ÙƒÙŠØ©</th>
        </tr>
      </thead>
      <tbody id="summaryBody"></tbody>
    </table>
  </section>

  <!-- Ø®Ø·Ø© ØªØ­Ø³ÙŠÙ† Ù…Ø·ÙˆÙ‘Ø±Ø© A4 -->
  <section class="card" id="planSection">
    <div class="flex" style="justify-content:space-between;align-items:center">
      <h3>Ù†Ù…ÙˆØ°Ø¬ Ø®Ø·Ø© ØªØ­Ø³ÙŠÙ† (A4) â€“ Ø°ÙƒÙŠ ÙˆÙ‚Ø§Ø¨Ù„ Ù„Ù„Ù‚ÙŠØ§Ø³</h3>
      <button class="btn" id="btnPlanPDF">ğŸ–¨ï¸ Ø­ÙØ¸ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø®Ø·Ø© PDF</button>
    </div>
    <table class="table" id="planTable">
      <thead>
        <tr>
          <th>Ø§Ù„Ù…Ø¬Ø§Ù„</th>
          <th>Ø§Ù„Ù…Ø§Ø¯Ø©/Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù</th>
          <th>Ø§Ù„Ù‡Ø¯Ù (SMART)</th>
          <th>Ø§Ù„ÙØµÙ„</th>
          <th>Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</th>
          <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
          <th>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th>
          <th>Ù…Ø¤Ø´Ø± Ø§Ù„Ù‚ÙŠØ§Ø³</th>
          <th>Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
        </tr>
      </thead>
      <tbody id="planBody"></tbody>
    </table>
    <div class="flex" style="margin-top:8px">
      <button class="btn ghost" id="btnAddRow">â• Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯</button>
      <button class="btn ghost" id="btnExportExcel">ğŸ§¾ ØªØµØ¯ÙŠØ± Ø§Ù„Ø®Ø·Ø© Excel</button>
    </div>
  </section>

  <!-- ØªÙˆØµÙŠØ§Øª Ø°ÙƒÙŠØ© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© -->
  <section class="card">
    <h3>ØªÙˆØµÙŠØ§Øª Ø°ÙƒÙŠØ© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙˆØ§Ù„Ù‚ÙŠØ§Ø³</h3>
    <ul style="margin:6px 0 0 0;padding-inline-start:18px">
      <li>ØªØ­Ø¯ÙŠØ¯ <strong>Ø£Ø³Ø¨ÙˆØ¹ ØªØ¯Ø®Ù„</strong> Ù„ÙƒÙ„ Ù…Ø§Ø¯Ø© Ø¶Ø¹ÙŠÙØ©ØŒ Ù…Ø¹ Ø­Ø²Ù…Ø© Ø¹Ù„Ø§Ø¬ (Ø­ØµØµ Ø¹Ù„Ø§Ø¬ÙŠØ© + ÙˆØ§Ø¬Ø¨Ø§Øª Ù…ÙØªÙ‚Ù†Ø© + Ø§Ø®ØªØ¨Ø§Ø± Ù‚ØµÙŠØ±) ÙˆÙ‚ÙŠØ§Ø³ Ø§Ù„Ø£Ø«Ø± ÙÙŠ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„ØªØ§Ù„ÙŠ Ù…Ø¨Ø§Ø´Ø±Ø©.</li>
      <li>ØªÙØ¹ÙŠÙ„ <strong>Ø¬Ù„Ø³Ø§Øª PLC</strong> Ø´Ù‡Ø±ÙŠØ© Ø¨ÙŠÙ† Ù…Ø¹Ù„Ù…ÙŠ Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø© Ø¨ÙŠÙ† Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø«Ù„Ø§Ø«Ø© Ù„ØªØ¨Ø§Ø¯Ù„ Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ù…Ø§Ø±Ø³Ø§Øª ÙˆÙ…Ù‚Ø§Ø±Ù†Ø© Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª.</li>
      <li>ÙÙŠ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø°Ø§Øª <strong>Ù†Ø³Ø¨Ø© Ù…Ù…ØªØ§Ø² â‰¥ 95%</strong>ØŒ ØªØ·Ø¨ÙŠÙ‚ <strong>Ø§Ù„ØªÙ…Ø§ÙŠØ²</strong> (Ù…Ø³Ø§Ø±Ø§Øª Ø¥Ø«Ø±Ø§Ø¦ÙŠØ©/ØªØ­Ø¯Ù‘Ù) ÙˆØ±ÙØ¹ Ù†Ø³Ø¨Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø°Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ù…Ø¹Ø±ÙÙŠØ© Ø§Ù„Ø¹Ù„ÙŠØ§ (ØªØ­Ù„ÙŠÙ„â€“ØªÙ‚ÙˆÙŠÙ…â€“Ø¥Ø¨Ø¯Ø§Ø¹).</li>
      <li>Ø¥ØµØ¯Ø§Ø± <strong>Ù†Ø´Ø±Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</strong> Ù„Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ© ØªØªØ¶Ù…Ù†: Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø­Ù…Ø±Ø§Ø¡ØŒ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§ØªØŒ ÙˆÙ†Ø³Ø¨ Ø§Ù„ØªØ­Ø³Ù‘Ù†.</li>
      <li>Ø±Ø¨Ø· Ø§Ù„Ø®Ø·Ø© Ø¨Ù€ <strong>Ù†ÙˆØ§ØªØ¬ Ø§Ù„ØªØ¹Ù„Ù…</strong> ÙˆØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯ (Ù†Ù…Ø§Ø°Ø¬/ØµÙˆØ±/Ù…Ø­Ø§Ø¶Ø±) Ø¯Ø§Ø®Ù„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø®Ø·Ø© Ù†ÙØ³Ù‡.</li>
    </ul>
  </section>

  <div class="footer">Â© Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© Ø¨Ø§Ù„Ø®Ø¨Ø± â€“ Ù¡Ù¤Ù¤Ù§Ù‡Ù€ | Ø¥Ø¹Ø¯Ø§Ø¯: Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© â€“ ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø¹Ù„ÙŠ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</div>
</main>

<script>
/*********************** Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© ***********************/
const STORAGE_KEY = 'yaq_results_1447_v1';
const STORAGE_KEY_EVAL = 'yaq_eval_1447_v1';
const { jsPDF } = window.jspdf;

// ØªÙˆÙ„ÙŠØ¯ ÙˆØ³Ù… Ù„ÙˆÙ†ÙŠ
function levelTag(p){ if(p>=85) return 'good'; if(p>=75) return 'ok'; if(p>=50) return 'warn'; return 'bad'; }

// Ù†Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡
function band(score){
  if(score>=90) return 'Ù…Ù…ØªØ§Ø²';
  if(score>=80) return 'Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§';
  if(score>=60) return 'Ø¬ÙŠØ¯';
  return 'Ø¶Ø¹ÙŠÙ';
}

// Ø­Ø§Ù„Ø© Ù…Ø§Ø¯Ø© ØªØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©
function needsFollowUp(stats, minWeak=20, avgCut=75){
  return (stats.poorPct>=minWeak) || (stats.avg < avgCut);
}

// Ø­Ø§Ù„Ø© Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ±ÙˆÙ‚ ÙØ±Ø¯ÙŠØ©
function noDifferentiation(stats){ return stats.excellentPct>=95; }

// Ù†Ù…ÙˆØ°Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø§Ø®Ù„ÙŠ
let state = loadState() || { rows:[], summary:[], plan:[], eval:{} };

function loadState(){ try{ const s = JSON.parse(localStorage.getItem(STORAGE_KEY)); return s; }catch(e){ return null; } }
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function resetState(){ localStorage.removeItem(STORAGE_KEY); state = { rows:[], summary:[], plan:[] }; }

/*********************** Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØªØ­Ù„ÙŠÙ„ ***********************/
async function analyzeFiles(files){
  const rows = [];
  for (const f of files){
    const ext = f.name.split('.').pop().toLowerCase();
    if(['xlsx','xls','csv'].includes(ext)){
      const buf = await f.arrayBuffer();
      const wb = XLSX.read(buf, { type:'array' });
      wb.SheetNames.forEach(sh=>{
        const ws = wb.Sheets[sh];
        const json = XLSX.utils.sheet_to_json(ws, { defval:'', raw:true });
        json.forEach(r=> rows.push(mapRow(r)) );
      });
    } else if(ext==='pdf'){
      const buf = await f.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
      const max = Math.min(pdf.numPages, 10);
      for(let p=1;p<=max;p++){
        const page = await pdf.getPage(p);
        const tc = await page.getTextContent();
        const text = tc.items.map(i=>i.str).join(' ');
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¹Ù„Ù‰ Ø´ÙƒÙ„: Ø§Ù„ØµÙ:.. Ø§Ù„Ù…Ø§Ø¯Ø©:.. Ø§Ù„Ø·Ø§Ù„Ø¨:.. Ø§Ù„Ø¯Ø±Ø¬Ø©:..
        const regex = /(Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ|Ø«Ø§Ù†ÙŠ Ø«Ø§Ù†ÙˆÙŠ|Ø«Ø§Ù„Ø« Ø«Ø§Ù†ÙˆÙŠ).*?(?:Ù…Ø§Ø¯Ø©|Ø§Ù„Ù…Ø§Ø¯Ø©)[:\s]*([\u0600-\u06FF\s]+?).*?(?:Ø§Ù„Ø¯Ø±Ø¬Ø©|Ø¯Ø±Ø¬Ø©)[:\s]*(\d{1,3})/g;
        let m; while((m=regex.exec(text))){
          rows.push({ grade: m[1].trim(), subject: m[2].trim(), student:'â€”', score: +m[3] });
        }
      }
    } else if(['doc','docx','txt'].includes(ext)){
      const buf = await f.arrayBuffer();
      if(ext==='txt'){
        const text = new TextDecoder().decode(buf);
        parseTextLines(text).forEach(r=> rows.push(r));
      }else{
        const res = await window.mammoth.extractRawText({ arrayBuffer: buf });
        parseTextLines(res.value||'').forEach(r=> rows.push(r));
      }
    }
  }
  state.rows = rows.filter(r=> r && r.grade && r.subject && Number.isFinite(r.score));
  buildSummary();
  fillSubjects();
  renderKPIs();
  renderSummaryTable();
  renderCharts();
  saveState();
}

function mapRow(r){
  // ÙŠØ­Ø§ÙˆÙ„ Ù…Ø·Ø§Ø¨Ù‚Ø© Ø±Ø¤ÙˆØ³ Ù…ØªÙ†ÙˆØ¹Ø© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
  const grade = r['Ø§Ù„ØµÙ'] || r['Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ'] || r['Grade'] || r['class'] || r['Class'] || '';
  const subject = r['Ø§Ù„Ù…Ø§Ø¯Ø©'] || r['Ø§Ù„Ù…Ù‚Ø±Ø±'] || r['Subject'] || '';
  const student = r['Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨'] || r['Ø§Ù„Ø·Ø§Ù„Ø¨'] || r['Student'] || '';
  const score = +(r['Ø§Ù„Ø¯Ø±Ø¬Ø©'] ?? r['Score'] ?? r['mark'] ?? r['Marks'] ?? r['result'] ?? '');
  return { grade:String(grade).trim(), subject:String(subject).trim(), student:String(student).trim(), score:Number.isFinite(score)?score:NaN };
}

function parseTextLines(text){
  const lines = text.split(/\n|\r|;/).map(x=>x.trim()).filter(Boolean);
  const out=[]; const gRe=/(Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ|Ø«Ø§Ù†ÙŠ Ø«Ø§Ù†ÙˆÙŠ|Ø«Ø§Ù„Ø« Ø«Ø§Ù†ÙˆÙŠ)/;
  lines.forEach(line=>{
    const m = line.match(gRe);
    const s = line.match(/(?:Ù…Ø§Ø¯Ø©|Ø§Ù„Ù…Ø§Ø¯Ø©)[:\s]*([\u0600-\u06FF\s]+)/);
    const sc = line.match(/(?:Ø§Ù„Ø¯Ø±Ø¬Ø©|Ø¯Ø±Ø¬Ø©)[:\s]*(\d{1,3})/);
    if(m && s && sc){ out.push({ grade:m[1], subject:s[1].trim(), student:'â€”', score:+sc[1] }); }
  });
  return out;
}

/*********************** Ù…Ù„Ø®Ù‘Øµ ÙˆØªØ­Ù„ÙŠÙ„Ø§Øª ***********************/
function buildSummary(){
  const map = new Map();
  state.rows.forEach(r=>{
    const key = r.grade+'||'+r.subject;
    if(!map.has(key)) map.set(key,{ grade:r.grade, subject:r.subject, count:0, sum:0, poor:0, good:0, verygood:0, excellent:0 });
    const obj = map.get(key); obj.count++; obj.sum += r.score;
    const b = band(r.score);
    if(b==='Ø¶Ø¹ÙŠÙ') obj.poor++;
    else if(b==='Ø¬ÙŠØ¯') obj.good++;
    else if(b==='Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§') obj.verygood++;
    else obj.excellent++;
  });
  state.summary = Array.from(map.values()).map(x=>{
    const avg = x.count? (x.sum/x.count):0;
    const poorPct = +(100*x.poor/x.count).toFixed(2);
    const excellentPct = +(100*x.excellent/x.count).toFixed(2);
    const note = noDifferentiation({excellentPct})? 'ØªÙ…ÙŠÙ‘Ø² â‰¥95Ùª â€” Ø±Ø§Ø¬Ø¹ Ø§Ù„ØªÙ…Ø§ÙŠØ²' : '';
    return { ...x, avg:+avg.toFixed(2), poorPct, excellentPct, note };
  });
}

/*********************** ÙˆØ§Ø¬Ù‡Ø© â€“ Ù…ÙˆØ§Ø¯/ØµÙÙˆÙ ***********************/
function fillSubjects(){
  const sel = document.getElementById('subjectSelect');
  const set = new Set(state.rows.map(r=>r.subject));
  sel.innerHTML = '<option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯</option>' + Array.from(set).sort().map(s=>`<option>${s}</option>`).join('');
}

/*********************** KPI Ø¹Ø§Ù…Ø© ***********************/
function renderKPIs(){
  const g = document.getElementById('kpiGrid'); g.innerHTML='';
  const total = state.rows.length;
  const pass = state.rows.filter(r=>r.score>=60).length;
  const exc = state.rows.filter(r=>r.score>=90).length;
  const weak = state.rows.filter(r=>r.score<60).length;
  const avg = total? (state.rows.reduce((a,b)=>a+b.score,0)/total).toFixed(2):0;
  const kpis = [
    {label:'Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª', value: total, unit:''},
    {label:'Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø§Øª', value: avg, unit:''},
    {label:'Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­', value: total? ((pass/total)*100).toFixed(2):0, unit:'%'} ,
    {label:'Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ù…ØªØ§Ø²', value: total? ((exc/total)*100).toFixed(2):0, unit:'%'}
  ];
  kpis.forEach(k=>{
    const div = document.createElement('div'); div.className='kpi';
    div.innerHTML = `<div class="v">${k.value}${k.unit}</div><div class="lbl">${k.label}</div>`;
    g.appendChild(div);
  });
}

/*********************** Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ***********************/
function renderSummaryTable(){
  const body = document.getElementById('summaryBody'); body.innerHTML='';
  const minWeak = +document.getElementById('minWeak').value;
  const avgCut = +document.getElementById('avgCut').value;
  state.summary.sort((a,b)=> a.grade.localeCompare(b.grade,'ar') || a.subject.localeCompare(b.subject,'ar'));
  state.summary.forEach(s=>{
    const weakPct = +(100*s.poor/s.count).toFixed(2);
    const tagClass = needsFollowUp({poorPct:weakPct, avg:s.avg},minWeak,avgCut) ? 'bad' : 'ok';
    const nd = noDifferentiation({excellentPct:s.excellentPct});
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${s.grade}</td>
      <td>${s.subject} ${nd?'<span class="tag">ÙØ±ÙˆÙ‚ ÙØ±Ø¯ÙŠØ©ØŸ â‰¥95% Ù…Ù…ØªØ§Ø²</span>':''}</td>
      <td>${s.count}</td>
      <td><span class="status ${levelTag(s.avg)}">${s.avg}</span></td>
      <td>${s.poor} (${weakPct}%)</td>
      <td>${s.good} (${(100*s.good/s.count).toFixed(2)}%)</td>
      <td>${s.verygood} (${(100*s.verygood/s.count).toFixed(2)}%)</td>
      <td>${s.excellent} (${s.excellentPct}%)</td>
      <td>${s.note|| (tagClass==='bad'?'ØªØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø© Ø¹Ø§Ø¬Ù„Ø©':'â€”')}</td>
    `;
    body.appendChild(tr);
  });
}

/*********************** Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© ***********************/
let mainChart, radarChart;
function renderCharts(){
  const grade = document.getElementById('gradeSelect').value;
  const subject = document.getElementById('subjectSelect').value;
  const type = document.getElementById('chartType').value;
  const filtered = state.summary.filter(s => (grade==='all'||s.grade===grade) && (subject==='all'||s.subject===subject));
  const labels = filtered.map(s=> s.grade+' â€“ '+s.subject);
  const avgs = filtered.map(s=> s.avg);
  const bands = [
    filtered.map(s=> 100*s.poor/s.count),
    filtered.map(s=> 100*s.good/s.count),
    filtered.map(s=> 100*s.verygood/s.count),
    filtered.map(s=> 100*s.excellent/s.count)
  ];
  if(mainChart){ mainChart.destroy(); }
  if(radarChart){ radarChart.destroy(); }
  const ctx = document.getElementById('mainChart');
  const rdx = document.getElementById('radarChart');
  if(type==='bar'){
    rdx.style.display='none'; ctx.style.display='block';
    mainChart = new Chart(ctx, { type:'bar', data:{ labels, datasets:[ {label:'Ø§Ù„Ù…ØªÙˆØ³Ø·', data:avgs} ] }, options:{ plugins:{legend:{display:false}}, scales:{y:{min:0,max:100}} } });
  } else {
    ctx.style.display='none'; rdx.style.display='block';
    radarChart = new Chart(rdx, { type:'radar', data:{ labels, datasets:[
      { label:'% Ø¶Ø¹ÙŠÙ', data: bands[0] },
      { label:'% Ø¬ÙŠØ¯', data: bands[1] },
      { label:'% Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§', data: bands[2] },
      { label:'% Ù…Ù…ØªØ§Ø²', data: bands[3] }
    ] }, options:{ plugins:{legend:{position:'bottom'}}, scales:{ r:{ min:0, max:100 } } } });
  }
}

/*********************** Ø®Ø·Ø© ØªØ­Ø³ÙŠÙ† â€“ ØªÙˆÙ„ÙŠØ¯ Ø³Ø±ÙŠØ¹ ***********************/
function weekLabel(hijri){ // ÙŠØªÙˆÙ‚Ø¹ YYYY/MM/DD Ù‡Ø¬Ø±ÙŠ
  try{ const m=moment(hijri,'iYYYY/iMM/iDD'); const week = Math.ceil(m.date()/7); return `Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${week}`; }catch(e){ return 'â€”'; }
}

function addPlanRow(row){
  const body = document.getElementById('planBody');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td contenteditable>${row.domain||''}</td>
    <td contenteditable>${row.subject||''}</td>
    <td contenteditable>${row.smart||''}</td>
    <td>
      <select>
        <option ${row.term==='Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„'?'selected':''}>Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„</option>
        <option ${row.term==='Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ'?'selected':''}>Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
      </select>
    </td>
    <td contenteditable>${row.week||''}</td>
    <td contenteditable>${row.action||''}</td>
    <td contenteditable>${row.owner||''}</td>
    <td contenteditable>${row.kpi||''}</td>
    <td contenteditable>${row.evidence||''}</td>
    <td>
      <select>
        <option ${row.status==='Ù…ÙƒØªÙ…Ù„'?'selected':''}>Ù…ÙƒØªÙ…Ù„</option>
        <option ${row.status==='Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°'?'selected':''}>Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
        <option ${row.status==='Ù…Ø¬Ø¯ÙˆÙ„'?'selected':''}>Ù…Ø¬Ø¯ÙˆÙ„</option>
        <option ${row.status==='Ù…ØªØ£Ø®Ø±'?'selected':''}>Ù…ØªØ£Ø®Ø±</option>
      </select>
    </td>
  `;
  body.appendChild(tr);
}

function generateImprovementPlan(){
  const minWeak = +document.getElementById('minWeak').value;
  const avgCut = +document.getElementById('avgCut').value;
  const body = document.getElementById('planBody');
  body.innerHTML='';
  const termGuess = 'Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„';
  const ownerTeach = 'Ù„Ø¬Ù†Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„ØªØ¹Ù„Ù‘Ù…';
  const ownerOutcomes = 'Ù„Ø¬Ù†Ø© Ù†ÙˆØ§ØªØ¬ Ø§Ù„ØªØ¹Ù„Ù…';
  const ownerAdmin = 'Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©';
  const ownerEnv = 'Ø§Ù„ÙˆÙƒÙŠÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ';

  state.summary.forEach(s=>{
    const weakPct = +(100*s.poor/s.count).toFixed(2);
    const follow = needsFollowUp({poorPct:weakPct, avg:s.avg}, minWeak, avgCut);
    const nd = noDifferentiation({ excellentPct: s.excellentPct });

    if(follow){
      // Ø®Ø·Ø© Ø¹Ù„Ø§Ø¬ Ø¹Ø§Ø¬Ù„Ø© â€“ Ù†ÙˆØ§ØªØ¬ Ø§Ù„ØªØ¹Ù„Ù… + Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„ØªØ¹Ù„Ù…
      addPlanRow({
        domain:'Ù†ÙˆØ§ØªØ¬ Ø§Ù„ØªØ¹Ù„Ù…', subject:`${s.grade} â€“ ${s.subject}`,
        smart:`Ø®ÙØ¶ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ø¹ÙŠÙ Ø¥Ù„Ù‰ â‰¤ ${(Math.max(0, weakPct-10)).toFixed(0)}% ÙˆØ±ÙØ¹ Ø§Ù„Ù…ØªÙˆØ³Ø· Ø¥Ù„Ù‰ â‰¥ ${Math.max(80, Math.ceil(s.avg+5))}% Ù‚Ø¨Ù„ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙØµÙ„`,
        term: termGuess, week: 'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 4â€“8',
        action:'Ø­ØµØµ Ø¹Ù„Ø§Ø¬ÙŠØ© Ù…Ø±ÙƒÙ‘Ø²Ø© + Ø¨Ù†Ùƒ Ø£Ø³Ø¦Ù„Ø© Ù…Ø¹ÙŠØ§Ø±ÙŠØ© + Ø§Ø®ØªØ¨Ø§Ø± Ù‚ØµÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠ + Ù…ØªØ§Ø¨Ø¹Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±',
        owner: ownerOutcomes, kpi:'% Ø¶Ø¹ÙŠÙ / Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø§Ø¯Ø©', evidence:'Ù‚ÙˆØ§Ø¦Ù… Ø¹Ù„Ø§Ø¬ â€“ Ù†ØªØ§Ø¦Ø¬ Ù‚ØµÙŠØ±Ø© â€“ ØªÙˆØ§ØµÙ„ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±', status:'Ù…Ø¬Ø¯ÙˆÙ„'
      });
      addPlanRow({
        domain:'Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„ØªØ¹Ù„Ù‘Ù…', subject:`${s.grade} â€“ ${s.subject}`,
        smart:'ØªØ·Ø¨ÙŠÙ‚ Ø£Ø¯ÙˆØ§Øª ØªÙ‚ÙˆÙŠÙ… ØªÙƒÙˆÙŠÙ†ÙŠ (Ø®Ø±ÙŠØ·Ø© ØªÙ‚Ø¯Ù‘Ù…) ÙˆØ±ÙØ¹ % Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØµÙÙŠØ© Ø¨Ù…Ø¹Ø¯Ù„ +20%',
        term: termGuess, week: 'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 3â€“10',
        action:'Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ù†Ø´ÙØ·Ø© (Ø¯ÙˆØ§Ø¦Ø± ØªØ¹Ù„Ù‘Ù…/Ù…Ø³Ø§Ø±Ø­) + ØªÙ…Ø§ÙŠØ² Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª + ØªØºØ°ÙŠØ© Ø±Ø§Ø¬Ø¹Ø© ÙÙˆØ±ÙŠØ©',
        owner: ownerTeach, kpi:'% Ù…Ø´Ø§Ø±ÙƒØ© â€“ Ù†ØªØ§Ø¦Ø¬ Ø¨Ù†ÙˆØ¯ ØªÙ‚ÙˆÙŠÙ…ÙŠØ©', evidence:'Ø§Ø³ØªÙ…Ø§Ø±Ø§Øª Ù…Ù„Ø§Ø­Ø¸Ø© â€“ Ø¹ÙŠÙ†Ø§Øª Ø£Ø¹Ù…Ø§Ù„ Ø·Ù„Ø§Ø¨', status:'Ù…Ø¬Ø¯ÙˆÙ„'
      });
    }

    if(nd){
      // Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ±ÙˆÙ‚ ÙØ±Ø¯ÙŠØ© â€“ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¹Ø¨Ø± Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„ØªØ¹Ù„Ù‘Ù… + Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
      addPlanRow({
        domain:'Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„ØªØ¹Ù„Ù‘Ù…', subject:`${s.grade} â€“ ${s.subject}`,
        smart:'Ø®ÙØ¶ Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ù…ØªØ§Ø² Ø¥Ù„Ù‰ â‰¤ 90% Ø¹Ø¨Ø± Ø²ÙŠØ§Ø¯Ø© Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø¹Ù„ÙŠØ§ ÙˆØ±ÙØ¹ Ø§Ù„ØªØ­Ø¯ÙŠ',
        term: termGuess, week: 'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 5â€“9',
        action:'ØªØµÙ…ÙŠÙ… Ù…Ù‡Ø§Ù… Ø£Ø¯Ø§Ø¡ Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø³ØªÙˆÙ‰ + ØªØ¹Ø§Ù‚Ø¯ ØªØ¹Ù„Ù‘Ù…ÙŠ ÙØ±Ø¯ÙŠ Ù„Ù„Ù…ØªÙÙˆÙ‚ÙŠÙ† + Ù…Ø´Ø§Ø±ÙŠØ¹ Ù‚ØµÙŠØ±Ø©',
        owner: ownerTeach, kpi:'Ù†Ø³Ø¨Ø© ØªÙˆØ²ÙŠØ¹ Ø§Ù„ÙØ¦Ø§Øª â€“ ÙˆØ²Ù† Ø£Ø³Ø¦Ù„Ø© C3â€“C6', evidence:'Ù†Ù…Ø§Ø°Ø¬ Ø£Ø³Ø¦Ù„Ø© â€“ Ù…Ù†ØªØ¬Ø§Øª ØªØ¹Ù„Ù…', status:'Ù…Ø¬Ø¯ÙˆÙ„'
      });
      addPlanRow({
        domain:'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©', subject:`${s.grade} â€“ ${s.subject}`,
        smart:'Ø¶Ø¨Ø· Ø¬ÙˆØ¯Ø© Ø¨Ù†ÙˆÙƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ø¹ØªÙ…Ø§Ø¯ Ø³Ù„Ù… ØªÙ‚Ø¯ÙŠØ± ÙŠØ¶Ù…Ù† Ø§Ù„ØªÙ…Ø§ÙŠØ² Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙ',
        term: termGuess, week: 'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 2â€“6',
        action:'Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨Ù†ÙˆÙƒ Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ â€“ Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¬Ø¯Ø§ÙˆÙ„ Ù…ÙˆØ§ØµÙØ§Øª â€“ Ø¬Ù„Ø³Ø© ØªØºØ°ÙŠØ© Ø±Ø§Ø¬Ø¹Ø©',
        owner: ownerAdmin, kpi:'Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª â€“ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©', evidence:'Ù…Ø­Ø§Ø¶Ø± â€“ Ø¬Ø¯Ø§ÙˆÙ„ Ù…ÙˆØ§ØµÙØ§Øª', status:'Ù…Ø¬Ø¯ÙˆÙ„'
      });
    }
  });

  // Ø¨Ù†Ø¯ Ø¨ÙŠØ¦Ø© Ù…Ø¯Ø±Ø³ÙŠØ© Ø¯Ø§Ø¹Ù…Ø©
  addPlanRow({
    domain:'Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©', subject:'ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', smart:'Ø±ÙØ¹ Ù…Ø¤Ø´Ø± Ø±Ø¶Ø§ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¹Ù† Ø§Ù„Ø¨ÙŠØ¦Ø© â‰¥ 85%', term: termGuess, week:'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 1â€“3',
    action:'ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¥Ø¶Ø§Ø¡Ø© ÙˆØ§Ù„ØªÙ‡ÙˆÙŠØ© â€“ Ù„ÙˆØ­Ø§Øª Ø¥Ø±Ø´Ø§Ø¯ÙŠØ© â€“ Ø¶Ø¨Ø· Ø§Ù„Ø¬Ù„Ø³Ø§Øª', owner:'Ø§Ù„ÙˆÙƒÙŠÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ', kpi:'Ø§Ø³ØªØ¨Ø§Ù†Ø© Ø±Ø¶Ø§ â€“ Ø¨Ø·Ø§Ù‚Ø§Øª Ù…Ù„Ø§Ø­Ø¸Ø©', evidence:'ØµÙˆØ± Ù‚Ø¨Ù„/Ø¨Ø¹Ø¯ â€“ Ù†Ù…Ø§Ø°Ø¬', status:'Ù…Ø¬Ø¯ÙˆÙ„'
  });
}

/*********************** Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ø²Ø±Ø§Ø± ***********************/
const input = document.getElementById('fileInput');
const btnAnalyze = document.getElementById('btnAnalyze');
const btnAnalyzeEval = document.getElementById('btnAnalyzeEval');
const btnAnalyzeResults2 = document.getElementById('btnAnalyzeResults2');
const btnSample = document.getElementById('btnSample');
const btnFlag = document.getElementById('btnFlag');
const btnImprove = document.getElementById('btnImprove');
const btnAddRow = document.getElementById('btnAddRow');
const btnExportExcel = document.getElementById('btnExportExcel');
const btnPlanPDF = document.getElementById('btnPlanPDF');
const btnPDF = document.getElementById('btnPDF');
const btnReset = document.getElementById('btnReset');

btnAnalyze.addEventListener('click',()=>{ if(input.files.length){ analyzeFiles(input.files); } else { alert('ÙØ¶Ù„Ø§Ù‹ Ø§Ø®ØªØ± Ù…Ù„ÙØ§Øª Ø£ÙˆÙ„Ø§Ù‹'); } });
btnAnalyzeResults2.addEventListener('click',()=>{ if(input.files.length){ analyzeFiles(input.files); } else { alert('ÙØ¶Ù„Ø§Ù‹ Ø§Ø®ØªØ± Ù…Ù„ÙØ§Øª Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø£ÙˆÙ„Ø§Ù‹'); } });
btnAnalyzeEval.addEventListener('click',()=>{ if(input.files.length){ analyzeExternalEval(input.files); } else { alert('ÙØ¶Ù„Ø§Ù‹ Ø§Ø®ØªØ± ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ (PDF/Word) Ø£ÙˆÙ„Ø§Ù‹'); } });
btnSample.addEventListener('click',()=>{
  // Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù…ÙˆØ²Ø¹Ø© Ø¹Ù„Ù‰ Ø§Ù„ØµÙÙˆÙ ÙˆØ§Ù„Ù…ÙˆØ§Ø¯
  const samples = [];
  const grades = ['Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ','Ø«Ø§Ù†ÙŠ Ø«Ø§Ù†ÙˆÙŠ','Ø«Ø§Ù„Ø« Ø«Ø§Ù†ÙˆÙŠ'];
  const subjects = ['Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª','Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©','Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©','Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡','Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡','Ø§Ù„Ø£Ø­ÙŠØ§Ø¡'];
  grades.forEach(g=> subjects.forEach(s=> {
    for(let i=0;i<30;i++){
      const base = s==='Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª'||s==='Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡'?70:78;
      const variance = Math.floor(Math.random()*26)-13; // -13..+12
      let score = Math.max(30, Math.min(100, base+variance));
      samples.push({ grade:g, subject:s, student:`Ø·Ø§Ù„Ø¨ ${i+1}`, score });
    }
  }));
  state.rows = samples; buildSummary(); fillSubjects(); renderKPIs(); renderSummaryTable(); renderCharts(); saveState();
});

btnFlag.addEventListener('click',()=>{ renderSummaryTable(); alert('ØªÙ… ÙˆØ³Ù… Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆÙÙ‚ Ø§Ù„Ø¹ØªØ¨Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.'); });
btnImprove.addEventListener('click',()=>{ generateImprovementPlan(); alert('ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø®Ø·Ø© ØªØ­Ø³ÙŠÙ† Ø¹Ø§Ø¬Ù„Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØ­Ù„ÙŠÙ„. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø¨Ù„ Ø§Ù„ØªØµØ¯ÙŠØ±.'); });
btnAddRow.addEventListener('click',()=> addPlanRow({domain:'',subject:'',smart:'',term:'Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„',week:'',action:'',owner:'',kpi:'',evidence:'',status:'Ù…Ø¬Ø¯ÙˆÙ„'}));

btnExportExcel.addEventListener('click',()=>{
  const rows = [['Ø§Ù„Ù…Ø¬Ø§Ù„','Ø§Ù„Ù…Ø§Ø¯Ø©/Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù','Ø§Ù„Ù‡Ø¯Ù (SMART)','Ø§Ù„ÙØµÙ„','Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹','Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡','Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„','Ù…Ø¤Ø´Ø± Ø§Ù„Ù‚ÙŠØ§Ø³','Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯','Ø§Ù„Ø­Ø§Ù„Ø©']];
  document.querySelectorAll('#planBody tr').forEach(tr=>{
    const tds = tr.querySelectorAll('td');
    rows.push([
      tds[0].innerText.trim(), tds[1].innerText.trim(), tds[2].innerText.trim(),
      tds[3].querySelector('select').value, tds[4].innerText.trim(), tds[5].innerText.trim(),
      tds[6].innerText.trim(), tds[7].innerText.trim(), tds[8].innerText.trim(), tds[9].querySelector('select').value
    ]);
  });
  const ws = XLSX.utils.aoa_to_sheet(rows); const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Ø®Ø·Ø© Ø§Ù„ØªØ­Ø³ÙŠÙ†');
  XLSX.writeFile(wb, 'Ø®Ø·Ø©-ØªØ­Ø³ÙŠÙ†-Ù†ØªØ§Ø¦Ø¬-Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ-1447.xlsx');
});

btnPlanPDF.addEventListener('click', async ()=>{
  const node = document.getElementById('planSection');
  const canvas = await html2canvas(node,{scale:2,background:'#ffffff'});
  const img = canvas.toDataURL('image/png'); const pdf = new jsPDF('p','pt','a4');
  const pw=pdf.internal.pageSize.getWidth(), ph=pdf.internal.pageSize.getHeight();
  const ratio = Math.min(pw/canvas.width, ph/canvas.height); const w=canvas.width*ratio, h=canvas.height*ratio; const x=(pw-w)/2, y=(ph-h)/2;
  pdf.addImage(img,'PNG',x,y,w,h); pdf.save('Ù†Ù…ÙˆØ°Ø¬-Ø®Ø·Ø©-ØªØ­Ø³ÙŠÙ†-A4.pdf');
});

btnPDF.addEventListener('click', async ()=>{
  const canvas = await html2canvas(document.body,{scale:2,background:'#ffffff'});
  const img = canvas.toDataURL('image/png'); const pdf = new jsPDF('l','pt','a4');
  const pw=pdf.internal.pageSize.getWidth(), ph=pdf.internal.pageSize.getHeight();
  const ratio = Math.min(pw/canvas.width, ph/canvas.height); const w=canvas.width*ratio, h=canvas.height*ratio; const x=(pw-w)/2, y=(ph-h)/2;
  pdf.addImage(img,'PNG',x,y,w,h); pdf.save('Dashboard-Ù†ØªØ§Ø¦Ø¬-ÙˆØ®Ø·Ø©-ØªØ­Ø³ÙŠÙ†-Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ.pdf');
});

btnReset.addEventListener('click',()=>{ resetState(); document.getElementById('summaryBody').innerHTML=''; document.getElementById('planBody').innerHTML=''; document.getElementById('subjectSelect').innerHTML='<option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯</option>'; renderKPIs(); if(mainChart) mainChart.destroy(); if(radarChart) radarChart.destroy(); });

// ØªØºÙŠÙŠØ±Ø§Øª Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„Ø±Ø³Ù…
['gradeSelect','subjectSelect','chartType','minWeak','avgCut'].forEach(id=> document.getElementById(id).addEventListener('change',()=>{ renderSummaryTable(); renderCharts(); }));

// ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ
if(state.rows.length){ buildSummary(); fillSubjects(); renderKPIs(); renderSummaryTable(); renderCharts(); }
</script>
<!-- Ù†Ø§ÙØ°Ø© ØªÙ‚Ø±ÙŠØ± A4 Ù…Ù†Ø¨Ø«Ù‚Ø© -->
<div id="a4Modal" class="modal">
  <div class="a4" id="a4Doc">
    <div class="govhdr">
      <span class="seal"></span>
      <div><strong>Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</strong></div>
      <div>ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…</div>
      <div>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø¨Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø±Ù‚ÙŠØ©</div>
      <div><strong>Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ Ø¨Ø§Ù„Ø®Ø¨Ø±</strong></div>
    </div>
    <h2 id="a4Title">ØªÙ‚Ø±ÙŠØ±</h2>
    <div class="meta" id="a4Meta"></div>
    <div class="small" style="text-align:center;margin-bottom:8px">Ù…Ø¨Ø§Ø¯Ø±Ø© Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ Ø¨Ø§Ù„Ø®Ø¨Ø± â€“ Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</div>
    <div id="a4Body" style="margin-top:8px"></div>
    <div class="actions">
      <button class="btn" id="a4Export">ğŸ“„ Ø­ÙØ¸ PDF</button>
      <button class="btn ghost" id="a4Close">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>
</body>
</html>
