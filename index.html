<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù…Ù†ØµØ© Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ§Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ â€“ Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ</title>

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

<style>
:root{
  --moe:#0b7e88; --ink:#06353b; --bg:#f5f8f8;
  --muted:#7a9aa0; --ok:#e8fff5; --okb:#13b38a;
  --bad:#fff3f3; --badb:#ef4444; --card:#ffffff;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:'Tajawal',sans-serif}
a{color:#145; text-decoration:none}
a:hover{text-decoration:underline}

/* ====== Responsive single block ====== */
.page{max-width:1200px;margin:0 auto;padding:10px 14px}

/* ====== Header (image only) ====== */
.header{
  width:100%; aspect-ratio: 7/1.6; /* ÙŠØ¶Ù…Ù† Ø§Ù„Ø¸Ù‡ÙˆØ± Ù„ÙƒÙ„ Ø§Ù„Ø´Ø§Ø´Ø§Øª */
  background:#053840 url('logo.png') center/contain no-repeat;
  border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,.12);
  margin:10px auto;
}

/* ====== Top controls ====== */
.controls{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;padding:10px}
.btn{background:var(--moe);color:#fff;border:0;border-radius:10px;padding:10px 16px;font-weight:700;cursor:pointer;box-shadow:0 6px 16px rgba(11,126,136,.2)}
.btn.light{background:#e8f3f4;color:#06353b}
.btn:hover{filter:brightness(.95)}

/* ====== Grid ====== */
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}
.card{background:var(--card);border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.08);padding:16px;position:relative}
.card h2{margin:0 0 6px;color:var(--moe);font-size:22px}
.kpi{display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:14px}
.progress{height:10px;background:#e6efef;border-radius:999px;overflow:hidden;margin:8px 0}
.bar{height:100%;background:#2aa897}
.small{font-size:12px;color:#567}

/* ====== Detail area ====== */
.detail{display:none;margin-top:12px;border-top:1px dashed #e1ecec;padding-top:12px}
.titleRow{display:flex;align-items:center;gap:10px;justify-content:space-between}
.titleRow h3{margin:0;color:#06353b}
.titleRow .donutWrap{width:110px}  /* Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© ÙÙ‚Ø· */
.subgrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;margin-top:8px}
.subCard{background:#f7fbfb;border:1px solid #e6efef;border-radius:12px;padding:10px}

/* ====== Detailed table per field ====== */
.tableWrap{margin-top:12px}
table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden}
thead th{background:#0f6f79;color:#fff;padding:10px;font-weight:700}
tbody td{padding:10px;border-bottom:1px solid #eef3f3;vertical-align:top}
tbody tr:last-child td{border-bottom:0}
.badge{padding:2px 8px;border-radius:99px;background:#e6efef;color:#246;font-size:12px}
.row-ok{background:var(--ok)}
.row-bad{background:var(--bad)}
.level{font-weight:700}
.actionsRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}

/* ====== Evidence modal ====== */
.modal{position:fixed;inset:0;background:rgba(2,52,59,.6);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:9999}
.sheet{width:min(920px,96vw);max-height:92vh;overflow:auto;background:#fff;border-radius:16px;box-shadow:0 12px 40px rgba(0,0,0,.35);padding:16px}
.sheet h4{margin:0 0 8px}
.row{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.row label{font-size:12px;color:#345}
input[type=text],input[type=date],select{border:1px solid #d7e7e7;border-radius:8px;padding:8px;width:100%}
.sheet .close{position:sticky;top:0;margin-bottom:8px;background:#e8eff0;border:0;color:#034;padding:6px 10px;border-radius:8px;cursor:pointer;font-weight:700}

/* ====== Print in popup (A4) ====== */
@media print{ .no-print{display:none !important} }

/* Footer */
.footer{padding:18px 10px;text-align:center;color:#7a9aa0}
</style>
</head>
<body>

<div class="page">

  <!-- Header (image only) -->
  <div class="header" aria-label="Ministry of Education"></div>

  <div class="controls">
    <button class="btn" id="btnAnalyze">ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„ ğŸ”</button>
    <button class="btn" id="btnFullReport">ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„ PDF ğŸ“˜</button>
    <button class="btn" id="btnFullPlan">Ø®Ø·Ø© ØªØ­Ø³ÙŠÙ† Ø´Ø§Ù…Ù„Ø© PDF ğŸ—‚ï¸</button>
  </div>

  <div id="dashboard" class="grid"></div>

  <div class="footer">Â© 1447 Ù‡Ù€ â€“ Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ â€“ Ù…Ù†ØµØ© Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ§Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ</div>
</div>

<!-- ===== Evidence Modal ===== -->
<div class="modal" id="eviModal" aria-hidden="true">
  <div class="sheet">
    <button class="close" id="eviClose">âœ• Ø¥ØºÙ„Ø§Ù‚</button>
    <h4>Ø¥Ø¶Ø§ÙØ© Ø´Ø§Ù‡Ø¯</h4>
    <div class="row" style="margin-bottom:8px">
      <div><label>Ø§Ù„ÙˆØµÙ</label><input id="eviText" type="text" placeholder="Ù…Ø«Ø§Ù„: ØªÙ‚Ø±ÙŠØ± Ø²ÙŠØ§Ø±Ø© Ù…Ø´Ø±Ù .."/></div>
      <div><label>Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</label>
        <select id="eviTerm">
          <option value="Ø§Ù„Ø£ÙˆÙ„">Ø§Ù„Ø£ÙˆÙ„</option><option value="Ø§Ù„Ø«Ø§Ù†ÙŠ">Ø§Ù„Ø«Ø§Ù†ÙŠ</option><option value="Ø§Ù„Ø«Ø§Ù„Ø«">Ø§Ù„Ø«Ø§Ù„Ø«</option>
        </select>
      </div>
      <div><label>Ø§Ù„ÙŠÙˆÙ…</label>
        <select id="eviDay">
          <option>Ø§Ù„Ø£Ø­Ø¯</option><option>Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†</option><option>Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option><option>Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option><option>Ø§Ù„Ø®Ù…ÙŠØ³</option>
        </select>
      </div>
      <div><label>Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ (Ù‡Ø¬Ø±ÙŠ)</label>
        <select id="eviWeek"></select>
      </div>
    </div>
    <div class="row">
      <div><label>Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù‡Ø¬Ø±ÙŠ Ø£Ù… Ø§Ù„Ù‚Ø±Ù‰)</label><input id="eviHijri" type="text" placeholder="1447/03/01"/></div>
      <div><label>Ø¥Ø±ÙØ§Ù‚ Ø±Ø§Ø¨Ø· (PDF/ØµÙˆØ±Ø©)</label><input id="eviLink" type="text" placeholder="https://...pdf"/></div>
      <div style="grid-column: span 2"><label>Ù„Ù…Ù† ÙŠØ®Øµ Ø§Ù„Ø´Ø§Ù‡Ø¯</label>
        <input id="eviOwner" type="text" placeholder="Ø§Ù„Ù…Ø¬Ø§Ù„/Ø§Ù„Ù…Ø¤Ø´Ø±/Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø³ÙŠÙ…Ù„Ø£ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹" disabled />
      </div>
    </div>
    <div class="actionsRow">
      <button class="btn" id="eviSave">Ø­ÙØ¸ Ø§Ù„Ø´Ø§Ù‡Ø¯</button>
      <button class="btn light" id="eviCancel">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
    <div class="small">* ØªÙØ³Ø­Ø¨ Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ®Ø·Ø· Ø§Ù„ØªØ­Ø³ÙŠÙ†ØŒ ÙˆÙŠÙ…ÙƒÙ† ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©.</div>
  </div>
</div>

<script>
/* =========== Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø®ØªØµØ±Ø© (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙˆØ³Ø¹Ø©) =========== */

/* Ø£Ø³Ø§Ø¨ÙŠØ¹ Ù‡Ø¬Ø±ÙŠ â€“ Ø£Ù…Ø«Ù„Ø© (ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ù‚Ø§Ø¦Ù…Ø© Ø£Ø¯Ù‚ Ù„Ø§Ø­Ù‚Ø§Ù‹) */
const WEEKS = [
  {id:'1447/02/18', name:'Ø¹ÙˆØ¯Ø© Ø§Ù„Ù‡ÙŠØ¦Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© â€” 1447/02/18'},
  {id:'1447/02/23', name:'Ø¹ÙˆØ¯Ø© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† â€” 1447/02/23'},
  {id:'1447/03/01', name:'Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ â€” 1447/03/01'},
  {id:'1447/04/01', name:'Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„ÙŠÙˆÙ… Ø§Ù„ÙˆØ·Ù†ÙŠ â€” 1447/04/01'},
  {id:'1447/05/30', name:'Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ø®Ø±ÙŠÙ (Ø¨Ø¯Ø§ÙŠØ©) â€” 1447/05/30'},
  {id:'1447/06/08', name:'Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ø®Ø±ÙŠÙ (Ù†Ù‡Ø§ÙŠØ©) â€” 1447/06/08'}
];

/* Ù…Ø¤Ø´Ø± Ø§Ù„Ù…Ø³ØªÙˆÙ‰ */
function levelOf(v){
  if(v>=90) return {txt:'Ù…Ù…ØªØ§Ø²', cls:'badge', color:'#10b981'};
  if(v>=75) return {txt:'Ù…ØªÙ‚Ø¯Ù…', cls:'badge', color:'#2aa897'};
  if(v>=60) return {txt:'Ù…ØªÙˆØ³Ø·', cls:'badge', color:'#f59e0b'};
  return {txt:'Ù…Ù†Ø®ÙØ¶', cls:'badge', color:'#ef4444'};
}
const fmt = v => Number(v).toFixed(2);

/* Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¬Ø§Ù„Ø§Øª (Ù‚ÙŠÙ… 2024/2025) + Ù…Ø¤Ø´Ø±Ø§Øª ÙØ±Ø¹ÙŠØ© Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© */
const fields = {
  management:   { name:'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©',   v2024:75.50, v2025:75.50, subs:[
    { id:'plans', name:'Ø§Ù„ØªØ®Ø·ÙŠØ·', v:54.00 },
    { id:'lead',  name:'Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©', v:72.75 },
    { id:'soc',   name:'Ø§Ù„Ù…Ø¬ØªÙ…Ø¹ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ', v:57.25 },
    { id:'dev',   name:'Ø§Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ù…Ø¤Ø³Ø³ÙŠ', v:60.25 }
  ]},
  teaching:     { name:'Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„ØªØ¹Ù„Ù…',     v2024:80.75, v2025:81.50, subs:[
    { id:'learnassess', name:'ØªÙ‚ÙˆÙŠÙ… Ø§Ù„ØªØ¹Ù„Ù…', v:82.75 },
    { id:'learnexp',    name:'Ø¨Ù†Ø§Ø¡ Ø®Ø¨Ø±Ø§Øª Ø§Ù„ØªØ¹Ù„Ù…', v:76.75 }
  ]},
  learning:     { name:'Ù†ÙˆØ§ØªØ¬ Ø§Ù„ØªØ¹Ù„Ù…',        v2024:78.50, v2025:78.50, subs:[
    { id:'achievement', name:'Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ', v:80.25 },
    { id:'devsoc',      name:'Ø§Ù„ØªØ·ÙˆØ± Ø§Ù„Ø´Ø®ØµÙŠ ÙˆØ§Ù„ØµØ­ÙŠ ÙˆØ§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ', v:86.25 }
  ]},
  environment:  { name:'Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©',     v2024:64.00, v2025:62.25, subs:[
    { id:'safety',      name:'Ø§Ù„Ø£Ù…Ù† ÙˆØ§Ù„Ø³Ù„Ø§Ù…Ø©', v:79.25 },
    { id:'building',    name:'Ø§Ù„Ù…Ø¨Ù†Ù‰ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ', v:71.50 }
  ]}
};

/* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© (Ù†Ù…Ø§Ø°Ø¬ Ù…Ù‚ØªØ¶Ø¨Ø© â€“ Ø¶Ø¹ ÙƒÙ„ Ø¬Ø¯ÙˆÙ„Ùƒ Ù‡Ù†Ø§) */
const detailed = {
  management: [
    {level:'Ù…Ù…ØªØ§Ø²', perf:94.50, indicator:'ØªÙ„ØªØ²Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø¨Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø³Ù„Ø§Ù…Ø© ÙˆØ§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø· ÙˆØªØªØ§Ø¨Ø¹ ØªØ·Ø¨ÙŠÙ‚Ù‡Ø§ Ø¨Ø§Ø³ØªÙ…Ø±Ø§Ø±.', improve:'ØªØ¹Ø²ÙŠØ² Ù†Ø´Ø± Ø§Ù„Ù‚ÙŠÙ… ÙˆØ§Ù„Ù‚Ø¯ÙˆØ© ÙˆØ±Ø¨Ø·Ù‡Ø§ Ø¨Ø§Ù„Ø´Ø±Ø§ÙƒØ© Ø§Ù„Ù…Ø¬ØªÙ…Ø¹ÙŠØ©.', evidence:'Ù„ÙˆØ­Ø§Øª Ø§Ù„Ø³Ù„ÙˆÙƒ â€“ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø· â€“ Ù…Ù†ØµØ© Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø·', tag:'ok'},
    {level:'Ù…Ø±ØªÙØ¹', perf:90.25, indicator:'ØªØ¹Ù…Ù„ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø¹Ù„Ù‰ ØªÙ‡ÙŠØ¦Ø© Ø¨ÙŠØ¦Ø© Ù…Ø¯Ø±Ø³ÙŠØ© Ø¢Ù…Ù†Ø© ÙˆØªØ¬Ù‡ÙŠØ²Ù‡Ø§.', improve:'ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… ØªØªØ¨Ø¹ ØµÙŠØ§Ù†Ø© Ù…Ø±Ø§ÙÙ‚ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ÙˆØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„.', evidence:'ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØµÙŠØ§Ù†Ø© â€“ ØµÙˆØ± Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ â€“ Ù…Ø­Ø§Ø¶Ø± Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²', tag:'ok'},
    {level:'Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§', perf:85.25, indicator:'ØªØªØ§Ø¨Ø¹ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ØªÙ†ÙÙŠØ° Ø®Ø·ØªÙ‡Ø§ Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ© ÙˆØªØ·ÙˆØ±Ù‡Ø§.', improve:'ØªØ·ÙˆÙŠØ± Ù„ÙˆØ­Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø¥Ù†Ø¬Ø§Ø².', evidence:'Ø³Ø¬Ù„Ø§Øª ØªÙ†ÙÙŠØ°ÙŠØ© â€“ Ù†Ù…Ø§Ø°Ø¬ Ù…ØªØ§Ø¨Ø¹Ø© â€“ ØªÙ‚Ø§Ø±ÙŠØ± Ø£Ø¯Ø§Ø¡', tag:'ok'},
    {level:'Ø¬ÙŠØ¯', perf:70.25, indicator:'ØªÙ‚Ù„ ÙØ§Ø¹Ù„ÙŠØ© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ø¯Ø§Ø¹Ù…Ø© Ù„Ù„ØªØ­Ø³ÙŠÙ†.', improve:'ØªØµÙ…ÙŠÙ… Ø±ÙˆØ²Ù†Ø§Ù…Ø© Ø±Ù‚Ù…ÙŠØ© Ø°ÙƒÙŠØ© ÙˆØ¬Ø¯ÙˆÙ„Ø© Ù…Ù‡Ø§Ù… Ø§Ù„ÙØ±Ù‚.', evidence:'Ø³Ø¬Ù„Ø§Øª Ø±Ù‚Ù…ÙŠØ© â€“ ØªÙ‚Ø§Ø±ÙŠØ± ØªØ´ØºÙŠÙ„ÙŠØ© â€“ Ø³Ø¬Ù„Ø§Øª ÙØ±ÙŠÙ‚', tag:'bad'}
  ],
  teaching: [
    {level:'Ù…Ù…ØªØ§Ø²', perf:99.25, indicator:'ØªÙ‚Ø¯Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø¨Ø±Ø§Ù…Ø¬ Ø¥Ø«Ø±Ø§Ø¦ÙŠØ© Ù†ÙˆØ¹ÙŠØ© Ù„Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†', improve:'Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø§Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆÙÙ‚ Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬Ø§Øª Ø§Ù„Ù…Ù‡Ù†ÙŠØ© ÙˆØªÙˆØ«ÙŠÙ‚ Ø£Ø«Ø±Ù‡.', evidence:'Ø®Ø·Ø· ØªØ¯Ø±ÙŠØ¨ â€“ Ù†Ù…Ø§Ø°Ø¬ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ø«Ø± â€“ ØªÙ‚Ø§Ø±ÙŠØ± Ø²ÙŠØ§Ø±Ø§Øª ØµÙÙŠØ©', tag:'ok'},
    {level:'Ù…Ø±ØªÙØ¹', perf:93.25, indicator:'ÙŠÙ†ØªÙ‚ÙŠ Ø§Ù„Ù…Ø¹Ù„Ù…ÙˆÙ† Ø£Ø¯ÙˆØ§Øª ØªÙ‚ÙˆÙŠÙ… ØªØ­Ù‚Ù‚ Ù†ÙˆØ§ØªØ¬ Ø§Ù„ØªØ¹Ù„Ù….', improve:'ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø¨Ø´ÙƒÙ„ Ø¯ÙˆØ±ÙŠ ÙˆÙˆØ¶Ø¹ Ø®Ø·Ø· Ø¹Ù„Ø§Ø¬ÙŠØ©.', evidence:'Ø³Ø¬Ù„Ø§Øª ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ â€“ Ø®Ø·Ø· Ø¹Ù„Ø§Ø¬ â€“ Ø£Ø¯ÙˆØ§Øª ØªÙ‚ÙˆÙŠÙ…', tag:'ok'},
    {level:'Ø¬ÙŠØ¯', perf:76.75, indicator:'ØªØ­ØªØ§Ø¬ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø¥Ù„Ù‰ ØªØ·ÙˆÙŠØ± Ø§Ù„ØªÙ†ÙˆØ¹ ÙÙŠ Ø£Ø³Ø§Ù„ÙŠØ¨ Ø§Ù„ØªØ¹Ù„Ù….', improve:'ØªØµÙ…ÙŠÙ… Ø£Ù†Ø´Ø·Ø© ØªØ¹Ù„Ù… Ù†Ø´Ø·Ø© ÙˆÙ…Ù‡Ø§Ù… Ø£ØµÙŠÙ„Ø© Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø­ÙŠØ§Ø©.', evidence:'Ù…Ù„ÙØ§Øª Ù…Ø´Ø§Ø±ÙŠØ¹ â€“ Ù…Ù†ØªØ¬ ØªØ¹Ù„Ù… â€“ Ù…Ø­Ø§Ø¶Ø± ØªÙ‚ÙŠÙŠÙ…', tag:'bad'}
  ],
  learning: [
    {level:'Ù…Ù…ØªØ§Ø²', perf:96.75, indicator:'ÙŠØ¸Ù‡Ø± Ø§Ù„Ù…ØªØ¹Ù„Ù…ÙˆÙ† Ø§Ø¹ØªØ²Ø§Ø²Ø§Ù‹ Ø¨Ù‚ÙŠÙ…Ù‡Ù… ÙˆÙ‡ÙˆÙŠØªÙ‡Ù… Ø§Ù„ÙˆØ·Ù†ÙŠØ©.', improve:'ØªØ¹Ø²ÙŠØ² Ø±Ø¨Ø· Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø¨Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ÙˆØ·Ù†ÙŠØ© Ø¹Ø¨Ø± Ø§Ù„Ù…Ù†ØµØ§Øª.', evidence:'Ù…Ù†ØªØ¬Ø§Øª Ø·Ù„Ø§Ø¨ÙŠØ© â€“ ØµÙˆØ± ÙØ¹Ø§Ù„ÙŠØ§Øª â€“ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù‡ÙˆÙŠØ©', tag:'ok'},
    {level:'Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§', perf:91.75, indicator:'ÙŠØ¸Ù‡Ø± Ø§Ù„Ù…ØªØ¹Ù„Ù…ÙˆÙ† Ø§ØªØ¬Ø§Ù‡Ø§Øª Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ© Ù†Ø­Ùˆ Ø°ÙˆØ§ØªÙ‡Ù….', improve:'ØªÙ†ÙÙŠØ° Ø¨Ø±Ù†Ø§Ù…Ø¬ Â«Ø£Ù†Ø§ Ø£ØµÙ„Ø­Â» Ù„ØªÙ†Ù…ÙŠØ© Ø§Ù„Ø«Ù‚Ø© Ø¨Ø§Ù„Ù†ÙØ³.', evidence:'ØµÙˆØ± Ø¨Ø±Ø§Ù…Ø¬ â€“ ØªÙ‚Ø§Ø±ÙŠØ± ØªÙ‚ÙŠÙŠÙ… â€“ Ù†ØªØ§Ø¦Ø¬ Ø§Ø³ØªØ¨ÙŠØ§Ù†Ø§Øª', tag:'ok'},
    {level:'Ø¬ÙŠØ¯', perf:82.94, indicator:'ÙŠØ­Ù‚Ù‚ Ø§Ù„Ù…ØªØ¹Ù„Ù…ÙˆÙ† Ù†ØªØ§Ø¦Ø¬ Ù…ØªÙØ§ÙˆØªØ© ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª.', improve:'ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ù†Ø®ÙØ¶Ø© ÙˆÙˆØ¶Ø¹ Ø®Ø·Ø· ØªØ­Ø³ÙŠÙ† ÙØ±Ø¯ÙŠØ©.', evidence:'ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ â€“ Ø®Ø·Ø· Ø¹Ù„Ø§Ø¬ â€“ Ù…ØªØ§Ø¨Ø¹Ø© ÙØ±Ø¯ÙŠØ©', tag:'bad'}
  ],
  environment: [
    {level:'Ù…Ù…ØªØ§Ø²', perf:97.50, indicator:'ØªØ¹Ù…Ù„ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø¹Ù„Ù‰ ØªÙ‡ÙŠØ¦Ø© ÙˆØµÙŠØ§Ù†Ø© Ø¬Ù…ÙŠØ¹ Ù…Ø±Ø§ÙÙ‚ Ø§Ù„Ù…Ø¨Ù†Ù‰.', improve:'Ø§Ø³ØªØ­Ø¯Ø§Ø« Ø³Ø¬Ù„ Ø±Ù‚Ù…ÙŠ Ù„Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„ÙˆÙ‚Ø§Ø¦ÙŠØ© ÙˆØªØ­Ø¯ÙŠØ¯ Ø®Ø·Ø© Ø¯ÙˆØ±ÙŠØ©.', evidence:'ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØµÙŠØ§Ù†Ø© â€“ ØµÙˆØ± Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ â€“ Ù…Ø­Ø§Ø¶Ø± Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²', tag:'ok'},
    {level:'Ø¬ÙŠØ¯', perf:73.25, indicator:'ØªØªÙ„Ù…Ù‘ÙØ³ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ù…Ù„Ø§Ø¡Ù…Ø© Ø¨ÙŠØ¦Ø© Ø§Ù„ØªØ¹Ù„Ù… Ù„Ù„Ù…ØªØ¹Ù„Ù…ÙŠÙ† Ø¨Ø´ÙƒÙ„ Ù…ØªÙˆØ³Ø·.', improve:'ØªØ·ÙˆÙŠØ± Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„ØµÙÙŠØ© Ø¨Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© ÙˆØ§Ù„Ø¬Ù„Ù€Ø³Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©.', evidence:'ØµÙˆØ± Ø§Ù„ÙØµÙˆÙ„ â€“ Ø§Ø³ØªØ¨ÙŠØ§Ù†Ø§Øª Ø±Ø¶Ø§ â€“ ØªÙ‚Ø§Ø±ÙŠØ± Ø¥Ø´Ø±Ø§ÙÙŠØ©', tag:'bad'},
    {level:'Ù…ØªÙˆØ³Ø·', perf:62.50, indicator:'ØªÙˆÙØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¥Ø¶Ø§Ø¡Ø© ÙˆØ§Ù„ØªÙ‡ÙˆÙŠØ© Ø¨Ù…Ø§ ÙŠØ­Ù‚Ù‚ Ø¨ÙŠØ¦Ø© ØµØ­ÙŠØ©.', improve:'ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¥Ø¶Ø§Ø¡Ø© ÙÙŠ Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆØµÙŠØ§Ù†Ø© Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ØªÙ‡ÙˆÙŠØ©.', evidence:'ØªÙ‚Ø§Ø±ÙŠØ± ÙÙ†ÙŠØ© â€“ ØµÙˆØ± Ø§Ù„ØµÙŠØ§Ù†Ø© â€“ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø±Ø§ÙÙ‚', tag:'bad'}
  ]
};

/* ===== Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„Ù„Ø´ÙˆØ§Ù‡Ø¯ ===== */
const STORE='yaqoubi_evidence_1447';
const mem=JSON.parse(localStorage.getItem(STORE)||'{}');
function saveMem(){ localStorage.setItem(STORE, JSON.stringify(mem)); }

/* ØªØ¬Ù‡ÙŠØ² Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ */
const eviWeekSel=document.getElementById('eviWeek');
WEEKS.forEach(w=>{ const o=document.createElement('option'); o.value=w.id;o.textContent=w.name; eviWeekSel.appendChild(o); });

/* ========= Ø±Ø³Ù… Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¬Ø§Ù„Ø§Øª ========= */
function renderDashboard(){
  const dash=document.getElementById('dashboard'); dash.innerHTML='';
  Object.entries(fields).forEach(([key,f])=>{
    const lvl=levelOf(f.v2025);
    const card=document.createElement('div'); card.className='card'; card.id=`card-${key}`;
    card.innerHTML=`
      <h2>${f.name}</h2>
      <div class="kpi"><span>2024: ${fmt(f.v2024)}% â†’ 2025: ${fmt(f.v2025)}%</span>
        <span class="badge" style="background:${lvl.color}22;color:${lvl.color}">${lvl.txt}</span></div>
      <div class="progress"><div class="bar" style="width:${Math.max(2,f.v2025)}%"></div></div>
      <div class="titleRow">
        <h3 class="small">Ø§Ø¶ØºØ· Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</h3>
        <div class="donutWrap"><canvas id="donut-${key}" height="120"></canvas></div>
      </div>
      <div class="detail" id="detail-${key}"></div>
    `;
    card.addEventListener('click', (e)=>{
      // Ù„Ø§ Ù†ØºÙ„Ù‚ Ø¹Ù†Ø¯ Ø¶ØºØ· Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„ØªÙØµÙŠÙ„
      if(e.target.closest('button') || e.target.closest('a') || e.target.closest('input') || e.target.closest('select')) return;
      toggleDetail(key);
    });
    dash.appendChild(card);

    // Ø¯Ø§Ø¦Ø±Ø© Ø¹Ù„ÙˆÙŠØ© ÙÙ‚Ø·
    const ctx=document.getElementById(`donut-${key}`).getContext('2d');
    new Chart(ctx,{type:'doughnut',
      data:{labels:f.subs.map(s=>s.name),datasets:[{data:f.subs.map(s=>s.v),backgroundColor:['#2aa897','#5d9ed6','#f1ad5b','#7ac6b7','#91a7ff','#a5d8a6']}]},
      options:{plugins:{legend:{display:false}},cutout:'70%'}
    });
  });
}

/* ======= ÙØªØ­ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¬Ø§Ù„ ======= */
function toggleDetail(key){
  const dash=document.getElementById('dashboard');
  Array.from(dash.children).forEach(c=>{ if(c.id!==`card-${key}`) c.style.display='none'; });
  const f=fields[key]; const box=document.getElementById(`detail-${key}`);
  const open=box.style.display==='block';
  if(open){ box.style.display='none'; Array.from(dash.children).forEach(c=>c.style.display=''); return; }

  // Ø¹Ù†ÙˆØ§Ù† ÙˆÙ…Ù„Ø®Øµ ÙˆØ¯ÙˆÙ†Øª Ø¹Ù„ÙˆÙŠØ© (Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©)
  // Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„ØµØºÙŠØ±Ø© Ù„Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ© (ØµØºÙ‘Ø±Øª Ø§Ù„Ø¯ÙˆØ§Ø¦Ø± ÙƒÙŠ ØªÙƒÙˆÙ† Ù…Ù†Ø³Ù‘Ù‚Ø©)
  const subsHtml = f.subs.map(s=>`
    <div class="subCard">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>${s.name}</strong>
        <span class="badge" style="background:${levelOf(s.v).color}22;color:${levelOf(s.v).color}">${fmt(s.v)}%</span>
      </div>
      <div class="small">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø¤Ø´Ø± Ø§Ù„ÙØ±Ø¹ÙŠ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¬Ø§Ù„</div>
    </div>`).join('');

  // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ
  const rows = (detailed[key]||[]).map((r,i)=>{
    const rowCls = r.tag==='bad' ? 'row-bad' : (r.tag==='ok' ? 'row-ok':'');
    const rowKey = `${key}::${i}`;
    const evis = (mem[rowKey]||[]).map((e,j)=>(
      `<div class="small">â€¢ ${e.hijri} â€“ ${e.text} â€” <a href="${e.link}" target="_blank">Ù…Ù„Ù Ø§Ù„Ø´Ø§Ù‡Ø¯</a></div>`
    )).join('');
    return `<tr class="${rowCls}">
      <td class="level">${r.level}</td>
      <td>${fmt(r.perf)}%</td>
      <td>${r.indicator}</td>
      <td>${r.improve}</td>
      <td>
        <div>${r.evidence}</div>
        ${evis?`<div style="margin-top:6px">${evis}</div>`:''}
        <div class="actionsRow">
          <button class="btn light" onclick="openEvidence('${key}',${i})">Ø¥Ø¶Ø§ÙØ© Ø´Ø§Ù‡Ø¯ +</button>
          <button class="btn" onclick="openFieldReport('${key}')">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¬Ø§Ù„ PDF</button>
          <button class="btn" onclick="openFieldPlan('${key}')">Ø®Ø·Ø© ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø¬Ø§Ù„ PDF</button>
        </div>
      </td>
    </tr>`;
  }).join('');

  box.innerHTML=`
    <div class="subgrid">${subsHtml}</div>
    <div class="tableWrap">
      <table>
        <thead>
          <tr><th>Ø§Ù„Ù…Ø³ØªÙˆÙ‰</th><th>Ù†Ø³Ø¨Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡</th><th>Ø§Ù„Ù…Ø¤Ø´Ø±</th><th>Ù…Ù‚ØªØ±Ø­Ø§Øª Ø§Ù„ØªØ­Ø³ÙŠÙ†</th><th>Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯</th></tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
      <div class="actionsRow" style="justify-content:flex-end;margin-top:10px">
        <button class="btn light" onclick="resetView()">Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¬Ø§Ù„Ø§Øª â†©ï¸</button>
      </div>
    </div>`;
  box.style.display='block';
}

function resetView(){
  const dash=document.getElementById('dashboard');
  Array.from(dash.children).forEach(c=>c.style.display='');
  document.querySelectorAll('.detail').forEach(d=>d.style.display='none');
}

/* ===== Ù†Ø§ÙØ°Ø© Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯ ===== */
let currentEvi = { key:'', idx:0 };
function openEvidence(fieldKey, rowIdx){
  currentEvi={key:fieldKey, idx:rowIdx};
  document.getElementById('eviOwner').value = `${fields[fieldKey].name} â€” Ø¨Ù†Ø¯ ${rowIdx+1}`;
  document.getElementById('eviText').value='';
  document.getElementById('eviHijri').value=todayHijri();
  document.getElementById('eviLink').value='';
  document.getElementById('eviTerm').value='Ø§Ù„Ø£ÙˆÙ„';
  document.getElementById('eviDay').value='Ø§Ù„Ø£Ø­Ø¯';
  document.getElementById('eviWeek').value=WEEKS[2].id;
  document.getElementById('eviModal').style.display='flex';
}
function closeEvidence(){ document.getElementById('eviModal').style.display='none'; }

document.getElementById('eviClose').onclick=closeEvidence;
document.getElementById('eviCancel').onclick=closeEvidence;
document.getElementById('eviSave').onclick=function(){
  const text=document.getElementById('eviText').value.trim();
  const term=document.getElementById('eviTerm').value;
  const day=document.getElementById('eviDay').value;
  const week=document.getElementById('eviWeek').value;
  const hijri=document.getElementById('eviHijri').value.trim() || todayHijri();
  const link=document.getElementById('eviLink').value.trim();
  if(!text && !link){ alert('Ø£Ø¯Ø®Ù„ ÙˆØµÙ Ø§Ù„Ø´Ø§Ù‡Ø¯ Ø£Ùˆ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù'); return; }

  const k=`${currentEvi.key}::${currentEvi.idx}`;
  mem[k]=mem[k]||[];
  mem[k].push({text,term,day,week,hijri,link,ts:Date.now()});
  saveMem();
  closeEvidence();
  // Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ø§Ù„ØªÙØµÙŠÙ„ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
  toggleDetail(currentEvi.key); toggleDetail(currentEvi.key);
};

/* ======= ØªØ§Ø±ÙŠØ® Ù‡Ø¬Ø±ÙŠ ======= */
function todayHijri(){
  try{
    // Ø£Ù… Ø§Ù„Ù‚Ø±Ù‰/Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ
    const fmt=new Intl.DateTimeFormat('ar-SA-u-ca-islamic', {year:'numeric',month:'2-digit',day:'2-digit'});
    return fmt.format(new Date()).replace(/\s/g,'');
  }catch(e){ return '1447/--/--'; }
}

/* ===== ØªÙˆÙ„ÙŠØ¯ Ø±Ø£Ø³ Ø§Ù„ØªÙ‚Ø±ÙŠØ±/Ø§Ù„Ø®Ø·Ø© ===== */
function reportHeaderHTML(){
  return `
  <div style="display:grid;grid-template-columns:1fr 160px 1fr;align-items:center;gap:14px;margin-bottom:10px">
    <div style="text-align:left;line-height:1.6;font-weight:700;color:#0b7e88">
      <div>Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</div>
      <div>ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…</div>
      <div>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø¨Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø±Ù‚ÙŠØ©</div>
      <div>Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ</div>
    </div>
    <div style="text-align:center"><img src="ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ….png" alt="MoE" style="height:84px"/></div>
    <div style="text-align:right;font-weight:700">Ø§Ù„ÙŠÙˆÙ…/Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù‡Ø¬Ø±ÙŠ): ${todayHijri()}</div>
  </div>`;
}

/* ===== ÙØªØ­ Ù†Ø§ÙØ°Ø© ÙˆØ·Ø¨Ø§Ø¹Ø© ===== */
function openDocWindow(title, contentHTML, filename){
  const w=window.open('', '_blank');
  if(!w){ alert('ØªØ¹Ø±Ù‘Ø¶ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©: ÙØ¶Ù„Ø§Ù‹ Ø§Ø³Ù…Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©.'); return; }
  const docHTML=`
  <!DOCTYPE html><html lang="ar" dir="rtl">
  <head><meta charset="utf-8"/><title>${title}</title>
  <style>
    body{font-family:'Tajawal',sans-serif;margin:18px;background:#fff;color:#06353b}
    h2{margin:8px 0;color:#0b7e88}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    thead th{background:#0f6f79;color:#fff;padding:8px}
    td{padding:8px;border:1px solid #e7eff0;vertical-align:top}
    .row-ok{background:#e8fff5}.row-bad{background:#fff3f3}
    .btn{padding:8px 12px;border:1px solid #0b7e88;border-radius:8px;background:#0b7e88;color:#fff;cursor:pointer;margin-left:6px}
    .toolbar{position:sticky;top:0;background:#fff;padding:6px 0;margin:6px 0;border-bottom:1px dashed #e1ecec}
    @media print{.toolbar{display:none}}
  </style></head>
  <body>
    ${reportHeaderHTML()}
    ${contentHTML}
    <div class="toolbar no-print">
      <button class="btn" onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø©</button>
      <button class="btn" onclick="window.close()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </body></html>`;
  w.document.open(); w.document.write(docHTML); w.document.close();
}

/* ===== Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ===== */
function buildFieldReportHTML(key){
  const f=fields[key]; const lvl=levelOf(f.v2025);
  const list = (detailed[key]||[]).map((r,i)=>{
    const rowKey=`${key}::${i}`;
    const evis=(mem[rowKey]||[]).map(e=>`<div>â€¢ ${e.hijri} â€” ${e.text}${e.link?` â€” <a href='${e.link}' target='_blank'>Ù…Ù„Ù</a>`:''}</div>`).join('');
    const cls=r.tag==='bad'?'row-bad':(r.tag==='ok'?'row-ok':'');
    return `<tr class="${cls}"><td>${r.level}</td><td>${fmt(r.perf)}%</td><td>${r.indicator}</td><td>${r.improve}</td><td>${r.evidence}${evis?`<div style="margin-top:6px">${evis}</div>`:''}</td></tr>`;
  }).join('');
  return `
  <h2>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¬Ø§Ù„: ${f.name}</h2>
  <div>Ø§Ù„Ø£Ø¯Ø§Ø¡ 2024: ${fmt(f.v2024)}% â€” Ø§Ù„Ø£Ø¯Ø§Ø¡ 2025: ${fmt(f.v2025)}% â€” Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${lvl.txt}</div>
  <table><thead><tr><th>Ø§Ù„Ù…Ø³ØªÙˆÙ‰</th><th>Ù†Ø³Ø¨Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡</th><th>Ø§Ù„Ù…Ø¤Ø´Ø±</th><th>Ù…Ù‚ØªØ±Ø­Ø§Øª Ø§Ù„ØªØ­Ø³ÙŠÙ†</th><th>Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯</th></tr></thead>
  <tbody>${list}</tbody></table>`;
}
function buildFieldPlanHTML(key){
  // Ø§Ø³ØªÙ†Ø¨Ø§Ø· Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù…Ø®ØªØµØ±Ø© Ù…Ù† Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
  const rows=(detailed[key]||[]).map((r,i)=>({
    action:r.improve, week:WEEKS[2].id, kpi:r.indicator.slice(0,60)+'â€¦', ev:r.evidence
  }));
  const tr=rows.map(r=>`<tr><td>${r.action}</td><td>${r.week}</td><td>${r.kpi}</td><td>${r.ev}</td></tr>`).join('');
  return `<h2>Ø®Ø·Ø© ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø¬Ø§Ù„: ${fields[key].name}</h2>
  <table><thead><tr><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th><th>Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ (Ù‡Ø¬Ø±ÙŠ)</th><th>Ø§Ù„Ù…Ø¤Ø´Ø±</th><th>Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯</th></tr></thead><tbody>${tr}</tbody></table>`;
}
async function openFieldReport(key){ openDocWindow('ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¬Ø§Ù„', buildFieldReportHTML(key), `report_${key}.pdf`); }
async function openFieldPlan(key){ openDocWindow('Ø®Ø·Ø© ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø¬Ø§Ù„', buildFieldPlanHTML(key), `plan_${key}.pdf`); }

/* ===== ØªÙ‚Ø§Ø±ÙŠØ±/Ø®Ø·Ø· Ø´Ø§Ù…Ù„Ø© ===== */
function buildComprehensive(kind){
  const title=(kind==='plan')?'Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªØ­Ø³ÙŠÙ†ÙŠØ© Ø§Ù„Ø´Ø§Ù…Ù„Ø© â€” Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ':'Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„ â€” Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ';
  const list=Object.keys(fields).map(k=>`<li><strong>${fields[k].name}:</strong> 2024 ${fmt(fields[k].v2024)}% â†’ 2025 ${fmt(fields[k].v2025)}%</li>`).join('');
  const block = (kind==='plan')
    ? `<table><thead><tr><th>Ø§Ù„Ù…Ø¬Ø§Ù„</th><th>Ø£Ø¨Ø±Ø² Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody>${
        Object.keys(fields).map(k=>`<tr><td>${fields[k].name}</td><td>${(detailed[k]||[]).slice(0,3).map(r=>r.improve).join(' â€” ')}</td></tr>`).join('')
      }</tbody></table>`
    : `<ul>${list}</ul>`;
  return `<h2>${title}</h2>${block}`;
}
function exportComprehensive(kind){
  openDocWindow(kind==='plan'?'Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©':'Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„', buildComprehensive(kind), (kind==='plan'?'plan_all':'report_all')+'.pdf');
}

/* Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
document.getElementById('btnAnalyze').addEventListener('click', renderDashboard);
document.getElementById('btnFullReport').addEventListener('click', ()=>exportComprehensive('report'));
document.getElementById('btnFullPlan').addEventListener('click', ()=>exportComprehensive('plan'));

/* ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ */
renderDashboard();
</script>
</body>
</html>
