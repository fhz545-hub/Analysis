<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>منصة التحليل الذكي – ثانوية اليعقوبي بالخبر</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--moe:#0f7a66;--ink:#0d2f2c;--ring:#d6efe9;--lite:#e8f4f1;--bg:#f7fbfa;--bad:#e11d48;--warn:#f59e0b;--ok:#0ea5a0;--accent:#1d4ed8}
*{box-sizing:border-box}
body{font-family:'Tajawal',system-ui,Arial;background:linear-gradient(180deg,#fff 0%,var(--bg) 100%);color:var(--ink);margin:0}
header{background:#063c39;color:#fff}
.hdr{max-width:1300px;margin:auto;display:flex;gap:14px;align-items:center;padding:12px 14px}
.hdr img{height:54px;width:auto;border-radius:6px;background:#fff}
.hdr .t{line-height:1.4}
.hdr .t .b{font-weight:800}
.shell{max-width:1300px;margin:auto;padding:12px}
.grid{display:grid;grid-template-columns:2fr 1fr;gap:12px}
@media(max-width:1100px){.grid{grid-template-columns:1fr}}
.card{background:#fff;border:1px solid var(--ring);border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:12px}
.card h3{margin:4px 0 10px;color:var(--moe)}
.small{font-size:12px;color:#567}
.flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{background:var(--moe);color:#fff;border:none;border-radius:12px;padding:9px 14px;font-weight:800;cursor:pointer}
.btn.ghost{background:#fff;color:#0a3d36;border:1.6px solid var(--moe)}
.btn.warn{background:var(--warn)} .btn.bad{background:var(--bad)} .btn.acc{background:var(--accent)}
.input{display:flex;flex-direction:column;gap:4px}
.input input[type="number"]{width:80px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border:1px solid var(--ring);padding:8px;text-align:right;vertical-align:top}
.table th{background:var(--lite);color:var(--moe)}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.kpi{border:1px solid var(--ring);border-radius:12px;padding:10px;text-align:center}
.kpi .v{font-size:20px;font-weight:800}
.badge{padding:2px 8px;border-radius:999px;font-size:11px;color:#fff;background:var(--bad)}
.gauge{height:14px;background:#eee;border-radius:999px;overflow:hidden}
.gauge>div{height:100%;background:linear-gradient(90deg,#ef4444,#f59e0b,#10b981);width:0%}
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.25);display:none;align-items:center;justify-content:center;z-index:99}
.spin{width:56px;height:56px;border-radius:50%;border:6px solid #fff;border-top-color:transparent;animation:sp 1s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
.notice{display:none;background:#fff7d6;color:#7a4d00;padding:10px 14px;border-bottom:2px solid #f7d382;text-align:center}
footer{color:#567;text-align:center;font-size:12px;margin:14px 0}
canvas{max-width:100%}
</style>

<!-- المكتبات – مؤجلة التحميل -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.worker.min.js" defer></script>
<script>document.addEventListener('DOMContentLoaded',()=>{if(window.pdfjsLib){pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.worker.min.js"}})</script>
<script src="https://unpkg.com/mammoth/mammoth.browser.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>
</head>
<body>
<div class="notice" id="serverNotice">لكي تعمل PDF/OCR وقراءة PDF/Word بسلاسة افتح الصفحة عبر خادم محلي مثل: <code>http://localhost:5500</code> (وليس <code>file:///</code>).</div>

<header>
  <div class="hdr">
    <img src="logo.png" alt="شعار وزارة التعليم" onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/thumb/6/69/Ministry_of_Education_Logo.svg/240px-Ministry_of_Education_Logo.svg.png'">
    <div class="t">
      <div class="b">وزارة التعليم – الإدارة العامة للتعليم بالمنطقة الشرقية – قطاع التعليم بالخبر</div>
      <div>مدرسة اليعقوبي الثانوية</div>
      <div style="opacity:.9">منصة التحليل والتحسين المدرسي الذكي (1447هـ)</div>
    </div>
  </div>
</header>

<div class="shell">
  <div class="grid">
    <section class="card">
      <h3>مؤشر المدرسة العام (School Performance Index)</h3>
      <div class="gauge"><div id="schoolGauge"></div></div>
      <div class="small" style="margin-top:6px">يُحسب المؤشر من: تحسين المتوسطات (40%) + تقليص %الضعيف (30%) + CV (20%) + تحسن الممتاز (10%).</div>
    </section>
    <aside class="card">
      <h3>استيراد البيانات</h3>
      <div class="flex" style="justify-content:space-between">
        <div class="input"><label>الملف (الفترة 1)</label><input id="f1" type="file" accept=".xlsx,.xls,.csv,.pdf,.doc,.docx,.txt,image/*"></div>
        <div class="input"><label>الملف (الفترة 2) اختياري</label><input id="f2" type="file" accept=".xlsx,.xls,.csv,.pdf,.doc,.docx,.txt,image/*"></div>
      </div>
      <div class="flex" style="margin-top:8px">
        <button class="btn" id="analyze">🔍 تحليل الملفات</button>
        <button class="btn ghost" id="demo">📄 نموذج CSV</button>
      </div>
      <hr>
      <h3>خيارات التحليل</h3>
      <div class="flex">
        <div class="input"><label>% حد الضعيف</label><input id="thWeak" type="number" value="20" min="0" max="100"></div>
        <div class="input"><label>متوسط أقل من</label><input id="thAvg" type="number" value="75" min="0" max="100"></div>
        <div class="input"><label>≤ CV%</label><input id="thCV" type="number" value="18" min="0" max="100"></div>
        <div class="input"><label>≤ Std</label><input id="thStd" type="number" value="12" min="0" max="100"></div>
      </div>
      <div class="flex" style="margin-top:8px">
        <button class="btn warn" id="mkPlan">🧭 توليد خطة SMART</button>
        <button class="btn acc" id="expX">🧾 تصدير Excel</button>
      </div>
    </aside>
  </div>

  <section class="card">
    <h3>مؤشرات رئيسية (KPIs)</h3>
    <div class="kpis" id="kpis"></div>
    <h3 style="margin-top:8px">الرسوم التحليلية</h3>
    <div class="flex" style="justify-content:space-between;align-items:center">
      <div class="flex">
        <label class="small">الصف:</label><select id="grade"><option value="all">جميع الصفوف</option></select>
        <label class="small">المادة:</label><select id="subject"><option value="all">جميع المواد</option></select>
        <label class="small">نمط الرسم:</label><select id="chartType"><option value="bar">أعمدة</option><option value="radar">رادار</option></select>
      </div>
      <div class="flex">
        <button class="btn ghost" id="savePdf">📄 حفظ PDF</button>
        <button class="btn bad" id="reset">♻️ إعادة ضبط</button>
      </div>
    </div>
    <canvas id="chart" height="260" style="margin-top:8px"></canvas>
    <canvas id="radar" height="260" style="display:none;margin-top:8px"></canvas>
  </section>

  <section class="card">
    <h3>خريطة الفجوات (Heatmap) + التحليل المقارن والتوصيات الذكية</h3>
    <table class="table">
      <thead><tr>
        <th>الصف</th><th>المادة</th><th>عدد</th><th>متوسط</th><th>% ضعيف</th><th>% ممتاز</th>
        <th>CV%</th><th>Std</th><th>التشخيص الذكي</th>
      </tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </section>

  <section class="card" id="planCard">
    <div class="flex" style="justify-content:space-between;align-items:center">
      <h3>خطة تحسين Auto-SMART (مرتبطة خوارزميًا بالتحليل)</h3>
      <div class="gauge" style="width:280px"><div id="schoolGauge2"></div></div>
    </div>
    <table class="table" id="planTbl">
      <thead><tr><th>#</th><th>المجال/المادة</th><th>الهدف (SMART)</th><th>الفصل</th><th>الأسابيع</th><th>الإجراء</th><th>المسؤول</th><th>المؤشر</th><th>الشواهد</th></tr></thead>
      <tbody id="planBody"></tbody>
    </table>
  </section>
</div>

<div id="overlay"><div class="spin"></div></div>
<footer>© ثانوية اليعقوبي الثانوية بالخبر – ١٤٤٧هـ | قائد المدرسة: فهد حامد الزهراني</footer>

<script>
/* ================== أدوات مساعدة موثوقة ================== */
const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
const showBusy=on=>{ $('#overlay').style.display=on?'flex':'none' };
if(location.protocol==='file:'){ $('#serverNotice').style.display='block' }
const { jsPDF } = window.jspdf || {};

// أرقام عربية/فارسية -> لاتينية + تنظيف
const AR_DIG='٠١٢٣٤٥٦٧٨٩', FA_DIG='۰۱۲۳۴۵۶۷۸۹';
function toLatinDigits(str){
  return String(str??'')
    .replace(/[\u0660-\u0669]/g,c=>AR_DIG.indexOf(c))
    .replace(/[\u06F0-\u06F9]/g,c=>FA_DIG.indexOf(c))
    .replace(/[\u200f\u200e\u202a-\u202c]/g,'');
}
const tidy = s => toLatinDigits(String(s??'').trim());
function pickNum(val){
  const s=tidy(val).replace(',', '.');
  const m=s.match(/(-?\d{1,3}(?:\.\d+)?)/);
  if(!m) return NaN;
  const x=+m[1];
  if(/%|٪/.test(s)) return Math.max(0,Math.min(100,x));
  return (x>=0 && x<=100)?x:NaN;
}

// إحصاء
const pct=(n,d)=>d?+(100*n/d).toFixed(2):0;
function mean(a){return a.length?a.reduce((s,x)=>s+x,0)/a.length:0}
function stddev(a){if(a.length<2)return 0;const m=mean(a);const v=a.reduce((s,x)=>s+(x-m)*(x-m),0)/(a.length-1);return Math.sqrt(v)}
function quantile(arr,q){const a=[...arr].sort((x,y)=>x-y);if(!a.length)return NaN;const p=(a.length-1)*q;const b=Math.floor(p), r=p-b;return a[b] + ((a[b+1]??a[b]) - a[b])*(r||0)}
function skewness(a){if(a.length<3)return 0;const m=mean(a),sd=stddev(a)||1,n=a.length;return (n/((n-1)*(n-2)))*a.reduce((s,x)=>s+Math.pow((x-m)/sd,3),0)}
const band=s=> s>=90?'ممتاز':s>=80?'جيد جدًا':s>=60?'جيد':'ضعيف';

/* ================== قراءة كل الأنواع ================== */
async function parseXlsxOrCsv(file){
  const wb = XLSX.read(await file.arrayBuffer(), {type:'array'});
  const sheet = wb.SheetNames[0];
  const rows = XLSX.utils.sheet_to_json(wb.Sheets[sheet], {header:1,defval:''}).filter(r=>r.some(c=>String(c).trim()!==''));
  if(!rows.length) return [];
  // تحديد صف العناوين تلقائيًا
  function headerScore(row){
    const keys=['الصف','grade','class','الشعبة','المادة','subject','course','الدرجة','score','mark','percent','النسبة','final'];
    let s=0; row.forEach(c=>{const t=tidy(c).toLowerCase(); if(keys.some(k=>t.includes(k))) s+=3; if(/[a-z\u0600-\u06FF]{3,}/i.test(t)) s+=1;});
    return s;
  }
  let hdr=0,best=-1;
  for(let i=0;i<Math.min(rows.length,30);i++){const sc=headerScore(rows[i]) + (rows[i].some(c=>/\d/.test(String(c)))?0:-1); if(sc>best){best=sc; hdr=i}}
  const headers=rows[hdr].map(tidy);
  // تعيين أعمدة
  let grade=-1,subject=-1,score=-1;
  headers.forEach((h,i)=>{ const t=String(h).toLowerCase();
    if(grade===-1 && /(الصف|الشعبة|grade|class)/.test(t)) grade=i;
    if(subject===-1 && /(المادة|المقرر|subject|course)/.test(t)) subject=i;
    if(score===-1 && /(الدرجة|score|mark|percent|النسبة|final)/.test(t)) score=i;
  });
  if(grade===-1||subject===-1||score===-1){ grade=0;subject=1;score=2; }
  const out=[];
  for(let i=hdr+1;i<rows.length;i++){
    const r=rows[i]; const g=tidy(r[grade]); const s=tidy(r[subject]); const sc=pickNum(r[score]);
    if(g && s && !isNaN(sc)) out.push({grade:g,subject:s,score:sc});
  }
  return out;
}
async function parsePdf(file){
  try{
    const pdf=await pdfjsLib.getDocument({data:await file.arrayBuffer()}).promise;
    let text=''; const max=Math.min(pdf.numPages,12);
    for(let p=1;p<=max;p++){const pg=await pdf.getPage(p);const tc=await pg.getTextContent();text+=' '+tc.items.map(i=>i.str).join(' ')}
    text=tidy(text);
    const out=[]; const re=/(أول ثانوي|ثاني ثانوي|ثالث ثانوي).*?(?:مادة|المادة)[:\s]*([\u0600-\u06FF\s]+?).*?(?:الدرجة|درجة|%|percent)[:\s]*(\d{1,3})/gi;
    let m; while((m=re.exec(text))){ out.push({grade:m[1],subject:m[2].trim(),score:+m[3]}) }
    if(out.length) return out;
  }catch(e){}
  // OCR احتياطي
  const buf=await file.arrayBuffer(); const pdf=await pdfjsLib.getDocument({data:buf}).promise;
  let ocr=''; const max=Math.min(pdf.numPages,6);
  for(let p=1;p<=max;p++){const pg=await pdf.getPage(p);const vp=pg.getViewport({scale:2});const c=document.createElement('canvas');c.width=vp.width;c.height=vp.height;await pg.render({canvasContext:c.getContext('2d'),viewport:vp}).promise;const {data}=await Tesseract.recognize(c.toDataURL(),'ara+eng'); ocr+=' '+(data.text||'');}
  const t=tidy(ocr); const out=[]; const rx=/(أول ثانوي|ثاني ثانوي|ثالث ثانوي).*?(?:مادة|المادة)[:\s]*([\u0600-\u06FF\s]+?).*?(?:الدرجة|درجة|%|percent)[:\s]*(\d{1,3})/gi;
  let m; while((m=rx.exec(t))){ out.push({grade:m[1],subject:m[2].trim(),score:+m[3]}) }
  return out;
}
async function parseWordOrTxt(file){
  const ext=file.name.split('.').pop().toLowerCase();
  let text='';
  if(ext==='txt'){ text=new TextDecoder().decode(await file.arrayBuffer()); }
  else{ const res=await window.mammoth.extractRawText({arrayBuffer:await file.arrayBuffer()}); text=res.value||''; }
  text=tidy(text);
  const out=[]; const re=/(أول ثانوي|ثاني ثانوي|ثالث ثانوي).*?(?:مادة|المادة)[:\s]*([\u0600-\u06FF\s]+?).*?(?:الدرجة|درجة|%|percent)[:\s]*(\d{1,3})/gi;
  let m; while((m=re.exec(text))){ out.push({grade:m[1],subject:m[2].trim(),score:+m[3]}) }
  return out;
}
async function parseImage(file){
  const r=await Tesseract.recognize(file,'ara+eng'); const t=tidy(r.data.text||'');
  const out=[]; const re=/(أول ثانوي|ثاني ثانوي|ثالث ثانوي).*?(?:مادة|المادة)[:\s]*([\u0600-\u06FF\s]+?).*?(?:الدرجة|درجة|%|percent)[:\s]*(\d{1,3})/gi;
  let m; while((m=re.exec(t))){ out.push({grade:m[1],subject:m[2].trim(),score:+m[3]}) }
  return out;
}
async function parseAny(file){
  const ext=(file.name.split('.').pop()||'').toLowerCase();
  if(['xlsx','xls','csv'].includes(ext)) return await parseXlsxOrCsv(file);
  if(ext==='pdf') return await parsePdf(file);
  if(['doc','docx','txt'].includes(ext)) return await parseWordOrTxt(file);
  if(['png','jpg','jpeg','webp'].includes(ext)) return await parseImage(file);
  // محاولة أخيرة: جرّب كـ Excel
  try{ return await parseXlsxOrCsv(file) }catch(e){ return [] }
}

/* ================== التحليل والعرض ================== */
let rowsAll=[], summary=[], chartObj=null, radarObj=null;

function buildSummary(rows){
  const M=new Map();
  rows.forEach(r=>{
    const k=r.grade+'||'+r.subject;
    if(!M.has(k))M.set(k,{grade:r.grade,subject:r.subject,scores:[]});
    M.get(k).scores.push(r.score);
  });
  return [...M.values()].map(o=>{
    const s=o.scores, n=s.length, avg=+mean(s).toFixed(2), med=+quantile(s,0.5).toFixed(2);
    const sd=+stddev(s).toFixed(2), cv=+(sd/(avg||1)*100).toFixed(2), sk=+skewness(s).toFixed(2);
    const poor=s.filter(x=>x<60).length, exc=s.filter(x=>x>=90).length;
    return {grade:o.grade,subject:o.subject,count:n,avg,med,sd,cv,sk,
      poor, excellent:exc, poorPct:pct(poor,n), excellentPct:pct(exc,n)};
  });
}
function schoolIndex(summ){
  if(!summ.length) return 0;
  const total=summ.reduce((a,b)=>a+b.count,0);
  const pass=summ.reduce((a,b)=>a+(b.count-b.poor),0);
  const exc =summ.reduce((a,b)=>a+b.excellent,0);
  const passPct=pct(pass,total), exPct=pct(exc,total);
  const balanced= 100 - Math.min(100,(summ.filter(s=>s.poorPct>25).length/summ.length)*100);
  return Math.round(passPct*0.6 + exPct*0.2 + balanced*0.2);
}
function renderKPIs(rows){
  const k=$('#kpis'); k.innerHTML='';
  const total=rows.length, pass=rows.filter(r=>r.score>=60).length, exc=rows.filter(r=>r.score>=90).length;
  const avg= total? (rows.reduce((a,b)=>a+b.score,0)/total).toFixed(2):0;
  [['عدد السجلات',total],['متوسط الدرجات',avg],['نسبة النجاح',pct(pass,total)+'%'],['نسبة الممتاز',pct(exc,total)+'%']]
    .forEach(([n,v])=>{const d=document.createElement('div');d.className='kpi';d.innerHTML=`<div class="v">${v}</div><div class="small">${n}</div>`;k.appendChild(d)});
}
function fillFilters(rows){
  const gs=[...new Set(rows.map(r=>r.grade))].sort();
  const ss=[...new Set(rows.map(r=>r.subject))].sort();
  grade.innerHTML='<option value="all">جميع الصفوف</option>'+gs.map(x=>`<option>${x}</option>`).join('');
  subject.innerHTML='<option value="all">جميع المواد</option>'+ss.map(x=>`<option>${x}</option>`).join('');
}
function renderTables(){
  const g=grade.value, s=subject.value, minW=+thWeak.value, avgCut=+thAvg.value, maxCV=+thCV.value, maxStd=+thStd.value;
  const tb=$('#tbody'); tb.innerHTML='';
  summary.filter(x=>(g==='all'||x.grade===g)&&(s==='all'||x.subject===s))
    .sort((a,b)=>a.grade.localeCompare(b.grade,'ar')||a.subject.localeCompare(b.subject,'ar'))
    .forEach(x=>{
      const need = (x.poorPct>=minW) || (x.avg<avgCut) || (x.cv>=maxCV) || (x.sd>=maxStd) || (x.excellentPct>=95 && x.cv<=5);
      const note = need ? 'علاج تفاضلي/مراجعة أدوات/تمايز' : 'متوازن – استمر في مهام الأداء والأسئلة العليا';
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${x.grade}</td><td>${x.subject}</td><td>${x.count}</td><td>${x.avg}</td>
        <td>${x.poorPct}%</td><td>${x.excellentPct}%</td><td>${x.cv}</td><td>${x.sd}</td>
        <td>${need?'<span class="badge">تحتاج متابعة</span>':''} ${note}</td>`;
      tb.appendChild(tr);
    });
}
function renderCharts(){
  const g=grade.value, s=subject.value, type=chartType.value;
  const filtered=summary.filter(x=>(g==='all'||x.grade===g)&&(s==='all'||x.subject===s));
  const labels=filtered.map(x=>x.grade+' – '+x.subject), avgs=filtered.map(x=>x.avg), spreads=filtered.map(x=>x.sd);
  if(chartObj) chartObj.destroy(); if(radarObj) radarObj.destroy();
  if(type==='bar'){ $('#radar').style.display='none'; $('#chart').style.display='block';
    chartObj=new Chart($('#chart'),{type:'bar',data:{labels,datasets:[{label:'المتوسط',data:avgs},{label:'الانحراف المعياري',data:spreads}]},options:{plugins:{legend:{position:'bottom'}},scales:{y:{min:0,max:100}}}});
  }else{ $('#chart').style.display='none'; $('#radar').style.display='block';
    radarObj=new Chart($('#radar'),{type:'radar',data:{labels,datasets:[
      {label:'% ضعيف',data:filtered.map(x=>x.poorPct)},
      {label:'% ممتاز',data:filtered.map(x=>x.excellentPct)},
      {label:'CV %',data:filtered.map(x=>x.cv)}
    ]},options:{plugins:{legend:{position:'bottom'}},scales:{r:{min:0,max:100}}}});
  }
}
function renderGauge(){
  const idx=schoolIndex(summary);
  $('#schoolGauge').style.width=idx+'%';
  $('#schoolGauge2').style.width=idx+'%';
  $('#schoolGauge').title='مؤشر المدرسة: '+idx+'%';
}

/* ===== خطة Auto-SMART ===== */
function buildPlan(){
  const minW=+thWeak.value, avgCut=+thAvg.value, maxCV=+thCV.value, maxStd=+thStd.value;
  const ordered=[...summary].sort((a,b)=>{
    const ka=(a.poorPct>=minW?3:0)+(a.cv>=maxCV?2:0)+((a.excellentPct>=95&&a.cv<=5)?1:0);
    const kb=(b.poorPct>=minW?3:0)+(b.cv>=maxCV?2:0)+((b.excellentPct>=95&&b.cv<=5)?1:0);
    return kb-ka || (b.poorPct-a.poorPct) || (b.cv-a.cv);
  }).slice(0,12);
  const rows=ordered.map((x,i)=>{
    let الهدف,الإجراء,المسؤول,المؤشر,الشواهد,الفصل,الأسابيع;
    if(x.poorPct>=minW || x.avg<avgCut){
      الهدف=`خفض الضعيف في ${x.subject} (${x.grade}) من ${x.poorPct}% إلى ≤ ${Math.max(0,Math.floor(x.poorPct-10))}% ورفع المتوسط إلى ≥ ${Math.max(75,Math.ceil(x.avg+5))}%`;
      الإجراء='تشخيص أسبوعي + مجموعات علاج تفاضلي + بنك أسئلة معيارية + اختبار قصير';
      المسؤول='قائد نواتج التعلم + معلم المادة'; المؤشر='% ضعف شهري / متوسط الوحدة / حضور العلاج';
      الشواهد='نماذج تشخيص، خطط علاج، أعمال طلاب قبل/بعد، تواصل ولي الأمر'; الفصل='الأول'; الأسابيع='3–10';
    }else if(x.excellentPct>=95 && x.cv<=5){
      الهدف=`رفع نسبة مهام الأداء والأسئلة العليا في ${x.subject} (${x.grade}) إلى ≥ 40% مع بقاء المتوسط ≥ ${Math.ceil(x.avg)}%`;
      الإجراء='مهام أداء عليا Rubrics + مشروعات قصيرة + امتحانات تفاضلية المستويات';
      المسؤول='لجنة التعليم والتعلّم'; المؤشر='% أسئلة عليا / % مهام أداء'; الشواهد='نماذج بنود، Rubrics، منتجات طلاب'; الفصل='الثاني'; الأسابيع='6–12';
    }else if(x.cv>=maxCV || x.sd>=maxStd){
      الهدف=`خفض CV في ${x.subject} (${x.grade}) من ${x.cv}% إلى ≤ ${Math.max(10,Math.ceil(x.cv-6))}% مع الحفاظ على متوسط ≥ ${Math.ceil(x.avg)}%`;
      الإجراء='توحيد جداول المواصفات + بنوك أسئلة معيارية + معايرة مصحّحين + مراجعة أدوات التقويم';
      المسؤول='قيادة القسم + معلمو المادة'; المؤشر='CV شهري / Std / نتائج معيارية قصيرة'; الشواهد='جداول مواصفات، تقارير معايرة'; الفصل='الأول'; الأسابيع='4–9';
    }else{
      الهدف=`الحفاظ على التوازن ورفع متوسط ${x.subject} (${x.grade}) إلى ≥ ${Math.max(85,Math.ceil(x.avg+3))}%`;
      الإجراء='استراتيجيات نشطة + تعلم تعاوني + إثراء المتميزين + دعم المتوسطين';
      المسؤول='المعلم + المرشد الأكاديمي'; المؤشر='متوسط الوحدة / % أسئلة عليا / رضا الطلبة';
      الشواهد='خطة درس، أدوات تقييم، تقارير رضا'; الفصل='الثاني'; الأسابيع='3–8';
    }
    return `<tr><td>${i+1}</td><td>${x.grade} – ${x.subject}</td><td>${الهدف}</td><td>${الفصل}</td><td>${الأسابيع}</td><td>${الإجراء}</td><td>${المسؤول}</td><td>${المؤشر}</td><td>${الشواهد}</td></tr>`;
  }).join('');
  $('#planBody').innerHTML=rows || '<tr><td colspan="9" style="text-align:center">حلّل البيانات أولًا</td></tr>';
}

/* ===== تصدير ===== */
async function savePDF(nodeSelector, filename){
  const node=(typeof nodeSelector==='string')?document.querySelector(nodeSelector):nodeSelector;
  const canvas=await html2canvas(node,{scale:2,background:'#ffffff',useCORS:true,allowTaint:false});
  const img=canvas.toDataURL('image/png');
  const pdf=new jsPDF('p','pt','a4'); const pw=pdf.internal.pageSize.getWidth(), ph=pdf.internal.pageSize.getHeight();
  const r=Math.min(pw/canvas.width,ph/canvas.height);
  pdf.addImage(img,'PNG',(pw-canvas.width*r)/2,(ph-canvas.height*r)/2,canvas.width*r,canvas.height*r);
  pdf.save(filename);
}
function exportPlanExcel(){
  const rows=[['#','المجال/المادة','الهدف (SMART)','الفصل','الأسابيع','الإجراء','المسؤول','المؤشر','الشواهد']];
  document.querySelectorAll('#planBody tr').forEach(tr=>rows.push([...tr.children].map(td=>td.innerText)));
  const ws=XLSX.utils.aoa_to_sheet(rows), wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'خطة التحسين'); XLSX.writeFile(wb,'خطة-تحسين-اليعقوبي.xlsx');
}

/* ===== ربط الأزرار وضمان العمل ===== */
window.addEventListener('DOMContentLoaded', ()=>{
  $('#demo').onclick=()=>{
    const csv=`الصف,المادة,الدرجة
أول ثانوي,رياضيات,55
أول ثانوي,رياضيات,72
ثاني ثانوي,كيمياء,91
ثالث ثانوي,لغة عربية,84
ثالث ثانوي,لغة عربية,63`;
    const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8'})); a.download='نموذج-نتائج.csv'; a.click();
  };

  $('#analyze').onclick=async()=>{
    const f1=$('#f1').files[0], f2=$('#f2').files[0];
    if(!f1 && !f2){ alert('فضلاً اختر ملفًا واحدًا على الأقل'); return; }
    showBusy(true);
    try{
      rowsAll=[];
      if(f1){ rowsAll.push(...await parseAny(f1)); }
      if(f2){ rowsAll.push(...await parseAny(f2)); }
      if(!rowsAll.length){ alert('لا توجد سجلات صالحة. تأكد من الأعمدة: الصف | المادة | الدرجة'); return; }
      summary = buildSummary(rowsAll);
      renderKPIs(rowsAll); fillFilters(rowsAll); renderCharts(); renderTables(); renderGauge();
      alert('تم التحليل بنجاح');
    }catch(e){ console.error(e); alert('تعذر التحليل: '+(e.message||e)); }
    finally{ showBusy(false); }
  };

  $('#mkPlan').onclick=()=>{ buildPlan(); renderGauge(); document.querySelector('#planCard').scrollIntoView({behavior:'smooth'}); };
  $('#expX').onclick=exportPlanExcel;
  $('#savePdf').onclick=()=>savePDF(document.body,'Dashboard-اليعقوبي.pdf');
  $('#reset').onclick=()=>{ rowsAll=[];summary=[]; if(chartObj)chartObj.destroy(); if(radarObj)radarObj.destroy(); $('#kpis').innerHTML=''; $('#tbody').innerHTML=''; $('#planBody').innerHTML=''; fillFilters([]); renderGauge(); alert('تمت إعادة الضبط'); };
  ['grade','subject','chartType','thWeak','thAvg','thCV','thStd'].forEach(id=>document.getElementById(id).addEventListener('change',()=>{ renderCharts(); renderTables(); buildPlan(); }));
});
</script>
</body>
</html>
