<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ù…Ù†ØµØ© Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ§Ù„ØªØ­Ø³ÙŠÙ† â€” Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ Ø¨Ø§Ù„Ø®Ø¨Ø±</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800&display=swap" rel="stylesheet">
<!-- Ù…ÙƒØªØ¨Ø§Øª -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.min.js"></script>
<script>if(window.pdfjsLib){pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.worker.min.js";}</script>
<script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment-hijri@2.3.1/moment-hijri.min.js"></script>
<style>
:root{
  --moe:#0f7a66; --ink:#0b2f2d; --ring:#d6efe9; --lite:#e8f4f1; --bg:#f7fbfa;
  --warn:#f59e0b; --bad:#e11d48; --accent:#1d4ed8;
}
/* Ø£Ø³Ø§Ø³ÙŠØ§Øª */
*{box-sizing:border-box}
html,body{height:100%}
body{font-family:'Tajawal',system-ui,Arial;color:var(--ink);margin:0;background:linear-gradient(180deg,#fff 0%,var(--bg) 100%)}

/* Ø¥Ø·Ø§Ø± A4 ØªÙØ§Ø¹Ù„ÙŠ (Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©) */
.wrapper{display:flex;justify-content:center;padding:14px}
.page{
  width:794px; min-height:1123px; background:#fff; border-radius:16px;
  border:1px solid var(--ring); box-shadow:0 20px 50px rgba(0,0,0,.08); overflow:hidden;
}

/* Ù‡ÙŠØ¯Ø± Ø¨ØµÙˆØ±Ø© Ø§Ù„Ø´Ø¹Ø§Ø± ÙÙ‚Ø· Ø¯ÙˆÙ† Ø§Ø¬ØªØ²Ø§Ø¡ */
.header{
  border-bottom:3px solid var(--moe); background:#fff; position:relative;
}
.header img{
  width:100%; height:140px; object-fit:contain; display:block; background:#fff;
}
.toolbar{
  display:flex; gap:8px; padding:10px 12px; justify-content:flex-end; align-items:center; border-top:1px solid var(--ring);
  background:linear-gradient(180deg,#fff, #f9fdfc);
}
.btn{
  background:linear-gradient(180deg,rgba(15,122,102,.95),#0b7e88);
  color:#fff; border:none; border-radius:12px; padding:10px 14px; font-weight:800; cursor:pointer;
  box-shadow:0 8px 20px rgba(15,122,102,.25), inset 0 1px 0 rgba(255,255,255,.25);
}
.btn.ghost{background:#fff;color:var(--moe);border:1.6px solid var(--moe);box-shadow:none}
.btn.warn{background:linear-gradient(180deg,#f59e0b,#de8c07)}
.btn.accent{background:linear-gradient(180deg,#1d4ed8,#1a43b8)}
.btn:disabled{opacity:.5;cursor:not-allowed}

/* Ø¹Ø¯Ø³Ø© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ */
.section{padding:12px}
.card{background:#fff; border-top:1px solid var(--ring); padding:12px}
h3{margin:6px 0 10px; color:var(--moe)}
.flex{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
.small{font-size:12px; color:#567}
.pill{border:1px solid var(--ring); border-radius:999px; padding:2px 8px; background:#fff; font-size:12px}

.drop{
  border:2px dashed var(--ring); border-radius:16px; padding:14px; cursor:pointer;
  background:linear-gradient(180deg,#fff,#f7fbfa); min-width:260px; flex:1;
}
.drop.on{background:#eef7f5}
.drop strong{color:var(--moe)}
.fileName{font-size:12px; color:#567; margin-top:4px}

/* KPIs + Ø¬Ø¯Ø§ÙˆÙ„ + Ø±Ø³Ù… */
.kpis{display:grid; grid-template-columns:repeat(4,1fr); gap:10px}
.kpi{border:1px solid var(--ring); border-radius:14px; text-align:center; padding:10px}
.kpi .v{font-weight:800; font-size:20px}
.table{width:100%; border-collapse:collapse; margin-top:8px}
.table th,.table td{border:1px solid var(--ring); padding:8px; text-align:right; vertical-align:top}
.table th{background:var(--lite); color:var(--moe)}
.badge{padding:2px 8px; border-radius:999px; font-size:11px; color:#fff}
.bad{background:var(--bad)} .warnb{background:var(--warn)} .okb{background:#0ea5a0}
.diag{background:#f6fbfa; border:1px dashed var(--ring); color:#356; padding:10px; border-radius:12px; margin-top:8px; max-height:220px; overflow:auto}
.progress{height:6px; background:#e8f4f1; border-radius:999px; overflow:hidden}
.progress>span{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--moe),#12b3a6)}

/* Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± A4 Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©/Ø§Ù„Ø­ÙØ¸ */
.modal{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:99}
.a4{
  width:794px; height:1123px; background:#fff; border-radius:12px; box-shadow:0 22px 60px rgba(0,0,0,.25);
  padding:22px; overflow:auto; position:relative;
}
.closeX{position:absolute; top:10px; left:10px; padding:6px 10px; border-radius:10px; border:1.6px solid var(--moe); background:#fff; color:#0a3d36; font-weight:800; cursor:pointer}
.gov{ text-align:center; line-height:1.4}
.gov img{width:160px; height:160px; object-fit:contain; display:block; margin:2px auto 6px}
.report-title{font-size:18px; color:#222; text-align:center; margin:4px 0 8px}
.meta{display:flex; gap:10px; justify-content:center; font-size:12px; color:#555}
.hide-on-print{display:block}

/* Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± + ØªÙƒØ¨ÙŠØ± Ø¯Ù‚Ø© Ø§Ù„ØµÙØ­Ø© */
@media print{
  .toolbar, .hide-on-print, .modal:not(.show-print) { display:none !important }
  body{background:#fff}
  .page{border:none; box-shadow:none}
}

/* ØªØ¬Ø§ÙˆØ¨ Ù„Ù„Ø¬ÙˆØ§Ù„ */
@media (max-width:860px){
  .kpis{grid-template-columns:repeat(2,1fr)}
  .header img{height:110px}
  .a4{width:100%; height:100%}
}
</style>
</head>
<body>
<div class="wrapper">
  <div class="page" id="page">
    <!-- Ù‡ÙŠØ¯Ø± Ø¨ØµÙˆØ±Ø© Ø§Ù„Ø´Ø¹Ø§Ø± ÙƒØ§Ù…Ù„Ø© Ø¯ÙˆÙ† Ø§Ø¬ØªØ²Ø§Ø¡ -->
    <div class="header">
      <img src="logo.png" alt="Ø´Ø¹Ø§Ø± ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…" onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/thumb/6/69/Ministry_of_Education_Logo.svg/640px-Ministry_of_Education_Logo.svg.png'"/>
      <div class="toolbar">
        <button class="btn" id="btnAuto">ğŸ¤– ØªØ­Ù„ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø°ÙƒÙŠ</button>
        <button class="btn ghost" id="btnPDF">ğŸ“„ Ø­ÙØ¸ ØªÙ‚Ø±ÙŠØ± A4</button>
        <button class="btn ghost" id="btnClear">ğŸ§¹ Ù…Ø³Ø­</button>
      </div>
    </div>

    <!-- Ø¹Ø¯Ø³Ø© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ -->
    <div class="section">
      <div class="card">
        <h3>Ø¹Ø¯Ø³Ø© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ (Excel/CSV Ø§Ù„Ø£ÙØ¶Ù„ â€“ ÙŠØ¯Ø¹Ù… PDF/Word/ØµÙˆØ±)</h3>
        <div class="flex" style="justify-content:space-between;align-items:flex-start">
          <label class="drop" id="dz1">
            <input type="file" id="file1" hidden multiple accept=".xlsx,.xls,.csv,.pdf,.doc,.docx,.txt,image/*">
            <div><strong>ğŸ“ Ø§Ù„Ù…Ù„Ù (Ù¡)</strong> â€” Ø³ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£ØµÙ„ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</div>
            <div class="fileName" id="f1Name">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</div>
          </label>
          <label class="drop" id="dz2">
            <input type="file" id="file2" hidden accept=".xlsx,.xls,.csv,.pdf,.doc,.docx,.txt,image/*">
            <div><strong>ğŸ§ª Ø§Ù„Ù…Ù„Ù (Ù¢) Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©</strong> â€” Ø§Ø®ØªÙŠØ§Ø±ÙŠ (Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¢Ø®Ø±/Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø£Ø®Ø±Ù‰)</div>
            <div class="fileName" id="f2Name">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</div>
          </label>
          <div class="flex">
            <button class="btn" id="btnAnalyze">ğŸ” ØªØ­Ù„ÙŠÙ„</button>
            <button class="btn warn" id="btnOCR">ğŸŒ ØªÙØ¹ÙŠÙ„ OCR Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©</button>
            <span class="pill">ÙŠØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ <strong>Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©</strong> ÙÙŠ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„</span>
          </div>
        </div>
        <div class="progress" style="margin-top:8px"><span id="pbar"></span></div>
        <div class="diag" id="diag" style="display:none"></div>
      </div>

      <!-- Ù…Ø¤Ø´Ø±Ø§Øª -->
      <div class="card">
        <h3>Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª ÙˆØ§Ù„Ø±Ø³ÙˆÙ…</h3>
        <div class="kpis" id="kpis"></div>
        <div class="flex" style="justify-content:space-between;align-items:center;margin-top:6px">
          <div class="flex"><span class="small">Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ù…:</span>
            <select id="chartType" class="pill">
              <option value="bar">Ø£Ø¹Ù…Ø¯Ø©</option>
              <option value="line">Ø®Ø·ÙŠ</option>
              <option value="radar">Ø±Ø§Ø¯Ø§Ø±</option>
            </select>
          </div>
          <span class="small">Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©/Ø§Ù„Ø­ÙØ¸: ØªÙØ®ÙÙ‰ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</span>
        </div>
        <canvas id="chart" height="260" style="margin-top:8px"></canvas>
      </div>

      <!-- ØªÙØµÙŠÙ„ -->
      <div class="card">
        <h3>ØªØ­Ù„ÙŠÙ„ ØªÙØµÙŠÙ„ÙŠ (Ø¨Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©)</h3>
        <div id="detail"></div>
      </div>

      <!-- Ø®Ø·Ø© ØªØ­Ø³ÙŠÙ† -->
      <div class="card">
        <div class="flex" style="justify-content:space-between;align-items:center">
          <h3>Ø®Ø·Ø© ØªØ­Ø³ÙŠÙ† SMART Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø§Ù„ØªÙ‚ÙˆÙŠÙ…</h3>
          <button class="btn ghost" id="btnExportPlan">ğŸ§¾ ØªØµØ¯ÙŠØ± Ø§Ù„Ø®Ø·Ø© Excel</button>
        </div>
        <div id="plan"></div>
      </div>

      <div class="small" style="text-align:center;margin-top:10px">
        Â© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© Ø¨Ø§Ù„Ø®Ø¨Ø± â€” Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ
      </div>
    </div>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± A4 -->
<div class="modal" id="reportModal">
  <div class="a4" id="a4">
    <button class="closeX" id="closeReport">âœ•</button>
    <div class="gov">
      <img src="logo.png" alt="Ø´Ø¹Ø§Ø± ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…" onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/thumb/6/69/Ministry_of_Education_Logo.svg/240px-Ministry_of_Education_Logo.svg.png'"/>
    </div>
    <div class="report-title"><strong>ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ§Ù„ØªØ­Ø³ÙŠÙ† Ù„Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ø£ÙˆÙ„ 1447Ù‡Ù€</strong></div>
    <div class="meta"><div>Ø§Ù„ØªØ§Ø±ÙŠØ®: <span id="rDate"></span></div><div>Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ Ø¨Ø§Ù„Ø®Ø¨Ø±</div></div>
    <div id="rBody" style="margin-top:10px"></div>
  </div>
</div>

<script>
/* ================== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ================== */
const pct=(n,d)=>d?+(100*n/d).toFixed(2):0;
const mean=a=>a.length?a.reduce((s,x)=>s+x,0)/a.length:0;
const std=a=>{if(a.length<2)return 0;const m=mean(a);return Math.sqrt(a.reduce((s,x)=>s+(x-m)*(x-m),0)/(a.length-1))};
const toLatin=s=>String(s??'').replace(/[\u0660-\u0669]/g,c=>'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'.indexOf(c)).replace(/[\u06F0-\u06F9]/g,c=>'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'.indexOf(c)).replace(/\u200f|\u200e|\u202a|\u202b|\u202c/g,'');
const tidy=v=>toLatin(String(v||'').replace(/\s+/g,' ').trim());
const pickNum=v=>{const s=toLatin(v).replace(',', '.'); const m=s.match(/-?\d{1,3}(?:\.\d+)?/); if(!m) return NaN; let x=+m[0]; if(/%/.test(s)) x=Math.max(0,Math.min(100,x)); return x;};
function setP(x){document.getElementById('pbar').style.width=(Math.max(0,Math.min(100,x))||0)+'%'}

/* ============ Ø¥ÙŠØ¬Ø§Ø¯ ØµÙ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø¨Ø¯Ù‚Ø© (Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡) ============ */
function findHeaderRow(table){
  let best=-1, idx=0;
  for(let i=0;i<Math.min(table.length,30);i++){
    const row=table[i];
    const score=row.reduce((t,c)=>t+(/[A-Za-z\u0600-\u06FF]/.test(String(c))?2:0)+(String(c).trim().length>1?1:0),0);
    if(score>best){best=score;idx=i}
  }
  return idx;
}
function normalizeTable(rows){
  const clean=rows.filter(r=>r.some(c=>String(c).trim()!=='')).map(r=>r.map(c=>String(c)));
  const h=findHeaderRow(clean);
  const headers=clean[h].map(tidy);
  const body=clean.slice(h+1).filter(r=>r.some(x=>String(x).trim()!==''));
  return [headers,...body];
}

/* ================ Ù‚Ø±Ø§Ø¡Ø© Ø¬Ø¯Ø§ÙˆÙ„ Ù…Ù† Excel/CSV ================ */
async function tableFromWorkbook(file){
  const wb=XLSX.read(await file.arrayBuffer(),{type:'array'});
  const sheet=wb.SheetNames[0];
  const rows=XLSX.utils.sheet_to_json(wb.Sheets[sheet],{header:1,defval:''});
  return normalizeTable(rows);
}

/* ================ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù†Øµ Ù…Ù† PDF/Word/TXT/ØµÙˆØ±Ø© ================ */
let OCR_ENABLED=false;
document.getElementById('btnOCR').addEventListener('click',()=>{
  OCR_ENABLED=!OCR_ENABLED; document.getElementById('btnOCR').textContent=OCR_ENABLED?'âœ… OCR Ù…ÙÙØ¹Ù‘Ù„':'ğŸŒ ØªÙØ¹ÙŠÙ„ OCR Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©';
});

async function textFromFile(file){
  const ext=(file.name.split('.').pop()||'').toLowerCase();
  try{
    if(ext==='txt'){ return new TextDecoder().decode(await file.arrayBuffer()); }
    if(ext==='doc' || ext==='docx'){ const r=await mammoth.extractRawText({arrayBuffer:await file.arrayBuffer()}); return r.value||''; }
    if(ext==='pdf'){
      let out=''; const pdf=await pdfjsLib.getDocument({data:await file.arrayBuffer()}).promise;
      const max=Math.min(pdf.numPages,12);
      for(let p=1;p<=max;p++){const pg=await pdf.getPage(p);out+=' '+(await pg.getTextContent()).items.map(i=>i.str).join(' ');}
      if(out.trim() || !OCR_ENABLED) return out;
    }
    if(OCR_ENABLED && (/image/.test(file.type)||ext==='pdf')){
      const { createWorker } = await import('https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.esm.min.js');
      const worker = await createWorker('ara+eng');
      const { data:{ text } } = await worker.recognize(await file.arrayBuffer());
      await worker.terminate(); return text||'';
    }
  }catch(e){ return '' }
  return '';
}

/* ================ ØªØ­ÙˆÙŠÙ„ Ù†Øµ Ø¨Ø³ÙŠØ· Ø¥Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ ================ */
function textToTable(text){
  const lines=(toLatin(text)||'').split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
  if(!lines.length) return [];
  const sample=lines.slice(0,50).join('\n');
  const sep=/;/.test(sample)?';': /,/.test(sample)?',': /\t/.test(sample)?'\t': /\s{2,}/.test(sample)?'  ':'|';
  const rows=lines.map(l=>l.split(sep).map(t=>t.trim()));
  return normalizeTable(rows);
}

/* ================ ÙƒØ´Ù Ø§Ù„Ù†ÙˆØ¹ (Ù†ØªØ§Ø¦Ø¬/ØªÙ‚ÙˆÙŠÙ…/Ø­Ø¶ÙˆØ±/Ø¹Ø§Ù…) ================ */
function detectKind(headers){
  const h=headers.map(tidy).map(x=>x.toLowerCase());
  const has=(...ks)=>ks.some(k=>h.some(x=>x.includes(k)));
  if( has('Ø§Ù„ØµÙ','grade','class') && has('Ø§Ù„Ù…Ø§Ø¯Ø©','subject','course') && has('Ø§Ù„Ø¯Ø±Ø¬Ø©','score','mark','percent','Ø§Ù„Ù†Ø³Ø¨Ø©') ) return 'grades';
  if( has('Ø§Ù„Ø³Ù†Ø©','year') && has('Ø§Ù„Ù…Ø¬Ø§Ù„','domain') && has('Ø§Ù„Ù…Ø¤Ø´Ø±','indicator','Ø§Ù„Ø¹Ù†ØµØ±') && has('Ø§Ù„Ù†Ø³Ø¨Ø©','%','score') ) return 'external';
  if( has('Ø§Ù„Ø­Ø¶ÙˆØ±','Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø·','attendance') ) return 'attendance';
  if( has('Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹','week') ) return 'weekly';
  return 'generic';
}

/* ================ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ù…Ù† Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ================ */
let weeksDB = []; // {term:'Ø§Ù„Ø£ÙˆÙ„/Ø§Ù„Ø«Ø§Ù†ÙŠ', week:'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ X', date:string}
function extractWeeksFromTable(table){
  if(!table || !table.length) return;
  const hdr=table[0].map(tidy);
  const m={week:null,date:null,term:null};
  hdr.forEach((x,i)=>{const t=x.toLowerCase(); if(m.week==null&&/(Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹|week)/.test(t)) m.week=i; if(m.date==null&&/(Ø§Ù„ØªØ§Ø±ÙŠØ®|date)/.test(t)) m.date=i; if(m.term==null&&/(Ø§Ù„ÙØµÙ„|term)/.test(t)) m.term=i;});
  const rows=table.slice(1).map(r=>({week: tidy(r[m.week]||''), date: tidy(r[m.date]||''), term: tidy(r[m.term]||'Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„')})).filter(r=>r.week);
  if(rows.length) weeksDB = rows;
}

/* ================ Ù…Ø­Ù„Ù„Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹ ================ */
function analyzeGrades(table, table2){
  const hdr=table[0].map(tidy); // Ø¹Ù†Ø§ÙˆÙŠÙ† Ø£ØµÙ„ÙŠØ©
  const map={grade:null,subject:null,score:null};
  hdr.forEach((x,i)=>{const t=x.toLowerCase(); if(map.grade==null&&/(Ø§Ù„ØµÙ|grade|class)/.test(t)) map.grade=i; if(map.subject==null&&/(Ø§Ù„Ù…Ø§Ø¯Ø©|subject|course)/.test(t)) map.subject=i; if(map.score==null&&/(Ø§Ù„Ø¯Ø±Ø¬Ø©|score|mark|percent|Ø§Ù„Ù†Ø³Ø¨Ø©)/.test(t)) map.score=i;});
  if(Object.values(map).some(v=>v==null)) throw new Error('Ù„Ù… ØªÙÙƒØªØ´Ù Ø£Ø¹Ù…Ø¯Ø© (Ø§Ù„ØµÙ/Ø§Ù„Ù…Ø§Ø¯Ø©/Ø§Ù„Ø¯Ø±Ø¬Ø©).');

  const rows=table.slice(1).map(r=>({grade: tidy(r[map.grade]), subject: tidy(r[map.subject]), score: pickNum(r[map.score])})).filter(r=>r.grade&&r.subject&&!isNaN(r.score));
  if(!rows.length) throw new Error('Ù„Ø§ Ø³Ø¬Ù„Ø§Øª Ø¯Ø±Ø¬Ø§Øª ØµØ§Ù„Ø­Ø©.');
  const M=new Map();
  rows.forEach(r=>{const k=r.grade+'||'+r.subject; if(!M.has(k)) M.set(k,{grade:r.grade,subject:r.subject,s:[]}); M.get(k).s.push(r.score)});
  let summary=[...M.values()].map(o=>{
    const s=o.s, n=s.length, avg=+mean(s).toFixed(2), sd=+std(s).toFixed(2), cv=+(sd/(avg||1)*100).toFixed(2);
    const poor=s.filter(x=>x<60).length, exc=s.filter(x=>x>=90).length;
    return {grade:o.grade, subject:o.subject, count:n, avg, sd, cv, poor, poorPct:pct(poor,n), excellent:exc, excellentPct:pct(exc,n)};
  });

  // Ù…Ù‚Ø§Ø±Ù†Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  if(table2 && table2.length){
    const hdr2=table2[0].map(tidy); const m2={grade:null,subject:null,score:null};
    hdr2.forEach((x,i)=>{const t=x.toLowerCase(); if(m2.grade==null&&/(Ø§Ù„ØµÙ|grade|class)/.test(t)) m2.grade=i; if(m2.subject==null&&/(Ø§Ù„Ù…Ø§Ø¯Ø©|subject|course)/.test(t)) m2.subject=i; if(m2.score==null&&/(Ø§Ù„Ø¯Ø±Ø¬Ø©|score|mark|percent|Ø§Ù„Ù†Ø³Ø¨Ø©)/.test(t)) m2.score=i;});
    if(Object.values(m2).every(v=>v!=null)){
      const rows2=table2.slice(1).map(r=>({grade: tidy(r[m2.grade]), subject: tidy(r[m2.subject]), score: pickNum(r[m2.score])})).filter(r=>r.grade&&r.subject&&!isNaN(r.score));
      const M2=new Map(); rows2.forEach(r=>{const k=r.grade+'||'+r.subject; if(!M2.has(k)) M2.set(k,[]); M2.get(k).push(r.score)});
      summary = summary.map(s=>{
        const baseAvg = +(mean(M2.get(s.grade+'||'+s.subject)||[])||0).toFixed(2);
        return {...s, baseAvg, diff:+(s.avg - baseAvg).toFixed(2)};
      });
    }
  }

  // KPIs
  const total=rows.length, pass=rows.filter(r=>r.score>=60).length, exc=rows.filter(r=>r.score>=90).length;
  const kpis={success: +pct(pass,total).toFixed(2), excellence:+pct(exc,total).toFixed(2), improvement:+(mean(summary.map(x=>Math.max(0,x.diff||0)*2))||0).toFixed(2)};

  // Ø®Ø·Ø© Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø§Ù„ØªÙ‚ÙˆÙŠÙ…
  const weeks = weeksDB.length? weeksDB : Array.from({length:8}, (_,i)=>({term:'Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„', week:`Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${i+3}`, date:''}));
  const plan = summary
    .sort((a,b)=>(b.poorPct-a.poorPct)||(b.cv-a.cv))
    .slice(0,12)
    .map((s,i)=>{
      const weak = s.poorPct>=20 || s.avg<75, vary = s.cv>=18 || s.sd>=12, diff = s.excellentPct>=95 && s.cv<=5;
      let goal, action, kpi, owner='Ù‚Ø§Ø¦Ø¯ Ù†ÙˆØ§ØªØ¬ Ø§Ù„ØªØ¹Ù„Ù… + Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø§Ø¯Ø©', term='Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„', week=weeks[i%weeks.length]?.week||'3â€“10';
      if(weak){ goal=`Ø®ÙØ¶ %Ø§Ù„Ø¶Ø¹ÙŠÙ ÙÙŠ ${s.subject} (${s.grade}) Ù…Ù† ${s.poorPct}% Ø¥Ù„Ù‰ â‰¤ ${Math.max(0,Math.floor(s.poorPct-10))}% ÙˆØ±ÙØ¹ Ø§Ù„Ù…ØªÙˆØ³Ø· Ø¥Ù„Ù‰ â‰¥ ${Math.max(75,Math.ceil(s.avg+5))}%`;
        action='ØªØ´Ø®ÙŠØµ Ø¨Ù†ÙˆØ¯ Ø£Ø³Ø¨ÙˆØ¹ÙŠ + Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø¹Ù„Ø§Ø¬ ØªÙØ§Ø¶Ù„ÙŠ + Ø¨Ù†Ùƒ Ø£Ø³Ø¦Ù„Ø© Ù…Ø¹ÙŠØ§Ø±ÙŠØ© + ÙˆØ§Ø¬Ø¨Ø§Øª Ù‚ØµÙŠØ±Ø© Ù…Ø¨Ù†ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©';
        kpi='% Ø¶Ø¹Ù Ø´Ù‡Ø±ÙŠ / Ù…ØªÙˆØ³Ø· Ø§Ù„ÙˆØ­Ø¯Ø© / Ø­Ø¶ÙˆØ± Ø§Ù„Ø¹Ù„Ø§Ø¬';
      }else if(diff){ goal=`Ø±ÙØ¹ % Ù…Ù‡Ø§Ù… Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø¹Ù„ÙŠØ§ ÙÙŠ ${s.subject} (${s.grade}) Ø¥Ù„Ù‰ â‰¥ 40% Ù…Ø¹ Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ù…ØªÙˆØ³Ø· â‰¥ ${Math.ceil(s.avg)}%`;
        action='Ù…Ù‡Ø§Ù… Ø£Ø¯Ø§Ø¡ Ø¹Ù„ÙŠØ§ (Rubrics) + Ù…Ø´Ø§Ø±ÙŠØ¹ Ù‚ØµÙŠØ±Ø© + Ø§Ù…ØªØ­Ø§Ù†Ø§Øª ØªÙØ§Ø¶Ù„ÙŠØ© Ù…Ø³ØªÙˆÙŠØ§Øª';
        kpi='% Ø£Ø³Ø¦Ù„Ø© Ø¹Ù„ÙŠØ§ / ØªÙ†ÙˆÙ‘Ø¹ Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø¨Ù†ÙˆØ¯'; owner='Ù„Ø¬Ù†Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„ØªØ¹Ù„Ù‘Ù…'; term='Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ';
      }else if(vary){ goal=`Ø®ÙØ¶ CV ÙÙŠ ${s.subject} (${s.grade}) Ù…Ù† ${s.cv}% Ø¥Ù„Ù‰ â‰¤ ${Math.max(10,Math.ceil(s.cv-6))}% Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ù…ØªÙˆØ³Ø· â‰¥ ${Math.ceil(s.avg)}%`;
        action='ØªÙˆØ­ÙŠØ¯ Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª + Ø¨Ù†ÙˆÙƒ Ø£Ø³Ø¦Ù„Ø© Ù…Ø¹ÙŠØ§Ø±ÙŠØ© + Ù…Ø¹Ø§ÙŠØ±Ø© Ø§Ù„Ù…ØµØ­Ø­ÙŠÙ†'; kpi='CV Ø´Ù‡Ø±ÙŠ / Std / Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¹ÙŠØ§Ø±ÙŠ Ù‚ØµÙŠØ±';
      }else{ goal=`Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆØ§Ø²Ù† ÙˆØ±ÙØ¹ Ù…ØªÙˆØ³Ø· ${s.subject} (${s.grade}) Ø¥Ù„Ù‰ â‰¥ ${Math.max(85,Math.ceil(s.avg+3))}%`;
        action='Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ù†Ø´Ø·Ø© ÙˆØªØ¹Ø§ÙˆÙ† + Ø¥Ø«Ø±Ø§Ø¡ Ù„Ù„Ù…ØªÙ…ÙŠØ²ÙŠÙ† + Ø¯Ø¹Ù… Ù„Ù„Ù…ØªÙˆØ³Ø·ÙŠÙ†'; kpi='Ù…ØªÙˆØ³Ø· Ø§Ù„ÙˆØ­Ø¯Ø© / % Ø£Ø³Ø¦Ù„Ø© Ø¹Ù„ÙŠØ§ / Ø±Ø¶Ø§ Ø§Ù„Ø·Ù„Ø¨Ø©'; owner='Ø§Ù„Ù…Ø¹Ù„Ù… + Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ'; term='Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ';
      }
      return [i+1, `${s.grade} â€“ ${s.subject}`, goal, term, week, action, owner, kpi, 'Ø´ÙˆØ§Ù‡Ø¯: Ù†Ù…Ø§Ø°Ø¬/Ù…Ø­Ø§Ø¶Ø±/Ø£Ø¹Ù…Ø§Ù„ Ù‚Ø¨Ù„-Ø¨Ø¹Ø¯'];
    });

  return {kind:'grades', hdr, map, summary, kpis, plan};
}

function analyzeExternal(table, table2){
  const hdr=table[0].map(tidy); const m={year:null,domain:null,indicator:null,percent:null};
  hdr.forEach((x,i)=>{const t=x.toLowerCase(); if(m.year==null&&/(Ø§Ù„Ø³Ù†Ø©|year)/.test(t)) m.year=i; if(m.domain==null&&/(Ø§Ù„Ù…Ø¬Ø§Ù„|domain)/.test(t)) m.domain=i; if(m.indicator==null&&/(Ø§Ù„Ù…Ø¤Ø´Ø±|indicator|Ø§Ù„Ø¹Ù†ØµØ±)/.test(t)) m.indicator=i; if(m.percent==null&&/(Ø§Ù„Ù†Ø³Ø¨Ø©|%|score)/.test(t)) m.percent=i;});
  if(Object.values(m).some(v=>v==null)) throw new Error('Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©.');
  const rows=table.slice(1).map(r=>({year:+tidy(r[m.year]).replace(/\D/g,''), dom:tidy(r[m.domain]), ind:tidy(r[m.indicator]||r[m.domain]), val:pickNum(r[m.percent])})).filter(r=>r.year && r.dom && !isNaN(r.val));
  const years=[...new Set(rows.map(r=>r.year))].sort(); const domains=[...new Set(rows.map(r=>r.dom))];
  const avg=(yr,dom)=>mean(rows.filter(r=>r.year===yr && r.dom===dom).map(r=>r.val));
  const summary=domains.map(d=>({domain:d, yA:+(avg(years[0],d)||0).toFixed(2), yB:+(avg(years[1]||years[0],d)||0).toFixed(2)}));
  const plan = summary.map((r,i)=>{const diff=+(r.yB-r.yA).toFixed(2); const target=Math.min(95, Math.max(85, Math.ceil((r.yB||r.yA)+5)));
    const actions = /Ù†ÙˆØ§ØªØ¬|ØªØ­ØµÙŠÙ„/.test(r.domain)?'ØªØ­Ù„ÙŠÙ„ Ø¨Ù†ÙˆØ¯ â€“ Ø¹Ù„Ø§Ø¬ ØªÙØ§Ø¶Ù„ÙŠ â€“ Ù…ØªØ§Ø¨Ø¹Ø© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©' : /Ø§Ù„ØªØ¹Ù„ÙŠÙ…|Ø§Ù„ØªØ¹Ù„/.test(r.domain)?'ØªÙ‚ÙˆÙŠÙ… ØªÙƒÙˆÙŠÙ†ÙŠ â€“ ØªÙ…Ø§ÙŠØ² â€“ PLC Ø´Ù‡Ø±ÙŠØ©' : /Ø§Ù„Ø¨ÙŠØ¦Ø©|Ø³Ù„Ø§Ù…Ø©/.test(r.domain)?'Ø³Ù„Ø§Ù…Ø© ÙˆÙ…Ù†Ø§Ø® â€“ Ø§Ù†Ø¶Ø¨Ø§Ø· â€“ Ø¬Ø§Ø°Ø¨ÙŠØ©' : 'ØªÙ…ÙƒÙŠÙ† ÙØ±Ù‚ Ø§Ù„Ø¹Ù…Ù„ â€“ Ø­ÙˆÙƒÙ…Ø© â€“ Ù…ØªØ§Ø¨Ø¹Ø© ØªØ´ØºÙŠÙ„ÙŠØ©';
    return [i+1, r.domain, `Ø±ÙØ¹ Ø§Ù„Ù…Ø¬Ø§Ù„ Ø¥Ù„Ù‰ â‰¥ ${target}% (ØªØ­Ø³Ù† ${diff}% Ø®Ù„Ø§Ù„ Ø§Ù„Ø¹Ø§Ù…)`, 'Ø³Ù†ÙˆÙŠØ§Ù‹', 'ÙØµÙ„ÙŠ/Ø´Ù‡Ø±ÙŠ', actions, 'Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ù…Ø¬Ø§Ù„', 'Ø§Ø³ØªØ¨Ø§Ù†Ø§Øª/Ø²ÙŠØ§Ø±Ø§Øª/Ù†ØªØ§Ø¦Ø¬ Ù…Ø¹ÙŠØ§Ø±ÙŠØ©', 'Ù…Ø­Ø§Ø¶Ø±/Ù†Ù…Ø§Ø°Ø¬/ØµÙˆØ±'];
  });
  const kpis={success:+(mean(summary.map(s=>s.yB))||0).toFixed(2), excellence:0, improvement:+(mean(summary.map(s=>s.yB-s.yA))||0).toFixed(2)};
  return {kind:'external', hdr, map:m, summary, kpis, plan};
}

function analyzeAttendance(table){
  const hdr=table[0].map(tidy); const m={grade:null,indicator:null,value:null};
  hdr.forEach((x,i)=>{const t=x.toLowerCase(); if(m.grade==null&&/(Ø§Ù„ØµÙ|grade|class)/.test(t)) m.grade=i; if(m.indicator==null&&/(Ø§Ù„Ø­Ø¶ÙˆØ±|Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø·|indicator|Ø§Ù„Ø¨Ù†Ø¯)/.test(t)) m.indicator=i; if(m.value==null&&/(Ø§Ù„Ù†Ø³Ø¨Ø©|%|value|score)/.test(t)) m.value=i;});
  const rows=table.slice(1).map(r=>({grade: tidy(r[m.grade]||'Ø§Ù„ÙƒÙ„'), ind: tidy(r[m.indicator]), val: pickNum(r[m.value])})).filter(r=>r.ind&&!isNaN(r.val));
  const groups=[...new Set(rows.map(r=>r.ind))];
  const summary=groups.map(g=>({indicator:g, avg:+mean(rows.filter(r=>r.ind===g).map(r=>r.val)).toFixed(2)}));
  const plan=summary.map((s,i)=>[i+1, s.indicator, `Ø±ÙØ¹ ${s.indicator} Ø¥Ù„Ù‰ â‰¥ ${Math.min(98, Math.ceil(s.avg+2))}%`, 'ÙØµÙ„ÙŠÙ†', 'Ø£Ø³Ø¨ÙˆØ¹ÙŠ', 'Ù…ØªØ§Ø¨Ø¹Ø© ØµÙ„Ø§Ø­ÙŠØ§Øª Ù†ÙˆØ±/Ø³Ø¬Ù„ ØªØ£Ø®Ø± â€“ Ø±Ø³Ø§Ø¦Ù„ Ù„ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± â€“ Ø­Ù…Ù„Ø§Øª Ø§Ù†Ø¶Ø¨Ø§Ø·', 'ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ø·Ù„Ø§Ø¨', '% Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø· / Ø§Ù„ØºÙŠØ§Ø¨', 'Ù†Ù…Ø§Ø°Ø¬ ÙˆØ§ØªØµØ§Ù„Ø§Øª']);
  const kpis={success:+(mean(summary.map(x=>x.avg))||0).toFixed(2), excellence:0, improvement:0};
  return {kind:'attendance', hdr, map:m, summary, kpis, plan};
}

function analyzeGeneric(table){
  const hdr=table[0].map(tidy);
  const cols = hdr.map((_,i)=>table.slice(1).map(r=>pickNum(r[i])).filter(x=>!isNaN(x)));
  const summary=hdr.map((h,i)=>({col:h||('Ø¹Ù…ÙˆØ¯ '+(i+1)), count:cols[i].length, avg:+mean(cols[i]).toFixed(2), sd:+std(cols[i]).toFixed(2)})).filter(x=>x.count>0).sort((a,b)=>b.count-a.count).slice(0,12);
  const plan=summary.map((s,i)=>[i+1, s.col, `ØªØ­Ø³ÙŠÙ† Ù…Ø¤Ø´Ø± ${s.col} ÙˆØ®ÙØ¶ Ø§Ù„ØªØ´ØªØª (Stdâ‰¤${Math.max(1, Math.ceil(s.sd*0.8))})`, 'Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±Ø©', 'Ø´Ù‡Ø±ÙŠ', 'ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª â€“ ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ù…ØµØ§Ø¯Ø± â€“ ØªØªØ¨Ù‘Ø¹ Ø¯ÙˆØ±ÙŠ', 'ÙØ±ÙŠÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'Ù…ØªÙˆØ³Ø·/Std/Ø§ØªØ³Ø§Ù‚', 'Ø³Ø¬Ù„ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª']);
  const kpis={success:+(mean(summary.map(x=>x.avg))||0).toFixed(2), excellence:0, improvement:0};
  return {kind:'generic', hdr, map:null, summary, kpis, plan};
}

/* ================ ØªØ¬Ø³ÙŠØ¯ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ================ */
let chartObj=null;
function renderKPIs(k){ const KP=document.getElementById('kpis'); KP.innerHTML='';
  [['Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­', (k.success??0)+'%'],['Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ù…ØªØ§Ø²',(k.excellence??0)+'%'],['Ø§Ù„ØªØ­Ø³Ù†',(k.improvement??0)+'%'],['Ø¹Ø¯Ø¯ Ù…Ø¤Ø´Ø±Ø§Øª', (Array.isArray(current.summary)? current.summary.length:0)]]
  .forEach(([n,v])=>{const d=document.createElement('div');d.className='kpi';d.innerHTML=`<div class="v">${v}</div><div class="small">${n}</div>`;KP.appendChild(d)});
}
function renderChart(kind, data){
  const ctx=document.getElementById('chart'); if(chartObj) chartObj.destroy();
  const type=document.getElementById('chartType').value;
  let labels=[], dsets=[];
  if(kind==='grades'){ labels=data.map(x=>x.grade+' â€“ '+x.subject); dsets=[{label:'Ø§Ù„Ù…ØªÙˆØ³Ø·',data:data.map(x=>x.avg)},{label:'% Ø¶Ø¹ÙŠÙ',data:data.map(x=>x.poorPct)},{label:'CV %',data:data.map(x=>x.cv||0)}]; }
  else if(kind==='external'){ labels=data.map(x=>x.domain); dsets=[{label:'Ø§Ù„Ø³Ù†Ø© A',data:data.map(x=>x.yA)},{label:'Ø§Ù„Ø³Ù†Ø© B',data:data.map(x=>x.yB)}]; }
  else if(kind==='attendance'){ labels=data.map(x=>x.indicator); dsets=[{label:'Ø§Ù„Ù…ØªÙˆØ³Ø·',data:data.map(x=>x.avg)}]; }
  else { labels=data.map(x=>x.col); dsets=[{label:'Ø§Ù„Ù…ØªÙˆØ³Ø·',data:data.map(x=>x.avg)},{label:'Std',data:data.map(x=>x.sd)}]; }
  chartObj=new Chart(ctx,{type: type==='line'?'line':type, data:{labels, datasets:dsets}, options:{responsive:true, plugins:{legend:{position:'bottom'}}, scales:{y:{beginAtZero:true}}}});
}
function renderDetail(kind, hdr, map, data){
  const D=document.getElementById('detail');
  if(kind==='grades'){
    const GH=hdr[map.grade]||'Ø§Ù„ØµÙ', SH=hdr[map.subject]||'Ø§Ù„Ù…Ø§Ø¯Ø©', VH=hdr[map.score]||'Ø§Ù„Ø¯Ø±Ø¬Ø©';
    D.innerHTML=`<table class="table"><thead><tr><th>${GH}</th><th>${SH}</th><th>Ø¹Ø¯Ø¯</th><th>Ù…ØªÙˆØ³Ø·</th><th>Std</th><th>CV%</th><th>% Ø¶Ø¹ÙŠÙ</th><th>% Ù…Ù…ØªØ§Ø²</th>${data[0].baseAvg!=null?'<th>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø£Ø³Ø§Ø³</th><th>Ø§Ù„ÙØ§Ø±Ù‚</th>':''}</tr></thead><tbody>${
      data.map(s=>`<tr><td>${s.grade}</td><td>${s.subject}</td><td>${s.count}</td><td>${s.avg}</td><td>${s.sd||0}</td><td>${s.cv||0}</td><td>${s.poorPct}</td><td>${s.excellentPct}</td>${s.baseAvg!=null?`<td>${s.baseAvg}</td><td>${s.diff}</td>`:''}</tr>`).join('')
    }</tbody></table>`;
  } else if(kind==='external'){
    const yA='Ø§Ù„Ø³Ù†Ø© A', yB='Ø§Ù„Ø³Ù†Ø© B';
    D.innerHTML=`<table class="table"><thead><tr><th>Ø§Ù„Ù…Ø¬Ø§Ù„</th><th>${yA}</th><th>${yB}</th><th>Ø§Ù„ÙØ§Ø±Ù‚</th></tr></thead><tbody>${
      data.map(r=>`<tr><td>${r.domain}</td><td>${r.yA}</td><td>${r.yB}</td><td>${(r.yB-r.yA).toFixed(2)}</td></tr>`).join('')
    }</tbody></table>`;
  } else if(kind==='attendance'){
    D.innerHTML=`<table class="table"><thead><tr><th>Ø§Ù„Ù…Ø¤Ø´Ø±</th><th>Ù…ØªÙˆØ³Ø·</th></tr></thead><tbody>${
      data.map(r=>`<tr><td>${r.indicator}</td><td>${r.avg}</td></tr>`).join('')
    }</tbody></table>`;
  } else {
    D.innerHTML=`<table class="table"><thead><tr><th>Ø§Ù„Ø¹Ù…ÙˆØ¯</th><th>Count</th><th>Average</th><th>Std</th></tr></thead><tbody>${
      data.map(r=>`<tr><td>${r.col}</td><td>${r.count}</td><td>${r.avg}</td><td>${r.sd}</td></tr>`).join('')
    }</tbody></table>`;
  }
}
function renderPlan(rows){ const P=document.getElementById('plan'); P.innerHTML=`<table class="table"><thead><tr><th>#</th><th>Ø§Ù„Ù…Ø¬Ø§Ù„/Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ù‡Ø¯Ù (SMART)</th><th>Ø§Ù„ÙØµÙ„</th><th>Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th><th>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th><th>Ø§Ù„Ù…Ø¤Ø´Ø±</th><th>Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯</th></tr></thead><tbody>${
  rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('')
}</tbody></table>`}

let current={kind:null, hdr:[], map:null, summary:[], kpis:{}, plan:[]};

/* ================ Ø²Ø± Ø§Ù„ØªØ­Ù„ÙŠÙ„ (ÙŠØ¯ÙˆÙŠ ÙˆØªÙ„Ù‚Ø§Ø¦ÙŠ) ================ */
document.getElementById('btnAnalyze').addEventListener('click',()=>runAnalyze(false));
document.getElementById('btnAuto').addEventListener('click',()=>runAnalyze(true));

async function readAsTableOrText(file){
  const ext=(file.name.split('.').pop()||'').toLowerCase();
  if(['xlsx','xls','csv'].includes(ext)) return {table: await tableFromWorkbook(file)};
  const txt = await textFromFile(file); return {table: textToTable(txt), raw: txt};
}

async function runAnalyze(auto){
  try{
    setP(5); const diag=document.getElementById('diag'); diag.style.display='none'; diag.textContent='';
    const f1=document.getElementById('file1').files[0]; if(!f1) return alert('ÙØ¶Ù„Ø§Ù‹ Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„Ù (Ù¡) Ø£ÙˆÙ„Ù‹Ø§.');
    const f2=document.getElementById('file2').files[0]||null;

    // Ù…Ù„Ù Ù¡
    const r1=await readAsTableOrText(f1); setP(25);
    if(!r1.table || !r1.table.length) throw new Error('ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù (Ù¡). ÙŠÙÙØ¶Ù‘Ù„ Excel/CSV.');
    extractWeeksFromTable(r1.table);

    // Ù…Ù„Ù Ù¢ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©)
    let t2=null; if(f2){ const r2=await readAsTableOrText(f2); setP(45); t2=r2.table; extractWeeksFromTable(r2.table); }

    const headers=r1.table[0].map(tidy);
    const kind=detectKind(headers);

    if(kind==='weekly'){ extractWeeksFromTable(r1.table); }

    if(kind==='grades')    current = analyzeGrades(r1.table, t2);
    else if(kind==='external') current = analyzeExternal(r1.table, t2);
    else if(kind==='attendance') current = analyzeAttendance(r1.table);
    else                       current = analyzeGeneric(r1.table);

    setP(75);
    renderKPIs(current.kpis);
    renderChart(current.kind, current.summary);
    renderDetail(current.kind, current.hdr, current.map, current.summary);
    renderPlan(current.plan);

    setP(100);
    diag.style.display='block';
    const nameMapInfo = current.kind==='grades'
      ? `Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†: <strong>${current.hdr[current.map.grade]||'Ø§Ù„ØµÙ'}</strong> / <strong>${current.hdr[current.map.subject]||'Ø§Ù„Ù…Ø§Ø¯Ø©'}</strong> / <strong>${current.hdr[current.map.score]||'Ø§Ù„Ø¯Ø±Ø¬Ø©'}</strong>`
      : `Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©: ${current.hdr.length}`;
    diag.innerHTML = `ØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ (${ {grades:'Ù†ØªØ§Ø¦Ø¬/Ø¯Ø±Ø¬Ø§Øª', external:'ØªÙ‚ÙˆÙŠÙ… Ø®Ø§Ø±Ø¬ÙŠ', attendance:'Ø­Ø¶ÙˆØ±/Ø§Ù†Ø¶Ø¨Ø§Ø·', generic:'Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø§Ù…Ø©'}[current.kind] }). ${nameMapInfo}.`;
  }catch(e){
    setP(0);
    const diag=document.getElementById('diag'); diag.style.display='block'; diag.innerHTML=`ØªØ¹Ø°Ù‘Ø± Ø§Ù„ØªØ­Ù„ÙŠÙ„: ${e.message}`;
  }
}

/* ================ ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ù… ================= */
document.getElementById('chartType').addEventListener('change',()=>{
  if(current.kind) renderChart(current.kind, current.summary);
});

/* ================ ØªØµØ¯ÙŠØ± Ø§Ù„Ø®Ø·Ø© ================= */
document.getElementById('btnExportPlan').addEventListener('click', ()=>{
  if(!current.plan || !current.plan.length) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø·Ø© Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§.');
  const rows=[['#','Ø§Ù„Ù…Ø¬Ø§Ù„/Ø§Ù„Ù…Ø§Ø¯Ø©','Ø§Ù„Ù‡Ø¯Ù (SMART)','Ø§Ù„ÙØµÙ„','Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹','Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡','Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„','Ø§Ù„Ù…Ø¤Ø´Ø±','Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯'], ...current.plan];
  const ws=XLSX.utils.aoa_to_sheet(rows), wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Ø®Ø·Ø© ØªØ­Ø³ÙŠÙ†');
  XLSX.writeFile(wb,'Ø®Ø·Ø©-ØªØ­Ø³ÙŠÙ†-Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ.xlsx');
});

/* ================ Ø­ÙØ¸ ØªÙ‚Ø±ÙŠØ± A4 ================= */
document.getElementById('btnPDF').addEventListener('click', async ()=>{
  if(!current.kind){ return alert('Ø­Ù„Ù‘Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.'); }
  const modal=document.getElementById('reportModal'); const rDate=document.getElementById('rDate'); rDate.textContent=moment().format('iYYYY/iMM/iDD Ù‡Ù€');
  const rBody=document.getElementById('rBody');

  // Ù„Ù‚Ø·Ø© Ø§Ù„Ø±Ø³Ù… ÙƒØµÙˆØ±Ø©
  let chartImg=''; try{ chartImg = chartObj? `<div style="text-align:center;margin:6px 0"><img src="${chartObj.toBase64Image()}" style="max-width:720px;width:100%"></div>`:''; }catch{}

  // Ø¬Ø¯ÙˆÙ„ Ù…Ù„Ø®Øµ Ù…Ø®ØªØµØ±
  let tbl='';
  if(current.kind==='grades'){
    tbl = `<table class="table"><thead><tr><th>${current.hdr[current.map.grade]||'Ø§Ù„ØµÙ'}</th><th>${current.hdr[current.map.subject]||'Ø§Ù„Ù…Ø§Ø¯Ø©'}</th><th>Ø¹Ø¯Ø¯</th><th>Ù…ØªÙˆØ³Ø·</th><th>Std</th><th>CV%</th><th>% Ø¶Ø¹ÙŠÙ</th><th>% Ù…Ù…ØªØ§Ø²</th></tr></thead><tbody>${
      current.summary.slice(0,12).map(s=>`<tr><td>${s.grade}</td><td>${s.subject}</td><td>${s.count}</td><td>${s.avg}</td><td>${s.sd||0}</td><td>${s.cv||0}</td><td>${s.poorPct}</td><td>${s.excellentPct}</td></tr>`).join('')
    }</tbody></table>`;
  }else if(current.kind==='external'){
    tbl = `<table class="table"><thead><tr><th>Ø§Ù„Ù…Ø¬Ø§Ù„</th><th>Ø§Ù„Ø³Ù†Ø© A</th><th>Ø§Ù„Ø³Ù†Ø© B</th><th>Ø§Ù„ÙØ§Ø±Ù‚</th></tr></thead><tbody>${
      current.summary.slice(0,12).map(r=>`<tr><td>${r.domain}</td><td>${r.yA}</td><td>${r.yB}</td><td>${(r.yB-r.yA).toFixed(2)}</td></tr>`).join('')
    }</tbody></table>`;
  }else if(current.kind==='attendance'){
    tbl = `<table class="table"><thead><tr><th>Ø§Ù„Ù…Ø¤Ø´Ø±</th><th>Ù…ØªÙˆØ³Ø·</th></tr></thead><tbody>${
      current.summary.slice(0,12).map(r=>`<tr><td>${r.indicator}</td><td>${r.avg}</td></tr>`).join('')
    }</tbody></table>`;
  }else{
    tbl = `<table class="table"><thead><tr><th>Ø§Ù„Ø¹Ù…ÙˆØ¯</th><th>Count</th><th>Average</th><th>Std</th></tr></thead><tbody>${
      current.summary.slice(0,12).map(r=>`<tr><td>${r.col}</td><td>${r.count}</td><td>${r.avg}</td><td>${r.sd}</td></tr>`).join('')
    }</tbody></table>`;
  }

  // Ø®Ø·Ø©
  const planHTML = `<h3 style="margin:8px 0 6px">Ø®Ø·Ø© ØªØ­Ø³ÙŠÙ† SMART</h3><table class="table"><thead><tr><th>#</th><th>Ø§Ù„Ù…Ø¬Ø§Ù„/Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ù‡Ø¯Ù (SMART)</th><th>Ø§Ù„ÙØµÙ„</th><th>Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th><th>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th><th>Ø§Ù„Ù…Ø¤Ø´Ø±</th><th>Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯</th></tr></thead><tbody>${
    current.plan.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('')
  }</tbody></table>`;

  rBody.innerHTML = (chartImg || '') + tbl + planHTML;

  // Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø§ÙØ°Ø©
  modal.style.display='flex';

  // Ø­ÙØ¸ PDF Ø¨Ù‚ÙŠØ§Ø³ A4
  const { jsPDF } = window.jspdf;
  const a4node=document.getElementById('a4');

  const canvas=await html2canvas(a4node,{scale:2,background:'#fff'});
  const pdf=new jsPDF('p','pt','a4');
  const img=canvas.toDataURL('image/png'); const pw=pdf.internal.pageSize.getWidth(), ph=pdf.internal.pageSize.getHeight(); const r=Math.min(pw/canvas.width, ph/canvas.height);
  pdf.addImage(img,'PNG',(pw-canvas.width*r)/2,(ph-canvas.height*r)/2,canvas.width*r,canvas.height*r);
  pdf.save('ØªÙ‚Ø±ÙŠØ±-Ø§Ù„ØªØ­Ù„ÙŠÙ„-ÙˆØ§Ù„ØªØ­Ø³ÙŠÙ†-A4.pdf');
});

document.getElementById('closeReport').addEventListener('click',()=>{ document.getElementById('reportModal').style.display='none'; });

/* ================ Ù…Ø³Ø­ ================ */
document.getElementById('btnClear').addEventListener('click',()=>{
  current={kind:null,hdr:[],map:null,summary:[],kpis:{},plan:[]};
  document.getElementById('kpis').innerHTML='';
  document.getElementById('detail').innerHTML='';
  document.getElementById('plan').innerHTML='';
  const ctx=document.getElementById('chart'); if(chartObj){ chartObj.destroy(); ctx.getContext('2d').clearRect(0,0,ctx.width,ctx.height); }
  document.getElementById('diag').style.display='none';
  setP(0);
});

/* Ø£Ø³Ù„Ø§Ùƒ Ø§Ù„Ø¯Ø±ÙˆØ¨Ø²ÙˆÙ† */
function wireDrop(dzId,inputId,labelId){
  const dz=document.getElementById(dzId), inp=document.getElementById(inputId), lab=document.getElementById(labelId);
  ['dragover','dragenter'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();dz.classList.add('on')}));
  ['dragleave','dragend','drop'].forEach(ev=>dz.addEventListener(ev,()=>dz.classList.remove('on')));
  dz.addEventListener('click',()=>inp.click());
  dz.addEventListener('drop',e=>{e.preventDefault();inp.files=e.dataTransfer.files;lab.textContent=Array.from(inp.files).map(f=>f.name).join(' â€¢ ');});
  inp.addEventListener('change',()=>lab.textContent=Array.from(inp.files).map(f=>f.name).join(' â€¢ ')||'Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù');
}
wireDrop('dz1','file1','f1Name'); wireDrop('dz2','file2','f2Name');
</script>
</body>
</html>
