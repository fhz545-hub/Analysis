<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù…Ù†ØµØ© Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ§Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø¤Ø³Ø³ÙŠ â€“ Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ</title>

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --moe:#0b7e88; --ink:#02343b; --bg:#f5f8f8;
  --muted:#7a9aa0; --ok:#35bfa3; --warn:#ffb347; --bad:#ff4d4d;
  --card:#ffffff; --line:#e6efef;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:'Tajawal',sans-serif}

/* Header image */
.header{width:100%;height:260px;overflow:hidden;background:#013a40}
.header img{width:100%;height:100%;object-fit:cover;display:block}

/* Controls */
.controls{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;padding:14px}
.btn{background:var(--moe);color:#fff;border:0;border-radius:10px;padding:10px 18px;font-weight:700;cursor:pointer;box-shadow:0 6px 16px rgba(11,126,136,.2)}
.btn.secondary{background:#1f6e7a}
.btn:hover{filter:brightness(.95)}
.btn.icon{display:inline-flex;align-items:center;gap:8px}

/* Grid */
.container{max-width:1200px;margin:0 auto;padding:10px 14px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px}
.card{background:var(--card);border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.08);padding:16px;position:relative}
.card h2{margin:0 0 6px;color:var(--moe)}
.kpi{display:flex;justify-content:space-between;align-items:center;color:var(--muted)}
.progress{height:12px;background:#e6efef;border-radius:999px;overflow:hidden;margin:8px 0}
.bar{height:100%}
.badge{padding:2px 8px;border-radius:99px;background:#e6efef;color:#246;font-size:12px}
.small{font-size:12px;color:#567}
.actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}

/* Detail view */
.detail{display:none;margin-top:12px;border-top:1px dashed #e1ecec;padding-top:10px}
.detail h3{margin:0 0 8px}
.subgrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:14px}
.sub{background:#f7fbfb;border:1px solid #e6efef;border-radius:12px;padding:12px}
.sub .hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.levelTag{font-weight:700;color:#345}

/* Evidence */
.evi{display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-top:8px}
.evi input[type=text], .evi select{border:1px solid #d7e7e7;border-radius:8px;padding:6px}
.link{color:#0b7e88;text-decoration:none}
.link:hover{text-decoration:underline}

/* Modal (evidence preview / add) */
.modal{position:fixed;inset:0;background:rgba(2,52,59,.55);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:9999}
.modal .sheet{width:min(860px,92vw);max-height:90vh;overflow:auto;background:#fff;border-radius:14px;box-shadow:0 16px 40px rgba(0,0,0,.35);padding:16px;position:relative}
.modal .close{position:absolute;top:10px;left:10px;border:0;background:#e8eff0;color:#034;padding:6px 10px;border-radius:8px;cursor:pointer;font-weight:700}

/* Footer */
.footer{padding:16px;text-align:center;color:#7a9aa0}

/* report/plan tab (A4) */
@media print { .no-print{display:none} }
</style>
</head>
<body>

<!-- Header image only (Ø¶Ø¹ Ù…Ù„ÙÙƒ Ø¨Ø§Ø³Ù… logo.png ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù„Ø¯) -->
<div class="header"><img src="logo.png" alt="Header"></div>

<div class="controls">
  <button class="btn" id="btnAnalyze">ğŸ” ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„</button>
  <button class="btn secondary" id="btnFullReport">ğŸ“˜ ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„</button>
  <button class="btn secondary" id="btnFullPlan">ğŸ—‚ï¸ Ø®Ø·Ø© ØªØ­Ø³ÙŠÙ† Ø´Ø§Ù…Ù„Ø©</button>
</div>

<div class="container">
  <div id="dashboard" class="grid"></div>
</div>

<!-- Evidence modal -->
<div class="modal" id="eviModal">
  <div class="sheet" id="eviSheet">
    <button class="close" onclick="hideModal()">âœ• Ø¥ØºÙ„Ø§Ù‚</button>
    <h3 style="margin-top:0;color:#0b7e88">Ø¥Ø¶Ø§ÙØ©/Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯</h3>
    <div id="eviBody"></div>
  </div>
</div>

<div class="footer">Â© 1447 Ù‡Ù€ â€“ Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ â€“ Ù…Ù†ØµØ© Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ§Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø¤Ø³Ø³ÙŠ</div>

<script>
/* ========== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© ========== */
const STORE = 'yaqoubi_improve_1447';
const mem   = JSON.parse(localStorage.getItem(STORE)||'{}');
function saveMem(){ localStorage.setItem(STORE, JSON.stringify(mem)); }
function todayHijri(){
  try{
    const fmt = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', {year:'numeric', month:'numeric', day:'numeric'});
    return fmt.format(new Date());
  }catch(e){ return '1447/â€”/â€”'; }
}
const levelOf = v => (v>=90?{txt:'ØªÙ…ÙŠÙ‘Ø²',color:'#10b981'}:v>=75?{txt:'ØªÙ‚Ø¯Ù‘Ù…',color:'#35bfa3'}:v>=50?{txt:'Ø§Ù†Ø·Ù„Ø§Ù‚',color:'#ffb347'}:{txt:'ØªÙ‡ÙŠØ¦Ø©',color:'#ff4d4d'});
const fmt = n => Number(n).toFixed(2);

/* ========== ØªÙ‚ÙˆÙŠÙ… (Ù‡Ø¬Ø±ÙŠ) Ù…Ø®ØªØµØ± Ù„Ù„Ø±Ø¨Ø· Ø§Ù„Ø²Ù…Ù†ÙŠ ========== */
const calendarHijri = [
  { h:'1447/02/18', label:'Ø¹ÙˆØ¯Ø© Ø§Ù„Ù‡ÙŠØ¦Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©' },
  { h:'1447/02/23', label:'Ø¹ÙˆØ¯Ø© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†' },
  { h:'1447/03/01', label:'Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ' },
  { h:'1447/04/01', label:'Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„ÙŠÙˆÙ… Ø§Ù„ÙˆØ·Ù†ÙŠ' },
  { h:'1447/06/20', label:'Ø¥Ø¬Ø§Ø²Ø© Ø¥Ø¶Ø§ÙÙŠØ©' },
  { h:'1447/07/20', label:'Ø¥Ø¬Ø§Ø²Ø© Ù…Ù†ØªØµÙ Ø§Ù„Ø¹Ø§Ù…' },
  { h:'1447/09/05', label:'ÙŠÙˆÙ… Ø§Ù„ØªØ£Ø³ÙŠØ³' },
  { h:'1447/09/17', label:'Ø¨Ø¯Ø§ÙŠØ© Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„ÙØ·Ø±' },
  { h:'1447/12/05', label:'Ø¨Ø¯Ø§ÙŠØ© Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ø£Ø¶Ø­Ù‰' },
];

/* ========== Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¬Ø§Ù„Ø§Øª + ØªÙØµÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª/Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª ==========
   â€” Ø§Ù„Ù‚ÙŠÙ… Ù…Ø£Ø®ÙˆØ°Ø© ÙˆÙ…Ù‡ÙŠÙƒÙ„Ø© Ø¨Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„ØªØ¹Ù…Ù„ ÙÙˆØ±Ù‹Ø§.
   â€” Ø²ÙØ¯ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª ÙƒÙ…Ø§ ØªØ´Ø§Ø¡ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ù†Ø³Ù‚. */
const fields = {
  management: {
    name:'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©', v2024:75.50, v2025:75.50,
    subs:[
      {code:'1-1-1-1', title:'ØªØ¶Ø¹ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø®Ø·Ø© ØªØ´ØºÙŠÙ„ÙŠØ© Ù…ØªÙƒØ§Ù…Ù„Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙˆÙÙ‚ Ø£Ù‡Ø¯Ø§Ù ØªØ·ÙˆÙŠØ±ÙŠØ© Ù…Ø­Ø¯Ø¯Ø©', score:81.75, level:'ØªÙ‚Ø¯Ù‘Ù…',
        improve:['Ù„ÙˆØ­Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© Ù„Ù„Ø®Ø·Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©','Ù…Ø¤Ø´Ø±Ø§Øª Ø¥Ù†Ø¬Ø§Ø² Ù„ÙƒÙ„ Ù‚Ø³Ù…','Ø§Ø¬ØªÙ…Ø§Ø¹ ØªØ­Ø³ÙŠÙ†ÙŠ Ø´Ù‡Ø±ÙŠ'],
      },
      {code:'2-1-1-1', title:'Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ØªÙÙÙŠØ¯ ØªÙ†ÙÙŠØ°Ù‡Ø§ Ø®Ø·ØªÙ‡Ø§ ÙˆØªØ·ÙˆÙŠØ±Ù‡Ø§ Ø¨Ù…Ø§ ÙŠØ¶Ù…Ù† ØªØ­Ù‚ÙŠÙ‚ Ø£Ù‡Ø¯Ø§ÙÙ‡Ø§', score:72.00, level:'Ø§Ù†Ø·Ù„Ø§Ù‚',
        improve:['ØªØºØ°ÙŠØ© Ø±Ø§Ø¬Ø¹Ø© Ø¯ÙˆØ±ÙŠØ©','Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±','ØªÙ‚Ø§Ø±ÙŠØ± Ø¥Ù†Ø¬Ø§Ø² Ù…Ø®ØªØµØ±Ø©'],
      },
      {code:'1-4-1-1', title:'ØªØ´Ø¬Ø¹ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ù…Ù†Ø³ÙˆØ¨ÙŠÙ‡Ø§ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø®ØµØ© Ø§Ù„Ù…Ù‡Ù†ÙŠØ©', score:63.00, level:'ØªÙ‡ÙŠØ¦Ø©',
        improve:['Ø¨Ø±Ø§Ù…Ø¬ Ø¯Ø¹Ù… Ø§Ù„Ø±Ø®ØµØ©','ØªØ­ÙÙŠØ²Ø§Øª','Ø®Ø·Ø· ÙØ±Ø¯ÙŠØ©'],
      },
      {code:'4-1-4-1', title:'ØªÙ†ÙØ° Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø®Ø·Ø© Ù„ØªØ­Ø³ÙŠÙ† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ', score:70.00, level:'Ø§Ù†Ø·Ù„Ø§Ù‚',
        improve:['ØªØ­Ù„ÙŠÙ„ ÙØ¬ÙˆØ§Øª','Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù‚ØµÙŠØ±Ø© Ø§Ù„Ø£Ø¬Ù„','Ù…ØªØ§Ø¨Ø¹Ø© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©'],
      },
    ]
  },
  teaching: {
    name:'Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„ØªØ¹Ù„Ù…', v2024:80.75, v2025:81.50,
    subs:[
      {code:'1-1-1-2', title:'ØªÙˆÙØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ÙØ±ØµÙ‹Ø§ Ù…ØªÙƒØ§ÙØ¦Ø© Ù„Ù„ØªØ¹Ù„Ù… Ù„Ø°ÙˆÙŠ Ø§Ù„Ø¥Ø¹Ø§Ù‚Ø© ÙˆØ§Ù„Ù…ÙˆÙ‡ÙˆØ¨ÙŠÙ†', score:76.75, level:'ØªÙ‚Ø¯Ù‘Ù…',
        improve:['ØªÙƒÙŠÙŠÙ Ø§Ù„Ø£Ù†Ø´Ø·Ø©','Ù…Ù„ÙØ§Øª ØªÙ‚Ø¯Ù…','Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ø±Ù†Ø©'],
      },
      {code:'2-1-1-2', title:'ØªØ¯Ø¹Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ù†Ù‡Ø¬ Ù„ØªØ­Ù‚ÙŠÙ‚ Ù†ÙˆØ§ØªØ¬ Ø§Ù„ØªØ¹Ù„Ù… Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©', score:97.75, level:'ØªÙ…ÙŠÙ‘Ø²',
        improve:['Ø®Ø±Ø§Ø¦Ø· ØªØ¹Ù„Ù…','Ù‡ÙŠÙƒÙ„Ø© Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø¨Ù†Ø§Ø¦ÙŠ','Ù…ØµØ§Ø¯Ø± Ø¥Ø«Ø±Ø§Ø¦ÙŠØ©'],
      },
      {code:'4-1-1-2', title:'ØªÙØ¹Ù‘Ù„ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„ØªØ¹Ù„Ù… Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', score:79.25, level:'ØªÙ‚Ø¯Ù‘Ù…',
        improve:['Ø­ØµØµ Ù…ØªØ²Ø§Ù…Ù†Ø©','Ù…Ù‡Ù…Ø§Øª Ø±Ù‚Ù…ÙŠØ©','ØªÙ‚Ø§Ø±ÙŠØ± Ù…Ù†ØµØ©'],
      }
    ]
  },
  learning: {
    name:'Ù†ÙˆØ§ØªØ¬ Ø§Ù„ØªØ¹Ù„Ù…', v2024:78.50, v2025:78.50,
    subs:[
      {code:'1-1-1-3', title:'ÙŠØ­Ù‚Ù‚ Ø§Ù„Ù…ØªØ¹Ù„Ù…ÙˆÙ† Ù†ØªØ§Ø¦Ø¬ Ù…ØªÙ‚Ø¯Ù…Ø© ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ØªØ­ØµÙŠÙ„ÙŠØ©', score:79.04, level:'ØªÙ‚Ø¯Ù‘Ù…',
        improve:['Ø¨Ù†ÙˆÙƒ Ø£Ø³Ø¦Ù„Ø©','Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù‚ØµÙŠØ±Ø© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©','ØªØ­Ù„ÙŠÙ„ ÙÙˆØ±ÙŠ'],
      },
      {code:'2-1-1-3', title:'ÙŠØ­Ù‚Ù‚ Ø§Ù„Ù…ØªØ¹Ù„Ù…ÙˆÙ† Ù†ØªØ§Ø¦Ø¬ Ù…ØªÙ‚Ø¯Ù…Ø© ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ÙˆØ·Ù†ÙŠØ©', score:82.94, level:'ØªÙ‚Ø¯Ù‘Ù…',
        improve:['Ù†Ù…Ø§Ø°Ø¬ ÙˆØ·Ù†ÙŠØ©','Ù…Ø­Ø§ÙƒØ§Ø©','ØªØ¯Ø±ÙŠØ¨ Ø¹Ù„Ù‰ Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±'],
      },
      {code:'7-1-2-3', title:'ÙŠØ¸Ù‡Ø± Ø§Ù„Ù…ØªØ¹Ù„Ù…ÙˆÙ† Ø§Ø¹ØªØ²Ø§Ø²Ø§Ù‹ Ø¨Ù‚ÙŠÙ…Ù‡Ù… ÙˆÙ‡ÙˆÙŠØªÙ‡Ù… Ø§Ù„ÙˆØ·Ù†ÙŠØ©', score:91.75, level:'ØªÙ…ÙŠÙ‘Ø²',
        improve:['Ù…Ø´Ø§Ø±ÙŠØ¹ ÙˆØ·Ù†ÙŠØ©','Ù…Ù†Ø§Ø³Ø¨Ø§Øª ÙˆØ·Ù†ÙŠØ©','Ø¥Ù†ØªØ§Ø¬Ø§Øª Ø·Ù„Ø§Ø¨ÙŠØ©'],
      }
    ]
  },
  environment: {
    name:'Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©', v2024:64.00, v2025:62.25,
    subs:[
      {code:'1-1-1-4', title:'ØªÙ†Ø¸ÙŠÙ… Ù…Ø¨Ù†Ù‰ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ù…Ù„Ø§Ø¦Ù… Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† ÙˆØ§Ù„Ù…Ø±Ø­Ù„Ø©', score:73.25, level:'Ø§Ù†Ø·Ù„Ø§Ù‚',
        improve:['Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù‚Ø§Ø¹Ø§Øª','Ù…Ø®Ø§Ø±Ø¬ Ø·ÙˆØ§Ø±Ø¦','Ø®Ø±Ø§Ø¦Ø· Ø³Ù„Ø§Ù…Ø©'],
      },
      {code:'1-2-4-4', title:'ØªÙˆÙØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ù…Ø¯Ø§Ø®Ù„ ÙˆÙ…Ø®Ø§Ø±Ø¬ Ø¢Ù…Ù†Ø© ÙˆÙ…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø£Ù…Ù† ÙˆØ§Ù„Ø³Ù„Ø§Ù…Ø©', score:64.00, level:'ØªÙ‡ÙŠØ¦Ø©',
        improve:['Ù…Ø³Ø§Ø±Ø§Øª Ø¥Ø®Ù„Ø§Ø¡','Ù„ÙˆØ­Ø§Øª Ø³Ù„Ø§Ù…Ø©','Ø­Ù‚Ø§Ø¦Ø¨ Ø¥Ø³Ø¹Ø§Ù'],
      },
      {code:'3-1-2-4', title:'ØªØ­Ø§ÙØ¸ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø¹Ù„Ù‰ Ù†Ø¸Ø§ÙØ© Ø§Ù„Ù…Ø¨Ù†Ù‰', score:79.50, level:'ØªÙ‚Ø¯Ù‘Ù…',
        improve:['Ø¬Ø¯Ø§ÙˆÙ„ Ù†Ø¸Ø§ÙØ©','Ù…Ø±Ø§Ù‚Ø¨Ø© ÙŠÙˆÙ…ÙŠØ©','ØªÙˆØ¹ÙŠØ© Ø³Ù„ÙˆÙƒÙŠØ©'],
      }
    ]
  }
};

/* ========== Ø±Ø³Ù… Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¬Ø§Ù„Ø§Øª ========== */
function renderDashboard(){
  const dash = document.getElementById('dashboard'); dash.innerHTML='';
  Object.entries(fields).forEach(([key,f])=>{
    const lvl=levelOf(f.v2025);
    const card=document.createElement('div'); card.className='card'; card.id=`card-${key}`;
    card.innerHTML=`
      <h2>${f.name}</h2>
      <div class="kpi"><span>2024: ${fmt(f.v2024)}% â†’ 2025: ${fmt(f.v2025)}%</span><span class="badge">${lvl.txt}</span></div>
      <div class="progress"><div class="bar" style="width:${Math.max(2,f.v2025)}%;background:${lvl.color}"></div></div>
      <canvas id="donut-${key}" height="150"></canvas>
      <div class="actions">
        <button class="btn" onclick="toggleDetail('${key}')">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØµÙŠÙ„</button>
        <button class="btn secondary" onclick="openFieldReport('${key}')">ğŸ§¾ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¬Ø§Ù„</button>
        <button class="btn secondary" onclick="openFieldPlan('${key}')">ğŸ’¡ Ø®Ø·Ø© ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø¬Ø§Ù„</button>
      </div>
      <div class="detail" id="detail-${key}"></div>
    `;
    dash.appendChild(card);

    const ctx = document.getElementById(`donut-${key}`).getContext('2d');
    new Chart(ctx,{type:'doughnut',
      data:{labels:['2024','2025'],datasets:[{data:[f.v2024,f.v2025],backgroundColor:['#dfecec',lvl.color]}]},
      options:{plugins:{legend:{position:'bottom'}},cutout:'65%'}
    });
  });
}

/* ========== ÙØªØ­ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¬Ø§Ù„ (ÙŠØ®ÙÙŠ Ø§Ù„Ø¨Ù‚ÙŠØ© ÙˆÙŠÙØ¸Ù‡Ø± Ø§Ù„ØªÙØµÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„) ========== */
function toggleDetail(key){
  const dash=document.getElementById('dashboard');
  Array.from(dash.children).forEach(c=>{ if(c.id!==`card-${key}`) c.style.display='none'; });
  const f=fields[key];
  const box=document.getElementById(`detail-${key}`);
  const opened=box.style.display==='block';
  if(opened){ resetView(); return; }

  // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„ÙƒØ¨ÙŠØ±Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¬Ø§Ù„ ÙˆØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ù„Ù…ÙŠÙ†ÙŠ
  const donut = document.querySelector(`#card-${key} canvas`);
  if(donut){ donut.height=90; donut.style.marginTop='-4px'; }

  const rows=f.subs.map(s=>{
    const lvl = levelOf(s.score);
    const keyE = `${key}__${s.code}`;
    const evis = (mem.evidence?.[keyE]||[]).map(e=>(
      `<li class="small">â€¢ ${e.week} â€” ${e.text||''}${e.fileName?` â€” <a class="link" href="${e.fileUrl||'#'}" target="_blank">${e.fileName}</a>`:''}</li>`
    )).join('');
    return `
      <div class="sub">
        <div class="hdr">
          <div><span class="levelTag">${s.code}</span> â€“ <strong>${s.title}</strong></div>
          <span class="badge" style="background:${lvl.color}22;color:${lvl.color}">${lvl.txt} â€“ ${fmt(s.score)}%</span>
        </div>
        <div class="small" style="margin:6px 0 10px;border-top:1px dashed var(--line);padding-top:8px">
          Ù…Ù‚ØªØ±Ø­Ø§Øª Ø§Ù„ØªØ­Ø³ÙŠÙ†: ${s.improve.join(' â€¢ ')}
        </div>
        <div class="evi">
          <input type="text" id="in-${key}-${s.code}" placeholder="Ø£Ø¶Ù Ø´Ø§Ù‡Ø¯/Ø¥Ø¬Ø±Ø§Ø¡ Ù…Ø®ØªØµØ±â€¦"/>
          <select id="wk-${key}-${s.code}">
            ${calendarHijri.map(c=>`<option value="${c.h}">${c.h} â€“ ${c.label}</option>`).join('')}
          </select>
          <input type="file" id="file-${key}-${s.code}" accept="application/pdf,image/*"/>
          <button class="btn" onclick="addEvidence('${key}','${s.code}')">Ø¥Ø¶Ø§ÙØ© Ø´Ø§Ù‡Ø¯</button>
          <button class="btn secondary" onclick="showEvidence('${key}','${s.code}','${s.title}')">Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯</button>
        </div>
        <ul id="evilist-${key}-${s.code}" style="margin:8px 0 0">${evis || '<li class="small">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´ÙˆØ§Ù‡Ø¯ Ø¨Ø¹Ø¯</li>'}</ul>
      </div>`;
  }).join('');

  box.innerHTML=`
    <h3 style="color:#0b7e88">Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ â€“ ${f.name}</h3>
    <div class="subgrid">${rows}</div>
    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" onclick="openFieldReport('${key}')">ğŸ§¾ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¬Ø§Ù„</button>
      <button class="btn" onclick="openFieldPlan('${key}')">ğŸ’¡ Ø®Ø·Ø© ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø¬Ø§Ù„</button>
      <button class="btn secondary" onclick="resetView()">ğŸ”™ Ø±Ø¬ÙˆØ¹ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¬Ø§Ù„Ø§Øª</button>
    </div>
  `;
  box.style.display='block';
}
function resetView(){
  const dash=document.getElementById('dashboard');
  Array.from(dash.children).forEach(c=>c.style.display='');
  document.querySelectorAll('.detail').forEach(d=>d.style.display='none');
}

/* ========== Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯ (Ø­ÙØ¸/Ø§Ø³ØªØ¹Ø±Ø§Ø¶) ========== */
async function addEvidence(fieldKey, code){
  const textEl=document.getElementById(`in-${fieldKey}-${code}`);
  const text=textEl?textEl.value.trim():'';
  const week=document.getElementById(`wk-${fieldKey}-${code}`)?.value || '';
  const fileInput=document.getElementById(`file-${fieldKey}-${code}`);

  let fileName='', fileUrl='', fileData='';
  if(fileInput?.files?.[0]){
    const f=fileInput.files[0]; fileName=f.name;
    fileData=await new Promise((res,rej)=>{const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f);});
    try{ fileUrl=URL.createObjectURL(fileInput.files[0]); }catch(e){}
  }
  if(!text && !fileName) return;

  mem.evidence = mem.evidence || {};
  const k = `${fieldKey}__${code}`;
  mem.evidence[k] = mem.evidence[k] || [];
  mem.evidence[k].push({text,week,fileName,fileUrl,fileData,ts:Date.now()});
  saveMem();

  const ul=document.getElementById(`evilist-${fieldKey}-${code}`);
  if(ul){
    const li=document.createElement('li'); li.className='small';
    li.innerHTML=`â€¢ ${week} â€” ${text||''} ${fileName?`â€” <a class='link' href='${fileUrl||"#"}' target='_blank'>${fileName}</a>`:''}`;
    ul.appendChild(li);
  }
  if(textEl) textEl.value='';
  if(fileInput) fileInput.value='';
}
function showEvidence(fieldKey, code, title){
  const list = mem.evidence?.[`${fieldKey}__${code}`]||[];
  const box  = document.getElementById('eviBody');
  box.innerHTML = `
    <div class="small" style="margin-bottom:8px;color:#0b7e88"><strong>Ø§Ù„Ù…Ø¬Ø§Ù„:</strong> ${fields[fieldKey].name} â€” <strong>Ø§Ù„Ù…Ø¤Ø´Ø±:</strong> ${title} â€” <strong>Ø§Ù„ÙƒÙˆØ¯:</strong> ${code}</div>
    ${list.length?'<ol style="padding-right:18px">'+list.map(e=>`
      <li style="margin:6px 0">
        ${e.week} â€” ${e.text||''}
        ${e.fileName?` â€” <a class="link" href="${e.fileUrl||'#'}" target="_blank">${e.fileName}</a>`:''}
      </li>`).join('')+'</ol>':'<div class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´ÙˆØ§Ù‡Ø¯ Ø¨Ø¹Ø¯.</div>'}
    <div style="margin-top:10px" class="no-print">
      <button class="btn" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
    </div>
  `;
  document.getElementById('eviModal').style.display='flex';
}
function hideModal(){ document.getElementById('eviModal').style.display='none'; }

/* ========== ØªØ¨ÙˆÙŠØ¨ Ø¬Ø¯ÙŠØ¯ Ù„Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ±/Ø®Ø·Ø© ========== */
function openPrintTab(title, bodyHTML){
  const w = window.open('', '_blank');
  const hijri = todayHijri();
  w.document.write(`
    <!doctype html><html lang="ar" dir="rtl"><head>
    <meta charset="utf-8"><title>${title}</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
      body{font-family:'Tajawal',sans-serif;color:#123;margin:18px}
      .header{border:1px solid #e9f1f1;border-radius:12px;padding:10px 12px;margin-bottom:12px}
      .rwrap{display:grid;grid-template-columns:1fr 140px 1fr;align-items:center;gap:14px}
      .left{text-align:left}.center{text-align:center}.right{text-align:right}
      .stack{line-height:1.6;font-weight:700;color:#0b7e88}
      img.logo{height:78px}
      h1{margin:10px 0 12px;color:#0b7e88;text-align:center}
      table{width:100%;border-collapse:collapse}
      th,td{border:1px solid #ddd;padding:6px}
      .muted{color:#5b7080}
      .printbar{display:flex;gap:8px;justify-content:center;margin:8px 0 16px}
      @media print{.printbar{display:none}}
    </style></head><body>
      <div class="header">
        <div class="rwrap">
          <div class="left">
            <div class="stack" style="text-align:center">
              <div>Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</div>
              <div>ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…</div>
              <div>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø¨Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø±Ù‚ÙŠØ©</div>
              <div>Ù…Ø¯Ø±Ø³Ø© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©</div>
            </div>
          </div>
          <div class="center"><img class="logo" src="ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ….png"></div>
          <div class="right"><strong>${hijri}</strong></div>
        </div>
      </div>
      <h1>${title}</h1>
      <div class="printbar"><button onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©/Ø­ÙØ¸ PDF</button></div>
      ${bodyHTML}
    </body></html>
  `);
  w.document.close();
}

/* ========== Ø¨Ù†Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ ØªÙ‚Ø±ÙŠØ±/Ø®Ø·Ø© Ø§Ù„Ù…Ø¬Ø§Ù„/Ø§Ù„Ø´Ø§Ù…Ù„ ========== */
function fieldSectionHTML(key){
  const f=fields[key];
  const items=f.subs.map(s=>{
    const lvl=levelOf(s.score);
    const k = `${key}__${s.code}`;
    const evis=(mem.evidence?.[k]||[]).map(e=>`${e.week} â€” ${e.text||''}${e.fileName?` â€” ${e.fileName}`:''}`).join(' | ') || 'â€”';
    return `<tr>
      <td>${s.code}</td>
      <td>${s.title}</td>
      <td>${fmt(s.score)}% (${lvl.txt})</td>
      <td>${evis}</td>
      <td>${s.improve.join('ØŒ ')}</td>
    </tr>`;
  }).join('');
  return `
    <h2 style="color:#0b7e88;margin:10px 0">${f.name}</h2>
    <div class="muted" style="margin-bottom:6px">Ø§Ù„Ø£Ø¯Ø§Ø¡: 2024 ${fmt(f.v2024)}% â†’ 2025 ${fmt(f.v2025)}%</div>
    <table>
      <thead><tr><th>Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„Ù…Ø¤Ø´Ø±</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th><th>Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯</th><th>Ù…Ù‚ØªØ±Ø­Ø§Øª Ø§Ù„ØªØ­Ø³ÙŠÙ†</th></tr></thead>
      <tbody>${items}</tbody>
    </table>
  `;
}
function openFieldReport(key){
  const html = fieldSectionHTML(key);
  openPrintTab('ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¬Ø§Ù„ â€“ '+fields[key].name, html);
}
function openFieldPlan(key){
  const f=fields[key];
  const rows=f.subs.map(s=>{
    const target = 90;
    const gap = Math.max(0, target - s.score).toFixed(2);
    const week = calendarHijri[2]?.h || todayHijri();
    return `<tr>
      <td>${s.title}</td>
      <td>${s.code}</td>
      <td>${gap}%</td>
      <td>${week}</td>
      <td>${s.improve.join('ØŒ ')}</td>
      <td>Ø´ÙˆØ§Ù‡Ø¯ Ø§Ù„ØªÙ†ÙÙŠØ° (Ø±ÙˆØ§Ø¨Ø·/Ù†Ù…Ø§Ø°Ø¬/ØµÙˆØ±)</td>
    </tr>`;
  }).join('');
  const html = `
    <div class="muted" style="margin-bottom:6px">Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø¹Ø§Ù…: Ø¨Ù„ÙˆØº Ù…Ø³ØªÙˆÙ‰ â€œØªÙ…ÙŠÙ‘Ø² â‰¥ 90%â€ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¬Ø§Ù„.</div>
    <table>
      <thead><tr><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th><th>Ø§Ù„ÙƒÙˆØ¯</th><th>ÙØ¬ÙˆØ© Ø§Ù„Ù…Ø¤Ø´Ø±</th><th>Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ (Ù‡Ø¬Ø±ÙŠ)</th><th>Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªÙ†ÙÙŠØ°</th><th>Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
  openPrintTab('Ø®Ø·Ø© ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø¬Ø§Ù„ â€“ '+f.name, html);
}
function openFull(kind){
  const title = kind==='plan' ? 'Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªØ­Ø³ÙŠÙ†ÙŠØ© Ø§Ù„Ø´Ø§Ù…Ù„Ø© â€“ Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ' : 'Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„ â€“ Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ';
  const list = Object.keys(fields).map(k=>{
    const f=fields[k];
    return `<li><strong>${f.name}:</strong> 2024 ${fmt(f.v2024)}% â†’ 2025 ${fmt(f.v2025)}%</li>`;
  }).join('');
  const body = `<ul>${list}</ul>` + Object.keys(fields).map(k=>fieldSectionHTML(k)).join('<hr/>');
  openPrintTab(title, body);
}

/* ========== Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ========== */
document.getElementById('btnAnalyze').addEventListener('click', renderDashboard);
document.getElementById('btnFullReport').addEventListener('click', ()=>openFull('report'));
document.getElementById('btnFullPlan').addEventListener('click', ()=>openFull('plan'));

/* Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ´ØºÙŠÙ„ */
renderDashboard();
</script>
</body>
</html>
