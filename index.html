<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ููุตุฉ ุงูุชุญููู ูุงูุชุญุณูู ุงููุฏุฑุณู โ ุซุงูููุฉ ุงููุนููุจู</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{
  --moe:#0b7e88; --ink:#06353b; --bg:#f5f8f8; --card:#ffffff;
  --shine1:#e8fbfb; --shine2:#d9f2f3; --muted:#6f8e94;
  --ok:#e9fff4; --vg:#eef5ff; --gd:#fff6ec; --md:#ffefef;
  /* ุฃููุงู ุงููุณุชููุงุช ุญุณุจ ุงูููุญู */
  --lv-excel:#16a34a;     /* ุงูุชูููุฒ โ ุฃุฎุถุฑ */
  --lv-progress:#2563eb;  /* ุงูุชูุฏูู โ ุฃุฒุฑู */
  --lv-launch:#f59e0b;    /* ุงูุงูุทูุงู โ ุจุฑุชูุงูู */
  --lv-ready:#e11d48;     /* ุงูุชููุฆุฉ โ ุฃุญูุฑ ูุฑูุฒู */
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:'Tajawal',sans-serif}
.page{max-width:1200px;margin:0 auto;padding:10px 14px}
a{color:#135;text-decoration:none}
a:hover{text-decoration:underline}

/* ุฑุฃุณ ุงูููุตุฉ (ุตูุฑุฉ ุจุนุฑุถ ุงูุตูุญุฉ) */
.header{
  width:100%;
  height:180px;           /* ููููู ุชุนุฏูู ุงูุงุฑุชูุงุน */
  border-radius:16px;
  overflow:hidden;
  box-shadow:0 10px 28px rgba(0,0,0,.12);
  background:linear-gradient(135deg,var(--shine1),var(--shine2));
  margin:12px auto;
}
.header img{
  width:100%;
  height:100%;
  object-fit:cover;       /* ูููุฃ ุงูุนุฑุถ ูุงููุงู ุจุฏูู ุชุดููู */
  display:block;
}

/* ุงูุฃุฒุฑุงุฑ */
.controls{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;padding:6px}
.btn{background:var(--moe);color:#fff;border:0;border-radius:12px;padding:10px 16px;font-weight:700;cursor:pointer;box-shadow:0 6px 18px rgba(11,126,136,.25)}
.btn.light{background:#eef6f7;color:#06353b}
.btn.ghost{background:#fff;color:var(--moe);border:1px solid #d7ecec}
.btn:hover{filter:brightness(.97)}
/* ููุณ ุงูููู ูุฒุฑู ุงูุชูููู ุงูุฎุงุฑุฌู */
.btn.eval{background:linear-gradient(135deg,#0b7e88,#22b8a0);box-shadow:0 8px 20px rgba(11,126,136,.25)}

/* ุงูุดุจูุฉ */
.grid{display:grid;grid-template-columns:repeat(4,minmax(260px,1fr));gap:16px}
@media (max-width:1150px){.grid{grid-template-columns:repeat(3,minmax(260px,1fr))}}
@media (max-width:900px){.grid{grid-template-columns:repeat(2,minmax(260px,1fr))}}
@media (max-width:620px){.grid{grid-template-columns:1fr}}

.card{
  background:linear-gradient(180deg,#ffffff 0%,#f9feff 100%);
  border-radius:16px;padding:14px;position:relative;
  box-shadow:0 10px 24px rgba(0,0,0,.08),inset 0 0 0 1px #e6efef;
}
.card h2{margin:0 0 6px;color:var(--moe);font-size:20px}
.kpi{display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:13px}
.progress{height:10px;background:#e6efef;border-radius:999px;overflow:hidden;margin:8px 0}
.bar{height:100%;background:#2aa897}
.badge{padding:2px 8px;border-radius:999px;background:#eaf6f6;color:#246;font-size:12px;font-weight:700}
.badge.excel{background:color-mix(in srgb,var(--lv-excel) 18%,#fff);color:var(--lv-excel)}
.badge.progress{background:color-mix(in srgb,var(--lv-progress) 18%,#fff);color:var(--lv-progress)}
.badge.launch{background:color-mix(in srgb,var(--lv-launch) 22%,#fff);color:var(--lv-launch)}
.badge.ready{background:color-mix(in srgb,var(--lv-ready) 20%,#fff);color:var(--lv-ready)}
.centerBar{display:flex;gap:8px;justify-content:center;align-items:center;margin:8px 0}

/* ููุญุฉ ุงูุชูุงุตูู */
.fullpanel{position:fixed;inset:0;z-index:9998;background:rgba(6,53,59,.06);display:none;align-items:flex-start;justify-content:center;padding:12px 8px 24px}
.fullpanel .inner{width:min(1200px,96vw);max-height:90vh;overflow:auto;background:#fff;border-radius:16px;box-shadow:0 20px 40px rgba(0,0,0,.20);padding:14px}
.fullpanel .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.fullpanel .topbar .title{font-weight:700;color:#0b7e88}
.fullpanel .close{background:#e8eff0;color:#034;border:0;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:700}
.subgrid{display:grid;grid-template-columns:repeat(2,minmax(160px,1fr));gap:8px}
.subCard{background:#f7fbfb;border:1px solid #e6efef;border-radius:12px;padding:10px}

/* ุงูุฌุฏุงูู */
.tableWrap{margin-top:10px;overflow:auto}
table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;table-layout:fixed}
thead th{background:#0f6f79;color:#fff;padding:10px;font-weight:700}
tbody td{padding:10px;border-bottom:1px solid #eef3f3;vertical-align:top;word-break:break-word}
tbody tr:last-child td{border-bottom:0}
.row-excellent{background:var(--ok)}
.row-verygood{background:var(--vg)}
.row-good{background:var(--gd)}
.row-medium{background:var(--md)}
.level{font-weight:700}

/* ูุงูุฐุฉ ุงูุดูุงูุฏ */
.modal{position:fixed;inset:0;background:rgba(2,52,59,.6);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:9999}
.sheet{width:min(940px,96vw);max-height:92vh;overflow:auto;background:#fff;border-radius:16px;box-shadow:0 12px 40px rgba(0,0,0,.35);padding:16px}
.sheet h4{margin:0 0 8px}
.row{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.row label{font-size:12px;color:#345}
input[type=text],input[type=file],select{border:1px solid #d7e7e7;border-radius:8px;padding:8px;width:100%}
.sheet .close{position:sticky;top:0;margin-bottom:8px;background:#e8eff0;border:0;color:#034;padding:6px 10px;border-radius:8px;cursor:pointer;font-weight:700}
.btn-evi{background:#0b7e88;color:#fff;border:0;border-radius:999px;padding:8px 14px;cursor:pointer;box-shadow:0 6px 16px rgba(11,126,136,.25);display:inline-flex;align-items:center;gap:6px}
.btn-evi svg{width:16px;height:16px}

/* ุงูุทุจุงุนุฉ */
@page{size:A4;margin:10mm}
@media print{
  .controls,.no-print,.fullpanel,.modal{display:none!important}
  .page{max-width:800px;margin:0 auto!important}
  .header{box-shadow:none!important;border:0!important}
}
.footer{padding:18px 10px;text-align:center;color:#7a9aa0}

/* ุตูุฑุฉ ุงูููุฏุฑ ุฏุงุฎู ุชูุงุฑูุฑ/ุฎุทุท A4 */
.reportHeader{
  width:100%;
  height:160px;
  object-fit:cover;
  border-radius:8px;
  display:block;
  margin-bottom:15px;
}
</style>
</head>
<body>
<div class="page">
  <div class="header" aria-label="ูุฒุงุฑุฉ ุงูุชุนููู โ ุดุนุงุฑ">
    <img id="siteLogo" src="" alt="ุดุนุงุฑ ูุฒุงุฑุฉ ุงูุชุนููู โ ุซุงูููุฉ ุงููุนููุจู">
  </div>

  <div class="controls">
    <button class="btn eval" id="btnExt2025">ุงูุชูููู ุงูุฎุงุฑุฌู ูขููขูฅู ๐</button>
    <button class="btn eval" id="btnExt2024">ุงูุชูููู ุงูุฎุงุฑุฌู ูขููขูคู ๐</button>
    <button class="btn" id="btnAnalyze">ุชุญููู ุดุงูู ๐</button>
    <button class="btn" id="btnFullReport">ุงูุชูุฑูุฑ ุงูุดุงูู PDF ๐</button>
    <button class="btn" id="btnFullPlan">ุงูุฎุทุฉ ุงูุดุงููุฉ PDF ๐๏ธ</button>
  </div>

  <div id="dashboard" class="grid"></div>

  <div class="footer">ุชูููุฐ ูุชุตููู ููุฏ ุญุงูุฏ ุงูุฒูุฑุงูู</div>
</div>

<!-- ุชูุงุตูู ุงููุฌุงู -->
<div class="fullpanel" id="fullPanel" aria-hidden="true">
  <div class="inner">
    <div class="topbar">
      <div class="title" id="fpTitle">ุงูุชูุงุตูู</div>
      <div style="display:flex;gap:8px">
        <button class="btn light" id="fpHome">ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ โต</button>
        <button class="close" id="fpClose">ุฅุบูุงู โ</button>
      </div>
    </div>
    <div id="fpBody"></div>
  </div>
</div>

<!-- ูุงูุฐุฉ ุงูุดูุงูุฏ -->
<div class="modal" id="eviModal" aria-hidden="true">
  <div class="sheet">
    <button class="close" id="eviClose">โ ุฅุบูุงู</button>
    <h4 style="text-align:center">ุฅุถุงูุฉ ุดุงูุฏ</h4>
    <div class="row" style="margin-bottom:8px">
      <div><label>ุงุณู/ูุตู ุงูุดุงูุฏ</label><input id="eviText" type="text" placeholder="ูุซุงู: ุชุญููู ูุชุงุฆุฌ ุตู1.."/></div>
      <div><label>ุงููุตู ุงูุฏุฑุงุณู</label>
        <select id="eviTerm"><option value="T1">ุงูุฃูู</option><option value="T2">ุงูุซุงูู</option></select>
      </div>
      <div><label>ุงูุฃุณุจูุน (ูุฌุฑู)</label><select id="eviWeek"></select></div>
      <div><label>ุงูุชุงุฑูุฎ (ูุฌุฑู ุฃู ุงููุฑู)</label><input id="eviHijri" type="text" placeholder="1447/03/01"/></div>
    </div>
    <div class="row">
      <div><label>ุฑูุน ููู (PDF/ุตูุฑุฉ)</label><input id="eviFile" type="file" accept="application/pdf,image/*"/></div>
      <div style="grid-column:span 3"><label>ูุชุจุน</label><input id="eviOwner" type="text" disabled/></div>
    </div>
    <div style="display:flex;gap:8px;margin-top:8px;justify-content:center">
      <button class="btn" id="eviSave">ุญูุธ ุงูุดุงูุฏ</button>
      <button class="btn light" id="eviCancel">ุฅูุบุงุก</button>
    </div>
    <div class="small" style="margin-top:6px;text-align:center">* ุงูุดูุงูุฏ ุชูุณุญุจ ุชููุงุฆูุงู ููุชูุงุฑูุฑ ูุฎุทุท ุงูุชุญุณูู. ูุชุญ ุงูุดุงูุฏ ูููู PDF ูุธูู ููุทุจุงุนุฉ.</div>
  </div>
</div>

<script>
/* ========== 0) ุดุนุงุฑ ููุญูุฏ ูุชุฎุฒููู ========== */
const LOGO_KEY = 'yaqoubi_logo_src';
let LOGO_URL   = localStorage.getItem(LOGO_KEY) || 'logo.png';

function applyLogoToHeader(){
  const img = document.getElementById('siteLogo');
  if(img){ img.src = LOGO_URL; }
}
/* ููููู ูู ุงููููุณูู ุชุบููุฑ ุงูุตูุฑุฉ ูุณููุญููุธ ุงูุฑุงุจุท */
function setLogo(url){
  if(!url) return;
  LOGO_URL = url.trim();
  localStorage.setItem(LOGO_KEY, LOGO_URL);
  applyLogoToHeader();
}

/* ========== 1) ุฃุณุงุจูุน ูุฌุฑู ========== */
const TERM1=[{w:1,from:'01 / 03 / 1447',to:'05 / 03 / 1447',note:'ุจุฏุงูุฉ ุงูุนุงู ุงูุฏุฑุงุณู'},{w:2,from:'08 / 03 / 1447',to:'12 / 03 / 1447'},{w:3,from:'15 / 03 / 1447',to:'19 / 03 / 1447'},{w:4,from:'22 / 03 / 1447',to:'26 / 03 / 1447'},{w:5,from:'29 / 03 / 1447',to:'03 / 04 / 1447'},{w:6,from:'06 / 04 / 1447',to:'10 / 04 / 1447'},{w:7,from:'13 / 04 / 1447',to:'17 / 04 / 1447'},{w:8,from:'20 / 04 / 1447',to:'24 / 04 / 1447'},{w:9,from:'27 / 04 / 1447',to:'01 / 05 / 1447'},{w:10,from:'04 / 05 / 1447',to:'08 / 05 / 1447'},{w:11,from:'11 / 05 / 1447',to:'15 / 05 / 1447'},{w:12,from:'18 / 05 / 1447',to:'22 / 05 / 1447'},{w:13,from:'25 / 05 / 1447',to:'29 / 05 / 1447'},{w:'โ',from:'30 / 05 / 1447',to:'08 / 06 / 1447',note:'๐ ุฅุฌุงุฒุฉ ุงูุฎุฑูู'},{w:14,from:'09 / 06 / 1447',to:'13 / 06 / 1447',note:'ุจุนุฏ ุงูุนูุฏุฉ ูู ุงูุฅุฌุงุฒุฉ'},{w:15,from:'16 / 06 / 1447',to:'20 / 06 / 1447'},{w:16,from:'23 / 06 / 1447',to:'27 / 06 / 1447'},{w:17,from:'30 / 06 / 1447',to:'04 / 07 / 1447'},{w:18,from:'07 / 07 / 1447',to:'11 / 07 / 1447'},{w:19,from:'14 / 07 / 1447',to:'18 / 07 / 1447',note:'โณ๏ธ ุฎุชุงู ุงููุตู ุงูุฏุฑุงุณู ุงูุฃูู'}];
const TERM2=[{w:1,from:'29 / 07 / 1447',to:'03 / 08 / 1447',note:'ุจุฏุงูุฉ ุงููุตู ุงูุซุงูู'},{w:2,from:'06 / 08 / 1447',to:'10 / 08 / 1447'},{w:3,from:'13 / 08 / 1447',to:'17 / 08 / 1447'},{w:4,from:'20 / 08 / 1447',to:'24 / 08 / 1447'},{w:5,from:'27 / 08 / 1447',to:'02 / 09 / 1447'},{w:6,from:'05 / 09 / 1447',to:'09 / 09 / 1447'},{w:7,from:'12 / 09 / 1447',to:'15 / 09 / 1447',note:'ุขุฎุฑ ุฃุณุจูุน ูุจู ุงูุฅุฌุงุฒุฉ'},{w:'โ',from:'16 / 09 / 1447',to:'10 / 10 / 1447',note:'๐ ุฅุฌุงุฒุฉ ุฑูุถุงู ูุนูุฏ ุงููุทุฑ'},{w:8,from:'10 / 10 / 1447',to:'14 / 10 / 1447',note:'ุงุณุชุฆูุงู ุงูุฏุฑุงุณุฉ ุจุนุฏ ุงูุนูุฏ'},{w:9,from:'17 / 10 / 1447',to:'21 / 10 / 1447'},{w:10,from:'24 / 10 / 1447',to:'28 / 10 / 1447'},{w:11,from:'01 / 11 / 1447',to:'05 / 11 / 1447'},{w:12,from:'08 / 11 / 1447',to:'12 / 11 / 1447'},{w:13,from:'15 / 11 / 1447',to:'19 / 11 / 1447'},{w:14,from:'22 / 11 / 1447',to:'26 / 11 / 1447'},{w:15,from:'29 / 11 / 1447',to:'03 / 12 / 1447'},{w:'โ',from:'04 / 12 / 1447',to:'14 / 12 / 1447',note:'๐ ุฅุฌุงุฒุฉ ุนูุฏ ุงูุฃุถุญู'},{w:16,from:'15 / 12 / 1447',to:'19 / 12 / 1447',note:'ุงุณุชุฆูุงู ุงูุฏุฑุงุณุฉ ุจุนุฏ ุงูุฃุถุญู'},{w:17,from:'22 / 12 / 1447',to:'26 / 12 / 1447'},{w:18,from:'29 / 12 / 1447',to:'03 / 01 / 1448'},{w:19,from:'06 / 01 / 1448',to:'10 / 01 / 1448',note:'ุฎุชุงู ุฃุณุงุจูุน ุงููุตู'}];

/* ========== 2) ุฃุฏูุงุช ูุณุงุนุฏุฉ ========== */
const fmt=v=>Number(v).toFixed(2);
function todayHijri(){
  try{
    const f=new Intl.DateTimeFormat('ar-SA-u-ca-islamic',{year:'numeric',month:'2-digit',day:'2-digit',weekday:'long'});
    return f.format(new Date());
  }catch(e){return '.../.. /1447ูู'}
}
/* ุชุตููู ุงููุณุชูู ุญุณุจ ุงููุฑูู */
function perfLevel(pct){
  if(pct>=90) return {name:'ุงูุชูููุฒ', key:'excel',  color:getComputedStyle(document.documentElement).getPropertyValue('--lv-excel').trim()};
  if(pct>=75) return {name:'ุงูุชูุฏูู', key:'progress',color:getComputedStyle(document.documentElement).getPropertyValue('--lv-progress').trim()};
  if(pct>=50) return {name:'ุงูุงูุทูุงู', key:'launch', color:getComputedStyle(document.documentElement).getPropertyValue('--lv-launch').trim()};
  return {name:'ุงูุชููุฆุฉ', key:'ready', color:getComputedStyle(document.documentElement).getPropertyValue('--lv-ready').trim()};
}
function levelRowClass(arLevel){
  if(arLevel==='ุงูุชูููุฒ'||arLevel==='ุงูุชูุฏูู') return 'row-excellent';
  if(arLevel==='ุงูุงูุทูุงู') return 'row-verygood';
  if(arLevel==='ุงูุชููุฆุฉ') return 'row-good';
  return 'row-medium';
}

/* ========== 3) ุงูุจูุงูุงุช ========== */
const fields={
  management:{name:'ุงูุฅุฏุงุฑุฉ ุงููุฏุฑุณูุฉ',v2024:75.50,v2025:75.50,subs:[
    {id:'plans',name:'ุงูุชุฎุทูุท',v:54.00},
    {id:'lead',name:'ููุงุฏุฉ ุงูุนูููุฉ ุงูุชุนููููุฉ',v:72.75},
    {id:'soc',name:'ุงููุฌุชูุน ุงููุฏุฑุณู',v:57.25},
    {id:'dev',name:'ุงูุชุทููุฑ ุงููุคุณุณู',v:60.25}
  ]},
  teaching:{name:'ุงูุชุนููู ูุงูุชุนููู',v2024:80.75,v2025:81.50,subs:[
    {id:'assess',name:'ุชูููู ุงูุชุนููู',v:82.75},
    {id:'exp',name:'ุจูุงุก ุฎุจุฑุงุช ุงูุชุนููู',v:76.75}
  ]},
  learning:{name:'ููุงุชุฌ ุงูุชุนููู',v2024:78.50,v2025:78.50,subs:[
    {id:'ach',name:'ุงูุชุญุตูู ุงูุชุนูููู',v:80.25},
    {id:'socdev',name:'ุงูุชุทูุฑ ุงูุดุฎุตู ูุงูุตุญู ูุงูุงุฌุชูุงุนู',v:86.25}
  ]},
  environment:{name:'ุงูุจูุฆุฉ ุงููุฏุฑุณูุฉ',v2024:64.00,v2025:62.25,subs:[
    {id:'safety',name:'ุงูุฃูู ูุงูุณูุงูุฉ',v:79.00},
    {id:'building',name:'ุงููุจูู ุงููุฏุฑุณู',v:71.50}
  ]}
};

/* ุชูุงุตูู ุงูุจููุฏ */
const detailed={
  management:[
    {level:'ุงูุชูููุฒ',perf:94.50,indicator:'ุชูุดุฑ ุงููุฏุฑุณุฉ ููุงุนุฏ ุงูุณููู ูุงูููุงุธุจุฉ ูุชุชุงุจุน ุชุทุจูููุง ุจุงูุชุธุงู.',improve:'ูุดุฑ ุงูููุงุนุฏ ุฑููููุง ูุฑุจุทูุง ุจูุชุงุจุนุฉ ุฃุณุจูุนูุฉ ููุงูุถุจุงุท.',evidence:'ููุญุงุช ุงูุณูููุ ุชูุงุฑูุฑ ุงูุงูุถุจุงุทุ ุณุฌูุงุช ุฅุดุนุงุฑุงุช.'},
    {level:'ุงูุชูุฏูู',perf:90.25,indicator:'ุชููุฆุฉ ูุตูุงูุฉ ูุฑุงูู ุงููุจูู ูุชุฌููุฒุงุชู.',improve:'ูุธุงู ุตูุงูุฉ ุฑููู ูุชูุซูู ุจุงูุตูุฑ ูุงูุชูุงุฑูุฑ.',evidence:'ุฃูุงูุฑ ุนููุ ุตูุฑ ูุจู/ุจุนุฏุ ูุญุงุถุฑ ุฅูุฌุงุฒ.'},
    {level:'ุงูุชูุฏูู',perf:89.25,indicator:'ููุงุฎ ุขูู ููุญููุฒ ููุชุนููู ูุงูููู.',improve:'ุจุฑุงูุฌ ุฏุนู ููุณู ูููุงุณ ุฑุถุง ุงููุณุชููุฏูู ุฏูุฑููุง.',evidence:'ุงุณุชุจุงูุงุช ุฑุถุงุ ุณุฌูุงุช ุฅุฑุดุงุฏุ ุฎุทุท ููุงุฆูุฉ.'},
    {level:'ุงูุงูุทูุงู',perf:87.00,indicator:'ูุชุงุจุนุฉ ุฃุฏุงุก ุงูุนุงูููู ูุฏุนู ุงูุชุทููุฑ ุงููููู.',improve:'ุฎุทุท ุชุทููุฑ ูุฑุฏูุฉ ูุจููุฉ ุนูู ุชูููู ุณููู.',evidence:'ููุงุฐุฌ ุชููููุ ุฎุทุท ุชุญุณููุ ูุญุงุถุฑ ุชุบุฐูุฉ ุฑุงุฌุนุฉ.'},
    {level:'ุงูุงูุทูุงู',perf:85.25,indicator:'ูุชุงุจุนุฉ ุชูููุฐ ุงูุฎุทุฉ ุงูุชุดุบูููุฉ ูุชุทููุฑูุง.',improve:'ููุญุฉ ูุคุดุฑุงุช ุฃุณุจูุนูุฉ ูุฑุจุท ุงูููุงู ุจุงููุฎุฑุฌุงุช.',evidence:'ููุญุฉ ุฃุฏุงุกุ ุชูุงุฑูุฑ ุชูุฏูุ ูุญุงุถุฑ ูุฑู ุงูุนูู.'},
    {level:'ุงูุงูุทูุงู',perf:83.75,indicator:'ุชูุงุตู ูุนูุงู ูุน ุฃูููุงุก ุงูุฃููุฑ ูุงููุฌุชูุน.',improve:'ูููุงุช ุชูุงุตู ููุญูุฏุฉ ูุฌุฏููุฉ ููุงุกุงุช ุฏูุฑูุฉ.',evidence:'ููุตุฉ ุชูุงุตูุ ูุญุงุถุฑ ููุงุกุงุชุ ุชูุงุฑูุฑ ุชูุงุนู.'},
    {level:'ุงูุงูุทูุงู',perf:82.00,indicator:'ุชุดุฌูุน ุงูุญุตูู ุนูู ุงูุฑุฎุตุฉ ุงูููููุฉ.',improve:'ุจุฑูุงูุฌ ุชุญููุฒู ูุฌุฏููุฉ ุฏุฎูู ุงูุงุฎุชุจุงุฑุงุช.',evidence:'ููุงุฆู ุชุณุฌููุ ุดูุงุฏุงุช ุญุถูุฑุ ูุชุงุฆุฌ ุงูุฑุฎุตุฉ.'},
    {level:'ุงูุชููุฆุฉ',perf:80.00,indicator:'ุชุนุฒูุฒ ุซูุงูุฉ ุงูุนูู ุงูุฌูุงุนู.',improve:'ูุฑู ุชูููุฒ ุจูููุงุช ูุงุถุญุฉ ููุชุงุจุนุฉ ุฅูุฌุงุฒ.',evidence:'ุชุดููู ุงููุฑูุ ุฎุทุท ูุฑูุ ุชูุงุฑูุฑ ูุฎุชุตุฑุฉ.'},
    {level:'ุงูุชููุฆุฉ',perf:78.00,indicator:'ุชูุซูู ุงูููู ูุงููููุฉ ุงููุทููุฉ.',improve:'ููู ุฑููู ูููููุฉ ูุฑุชุจุท ุจุงูุฃูุดุทุฉ.',evidence:'ุตูุฑ ูุนุงููุงุชุ ูููุงุช ุฅูุฌุงุฒุ ููุงุฐุฌ ุชูุซูู.'},
    {level:'ุงูุชููุฆุฉ',perf:76.50,indicator:'ุชูุนูู ูููุงุช ุงูุชูุงุตู ุงูุฏุงุฎูู.',improve:'ุชูุธูู ุงููุฑุงุณูุงุช ูุงูุงุฌุชูุงุนุงุช ุฅููุชุฑููููุง.',evidence:'ุณุฌูุงุช ุชุนูููุงุชุ ูุญุงุถุฑุ ููุงุฆุญ ุฅุฌุฑุงุกุงุช.'},
    {level:'ุงูุชููุฆุฉ',perf:75.50,indicator:'ุชูุนูู ุงูุดุฑุงูุงุช ุงููุฌุชูุนูุฉ.',improve:'ุซูุงุซ ุดุฑุงูุงุช ููุนูุฉ ูุฑุชุจุทุฉ ุจุงูุชุนููู.',evidence:'ูุฐูุฑุงุช ุชูุงููุ ุชูุงุฑูุฑ ูุนุงููุงุชุ ุดูุงุฏุงุช ุดุฑุงูุฉ.'},
    {level:'ุงูุชููุฆุฉ',perf:72.00,indicator:'ุชุทููุฑ ุฃูุธูุฉ ุงููุชุงุจุนุฉ ุงูุฅููุชุฑูููุฉ.',improve:'ููุญุฉ ูุคุดุฑุงุช ุฐููุฉ ูุชุญูููุงุช ุดูุฑูุฉ.',evidence:'ุชูุงุฑูุฑ ุชุญููููุฉุ ููุญุงุช ููุงุณุ ุฃุฑุดูู ุฑููู.'},
    {level:'ุงูุชููุฆุฉ',perf:70.25,indicator:'ุชูุธูู ุงูุชูููุฉ ูู ุงูุฅุฏุงุฑุฉ ุงูููููุฉ.',improve:'ุฑูุน ุงุณุชุฎุฏุงู (ููุฑ/ูุงุฑุณ/ูุฏุฑุณุชู) ูุชุชุจุน ุงูุชูุงุฑูุฑ.',evidence:'ุณุฌูุงุช ุฏุฎููุ ุชูุงุฑูุฑ ุงุณุชุฎุฏุงูุ ูุตูููุฉ ุงูุชุฒุงู.'}
  ],
  teaching:[
    {level:'ุงูุชูููุฒ',perf:99.25,indicator:'ุจุฑุงูุฌ ุชุฏุฑูุจูุฉ ููุนูุฉ ุชุทููุฑ ุงูููุงุฑุงุช ุงูุตูููุฉ.',improve:'ููุงุกูุฉ ุงูุชุฏุฑูุจ ูุชุชุจุน ุงูุฃุซุฑ ุฏุงุฎู ุงูุญุตุฉ.',evidence:'ุฎุทุท ุชุฏุฑูุจุ ุชูุงุฑูุฑ ุฃุซุฑ.'},
    {level:'ุงูุชูููุฒ',perf:97.75,indicator:'ุจูุฆุฉ ูุญููุฒุฉ ููุชูููุฑ ุงูุฅุจุฏุงุนู/ุงููุงูุฏ.',improve:'ุชุถููู ููุงุฑุงุช ุงูุชูููุฑ ุงูุนููุง.',evidence:'ุฎุทุท ุฏุฑูุณุ ููุงุญุธุงุช ุตููุฉ.'},
    {level:'ุงูุชูููุฒ',perf:97.50,indicator:'ุชูููุฉ ุงูุชุนููู ุงูุฐุงุชู ูุงูุจุญุซ.',improve:'ูุดุงุฑูุน ุจุญุซ ุฑูููุฉ.',evidence:'ุจุญูุซ ุทูุงุจูุฉ.'},
    {level:'ุงูุชูุฏูู',perf:96.75,indicator:'ุงุณุชุฑุงุชูุฌูุงุช ุชุฏุฑูุณ ุญุฏูุซุฉ.',improve:'ุชูุซูู ุงูุชุทุจูู ูุฒูุงุฑุงุช ุตููุฉ.',evidence:'ุชูุงุฑูุฑ ุฒูุงุฑุงุช.'},
    {level:'ุงูุชูุฏูู',perf:94.75,indicator:'ูุณุงุฆู ุชุนููููุฉ ุฑูููุฉ ูุชููุนุฉ.',improve:'ุฅูุชุงุฌ ูุญุชูู ุชูุงุนูู.',evidence:'ูููุงุช ุฏุฑูุณ ุฑูููุฉ.'},
    {level:'ุงูุชูุฏูู',perf:93.25,indicator:'ุชููุน ุฃุฏูุงุช ุงูุชูููู.',improve:'ุชุญููู ุฃุณุจูุนู ูุฑุจุท ุจุนูุงุฌ/ุฅุซุฑุงุก.',evidence:'ุณุฌูุงุช ุชุญููู.'},
    {level:'ุงูุงูุทูุงู',perf:91.75,indicator:'ุชุบุฐูุฉ ุฑุงุฌุนุฉ ุจููุงุกุฉ.',improve:'ูููุฐุฌ ููุญูุฏ ูุฃูุดุทุฉ ุชุตุญูุญูุฉ.',evidence:'ููุงุฐุฌ ูุชุงุจุนุฉ.'},
    {level:'ุงูุงูุทูุงู',perf:89.50,indicator:'ุชูุธูู ุงูุชูููุฉ ูู ุงูุชุนููู.',improve:'ุฃุฏูุงุช ุชูุงุนููุฉ ุฏุงุฎู ุงูุญุตุฉ.',evidence:'ุชูุงุฑูุฑ ยซูุฏุฑุณุชูยป.'},
    {level:'ุงูุชููุฆุฉ',perf:88.00,indicator:'ุชุนููู ุชุนุงููู ููุดุงุฑูุน.',improve:'Rubrics ูุชูููู ุฃุฏูุงุฑ.',evidence:'ูููุงุช ูุดุงุฑูุน.'},
    {level:'ุงูุชููุฆุฉ',perf:86.75,indicator:'ุชูููุฉ ุงูุชูููุฑ ุงููุงูุฏ.',improve:'ุฃูุดุทุฉ ุชุญููู ูููุงุด.',evidence:'ุฎุทุท ุฃูุดุทุฉ.'},
    {level:'ุงูุชููุฆุฉ',perf:84.50,indicator:'ุจุฑุงูุฌ ุฅุซุฑุงุฆูุฉ ููููููุจูู.',improve:'ูุฑุด ุฃุณุจูุนูุฉ.',evidence:'ููุงุฆู ูุดุงุฑููู.'},
    {level:'ุงูุชููุฆุฉ',perf:82.75,indicator:'ุจูุงุก ุงูุฏุฑูุณ ุจููุงุชุฌ ูุงุถุญุฉ.',improve:'ูุฑุงุฌุนุฉ ุงูุฎุทุท ุงูููููุฉ.',evidence:'ุฎุทุท ูุญุฏุซุฉ.'},
    {level:'ุงูุชููุฆุฉ',perf:76.75,indicator:'ุชูููุน ุงูุฃุณุงููุจ ูููุฑูู ุงููุฑุฏูุฉ.',improve:'ุฃูุดุทุฉ ูุชุนุฏุฏุฉ ุงูุฃููุงุท.',evidence:'ุชูุงุฑูุฑ ุตููุฉ.'}
  ],
  learning:[
    {level:'ุงูุชูููุฒ',perf:96.75,indicator:'ุงุนุชุฒุงุฒ ุจุงูููู ูุงููููุฉ ุงููุทููุฉ.',improve:'ุฑุจุท ุงูุฃูุดุทุฉ ุจุงูููู.',evidence:'ููุชุฌุงุช ูุตูุฑ ูุนุงููุงุช.'},
    {level:'ุงูุชูููุฒ',perf:96.25,indicator:'ุงุชุฌุงูุงุช ุฅูุฌุงุจูุฉ ูุฏุงูุนูุฉ.',improve:'ุจุฑุงูุฌ ุชุญููุฒูุฉ ูุฅุฑุดุงุฏ.',evidence:'ุงุณุชุจุงูุงุช ูุฎุทุท.'},
    {level:'ุงูุชูููุฒ',perf:95.50,indicator:'ูุชุงุฆุฌ ูุทููุฉ/ุฏูููุฉ ูุชููุฒุฉ.',improve:'ุงุฎุชุจุงุฑุงุช ูุนูุงุฑูุฉ ูุฎุทุท ุนูุงุฌ.',evidence:'ุชุญูููุงุช ูุชุงุฆุฌ.'},
    {level:'ุงูุชูููุฒ',perf:94.00,indicator:'ุงูุชุฒุงู ูุงูุถุจุงุท.',improve:'ูุชุงุจุนุฉ ููููุฉ ูุชูุฑูู.',evidence:'ุณุฌูุงุช ุงูุงูุถุจุงุท.'},
    {level:'ุงูุงูุทูุงู',perf:91.75,indicator:'ุงุชุฌุงูุงุช ูุญู ุงูุฐุงุช ูุงูููู.',improve:'ุจุฑุงูุฌ ููุงุฑูุฉ ููุณุงุฑุงุช ููุงุฏุฉ.',evidence:'ุชูุงุฑูุฑ ุจุฑุงูุฌ.'},
    {level:'ุงูุงูุทูุงู',perf:89.25,indicator:'ููุงุฑุงุช ุงูุจุญุซ ูุงูุชุนููู ุงูุฐุงุชู.',improve:'ูุดุงุฑูุน ุจุญุซ ุฑูููุฉ.',evidence:'ุจุญูุซ ุทูุงุจูุฉ.'},
    {level:'ุงูุงูุทูุงู',perf:86.25,indicator:'ููุงุฑุงุช ุงุฌุชูุงุนูุฉ ูุตุญูุฉ.',improve:'ุญููุงุช ุชูุนููุฉ.',evidence:'ูุดุฑุงุช ูุชูุงุฑูุฑ.'},
    {level:'ุงูุชููุฆุฉ',perf:84.25,indicator:'ูุจุงุฏุฑุงุช ูุฌุชูุนูุฉ.',improve:'ุดุฑุงูุงุช ููุนูุฉ.',evidence:'ูุฐูุฑุงุช ุชุนุงูู.'},
    {level:'ุงูุชููุฆุฉ',perf:82.94,indicator:'ุชูุฏู ูู ูุชุงุฆุฌ ุงูููุงุฏ.',improve:'ุชุญููู ุงููุชุงุฆุฌ ูุฎุทุท ุฏุนู.',evidence:'ุชูุงุฑูุฑ ุชุญููู.'},
    {level:'ุงูุชููุฆุฉ',perf:79.04,indicator:'ุชุญูู ููุงุชุฌ ุงูููุงุฏ ุงูุฃุณุงุณูุฉ.',improve:'ุชูููู ูุณุชูุฑ ูุฎุทุท ุชุญุณูู.',evidence:'ุฃุฏูุงุช ุชูููู.'},
    {level:'ุงูุชููุฆุฉ',perf:63.25,indicator:'ูุดุงุฑูุฉ ุซูุงููุฉ/ููููุฉ.',improve:'ุชุญููุฒ ุงููุดุงุฑูุฉ.',evidence:'ุชูุงุฑูุฑ ุฃูุดุทุฉ.'}
  ],
  environment:[
    {level:'ุงูุชูููุฒ',perf:97.50,indicator:'ุชููุฆุฉ ูุตูุงูุฉ ูุฑุงูู ุงููุจูู.',improve:'ุณุฌู ุฑููู ููุตูุงูุฉ.',evidence:'ุชูุงุฑูุฑ ูุตูุฑ.'},
    {level:'ุงูุชูููุฒ',perf:97.00,indicator:'ุงููุญุงูุธุฉ ุนูู ุงููุธุงูุฉ.',improve:'ุชุนุฒูุฒ ุงูุฅุดุฑุงู ุงููููู.',evidence:'ุชูุงุฑูุฑ ุฅุดุฑุงููุฉ.'},
    {level:'ุงูุงูุทูุงู',perf:94.00,indicator:'ุชูุงูุฑ ูุนุงููุฑ ุงูุฃูู ูุงูุณูุงูุฉ.',improve:'ูุฑุถูุงุช ุฏูุฑูุฉ ูุชุญุฏูุซ ุฃุฏูุงุช.',evidence:'ุณุฌูุงุช ุงูุฃูู ูุงูุณูุงูุฉ.'},
    {level:'ุงูุงูุทูุงู',perf:79.00,indicator:'ูุตููุงุช ุขููุฉ ูููุณููุฑุฉ.',improve:'ุชููุฆุฉ ุงูููุฑุงุช ูุฐูู ุงูุฅุนุงูุฉ.',evidence:'ุตูุฑ ุชุฌููุฒุงุช.'},
    {level:'ุงูุชููุฆุฉ',perf:73.25,indicator:'ุฌุงุฐุจูุฉ ุงูุจูุฆุฉ ุงููุฏุฑุณูุฉ.',improve:'ุชุญุณูู ุฌูุงูู ููุธููู.',evidence:'ุตูุฑ ุงููุตูู.'},
    {level:'ุงูุชููุฆุฉ',perf:64.00,indicator:'ูุฎุงุฑุฌ ุงูุทูุงุฑุฆ ูุงููุชุทูุจุงุช.',improve:'ูุฑุงุฌุนุฉ ูุฎุงุฑุฌ ูุฅุฑุดุงุฏุงุช.',evidence:'ุชูุงุฑูุฑ ุงูุฏูุงุน ุงููุฏูู.'},
    {level:'ุงูุชููุฆุฉ',perf:62.50,indicator:'ุงูุฅุถุงุกุฉ ูุงูุชูููุฉ.',improve:'ุชุญุณูู ุงูุฅุถุงุกุฉ ูุตูุงูุฉ ุงูุชูููุฉ.',evidence:'ุชูุงุฑูุฑ ูููุฉ.'}
  ]
};

/* ========== 4) ุชุฎุฒูู ุงูุดูุงูุฏ (ูุญูู + ุงุฎุชูุงุฑู ุณุญุงุจู) ========== */
const STORE='yaqoubi_evidence_1447';
const mem=JSON.parse(localStorage.getItem(STORE)||'{}');
function saveMem(){localStorage.setItem(STORE,JSON.stringify(mem))}
const SB_URL="https://vullbssjyyrnoyyxyebq.supabase.co";
const SB_ANON="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ1bGxic3NqeXlybm95eXh5ZWJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2OTQxODEsImV4cCI6MjA3NjI3MDE4MX0.D7o-dAyQbb2cjmp1ooZ0Mw9xoiih1JUarsEMZJVGfGc";
const supabase=window.supabase?window.supabase.createClient(SB_URL,SB_ANON):null;

/* ========== 5) ุฑุฃุณ ุงูุชูุงุฑูุฑ (ุตูุฑุฉ ุจุนุฑุถ ุงูุตูุญุฉ) ========== */
function bannerHeaderHTML(){
  return `<img class="reportHeader" src="${LOGO_URL}" alt="ุดุนุงุฑ ุงูุชูุฑูุฑ">`;
}

/* ========== 6) ูุงูุฐุฉ A4 ููุทุจุงุนุฉ ========== */
function openDocWindow(title,contentHTML){
  const w=window.open('','_blank'); if(!w){alert('ูุถูุงู ุงุณูุญ ุจุงูููุงูุฐ ุงูููุจุซูุฉ.');return;}
  const doc=`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"/>
  <title>${title}</title>
  <style>
    @page{size:A4;margin:10mm}
    body{font-family:'Tajawal',sans-serif;margin:0;background:#fff;color:#06353b}
    .wrap{max-width:1120px;margin:0 auto;padding:12px}
    h2{margin:6px 0;color:#0b7e88;text-align:center}
    h3{color:#0b7e88;margin:8px 0}
    table{width:100%;border-collapse:collapse;margin-top:8px;table-layout:fixed}
    thead th{background:#0f6f79;color:#fff;padding:8px;font-weight:700}
    td,th{padding:8px;border:1px solid #e7eff0;vertical-align:middle;text-align:center;font-size:13px;word-break:break-word}
    .row-excellent{background:#e9fff4}.row-verygood{background:#eef5ff}.row-good{background:#fff6ec}.row-medium{background:#ffefef}
    .toolbar{position:sticky;top:0;background:#fff;padding:6px 0;margin:6px 0;border-bottom:1px dashed #e1ecec;text-align:center}
    .btn{padding:8px 12px;border:1px solid #0b7e88;border-radius:8px;background:#0b7e88;color:#fff;cursor:pointer;margin:0 4px}
    .sig{font-size:12px;text-align:center;margin-top:8px;color:#345}
    @media print{.toolbar{display:none}}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:700}
    /* ุตูุฑุฉ ุงูููุฏุฑ ุฏุงุฎู ุงูุชูุงุฑูุฑ */
    .reportHeader{width:100%;height:160px;object-fit:cover;border-radius:8px;display:block;margin-bottom:15px;}
  </style></head><body>
  <div class="wrap">${bannerHeaderHTML()}${contentHTML}
    <div class="toolbar no-print"><button class="btn" onclick="window.print()">ุทุจุงุนุฉ</button><button class="btn" onclick="window.close()">ุฅุบูุงู</button></div>
  </div></body></html>`;
  w.document.open(); w.document.write(doc); w.document.close();
}

/* ========== 7) ุนุงุฑุถ PDF ููุดูุงูุฏ ========== */
function openEvidenceViewerPDF(url){
  const w=window.open('','_blank'); if(!w){alert('ูุถูุงู ุงุณูุญ ุจุงูููุงูุฐ ุงูููุจุซูุฉ.');return;}
  const doc=`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"/><title>ุดุงูุฏ</title>
  <style>@page{size:A4;margin:10mm}html,body{margin:0;height:100%}</style></head><body>
  <embed src="${url}" type="application/pdf" style="width:100%;height:100vh;border:0"/></body></html>`;
  w.document.open(); w.document.write(doc); w.document.close();
}

/* ========== 8) ููุญุฉ ุงููุฌุงูุงุช ========== */
function renderDashboard(){
  const dash=document.getElementById('dashboard');
  dash.innerHTML='';
  Object.entries(fields).forEach(([key,f])=>{
    const lvl=perfLevel(f.v2025);
    const card=document.createElement('div');
    card.className='card'; card.id=`card-${key}`;
    card.innerHTML=`
      <h2>${f.name}</h2>
      <div class="kpi">
        <span>2024: ${fmt(f.v2024)}% โ 2025: ${fmt(f.v2025)}%</span>
        <span class="badge ${lvl.key}">${lvl.name}</span>
      </div>
      <div class="progress"><div class="bar" style="width:${Math.max(2,f.v2025)}%;background:${lvl.color}"></div></div>
      <div style="display:flex;justify-content:center"><canvas id="donut-${key}" height="140" style="cursor:pointer"></canvas></div>
      <div class="centerBar">
        <button class="btn ghost" onclick="openFieldReport('${key}')">ุชูุฑูุฑ ุงููุฌุงู PDF</button>
        <button class="btn ghost" onclick="openFieldPlan('${key}')">ุฎุทุฉ ุชุญุณูู ุงููุฌุงู PDF</button>
      </div>`;
    dash.appendChild(card);
    try{
      const ctx=document.getElementById(`donut-${key}`).getContext('2d');
      new Chart(ctx,{type:'doughnut',data:{labels:f.subs.map(s=>s.name),datasets:[{data:f.subs.map(s=>s.v),backgroundColor:f.subs.map(s=>perfLevel(s.v).color)}]},options:{plugins:{legend:{display:false}},cutout:'68%'}});
      document.getElementById(`donut-${key}`).addEventListener('click',()=>openFieldFullScreen(key));
    }catch(e){}
  });
}

/* ========== 9) ุชูุงุตูู ุงููุฌุงู ========== */
function openFieldFullScreen(key){
  const panel=document.getElementById('fullPanel');
  const title=document.getElementById('fpTitle');
  const body=document.getElementById('fpBody');
  const f=fields[key]; title.textContent='ุงูุชุญููู ุงูุชูุตููู โ '+f.name;

  const subsHtml=f.subs.map(s=>{
    const lb=perfLevel(s.v);
    return `<div class="subCard" style="background:${lb.color}10;border-color:${lb.color}40;box-shadow:inset 0 0 0 1px ${lb.color}26;">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>${s.name}</strong>
        <span class="badge ${lb.key}">${fmt(s.v)}% โข ${lb.name}</span>
      </div>
    </div>`;
  }).join('');

  const rows=(detailed[key]||[]).map((r,i)=>{
    const lcls=levelRowClass(r.level);
    const lb=perfLevel(r.perf);
    const ekey=`${key}::${i}`;
    const evis=(mem[ekey]||[]).map((e,j)=>{
      const tagColor=perfLevel(Math.min(99,60+(j*7))).color;
      const name=e.text?e.text:'ุดุงูุฏ';
      return `<div class="small" style="margin:.25rem 0">
        <span class="badge" style="background:${tagColor}22;color:${tagColor};font-weight:700">${name}</span>
        โ ${e.hijri}
        ${e.url?`โ <a href="${e.url}" target="_blank" onclick="event.preventDefault();openEvidenceViewerPDF('${e.url}');">ูุดุงูุฏุฉ</a>`:''}
      </div>`;
    }).join('');
    return `<tr class="${lcls}">
      <td class="level" style="text-align:center">${r.level}<div class="small">${fmt(r.perf)}% โข ${lb.name}</div></td>
      <td>${r.indicator}</td>
      <td>${r.improve}</td>
      <td>
        ${r.evidence}
        ${evis?`<div style="margin-top:6px">${evis}</div>`:''}
        <div style="margin-top:10px;text-align:center;display:flex;gap:6px;justify-content:center">
          <button class="btn-evi" onclick="openEvidence('${key}',${i})" title="ุฅุถุงูุฉ ุดุงูุฏ">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 5v14M5 12h14" stroke-width="2" stroke-linecap="round"/></svg>ุฅุถุงูุฉ ุดุงูุฏ
          </button>
          <button class="btn-evi" onclick="deleteEvidence('${key}',${i})" title="ุญุฐู ุดูุงูุฏ ุงูุจูุฏ">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 6h18M8 6v12m8-12v12M5 6l1 14a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2l1-14" stroke-width="2" stroke-linecap="round"/></svg>ุญุฐู ุงูุดูุงูุฏ
          </button>
        </div>
      </td>
    </tr>`;
  }).join('');

  body.innerHTML=`<div class="subgrid">${subsHtml}</div>
  <div class="tableWrap"><table>
    <thead><tr><th style="width:160px">ุงููุณุชูู/ุงูุฃุฏุงุก</th><th>ุงููุนูุงุฑ</th><th>ููุชุฑุญุงุช ุงูุชุญุณูู</th><th>ุงูุดูุงูุฏ</th></tr></thead>
    <tbody>${rows}</tbody></table></div>`;
  panel.style.display='flex';
  document.getElementById('fpClose').onclick=()=>panel.style.display='none';
  document.getElementById('fpHome').onclick=()=>{panel.style.display='none';window.scrollTo({top:0,behavior:'smooth'})};
}

/* ========== 10) ุงูุดูุงูุฏ ========== */
let currentEvi={key:'',idx:0};
function fillWeeks(termVal){
  const sel=document.getElementById('eviWeek'); sel.innerHTML='';
  (termVal==='T1'?TERM1:TERM2).forEach(w=>{
    const o=document.createElement('option');
    o.value=`ุงูุฃุณุจูุน ${w.w} โ ${w.from}โ${w.to}${w.note?` (${w.note})`:''}`;
    o.textContent=o.value; sel.appendChild(o);
  });
}
document.getElementById('eviTerm').addEventListener('change',e=>fillWeeks(e.target.value));
function openEvidence(fieldKey,rowIdx){
  currentEvi={key:fieldKey,idx:rowIdx};
  document.getElementById('eviOwner').value=`${fields[fieldKey].name} โ ุจูุฏ ${rowIdx+1}`;
  document.getElementById('eviText').value='';
  document.getElementById('eviHijri').value=todayHijri().replace(/\s/g,'');
  document.getElementById('eviFile').value='';
  document.getElementById('eviTerm').value='T1'; fillWeeks('T1');
  document.getElementById('eviModal').style.display='flex';
}
function closeEvidence(){document.getElementById('eviModal').style.display='none'}
document.getElementById('eviClose').onclick=closeEvidence;
document.getElementById('eviCancel').onclick=closeEvidence;

async function persistEvidenceSupabase(payload){
  if(!supabase) return {error:'noClient'};
  try{
    const {data,error}=await supabase.from('evidences').insert(payload).select();
    if(error) return {error}; return {data};
  }catch(e){return {error:e}}
}

document.getElementById('eviSave').onclick=async ()=>{
  const text=document.getElementById('eviText').value.trim();
  const term=document.getElementById('eviTerm').value;
  const week=document.getElementById('eviWeek').value;
  const hijri=document.getElementById('eviHijri').value.trim()||todayHijri();
  const fileEl=document.getElementById('eviFile'); let url='';
  if(fileEl.files && fileEl.files[0]) url=URL.createObjectURL(fileEl.files[0]);
  if(!text && !url){alert('ุฃุฏุฎู ุงุณู ุงูุดุงูุฏ ูุงุฑูุน ููููุง (ุงุฎุชูุงุฑู).');return;}
  const k=`${currentEvi.key}::${currentEvi.idx}`;
  mem[k]=mem[k]||[]; const entry={text,term,week,hijri,url,ts:Date.now()};
  mem[k].push(entry); saveMem();
  persistEvidenceSupabase([{field_key:currentEvi.key,row_index:currentEvi.idx,text,term,week,hijri,file_url:url}]);
  closeEvidence(); document.getElementById('fullPanel').style.display='none'; openFieldFullScreen(currentEvi.key);
};
function deleteEvidence(key,index){
  const ekey=`${key}::${index}`;
  if(mem[ekey]){delete mem[ekey]; saveMem(); alert('ุชู ุญุฐู ุงูุดูุงูุฏ ููุฐุง ุงูุจูุฏ'); document.getElementById('fullPanel').style.display='none'; openFieldFullScreen(key);}
  else alert('ูุง ุชูุฌุฏ ุดูุงูุฏ ูุญููุธุฉ ููุฐุง ุงูุจูุฏ');
}

/* ========== 11) ุชูุงุฑูุฑ/ุฎุทุท ุงููุฌุงู ========== */
function buildFieldReportHTML(key){
  const f=fields[key];
  const rows=(detailed[key]||[]).map(r=>`
    <tr class="${levelRowClass(r.level)}">
      <td>${r.level} โ ${fmt(r.perf)}%</td>
      <td>${r.indicator}</td>
      <td>${r.improve}</td>
      <td>${r.evidence}</td>
    </tr>`).join('');
  const lvl=perfLevel(f.v2025);
  return `<h2>ุชูุฑูุฑ ุงููุฌุงู: ${f.name}</h2>
  <div style="text-align:center;margin:4px 0">ุงูุฃุฏุงุก 2024: ${fmt(f.v2024)}% โ ุงูุฃุฏุงุก 2025: ${fmt(f.v2025)}%
    <span class="pill" style="background:${lvl.color}20;color:${lvl.color}">ูุณุชูู ${lvl.name}</span></div>
  <table><thead><tr><th style="width:220px">ุงููุณุชูู/ุงููุณุจุฉ</th><th style="width:310px">ุงููุคุดุฑ</th><th style="width:270px">ููุชุฑุญุงุช ุงูุชุญุณูู</th><th style="width:250px">ุงูุดูุงูุฏ</th></tr></thead>
  <tbody>${rows}</tbody></table>
  <div class="sig">ูุฏูุฑ ุงููุฏุฑุณุฉ: ููุฏ ุญุงูุฏ ุนูู ุงูุฒูุฑุงูู โ ุงูุชุงุฑูุฎ: ${todayHijri()}</div>`;
}
function buildFieldPlanHTML(key){
  const f=fields[key];
  const rows=(detailed[key]||[]).slice(0,6).map((r,i)=>{
    const durations=['4 ุฃุณุงุจูุน','6 ุฃุณุงุจูุน','8 ุฃุณุงุจูุน','10 ุฃุณุงุจูุน','12 ุฃุณุจูุนูุง','ูุตู ุฏุฑุงุณู ูุงูู'];
    return `<tr><td>${r.indicator}</td><td>${r.improve}</td><td>${durations[i]||'6 ุฃุณุงุจูุน'}</td><td>${r.evidence}</td></tr>`;
  }).join('');
  return `<h2>ุฎุทุฉ ุชุญุณูู ุงููุฌุงู: ${f.name}</h2>
  <table><thead><tr><th>ุงููุฏู/ุงููุคุดุฑ</th><th>ุงูุฅุฌุฑุงุก ุงูุชุญุณููู</th><th>ุงููุฏุฉ</th><th>ุงูุดูุงูุฏ</th></tr></thead><tbody>${rows}</tbody></table>
  <div class="sig">ูุฏูุฑ ุงููุฏุฑุณุฉ: ููุฏ ุญุงูุฏ ุนูู ุงูุฒูุฑุงูู โ ุงูุชุงุฑูุฎ: ${todayHijri()}</div>`;
}
function openFieldReport(key){openDocWindow('ุชูุฑูุฑ ุงููุฌุงู',buildFieldReportHTML(key))}
function openFieldPlan(key){openDocWindow('ุฎุทุฉ ุชุญุณูู ุงููุฌุงู',buildFieldPlanHTML(key))}

/* ========== 12) ุงูุชูุฑูุฑ ุงูุดุงูู (ูุจุชูุฑ 2024 โ 2025) ========== */
function buildComprehensiveReport(){
  const yearBlock=(year)=>{
    const list=Object.entries(fields).map(([k,f])=>{
      const val=year===2024?f.v2024:f.v2025; const lv=perfLevel(val);
      return `<tr><td style="text-align:right">${f.name}</td><td>${fmt(val)}%</td><td><span class="pill" style="background:${lv.color}20;color:${lv.color}">${lv.name}</span></td></tr>`;
    }).join('');
    return `<div style="border:1px solid #e7eff0;border-radius:12px;padding:8px">
      <h3 style="text-align:center;margin:4px 0">ุงูุฃุฏุงุก ุงูุนุงู ${year}ู</h3>
      <table><thead><tr><th>ุงููุฌุงู</th><th>ุงููุณุจุฉ</th><th>ุงููุณุชูู</th></tr></thead><tbody>${list}</tbody></table>
    </div>`;
  };

  const diffs=Object.entries(fields).map(([k,f])=>({name:f.name,d:f.v2025-f.v2024}));
  const up=[...diffs].sort((a,b)=>b.d-a.d).slice(0,3);
  const down=[...diffs].sort((a,b)=>a.d-b.d).slice(0,3);

  const lowSubs=Object.entries(fields).flatMap(([k,f])=>f.subs.map(s=>({field:f.name,sub:s.name,v:s.v})));
  lowSubs.sort((a,b)=>a.v-b.v);
  const urgent=lowSubs.slice(0,5);

  const strengths=lowSubs.filter(x=>x.v>=90).map(x=>`<li>${x.field} โ ${x.sub} (${fmt(x.v)}%)</li>`).join('')||'<li>โ</li>';
  const improvements=lowSubs.filter(x=>x.v<75).map(x=>`<li>${x.field} โ ${x.sub} (${fmt(x.v)}%)</li>`).join('')||'<li>โ</li>';
  const follow=lowSubs.filter(x=>x.v>=75 && x.v<90).map(x=>`<li>${x.field} โ ${x.sub} (${fmt(x.v)}%)</li>`).join('')||'<li>โ</li>';

  return `<h2>๐ฉ ุงูุชูุฑูุฑ ุงูุดุงูู ูุฎุทุฉ ุงูุชุญุณูู ุงููุคุณุณู โ ุซุงูููุฉ ุงููุนููุจู ุจุงูุฎุจุฑ (1447ูู)</h2>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">${yearBlock(2024)}${yearBlock(2025)}</div>
  <h3>๐ฆ ููุญุฉ ุงููุฑููุงุช 2024 โ 2025</h3>
  <table><thead><tr><th>ุงููุฌุงู</th><th>ูุฑู ุงููุณุจุฉ</th><th>ุงูุงุชุฌุงู</th></tr></thead><tbody>
  ${diffs.map(d=>{const sym=d.d>0?'โ ุชุญุณูู':(d.d<0?'โ ุชุฑุงุฌุน':'โฒ ุซุจุงุช'); const col=d.d>0?'#16a34a':(d.d<0?'#e11d48':'#2563eb'); return `<tr><td>${d.name}</td><td>${d.d>0?'+':''}${fmt(d.d)}</td><td style="color:${col};font-weight:700">${sym}</td></tr>`}).join('')}</tbody></table>
  <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">
    <div style="border:1px solid #e7eff0;border-radius:12px;padding:8px"><h3 style="margin:4px 0">๐ ุฃูุจุฑ ูุซุจุงุช (ุชุญุณูู)</h3><ul style="text-align:right;margin:0 18px 8px 0">${up.map(x=>`<li>${x.name}: ${x.d>0?'+':''}${fmt(x.d)} ููุทุฉ</li>`).join('')}</ul></div>
    <div style="border:1px solid #e7eff0;border-radius:12px;padding:8px"><h3 style="margin:4px 0">๐ ูุฌูุงุช (ุชุฑุงุฌุน/ุซุจุงุช ููุฎูุถ)</h3><ul style="text-align:right;margin:0 18px 8px 0">${down.map(x=>`<li>${x.name}: ${x.d>0?'+':''}${fmt(x.d)} ููุทุฉ</li>`).join('')}</ul></div>
    <div style="border:1px solid #e7eff0;border-radius:12px;padding:8px"><h3 style="margin:4px 0">โฑ๏ธ ุฃููููุงุช ุงูุชุฏุฎู ุงูุณุฑูุน (2025)</h3><ul style="text-align:right;margin:0 18px 8px 0">${urgent.map(x=>`<li>${x.field} โ ${x.sub}: ${fmt(x.v)}%</li>`).join('')}</ul></div>
  </div>
  <h3>๐ฆ ููุฎุต ูุชุงุฆุฌ ุงููุฏุฑุณุฉ 2025</h3>
  <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">
    <div style="border:1px solid #e7eff0;border-radius:12px;padding:8px"><h3 style="color:var(--lv-excel);margin:4px 0">ุฌูุงูุจ ุงูุชูููุฒ</h3><ul style="text-align:right;margin:0 18px 8px 0">${strengths}</ul></div>
    <div style="border:1px solid #e7eff0;border-radius:12px;padding:8px"><h3 style="color:var(--lv-launch);margin:4px 0">ุฌูุงูุจ ุชุญุชุงุฌ ุชุญุณูู</h3><ul style="text-align:right;margin:0 18px 8px 0">${improvements}</ul></div>
    <div style="border:1px solid #e7eff0;border-radius:12px;padding:8px"><h3 style="color:var(--lv-progress);margin:4px 0">ุฌูุงูุจ ูุชุงุจุนุฉ ูุชุซุจูุช</h3><ul style="text-align:right;margin:0 18px 8px 0">${follow}</ul></div>
  </div>
  <div class="sig">ูุฏูุฑ ุงููุฏุฑุณุฉ: ููุฏ ุญุงูุฏ ุนูู ุงูุฒูุฑุงูู โ ุงูุชุงุฑูุฎ: ${todayHijri()}</div>`;
}

/* ========== 13) ุงูุฎุทุฉ ุงูุดุงููุฉ ========== */
function buildComprehensivePlan(){
  const planRows=Object.entries(fields).map(([k,f])=>{
    const lvl=perfLevel(f.v2025).name;
    const target=f.v2025>=90?'ุงุณุชุฏุงูุฉ ูุณุชูู ุงูุชูููุฒ โฅ 92%':(f.v2025>=75?'ุฑูุน ุงููุชูุณุท ุฅูู 90%+':(f.v2025>=50?'ุงูุงุฑุชูุงุก ุฅูู 75% ุนูู ุงูุฃูู':'ุงููุตูู ุฅูู 50% ุซู 75% ุชุฏุฑูุฌููุง'));
    const kpis='ูุณุจุฉ ุงูุฅูุฌุงุฒุ ุนุฏุฏ ุงูุดูุงูุฏ ุงููุนุชูุฏุฉุ ุชุญุณู ูุชุงุฆุฌ ุงููุคุดุฑุงุช ุงููุฑุนูุฉ';
    const tools='ููุญุฉ ุงููุคุดุฑุงุชุ ุชูุงุฑูุฑ ุงููุชุงุจุนุฉุ ุงุณุชุจุงูุงุช ุฑุถุงุ ููู ุงูุดูุงูุฏ';
    return `<tr class="${levelRowClass(lvl)}">
      <td>${fields[k].name}</td><td>${fmt(f.v2025)}% โ ูุณุชูู ${lvl}</td>
      <td>${target}</td><td>ุชุฏุฎูุงุช ุฏูููุฉ ูู ุงููุนุงููุฑ ุงูุถุนููุฉ + ุชุซุจูุช ููุงุท ุงูููุฉ</td>
      <td>${kpis}</td><td>ูุงุฆุฏ ุงููุฌุงู ููุฑูู ุงูุฌูุฏุฉ</td><td>ู1โู2</td><td>${tools}</td></tr>`;
  }).join('');
  return `<h2>ุงูุฎุทุฉ ุงูุดุงููุฉ ูุซุงูููุฉ ุงููุนููุจู ุจุงูุฎุจุฑ</h2>
  <table><thead><tr><th>ุงููุฌุงู ุงูุฑุฆูุณ</th><th>ุงููุถุน ุงูุฑุงูู (2025)</th><th>ุงููุฏู ุงูุชุญุณููู</th><th>ุงูุฅุฌุฑุงุกุงุช ุงูุชูููุฐูุฉ</th><th>ูุคุดุฑุงุช ุงูุฃุฏุงุก</th><th>ุงููุณุคูู</th><th>ุงูุฅุทุงุฑ ุงูุฒููู</th><th>ุฃุฏูุงุช ุงููุชุงุจุนุฉ</th></tr></thead><tbody>${planRows}</tbody></table>
  <div class="sig">ูุฏูุฑ ุงููุฏุฑุณุฉ: ููุฏ ุญุงูุฏ ุนูู ุงูุฒูุฑุงูู โ ุงูุชุงุฑูุฎ: ${todayHijri()}</div>`;
}

/* ========== 14) ุงูุชุดุบูู ูุงูุฃุฒุฑุงุฑ ========== */
window.addEventListener('DOMContentLoaded',()=>{
  applyLogoToHeader();  // โ ูุถุน ุงูุดุนุงุฑ ูู ุงูููุฏุฑ ุนูุฏ ุงูุชุญููู

  document.getElementById('btnExt2025').addEventListener('click',()=>{window.open('https://drive.google.com/file/d/1s0Rrv8gYkAbbZU3YudxWVC943iU18Df0/view?usp=drive_link','_blank')});
  document.getElementById('btnExt2024').addEventListener('click',()=>{window.open('https://drive.google.com/file/d/1YsfKzyjQl1SHuz24LLepZk8lb_ylf1Ar/view?usp=drive_link','_blank')});
  document.getElementById('btnAnalyze').addEventListener('click',renderDashboard);
  document.getElementById('btnFullReport').addEventListener('click',()=>openDocWindow('ุงูุชูุฑูุฑ ุงูุดุงูู',buildComprehensiveReport()));
  document.getElementById('btnFullPlan').addEventListener('click',()=>openDocWindow('ุงูุฎุทุฉ ุงูุดุงููุฉ',buildComprehensivePlan()));
  renderDashboard(); fillWeeks('T1');
});
</script>
</body>
</html>
