<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>منصة التحليل والتحسين المدرسي – ثانوية اليعقوبي</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

<style>
:root{
  --moe:#0b7e88; --ink:#06353b; --bg:#f5f8f8; --card:#ffffff;
  --shine1:#e8fbfb; --shine2:#d9f2f3; --muted:#6f8e94;
  --ok:#e9fff4; --ok2:#f2fff9; --vg:#f1fff9; --gd:#fffbe6; --md:#fff0e7;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:'Tajawal',sans-serif}
.page{max-width:1200px;margin:0 auto;padding:10px 14px}
a{color:#135; text-decoration:none} a:hover{text-decoration:underline}

/* HEADER – شعار فقط */
.header{
  width:100%; aspect-ratio:7/1.6;
  background:linear-gradient(135deg,var(--shine1),var(--shine2));
  border-radius:16px; box-shadow:0 10px 28px rgba(0,0,0,.12);
  position:relative; overflow:hidden; margin:12px auto;
}
.header:after{
  content:""; position:absolute; inset:0;
  background:url('logo.png') center/contain no-repeat;
  opacity:1;
}

/* Buttons */
.controls{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;padding:6px}
.btn{background:var(--moe);color:#fff;border:0;border-radius:12px;padding:10px 16px;font-weight:700;cursor:pointer;box-shadow:0 6px 18px rgba(11,126,136,.25)}
.btn.light{background:#eef6f7;color:#06353b}
.btn.ghost{background:#fff;color:var(--moe);border:1px solid #d7ecec}
.btn:hover{filter:brightness(.97)}

/* Grid cards */
.grid{display:grid;grid-template-columns:repeat(4,minmax(260px,1fr));gap:16px}
@media (max-width:1150px){.grid{grid-template-columns:repeat(3,minmax(260px,1fr))}}
@media (max-width:900px){.grid{grid-template-columns:repeat(2,minmax(260px,1fr))}}
@media (max-width:620px){.grid{grid-template-columns:1fr}}

.card{
  background:linear-gradient(180deg,#ffffff 0%, #f9feff 100%);
  border-radius:16px; padding:14px; position:relative;
  box-shadow:0 10px 24px rgba(0,0,0,.08), inset 0 0 0 1px #e6efef;
}
.card h2{margin:0 0 6px;color:var(--moe);font-size:20px}
.kpi{display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:13px}
.progress{height:10px;background:#e6efef;border-radius:999px;overflow:hidden;margin:8px 0}
.bar{height:100%;background:#2aa897}
.badge{padding:2px 8px;border-radius:999px;background:#eaf6f6;color:#246;font-size:12px}

/* Center buttons under donut */
.centerBar{display:flex;gap:8px;justify-content:center;align-items:center;margin:8px 0}

/* FULLSCREEN PANEL (لا نخفي الهيدر/الأزرار/الشبكة دائماً) */
.fullpanel{
  position:fixed; inset:0; z-index:9998;
  background:rgba(6,53,59,.06);
  display:none; align-items:flex-start; justify-content:center;
  padding:12px 8px 24px;
}
.fullpanel .inner{
  width:min(1200px,96vw); max-height:90vh; overflow:auto;
  background:#fff; border-radius:16px; box-shadow:0 20px 40px rgba(0,0,0,.20);
  padding:14px;
}
.fullpanel .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.fullpanel .topbar .title{font-weight:700;color:#0b7e88}
.fullpanel .close{background:#e8eff0;color:#034;border:0;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:700}

/* Small sub cards */
.subgrid{display:grid;grid-template-columns:repeat(2,minmax(160px,1fr));gap:8px}
.subCard{background:#f7fbfb;border:1px solid #e6efef;border-radius:12px;padding:10px}

/* Tables */
.tableWrap{margin-top:10px;overflow:auto}
table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;table-layout:fixed}
thead th{background:#0f6f79;color:#fff;padding:10px;font-weight:700}
tbody td{padding:10px;border-bottom:1px solid #eef3f3;vertical-align:top;word-break:break-word}
tbody tr:last-child td{border-bottom:0}

/* Row coloring by level */
.row-excellent{background:var(--ok)}
.row-verygood{background:var(--vg)}
.row-good{background:var(--gd)}
.row-medium{background:var(--md)}
.level{font-weight:700}

/* Evidence modal */
.modal{position:fixed;inset:0;background:rgba(2,52,59,.6);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:9999}
.sheet{width:min(940px,96vw);max-height:92vh;overflow:auto;background:#fff;border-radius:16px;box-shadow:0 12px 40px rgba(0,0,0,.35);padding:16px}
.sheet h4{margin:0 0 8px}
.row{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.row label{font-size:12px;color:#345}
input[type=text],input[type=file],select{border:1px solid #d7e7e7;border-radius:8px;padding:8px;width:100%}
.sheet .close{position:sticky;top:0;margin-bottom:8px;background:#e8eff0;border:0;color:#034;padding:6px 10px;border-radius:8px;cursor:pointer;font-weight:700}
.btn-evi{background:#0b7e88;color:#fff;border:0;border-radius:999px;padding:8px 14px;cursor:pointer;box-shadow:0 6px 16px rgba(11,126,136,.25);transition:200ms}
.btn-evi:hover{transform:translateY(-1px)}

/* A4 windows (تقارير/خطط/شاهد) */
@page { size: A4; margin: 10mm; }
@media print{ .no-print{display:none !important} }

.footer{padding:18px 10px;text-align:center;color:#7a9aa0}
</style>
</head>
<body>
<div class="page">

  <!-- Header -->
  <div class="header" aria-label="وزارة التعليم – شعار"></div>

  <!-- Top controls -->
  <div class="controls">
    <button class="btn" id="btnAnalyze">تحليل شامل 🔎</button>
    <button class="btn" id="btnFullReport">التقرير الشامل PDF 📘</button>
    <button class="btn" id="btnFullPlan">الخطة الشاملة PDF 🗂️</button>
  </div>

  <!-- Domains grid -->
  <div id="dashboard" class="grid"></div>

  <div class="footer">تنفيذ وتصميم فهد حامد الزهراني</div>
</div>

<!-- FULLSCREEN DETAILS (لا نخفي الهيدر/الأزرار/الشبكة دائماً) -->
<div class="fullpanel" id="fullPanel" aria-hidden="true">
  <div class="inner">
    <div class="topbar">
      <div class="title" id="fpTitle">التفاصيل</div>
      <div style="display:flex;gap:8px">
        <button class="btn light" id="fpHome">الصفحة الرئيسية ⟵</button>
        <button class="close" id="fpClose">إغلاق ✕</button>
      </div>
    </div>
    <div id="fpBody"></div>
  </div>
</div>

<!-- Evidence Modal -->
<div class="modal" id="eviModal" aria-hidden="true">
  <div class="sheet">
    <button class="close" id="eviClose">✕ إغلاق</button>
    <h4 style="text-align:center">إضافة شاهد</h4>
    <div class="row" style="margin-bottom:8px">
      <div><label>اسم/وصف الشاهد</label><input id="eviText" type="text" placeholder="مثال: تقرير زيارة مشرف .."/></div>
      <div><label>الفصل الدراسي</label>
        <select id="eviTerm"><option value="T1">الأول</option><option value="T2">الثاني</option></select>
      </div>
      <div><label>الأسبوع (هجري)</label><select id="eviWeek"></select></div>
      <div><label>التاريخ (هجري أم القرى)</label><input id="eviHijri" type="text" placeholder="1447/03/01"/></div>
    </div>
    <div class="row">
      <div><label>رفع ملف (PDF/صورة)</label><input id="eviFile" type="file" accept="application/pdf,image/*"/></div>
      <div style="grid-column:span 3"><label>يتبع</label><input id="eviOwner" type="text" disabled/></div>
    </div>
    <div style="display:flex;gap:8px;margin-top:8px;justify-content:center">
      <button class="btn" id="eviSave">حفظ الشاهد</button>
      <button class="btn light" id="eviCancel">إلغاء</button>
    </div>
    <div class="small" style="margin-top:6px;text-align:center">* الشواهد تُسحب تلقائياً للتقارير وخطط التحسين. فتح الشاهد يكون PDF نظيف للطباعة.</div>
  </div>
</div>
<script>
// تعريف دالة حذف الشاهد
function deleteEvidence(key, index) {
  const ekey = `${key}::${index}`; // إنشاء المفتاح الفريد بناءً على `key` و `index`
  
  // تحقق مما إذا كانت الشاهد موجودة في الذاكرة المحلية
  if (mem[ekey]) {
    // حذف الشاهد من الذاكرة المحلية
    delete mem[ekey];
    // حفظ التحديثات في الذاكرة المحلية
    saveMem();
    alert("تم حذف الشاهد بنجاح");
    renderDashboard(); // إعادة رسم الدوائر بعد الحذف
  } else {
    alert("الشاهد غير موجود");
  }
}

// دالة حفظ البيانات في الذاكرة
function saveMem() {
  localStorage.setItem(STORE, JSON.stringify(mem));
}

// دالة رسم البيانات (الدوائر)
function renderDashboard() {
  const dash = document.getElementById('dashboard');
  dash.innerHTML = '';
  
  // إضافة البيانات مثل الدوائر والعناصر التي ستظهر في الصفحة
}
</script>

<script>
/* ====== أسابيع هجري من طلبك ====== */
const TERM1 = [
  {w:1,from:'01 / 03 / 1447',to:'05 / 03 / 1447',note:'بداية العام الدراسي'},
  {w:2,from:'08 / 03 / 1447',to:'12 / 03 / 1447'},
  {w:3,from:'15 / 03 / 1447',to:'19 / 03 / 1447'},
  {w:4,from:'22 / 03 / 1447',to:'26 / 03 / 1447'},
  {w:5,from:'29 / 03 / 1447',to:'03 / 04 / 1447'},
  {w:6,from:'06 / 04 / 1447',to:'10 / 04 / 1447'},
  {w:7,from:'13 / 04 / 1447',to:'17 / 04 / 1447'},
  {w:8,from:'20 / 04 / 1447',to:'24 / 04 / 1447'},
  {w:9,from:'27 / 04 / 1447',to:'01 / 05 / 1447'},
  {w:10,from:'04 / 05 / 1447',to:'08 / 05 / 1447'},
  {w:11,from:'11 / 05 / 1447',to:'15 / 05 / 1447'},
  {w:12,from:'18 / 05 / 1447',to:'22 / 05 / 1447'},
  {w:13,from:'25 / 05 / 1447',to:'29 / 05 / 1447'},
  {w:'—',from:'30 / 05 / 1447',to:'08 / 06 / 1447',note:'🍂 إجازة الخريف'},
  {w:14,from:'09 / 06 / 1447',to:'13 / 06 / 1447',note:'بعد العودة من الإجازة'},
  {w:15,from:'16 / 06 / 1447',to:'20 / 06 / 1447'},
  {w:16,from:'23 / 06 / 1447',to:'27 / 06 / 1447'},
  {w:17,from:'30 / 06 / 1447',to:'04 / 07 / 1447'},
  {w:18,from:'07 / 07 / 1447',to:'11 / 07 / 1447'},
  {w:19,from:'14 / 07 / 1447',to:'18 / 07 / 1447',note:'✳️ ختام الفصل الدراسي الأول'},
];
const TERM2 = [
  {w:1,from:'29 / 07 / 1447',to:'03 / 08 / 1447',note:'بداية الفصل الثاني'},
  {w:2,from:'06 / 08 / 1447',to:'10 / 08 / 1447'},
  {w:3,from:'13 / 08 / 1447',to:'17 / 08 / 1447'},
  {w:4,from:'20 / 08 / 1447',to:'24 / 08 / 1447'},
  {w:5,from:'27 / 08 / 1447',to:'02 / 09 / 1447'},
  {w:6,from:'05 / 09 / 1447',to:'09 / 09 / 1447'},
  {w:7,from:'12 / 09 / 1447',to:'15 / 09 / 1447',note:'آخر أسبوع قبل الإجازة'},
  {w:'—',from:'16 / 09 / 1447',to:'10 / 10 / 1447',note:'🕌 إجازة رمضان وعيد الفطر'},
  {w:8,from:'10 / 10 / 1447',to:'14 / 10 / 1447',note:'استئناف الدراسة بعد العيد'},
  {w:9,from:'17 / 10 / 1447',to:'21 / 10 / 1447'},
  {w:10,from:'24 / 10 / 1447',to:'28 / 10 / 1447'},
  {w:11,from:'01 / 11 / 1447',to:'05 / 11 / 1447'},
  {w:12,from:'08 / 11 / 1447',to:'12 / 11 / 1447'},
  {w:13,from:'15 / 11 / 1447',to:'19 / 11 / 1447'},
  {w:14,from:'22 / 11 / 1447',to:'26 / 11 / 1447'},
  {w:15,from:'29 / 11 / 1447',to:'03 / 12 / 1447'},
  {w:'—',from:'04 / 12 / 1447',to:'14 / 12 / 1447',note:'🕋 إجازة عيد الأضحى'},
  {w:16,from:'15 / 12 / 1447',to:'19 / 12 / 1447',note:'استئناف الدراسة بعد الأضحى'},
  {w:17,from:'22 / 12 / 1447',to:'26 / 12 / 1447'},
  {w:18,from:'29 / 12 / 1447',to:'03 / 01 / 1448'},
  {w:19,from:'06 / 01 / 1448',to:'10 / 01 / 1448',note:'ختام أسابيع الفصل'},
];

/* ====== أدوات مساعدة ====== */
const fmt=v=>Number(v).toFixed(2);
function levelBadge(v){ if(v>=90)return {txt:'ممتاز',color:'#10b981'}; if(v>=85)return {txt:'مرتفع',color:'#22b8a0'}; if(v>=80)return {txt:'جيد جدًا',color:'#33c2a9'}; if(v>=75)return {txt:'جيد',color:'#f59e0b'}; return {txt:'متوسط',color:'#f97316'}; }
function mapLevelClass(arLevel){
  if(arLevel==='متميز'||arLevel==='مرتفع') return 'row-excellent';
  if(arLevel==='جيد جدًا') return 'row-verygood';
  if(arLevel==='جيد') return 'row-good';
  return 'row-medium';
}
function todayHijri(){
  try{
    const f=new Intl.DateTimeFormat('ar-SA-u-ca-islamic',{year:'numeric',month:'2-digit',day:'2-digit',weekday:'long'});
    return f.format(new Date());
  }catch(e){ return '.../.. /1447هـ'; }
}

/* ====== بيانات عليا للمجالات ====== */
const fields={
  management:{ name:'الإدارة المدرسية', v2024:75.50, v2025:75.50, subs:[
    {id:'plans', name:'التخطيط', v:54.00},
    {id:'lead', name:'قيادة العملية التعليمية', v:72.75},
    {id:'soc', name:'المجتمع المدرسي', v:57.25},
    {id:'dev', name:'التطوير المؤسسي', v:60.25}
  ]},
  teaching:{ name:'التعليم والتعلّم', v2024:80.75, v2025:81.50, subs:[
    {id:'assess', name:'تقويم التعلّم', v:82.75},
    {id:'exp', name:'بناء خبرات التعلّم', v:76.75}
  ]},
  learning:{ name:'نواتج التعلّم', v2024:78.50, v2025:78.50, subs:[
    {id:'ach', name:'التحصيل التعليمي', v:80.25},
    {id:'socdev', name:'التطور الشخصي والصحي والاجتماعي', v:86.25}
  ]},
  environment:{ name:'البيئة المدرسية', v2024:64.00, v2025:62.25, subs:[
    {id:'safety', name:'الأمن والسلامة', v:79.00},
    {id:'building', name:'المبنى المدرسي', v:71.50}
  ]}
};

/* ====== الجداول التفصيلية لكل مجال (كما زوّدتني) ====== */
const detailed={
  management:[
    {level:'متميز', perf:94.50, indicator:'تنشر المدرسة قواعد السلوك والمواظبة وتتابع تطبيقها بانتظام.', improve:'نشر القواعد رقميًا وربطها بمتابعة أسبوعية للانضباط.', evidence:'لوحات السلوك، تقارير الانضباط، سجلات إشعارات.'},
    {level:'مرتفع', perf:90.25, indicator:'تهيئة وصيانة مرافق المبنى وتجهيزاته.', improve:'نظام صيانة رقمي وتوثيق بالصور والتقارير.', evidence:'أوامر عمل، صور قبل/بعد، محاضر إنجاز.'},
    {level:'مرتفع', perf:89.25, indicator:'مناخ آمن ومحفّز للتعلّم والنمو.', improve:'برامج دعم نفسي وقياس رضا المستفيدين دوريًا.', evidence:'استبانات رضا، سجلات إرشاد، خطط وقائية.'},
    {level:'جيد جدًا', perf:87.00, indicator:'متابعة أداء العاملين ودعم التطوير المهني.', improve:'خطط تطوير فردية مبنية على تقويم سنوي.', evidence:'نماذج تقويم، خطط تحسين، محاضر تغذية راجعة.'},
    {level:'جيد جدًا', perf:85.25, indicator:'متابعة تنفيذ الخطة التشغيلية وتطويرها.', improve:'لوحة مؤشرات أسبوعية وربط المهام بالمخرجات.', evidence:'لوحة أداء، تقارير تقدم، محاضر فرق العمل.'},
    {level:'جيد جدًا', perf:83.75, indicator:'تواصل فعّال مع أولياء الأمور والمجتمع.', improve:'قنوات تواصل موحّدة وجدولة لقاءات دورية.', evidence:'منصة تواصل، محاضر لقاءات، تقارير تفاعل.'},
    {level:'جيد جدًا', perf:82.00, indicator:'تشجيع الحصول على الرخصة المهنية.', improve:'برنامج تحفيزي وجدولة دخول الاختبارات.', evidence:'قوائم تسجيل، شهادات حضور، نتائج الرخصة.'},
    {level:'جيد', perf:80.00, indicator:'تعزيز ثقافة العمل الجماعي.', improve:'فرق تميّز بمهمات واضحة ومتابعة إنجاز.', evidence:'تشكيل الفرق، خطط فرق، تقارير مختصرة.'},
    {level:'جيد', perf:78.00, indicator:'توثيق القيم والهوية الوطنية.', improve:'ملف رقمي للهوية مرتبط بالأنشطة.', evidence:'صور فعاليات، ملفات إنجاز، نماذج توثيق.'},
    {level:'جيد', perf:76.50, indicator:'تفعيل قنوات التواصل الداخلي.', improve:'تنظيم المراسلات والاجتماعات إلكترونيًا.', evidence:'سجلات تعميمات، محاضر، لوائح إجراءات.'},
    {level:'متوسط', perf:75.50, indicator:'تفعيل الشراكات المجتمعية.', improve:'ثلاث شراكات نوعية مرتبطة بالتعلّم.', evidence:'مذكرات تفاهم، تقارير فعاليات، شهادات شراكة.'},
    {level:'متوسط', perf:72.00, indicator:'تطوير أنظمة المتابعة الإلكترونية.', improve:'لوحة مؤشرات ذكية وتحليلات شهرية.', evidence:'تقارير تحليلية، لوحات قياس، أرشيف رقمي.'},
    {level:'متوسط', perf:70.25, indicator:'توظيف التقنية في الإدارة اليومية.', improve:'رفع استخدام (نور/فارس/مدرستي) وتتبع التقارير.', evidence:'سجلات دخول، تقارير استخدام، مصفوفة التزام.'}
  ],
  teaching:[
    {level:'متميز', perf:99.25, indicator:'تنفّذ المدرسة برامج تدريبية نوعية للمعلمين تُطوّر المهارات الصفّية.', improve:'مواءمة التدريب مع الاحتياجات الفعلية وتتبع أثره داخل الحصص.', evidence:'خطط تدريب، تقارير أثر، استمارات متابعة.'},
    {level:'متميز', perf:97.75, indicator:'تهيئة بيئة تعليمية محفّزة لتنمية التفكير الإبداعي/الناقد.', improve:'تضمين مهارات التفكير العليا في الخطط اليومية والتعلم النشط.', evidence:'خطط دروس، ملاحظات صفية، منتجات طلابية.'},
    {level:'متميز', perf:97.50, indicator:'تنمية مهارات التعلّم الذاتي والبحث لدى المتعلمين.', improve:'مشاريع بحث رقمية وتدريب على مصادر المعلومات والتحليل.', evidence:'بحوث طلابية، توثيق إشرافي، منصات مشاركة.'},
    {level:'مرتفع', perf:96.75, indicator:'تطبيق استراتيجيات تدريس حديثة داعمة لمهارات القرن 21.', improve:'توثيق التطبيق عبر زيارات صفية وتعلّم نظير لنظير.', evidence:'تقارير زيارات، تسجيلات قصيرة، استمارات أداء.'},
    {level:'مرتفع', perf:94.75, indicator:'توفير وسائل تعليمية رقمية متنوعة تدعم التعلّم الفعّال.', improve:'إنتاج محتوى رقمي تفاعلي وتدريب على توظيفه.', evidence:'ملفات دروس رقمية، نماذج توظيف تقنية.'},
    {level:'مرتفع', perf:93.25, indicator:'تنوّع أدوات التقويم لقياس نواتج التعلّم.', improve:'تحليل أسبوعي للنتائج وربطها بخطط علاج/إثراء صفّية.', evidence:'سجلات تحليل، خطط علاجية، أدوات تقويم.'},
    {level:'جيد جدًا', perf:91.75, indicator:'تقديم تغذية راجعة بنّاءة لتحسين أداء الطلاب.', improve:'نموذج موحّد للتغذية الراجعة وأنشطة تصحيحية لاحقة.', evidence:'نماذج تغذية راجعة، سجلات متابعة.'},
    {level:'جيد جدًا', perf:89.50, indicator:'توظيف التقنية بفاعلية في التعليم والتعلّم.', improve:'تفعيل أدوات التفاعل (اختبارات قصيرة/نماذج/منصات) بالحصة.', evidence:'تقارير «مدرستي»، أدلة أنشطة رقمية.'},
    {level:'جيد', perf:88.00, indicator:'إتاحة تعلّم تعاوني ومشاريع جماعية.', improve:'تصميم rubrics للمشاريع وتقويم الأدوار والمخرجات.', evidence:'ملفات مشاريع، محاضر تقويم، صور عروض.'},
    {level:'جيد', perf:86.75, indicator:'تنمية مهارات التفكير الناقد لدى المتعلمين.', improve:'أنشطة تحليل ونقاش منظّم في العلوم واللغة.', evidence:'خطط أنشطة، تقارير أداء، عينات أعمال.'},
    {level:'جيد', perf:84.50, indicator:'برامج إثرائية للمتميزين والموهوبين.', improve:'ورش أسبوعية إثرائية ومتابعة مخرجاتهم النوعية.', evidence:'قوائم مشاركين، منتجات، تقارير موهبة.'},
    {level:'متوسط', perf:82.75, indicator:'بناء الدروس وفق نواتج تعلم واضحة ومعلَنة.', improve:'مراجعة الخطط اليومية وضبط مؤشرات الإتقان.', evidence:'خطط محدثة، ملاحظات إشرافية.'},
    {level:'متوسط', perf:76.75, indicator:'تنويع أساليب التعليم بما يلائم الفروق الفردية.', improve:'أنشطة متعددة الأنماط (بصري/سمعي/حسي) داخل الحصة.', evidence:'خطط معدّلة، تقارير صفية، تحليل نتائج.'}
  ],
  learning:[
    {level:'متميز', perf:96.75, indicator:'يظهر المتعلمون اعتزازًا بالقيم والهوية الوطنية.', improve:'ربط الأنشطة الصفية واللاصفية بالقيم الوطنية عبر منصات المدرسة.', evidence:'منتجات طلابية، صور فعاليات، تقارير الهوية.'},
    {level:'متميز', perf:96.25, indicator:'لدى المتعلمين اتجاهات إيجابية ودافعية مرتفعة للتعلّم.', improve:'برامج تحفيزية منهجية وتيسير الإرشاد الأكاديمي.', evidence:'استبانات رضا، خطط إرشاد، تقارير متابعة.'},
    {level:'متميز', perf:95.50, indicator:'نتائج متميزة في الاختبارات الوطنية/الدولية.', improve:'اختبارات معيارية دورية وخطط علاجية للفاقد.', evidence:'نتائج اختبارات، تحليلات، خطط علاج.'},
    {level:'متميز', perf:94.00, indicator:'التزام بقواعد السلوك والانضباط.', improve:'متابعة يومية للانضباط وتكريم سلوكي دوري.', evidence:'سجلات الانضباط، محاضر تكريم، تقارير.'},
    {level:'جيد جدًا', perf:91.75, indicator:'اتجاهات إيجابية نحو الذات والنمو الشخصي.', improve:'برامج مهارية ومسارات قيادة طلابية.', evidence:'قوائم مشاركة، تقارير برامج، استبانات أثر.'},
    {level:'جيد جدًا', perf:89.25, indicator:'مهارات البحث والتعلّم الذاتي.', improve:'مشاريع بحث رقمية وتدريب على التوثيق.', evidence:'بحوث طلابية، نماذج تقييم، منصة مشاركة.'},
    {level:'جيد جدًا', perf:86.25, indicator:'مهارات اجتماعية وصحية إيجابية.', improve:'حملات توعوية وممارسات صحية.', evidence:'نشرات، صور فعاليات، تقارير نشاط.'},
    {level:'جيد', perf:84.25, indicator:'مبادرات مجتمعية وخدمة عامة.', improve:'شراكات نوعية ومبادرات طلابية.', evidence:'مذكرات تعاون، تقارير مبادرات، صور.'},
    {level:'جيد', perf:82.94, indicator:'تقدم في نتائج المواد.', improve:'تحليل النتائج وبناء خطط دعم.', evidence:'تقارير تحليل، خطط رفع، متابعة.'},
    {level:'جيد', perf:79.04, indicator:'تحقق نواتج تعلم في المواد الأساسية.', improve:'تقويم مستمر وربطه بخطط تحسين.', evidence:'أدوات تقويم، سجلات تحليل، خطط علاج.'},
    {level:'متوسط', perf:63.25, indicator:'مشاركة ثقافية/قيمية.', improve:'تحفيز المشاركة في المسابقات وبرامج القيم.', evidence:'صور فعاليات، تقارير أنشطة، نشرات.'}
  ],
  environment:[
    {level:'متميز', perf:97.50, indicator:'تهيئة وصيانة مرافق المبنى وتجهيزاته.', improve:'سجل رقمي للصيانة الوقائية وتحديث خطة الصيانة.', evidence:'تقارير صيانة، صور أعمال، محاضر.'},
    {level:'متميز', perf:97.00, indicator:'المحافظة على نظافة المبنى والمرافق.', improve:'تعزيز الإشراف اليومي وتحديد مسؤول متابعة.', evidence:'تقارير إشرافية، صور توثيق، عقود متابعة.'},
    {level:'جيد جدًا', perf:94.00, indicator:'توافر معايير الأمن والسلامة.', improve:'فرضيات دورية وتحديث أدوات السلامة.', evidence:'سجلات الأمن والسلامة، صور الفرضيات، تقارير.'},
    {level:'جيد جدًا', perf:79.00, indicator:'وصولات آمنة لعملية تعليمية ميسّرة.', improve:'تهيئة الممرات والمرافق لذوي الإعاقة.', evidence:'صور تجهيزات، تقارير إشرافية، محاضر.'},
    {level:'جيد', perf:73.25, indicator:'جاذبية البيئة المدرسية.', improve:'تطوير الصفوف بالألوان والجلسات التفاعلية.', evidence:'صور الفصول، استبانات رضا، تقارير.'},
    {level:'متوسط', perf:64.00, indicator:'مخارج الطوارئ ومتطلبات السلامة.', improve:'مراجعة المخارج وتفعيل لوحات الإرشاد والإضاءة.', evidence:'تقارير الدفاع المدني، صور المخارج، محاضر.'},
    {level:'متوسط', perf:62.50, indicator:'كفاية الإضاءة والتهوية.', improve:'تحسين الإضاءة وصيانة أجهزة التهوية شهريًا.', evidence:'تقارير فنية، صور صيانة، تقارير متابعة.'}
  ]
};

/* ====== تخزين الشواهد (محلي) ====== */
const STORE='yaqoubi_evidence_1447';
const mem=JSON.parse(localStorage.getItem(STORE)||'{}');
function saveMem(){ localStorage.setItem(STORE, JSON.stringify(mem)); }

/* ====== شعار ممتد لـ A4 ====== */
function bannerHeaderHTML(){
  return `
    <div style="
      width:100%;
      height:180px;
      background:url('logo.png') center/cover no-repeat;
      margin-bottom:15px;
      border-radius:8px;
    "></div>
  `;
}

/* ====== نافذة A4 عامة موسّعة للطباعة ====== */
function openDocWindow(title, contentHTML){
  const w=window.open('', '_blank'); if(!w){alert('فضلاً اسمح بالنوافذ المنبثقة.');return;}
  const doc=`
  <!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"/>
  <title>${title}</title>
  <style>
    @page { size: A4; margin: 10mm; }
    body{font-family:'Tajawal',sans-serif;margin:0;background:#fff;color:#06353b}
    .wrap{max-width:1120px;margin:0 auto;padding:12px;}
    h2{margin:6px 0;color:#0b7e88;text-align:center}
    h3{color:#0b7e88;margin:8px 0}
    table{width:100%;border-collapse:collapse;margin-top:8px;table-layout:fixed}
    thead th{background:#0f6f79;color:#fff;padding:8px;font-weight:700}
/* توسيط محتوى خلايا الجداول في نافذة الطباعة */
td,th{
  padding:8px;
  border:1px solid #e7eff0;
  vertical-align: middle;   /* بدل top */
  text-align: center;       /* توسيط أفقي */
  font-size:13px;
  word-break:break-word;
}
    .row-excellent{background:#e9fff4}.row-verygood{background:#f1fff9}.row-good{background:#fffbe6}.row-medium{background:#fff0e7}
    .toolbar{position:sticky;top:0;background:#fff;padding:6px 0;margin:6px 0;border-bottom:1px dashed #e1ecec;text-align:center}
    .btn{padding:8px 12px;border:1px solid #0b7e88;border-radius:8px;background:#0b7e88;color:#fff;cursor:pointer;margin:0 4px}
    .sig{font-size:12px;text-align:center;margin-top:8px;color:#345}
    @media print{.toolbar{display:none}}
  </style></head><body>
  <div class="wrap">
    ${bannerHeaderHTML()}
    ${contentHTML}
    <div class="toolbar no-print">
      <button class="btn" onclick="window.print()">طباعة</button>
      <button class="btn" onclick="window.close()">إغلاق</button>
    </div>
  </div>
  </body></html>`;
  w.document.open(); w.document.write(doc); w.document.close();
}

/* ====== عارض الشاهد: PDF فقط نظيف ====== */
function openEvidenceViewerPDF(url){
  const w=window.open('', '_blank'); if(!w){alert('فضلاً اسمح بالنوافذ المنبثقة.');return;}
  const doc=`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"/>
  <title>شاهد</title>
  <style>@page{size:A4;margin:10mm}html,body{margin:0;height:100%}</style>
  </head><body>
    <embed src="${url}" type="application/pdf" style="width:100%;height:100vh;border:0"/>
  </body></html>`;
  w.document.open(); w.document.write(doc); w.document.close();
}

/* ====== شبكة المجالات + نقر الدائرة لفتح ملء الشاشة ====== */
// دالة لرسم البيانات بعد تحميلها من Supabase
async function fetchData() {
  const { data, error } = await supabase.from('evidences').select('*');  // جلب كافة البيانات من الجدول evidences

  if (error) {
    console.error('حدث خطأ:', error);
  } else {
    console.log('تم استرجاع البيانات بنجاح:', data);
    renderDashboard(data); // تفعيل رسم الدوائر بعد تحميل البيانات
  }
}

// استدعاء الدالة لجلب البيانات
fetchData();

// دالة لعرض البيانات في الدوائر
function renderDashboard(data) {
  const dash = document.getElementById('dashboard');
  dash.innerHTML = '';
  const colors = ['#2aa897', '#5d9ed6', '#f1ad5b', '#7ac6b7', '#91a7ff', '#a5d8a6'];

  Object.entries(fields).forEach(([key, f]) => {
    const lvl = levelBadge(f.v2025);
    const card = document.createElement('div');
    card.className = 'card';
    card.id = `card-${key}`;
    card.innerHTML = `
      <h2>${f.name}</h2>
      <div class="kpi">
        <span>2024: ${fmt(f.v2024)}% → 2025: ${fmt(f.v2025)}%</span>
        <span class="badge" style="background:${lvl.color}22;color:${lvl.color}">${lvl.txt}</span>
      </div>
      <div class="progress">
        <div class="bar" style="width:${Math.max(2, f.v2025)}%"></div>
      </div>
      <div style="display:flex;justify-content:center">
        <canvas id="donut-${key}" height="140" style="cursor:pointer"></canvas>
      </div>
      <div class="centerBar">
        <button class="btn ghost" onclick="openFieldReport('${key}')">تقرير المجال PDF</button>
        <button class="btn ghost" onclick="openFieldPlan('${key}')">خطة تحسين المجال PDF</button>
      </div>
    `;
    dash.appendChild(card);

    const ctx = document.getElementById(`donut-${key}`).getContext('2d');
    const chart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: f.subs.map(s => s.name),
        datasets: [{
          data: f.subs.map(s => s.v),
          backgroundColor: colors
        }]
      },
      options: {
        plugins: { legend: { display: false } },
        cutout: '68%'
      }
    });

    // فتح التفاصيل عند الضغط على الدائرة
    document.getElementById(`donut-${key}`).addEventListener('click', () => openFieldFullScreen(key, colors));
  });
}

/* ====== بناء تفاصيل المجال لملء الشاشة (مع الجدول الكامل والشواهد) ====== */
function openFieldFullScreen(key, colors){
  const panel=document.getElementById('fullPanel');
  const title=document.getElementById('fpTitle');
  const body=document.getElementById('fpBody');
  const f=fields[key];
  title.textContent = 'التحليل التفصيلي – ' + f.name;

  const subsHtml=f.subs.map((s,i)=>{
    const col = colors[i%colors.length], lb=levelBadge(s.v);
    return `
      <div class="subCard" style="background:${col}14;border-color:${col}45;box-shadow:inset 0 0 0 1px ${col}30;">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>${s.name}</strong>
          <span class="badge" style="background:${col}26;color:${col}">${fmt(s.v)}%</span>
        </div>
        <div class="small">مستوى المؤشر الفرعي: ${lb.txt}</div>
      </div>`;
  }).join('');

  const rows=(detailed[key]||[]).map((r,i)=>{
    const ekey=`${key}::${i}`;
    const evis=(mem[ekey]||[]).map((e,j)=>`<div class="small">• ${e.hijri} — <a href="${e.url}" target="_blank" onclick="event.preventDefault();openEvidenceViewerPDF('${e.url}');">فتح الشاهد</a></div>`).join('');
    return `<tr class="${mapLevelClass(r.level)}">
      <td class="level" style="text-align:center">${r.level}<div class="small">${fmt(r.perf)}%</div></td>
      <td>${r.indicator}</td>
      <td>${r.improve}</td>
      <td>
        ${r.evidence}
        ${evis?`<div style="margin-top:6px">${evis}</div>`:''}
        <div style="margin-top:8px;text-align:center">
  <!-- زر إضافة شاهد -->
  <button class="btn-evi" onclick="openEvidence('${key}',${i})">إضافة شاهد</button>
  
  <!-- زر حذف الشاهد مع أيقونة الحذف -->
  <button class="btn-evi delete" onclick="deleteEvidence('${key}', ${i})">
    <i class="fa fa-trash"></i> حذف الشاهد
  </button>
</div>
</td>

    </tr>`;
  }).join('');

  body.innerHTML = `
    <div class="subgrid">${subsHtml}</div>
    <div class="tableWrap">
      <table>
        <thead><tr><th style="width:130px">المستوى/الأداء</th><th>المؤشر</th><th>مقترحات التحسين</th><th>الشواهد</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  `;

  panel.style.display='flex';
  // أزرار
  document.getElementById('fpClose').onclick=()=>{panel.style.display='none';};
  document.getElementById('fpHome').onclick=()=>{panel.style.display='none'; window.scrollTo({top:0,behavior:'smooth'});};
}

/* ====== شواهد ====== */
let currentEvi={key:'',idx:0};
function fillWeeks(termVal){
  const sel=document.getElementById('eviWeek'); sel.innerHTML='';
  const arr = termVal==='T1' ? TERM1 : TERM2;
  arr.forEach(w=>{
    const o=document.createElement('option');
    o.value = `الأسبوع ${w.w} — ${w.from}→${w.to}${w.note?` (${w.note})`:''}`;
    o.textContent = o.value;
    sel.appendChild(o);
  });
}
document.getElementById('eviTerm').addEventListener('change',(e)=>fillWeeks(e.target.value));

function openEvidence(fieldKey,rowIdx){
  currentEvi={key:fieldKey,idx:rowIdx};
  document.getElementById('eviOwner').value=`${fields[fieldKey].name} — بند ${rowIdx+1}`;
  document.getElementById('eviText').value='';
  document.getElementById('eviHijri').value=todayHijri().replace(/\s/g,'');
  document.getElementById('eviFile').value='';
  document.getElementById('eviTerm').value='T1';
  fillWeeks('T1');
  document.getElementById('eviModal').style.display='flex';
}
function closeEvidence(){ document.getElementById('eviModal').style.display='none'; }
document.getElementById('eviClose').onclick=closeEvidence;
document.getElementById('eviCancel').onclick=closeEvidence;

document.getElementById('eviSave').onclick=()=>{
  const text=document.getElementById('eviText').value.trim();
  const term=document.getElementById('eviTerm').value;
  const week=document.getElementById('eviWeek').value;
  const hijri=document.getElementById('eviHijri').value.trim()||todayHijri();
  const fileEl=document.getElementById('eviFile');
  let url='';
  if(fileEl.files && fileEl.files[0]){
    url = URL.createObjectURL(fileEl.files[0]);
  }
  if(!text && !url){ alert('أدخل اسم الشاهد وارفع ملفًا (اختياري).'); return; }
  const k=`${currentEvi.key}::${currentEvi.idx}`;
  mem[k]=mem[k]||[]; mem[k].push({text,term,week,hijri,url,ts:Date.now()}); saveMem();
  closeEvidence();
  document.getElementById('fullPanel').style.display='none';
  // إعادة الفتح مباشرة لعرض الشاهد المضاف
  openFieldFullScreen(currentEvi.key,['#2aa897','#5d9ed6','#f1ad5b','#7ac6b7','#91a7ff','#a5d8a6']);
};

/* ====== تقارير/خطط المجال ====== */
function buildFieldReportHTML(key){
  const f = fields[key], lvl = levelBadge(f.v2025);
  const rows = (detailed[key] || []).map(r => `
    <tr class="${mapLevelClass(r.level)}">
      <td>${r.level}</td>
      <td>${fmt(r.perf)}%</td>
      <td>${r.indicator}</td>
      <td>${r.improve}</td>
      <td>${r.evidence}</td>
    </tr>`).join('');

  return `
  <h2>تقرير المجال: ${f.name}</h2>
  <div style="text-align:center;margin:4px 0">
    الأداء 2024: ${fmt(f.v2024)}% — الأداء 2025: ${fmt(f.v2025)}% — المستوى: ${lvl.txt}
  </div>
  <table>
    <thead>
      <tr>
        <th style="width:70px">المستوى</th>
        <th style="width:70px">نسبة الأداء</th>
        <th style="width:310px">المؤشر</th>
        <th style="width:270px">مقترحات التحسين</th>
        <th style="width:250px">الشواهد</th>
      </tr>
    </thead>
    <tbody>${rows}</tbody>
  </table>
  <div class="sig">مدير المدرسة: فهد حامد علي الزهراني — التاريخ: ${todayHijri()}</div>`;
}

function buildFieldPlanHTML(key){
  const f=fields[key];
const rows = (detailed[key] || []).slice(0,6).map((r,i) => {
  // مدد مختلفة لكل بند في الخطة
  const durations = [
    '4 أسابيع',       // البند 1
    '6 أسابيع',       // البند 2
    '8 أسابيع',       // البند 3
    '10 أسابيع',      // البند 4
    '12 أسبوعًا',     // البند 5
    'فصل دراسي كامل' // البند 6
  ];

  return `<tr>
    <td>${r.indicator}</td>
    <td>${r.improve}</td>
    <td>${durations[i] || '6 أسابيع'}</td>
    <td>${r.evidence}</td>
  </tr>`;
}).join('');

  return `<h2>خطة تحسين المجال: ${f.name}</h2>
  <table><thead><tr><th>الهدف/المؤشر</th><th>الإجراء التحسيني</th><th>المدة</th><th>الشواهد</th></tr></thead><tbody>${rows}</tbody></table>
  <div class="sig">مدير المدرسة: فهد حامد علي الزهراني — التاريخ: ${todayHijri()}</div>`;
}
function openFieldReport(key){ openDocWindow('تقرير المجال', buildFieldReportHTML(key)); }
function openFieldPlan(key){ openDocWindow('خطة تحسين المجال', buildFieldPlanHTML(key)); }

/* ====== التقرير الشامل + الخطة الشاملة (عريض للطباعة) ====== */
function buildComprehensiveReport(){
  return `
  <h2>🟩 التقرير الشامل لخطة التحسين المؤسسي – ثانوية اليعقوبي بالخبر (1447هـ)</h2>
  <h3>🟦 أولاً: المقدمة</h3>
  <p>في ضوء توجهات وزارة التعليم نحو رفع كفاءة الأداء المدرسي وتحقيق مؤشرات التميز المؤسسي،
  تم تحليل نتائج التقويم المدرسي الخارجي حسب نتائج عامي ٢٠٢٤-٢٠٢٥م ،
  والتي شملت أربعة مجالات رئيسة هي: القيادة والإدارة المدرسية، التعليم والتعلّم، نواتج التعلّم، البيئة المدرسية.</p>
  <h3>🟦 ثانيًا: ملخص نتائج التحليل العام</h3>
  <table>
  <thead>
    <tr>
      <th style="width:130px">المجال</th>
      <th style="width:100px;text-align:center">متوسط الأداء</th>
      <th style="width:100px;text-align:center">مستوى الأداء</th>
      <th style="width:330px">أبرز نقاط القوة</th>
      <th style="width:330px">أبرز فرص التحسين</th>
    </tr>
  </thead>
  <tbody>

      <tr class="row-verygood"><td>القيادة والإدارة المدرسية</td><td>86%</td><td>جيد جدًا</td><td>خطة تشغيلية فعّالة – رخص مهنية – متابعة ميدانية.</td><td>ضعف التوثيق الرقمي – محدودية الشراكات المجتمعية.</td></tr>
      <tr class="row-verygood"><td>التعليم والتعلّم</td><td>88%</td><td>جيد جدًا</td><td>بيئة تعلم محفزة – استراتيجيات حديثة – تغذية راجعة فعالة.</td><td>ضعف تنويع الأساليب – ضعف توظيف التقنية في بعض المواد.</td></tr>
      <tr class="row-excellent"><td>نواتج التعلّم</td><td>91%</td><td>متميز</td><td>التزام سلوكي – اعتزاز بالهوية – تحصيل دراسي مرتفع.</td><td>تفاوت بين المواد الدراسية – ضعف المبادرات المجتمعية.</td></tr>
      <tr class="row-verygood"><td>البيئة المدرسية</td><td>84%</td><td>جيد جدًا</td><td>مرافق مهيأة – تطبيق معايير السلامة – بيئة نظيفة.</td><td>ضعف تجهيز مرافق ذوي الإعاقة وتحسين الإضاءة.</td></tr>
    </tbody>
  </table>
  <div class="sig">مدير المدرسة: فهد حامد علي الزهراني — التاريخ: ${todayHijri()}</div>
  `;
}
function buildComprehensivePlan(){
  return `
  <h2>خطة التحسين الشاملة لثانوية اليعقوبي بالخبر</h2>
  <p style="text-align:center;margin:4px 0">(مستقاة من تقريري التقويم الخارجي 2024م + 2025م، وفق مجالات الاعتماد المدرسي)</p>
  <table>
    <thead>
      <tr>
        <th>المجال الرئيس</th><th>ناتج التحليل (الوضع الحالي من التقريرين)</th><th>الهدف التحسيني (SMART)</th><th>الإجراءات التنفيذية المقترحة</th><th>مؤشرات الأداء (KPIs)</th><th>المسؤول / المنفذ</th><th>الإطار الزمني</th><th>أدوات المتابعة</th>
      </tr>
    </thead>
    <tbody>
      <tr class="row-verygood"><td>1. القيادة والإدارة المدرسية</td><td>ضعف سابق في متابعة الخطة التشغيلية وتحسنها لاحقًا (54% → 75%)، مع قصور في توثيق الشراكة (39.75%).</td><td>رفع كفاءة تنفيذ الخطة التشغيلية إلى 90% وتوثيق الشراكات المجتمعية بمعدل 10 شراكات نوعية خلال العام.</td><td>- توحيد النماذج الإشرافية والمتابعة الرقمية.<br>- تحليل دوري كل 6 أسابيع.<br>- لوحة مؤشرات أداء داخلية.<br>- خطة شراكة مجتمعية.</td><td>✔️ نسبة إنجاز الخطة التشغيلية.<br>✔️ عدد الشراكات الفاعلة.<br>✔️ عدد الاجتماعات التقييمية.</td><td>قائد المدرسة – وكيل الجودة – رائد الشراكة</td><td>مستمر طوال العام</td><td>لوحة التحليل المؤسسي – محاضر الاجتماعات – تقارير الشراكة</td></tr>
      <tr class="row-verygood"><td>2. التعليم والتعلّم</td><td>تباين في تطبيق الاستراتيجيات واستخدام التقنية (69.75%)، وتدنٍ في الرخص المهنية (24.75%).</td><td>رفع التعليم النشط إلى 90% وزيادة الرخص المهنية إلى 70%.</td><td>- برامج تدريبية أسبوعية.<br>- توظيف التقنية في 80% من الحصص.<br>- دروس رقمية نموذجية.<br>- متابعة فردية للمعلمين.</td><td>✔️ عدد الزيارات الصفية.<br>✔️ نسبة تفعيل التقنية.<br>✔️ الرخص المهنية الجديدة.</td><td>لجنة التعليم والتعلّم – النمو المهني</td><td>ف1–ف2</td><td>استمارات الزيارات – منصة الرخص – تقارير الأداء</td></tr>
      <tr class="row-excellent"><td>3. نواتج التعلم</td><td>ارتفاع القيم والانضباط (94%) مقابل ضعف المشاركة الإثرائية (45→55%).</td><td>رفع المشاركة الإثرائية إلى 80% وتحسين النتائج 10%.</td><td>- نادي الباحث الصغير.<br>- أولمبيادات وأنشطة وزارية.<br>- خطة علاج فجوات.<br>- متابعة كل أسبوعين.</td><td>✔️ عدد الأنشطة الإثرائية.<br>✔️ نسبة المشاركة.<br>✔️ تحسن نتائج المواد.</td><td>وكيل الشؤون التعليمية – رائد النشاط – لجنة النواتج</td><td>ف1–ف2</td><td>تحليل النتائج – استبانات – محاضر المتابعة</td></tr>
      <tr class="row-verygood"><td>4. البيئة المدرسية</td><td>قوة في الصيانة (97%) مقابل ضعف نسبي في السلامة (64%).</td><td>رفع جاهزية السلامة إلى 95% وتحقيق رضا بيئي 90%.</td><td>- خطتا إخلاء خلال العام.<br>- تدريب طوارئ.<br>- تحسين جمالي/وظيفي.<br>- سفراء السلامة.</td><td>✔️ عدد خطط الإخلاء.<br>✔️ زمن الاستجابة.<br>✔️ نتائج استبانات السلامة.<br>✔️ رضا المستفيدين.</td><td>منسق السلامة – لجنة البيئة – قائد المدرسة</td><td>ف1–ف2</td><td>تقارير الدفاع المدني – استبانات – صور التوثيق</td></tr>
    </tbody>
  </table>
  <div class="sig">مدير المدرسة: فهد حامد علي الزهراني — التاريخ: ${todayHijri()}</div>
  `;
}

/* أزرار أعلى الصفحة */
document.getElementById('btnFullReport').addEventListener('click',()=>openDocWindow('التقرير الشامل', buildComprehensiveReport()));
document.getElementById('btnFullPlan').addEventListener('click',()=>openDocWindow('الخطة الشاملة', buildComprehensivePlan()));
document.getElementById('btnAnalyze').addEventListener('click',renderDashboard);

/* تشغيل أولي */
renderDashboard();
// اختياري: لو فعّلت مشروع Supabase لديك
  window.SB_URL  = "https://YOUR_PROJECT.supabase.co";
  window.SB_ANON = "YOUR_PUBLIC_ANON_KEY";
</script>
</body>
</html>
