<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>منصة التحليل والتحسين المدرسي – ثانوية اليعقوبي</title>

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --moe:#0b7e88; --ink:#06353b; --bg:#f5f8f8; --card:#ffffff;
  --muted:#6f8e94; --ok:#e9fff4; --vg:#eef5ff; --gd:#fff6ec; --md:#ffefef;
  --lv-excel:#16a34a; --lv-progress:#2563eb; --lv-launch:#f59e0b; --lv-ready:#e11d48;
  --hero-h: 220px;  --hero-w: 1400px;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:#06353b;font-family:'Tajawal',sans-serif}
a{color:#135;text-decoration:none} a:hover{text-decoration:underline}

/* Hero */
.hero{width:100vw;margin:0;background:var(--bg);height:var(--hero-h);
  display:flex;align-items:center;justify-content:center}
.hero .brand{width:min(var(--hero-w),96vw);height:100%;
  background:url('logo.png') center/contain no-repeat}

/* Page */
.page{max-width:1280px;margin:0 auto;padding:0 16px}

/* Top buttons */
.controls{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;padding:10px 0 14px}
.btn{background:var(--moe);color:#fff;border:0;border-radius:12px;padding:10px 16px;font-weight:700;cursor:pointer;transition:.12s}
.btn:hover{filter:brightness(.97);transform:translateY(-1px)}
.btn.eval{background:linear-gradient(135deg,#0b7e88,#22b8a0)}
.btn.plan{background:linear-gradient(135deg,#2d6cdf,#4cc3ff)}
.btn.ops{background:linear-gradient(135deg,#f59e0b,#ffd166)}
.btn.light{background:#eef6f7;color:#06353b}

/* Fields grid */
.grid{display:grid;grid-template-columns:repeat(4,minmax(240px,1fr));gap:16px}
@media (max-width:1150px){.grid{grid-template-columns:repeat(3,minmax(220px,1fr))}}
@media (max-width:900px){.grid{grid-template-columns:repeat(2,minmax(220px,1fr))}}
@media (max-width:520px){.grid{grid-template-columns:1fr}}

/* Card */
.card{
  background:linear-gradient(180deg,#ffffff 0%,#f9feff 100%);
  border-radius:16px;padding:14px;border:1px solid #e6efef;cursor:pointer;
  transition:transform .12s, box-shadow .12s;
  box-shadow:0 4px 14px rgba(0,0,0,.045);
}
.card:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,.08)}
.card h2{margin:0 0 6px;color:#0b7e88;font-size:20px}
.kpi{display:flex;justify-content:space-between;align-items:center;color:#6f8e94;font-size:13px;gap:8px;flex-wrap:wrap}
.progress{height:10px;background:#e6efef;border-radius:999px;overflow:hidden;margin:8px 0}
.bar{height:100%}

/* Donut (glow) */
.donutWrap{position:relative;height:180px;display:flex;align-items:center;justify-content:center}
.donutCanvas{position:relative;width:100%;height:100%;filter:drop-shadow(0 4px 12px rgba(37,99,235,.15))}
.donutCenter{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);display:flex;flex-direction:column;align-items:center;gap:4px;pointer-events:none}
.donutCenter .lvl{font-size:16px;font-weight:800}
.donutCenter .pct{font-size:12px;color:#6f8e94}
.donutWrap::after{content:"";position:absolute;inset:8px;border-radius:999px;box-shadow:0 0 0 0 rgba(37,99,235,.18);animation:pulseD 2.8s ease-in-out infinite}
@keyframes pulseD{0%{box-shadow:0 0 0 0 rgba(37,99,235,.18)}70%{box-shadow:0 0 0 18px rgba(37,99,235,0)}100%{box-shadow:0 0 0 0 rgba(37,99,235,0)}}

/* Full panel */
.fullpanel{position:fixed;inset:0;z-index:9998;background:rgba(6,53,59,.06);display:none;align-items:flex-start;justify-content:center;padding:12px 8px 24px}
.fullpanel .inner{width:min(1400px,96vw);max-height:92vh;overflow:auto;background:#fff;border-radius:16px;border:1px solid #e6efef;padding:14px}
.fullpanel .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:8px;flex-wrap:wrap}
.pills{display:flex;gap:6px;flex-wrap:wrap}
.pill{display:inline-flex;align-items:center;gap:8px;border:0;cursor:pointer;padding:10px 14px;border-radius:999px;font-weight:800}
.pill.report{background:linear-gradient(135deg,#0b7e88,#1398a2);color:#fff}
.pill.plan{background:linear-gradient(135deg,#2563eb,#4cc3ff);color:#fff}
.fullpanel .close{background:#e8eff0;color:#034;border:0;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:700}

/* Sub cards + table */
.subgrid{display:grid;grid-template-columns:repeat(2,minmax(200px,1fr));gap:10px;margin-bottom:10px}
@media (max-width:680px){.subgrid{grid-template-columns:1fr}}
.subCard{background:radial-gradient(60% 60% at 50% 40%, #ffffff 0%, #f6fcfd 100%);border:1px solid #e6efef;border-radius:14px;padding:10px}

.tableWrap{margin-top:8px;overflow:auto}
table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;table-layout:fixed}
thead th{background:#0f6f79;color:#fff;padding:10px;font-weight:700}
tbody td{padding:10px;border-bottom:1px solid #eef3f3;vertical-align:top;word-break:break-word}
tbody tr:last-child td{border-bottom:0}
.row-excellent{background:var(--ok)} .row-verygood{background:var(--vg)} .row-good{background:var(--gd)} .row-medium{background:var(--md)}

/* Report/Plan columns */
th.col-lvl, td.col-lvl{width:160px}
th.col-crit{width:35%} th.col-imp{width:45%} th.col-evi{width:auto}

/* Evidence actions (icon-only) */
.eviBar{display:flex;gap:6px;justify-content:center;flex-wrap:wrap;margin-top:8px}
.eviDot{width:26px;height:26px;border-radius:999px;border:1px dashed #cfe4e6;background:#fff;display:inline-flex;align-items:center;justify-content:center;font-weight:800;font-size:12px;color:#0b7e88;transition:transform .12s, box-shadow .12s, background .12s}
.eviDot:hover{transform:translateY(-1px);box-shadow:0 4px 10px rgba(0,0,0,.08);background:#f4fbfb}
.eviActions{display:flex;gap:18px;justify-content:center;align-items:center;margin-top:6px}
.eviIcon{font-size:20px;line-height:1;cursor:pointer;user-select:none;transition:transform .12s}
.eviIcon:hover{transform:translateY(-1px)}
.eviIcon.add{color:#0b7e88}
.eviIcon.delete{color:#e11d48}

/* ===== الوسط: (تحصيلي | لوحة القيادة | القدرات) ===== */
.metricsRow{display:flex;justify-content:center;align-items:stretch;gap:18px;margin:14px 0 6px;flex-wrap:wrap}
.metricCard{
  position:relative;background:linear-gradient(180deg,#ffffff 0%,#f9feff 100%);
  border-radius:16px;padding:14px;border:1px solid #e6efef;
  box-shadow:0 6px 18px rgba(0,0,0,.06), inset 0 0 0 1px #e6efef;
  transition:transform .12s, box-shadow .12s;
}
.metricCard:hover{transform:translateY(-2px);box-shadow:0 10px 24px rgba(0,0,0,.09), inset 0 0 0 1px #e6efef}
.metricHead{display:flex;justify-content:center;align-items:center;gap:8px;margin-bottom:6px}
.metricTitle{margin:0;color:#0b7e88;font-size:18px;font-weight:800}
.metricBody{display:flex;align-items:center;justify-content:center}
.metricCard.small{width:320px;height:320px;display:flex;flex-direction:column;justify-content:flex-start;align-items:stretch;margin-inline:auto}
.metricCard.small .metricBody{flex:1;display:flex;align-items:center;justify-content:center}
.metricCard.small .ring{width:110px;height:110px}
.metricCard.small .ring svg{width:110px;height:110px}
.metricCard.small .ringValue{font-size:18px}
.metricCard.lead{width:560px;min-height:320px;margin-inline:auto}

/* Rings */
.ringWrap{display:flex;align-items:center;justify-content:center;gap:12px;width:100%}
.ring{width:96px;height:96px;position:relative}
.ring svg{width:96px;height:96px;display:block}
.ring .bg{stroke:#e6efef;stroke-width:10;fill:none}
.ring .fg{stroke:url(#royalGrad);stroke-width:10;fill:none;stroke-linecap:round;transform:rotate(-90deg);transform-origin:50% 50%}
.ringGlow{position:absolute;inset:-6px;border-radius:999px;box-shadow:0 0 0 0 rgba(37,99,235,.25);animation:pulse 2.2s ease-in-out infinite}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(37,99,235,.24)}70%{box-shadow:0 0 0 16px rgba(37,99,235,0)}100%{box-shadow:0 0 0 0 rgba(37,99,235,0)}}
.ringValue{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-weight:900;font-size:16px;color:#06353b}

/* Leadership icons */
.kbd-icons{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;justify-content:center}
.kbd-icon{display:flex;align-items:center;gap:8px;border:1px dashed #cfe4e6;background:#fff;padding:8px 10px;border-radius:12px;cursor:pointer;font-weight:800}
.kbd-icon:hover{background:#f4fbfb}
.kbd-icon svg{width:18px;height:18px}

/* Metric image modal */
.metricModal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:9999;padding:12px}
.metricModal .sheet{max-width:92vw;max-height:88vh;background:#fff;border-radius:16px;overflow:auto;border:1px solid #e6efef}
.metricModal img{display:block;max-width:100%;height:auto}
.metricModal .bar{display:flex;justify-content:space-between;gap:8px;align-items:center;padding:8px 12px;border-bottom:1px solid #eef1f2}
.metricModal .close{border:0;background:#e8eff0;color:#034;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer}

/* Evidence modal */
.modal{position:fixed;inset:0;display:none;z-index:10000;align-items:center;justify-content:center;background:rgba(6,53,59,.18);padding:12px}
.modal .sheet{width:min(920px,96vw);background:#fff;border-radius:16px;box-shadow:0 20px 40px rgba(0,0,0,.25);padding:14px;border:1px solid #e6efef;max-height:90vh;overflow:auto}
.modal .row{display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:8px}
.modal label{display:block;font-size:12px;color:#355;margin-bottom:4px}
.modal input,.modal select{width:100%;padding:10px;border-radius:10px;border:1px solid #dfecec;background:#fff}
.modal .close{background:#e8eff0;color:#034;border:0;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:700}
@media (max-width:1200px){.metricsRow{justify-content:center}.metricCard.lead{width:min(560px,95vw)}}
@media (max-width:960px){ .metricsRow{flex-direction:column;align-items:center} }
@media (max-width:780px){ .modal .row{grid-template-columns:1fr} }

/* Footer & print */
.footer{padding:18px 10px;text-align:center;color:#7a9aa0}
@page{size:A4;margin:10mm}
@media print{
  .controls,.no-print,.fullpanel,.modal,.metricModal{display:none!important}
  .page{max-width:100%;margin:0 auto!important;padding:0 10mm}
  .hero{box-shadow:none!important;border-radius:0!important}
}
</style>
</head>

<body>
  <!-- Hero -->
  <div class="hero" aria-label="وزارة التعليم – شعار">
    <div class="brand"></div>
  </div>

  <div class="page">
    <div class="controls">
      <button class="btn eval" id="btnExt2025" type="button">التقييم الخارجي ٢٠٢٥م 📄</button>
      <button class="btn eval" id="btnExt2024" type="button">التقييم الخارجي ٢٠٢٤م 📄</button>
      <button class="btn" id="btnAnalyze" type="button">تحليل شامل 🔎</button>
      <button class="btn plan" id="btnFullPlan" type="button">خطة التحسين 🗂️</button>
      <button class="btn ops" id="btnOps" type="button">الخطة التشغيلية 🗂️</button>
    </div>

    <div id="dashboard" class="grid"></div>
    <section id="metricsSection" class="metricsRow"></section>

    <div class="footer">تنفيذ وتصميم فهد حامد الزهراني</div>
  </div>

  <!-- Full analysis panel -->
  <div class="fullpanel" id="fullPanel" aria-hidden="true">
    <div class="inner">
      <div class="topbar">
        <div class="title" id="fpTitle">التحليل التفصيلي</div>
        <div class="pills">
          <button class="pill report" id="btnFieldReport" type="button" title="تقرير المجال للطباعة">تقرير المجال</button>
          <button class="pill plan" id="btnFieldPlan" type="button" title="خطة تحسين المجال للطباعة">خطة المجال</button>
          <button class="close" id="fpHome" type="button">الصفحة الرئيسية ⟵</button>
          <button class="close" id="fpClose" type="button">إغلاق ✕</button>
        </div>
      </div>
      <div id="fpBody"></div>
    </div>
  </div>

  <!-- Metric image modal -->
  <div class="metricModal" id="metricModal" aria-hidden="true">
    <div class="sheet">
      <div class="bar">
        <strong id="metricModalTitle" style="color:#0b7e88">عرض</strong>
        <button class="close" id="metricModalClose" type="button">إغلاق ✕</button>
      </div>
      <img id="metricModalImg" alt="عرض"/>
    </div>
  </div>

  <!-- Evidence modal -->
  <div class="modal" id="eviModal" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="eviTitle">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:6px">
        <h4 id="eviTitle" style="margin:0;text-align:center;color:#0b7e88">إضافة شاهد</h4>
        <button class="close" id="eviClose" type="button">✕ إغلاق</button>
      </div>

      <div class="row" style="margin-bottom:8px">
        <div><label>اسم/وصف الشاهد</label><input id="eviText" type="text" placeholder="مثال: تحليل نتائج صف1.."/></div>
        <div><label>الفصل الدراسي</label><select id="eviTerm"><option value="T1">الأول</option><option value="T2">الثاني</option></select></div>
        <div><label>الأسبوع</label><select id="eviWeek"></select></div>
        <div><label>التاريخ (هجري)</label><input id="eviHijri" type="text" placeholder="1447/03/01"/></div>
      </div>

      <div class="row">
        <div><label>رفع ملف (PDF/صورة)</label><input id="eviFile" type="file" accept="application/pdf,image/*"/></div>
        <div><label>رابط الشاهد (اختياري)</label><input id="eviLink" type="url" placeholder="https://..."/></div>
        <div style="grid-column:span 2"><label>يتبع</label><input id="eviOwner" type="text" disabled/></div>
      </div>

      <div style="display:flex;gap:8px;margin-top:8px;justify-content:center">
        <button class="btn" id="eviSave" type="button">حفظ الشاهد</button>
        <button class="btn light" id="eviCancel" type="button">إلغاء</button>
      </div>
      <div class="small" style="margin-top:6px;text-align:center">* الشواهد تُعرض مباشرة بعد الحفظ ويمكن حذفها من الصف.</div>
    </div>
  </div>

  <!-- Password mini-modal (للإضافة والحذف) -->
  <div class="modal" id="pwdModal" aria-hidden="true">
    <div class="sheet" style="max-width:420px">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:6px">
        <h4 style="margin:0;color:#0b7e88" id="pwdTitle">تحقق كلمة المرور</h4>
        <button class="close" id="pwdClose" type="button">✕</button>
      </div>
      <div>
        <label>أدخل كلمة المرور</label>
        <input id="pwdInput" type="password" placeholder="••••" />
      </div>
      <div style="display:flex;gap:8px;margin-top:10px;justify-content:center">
        <button class="btn" id="pwdOk" type="button">تأكيد</button>
        <button class="btn light" id="pwdCancel" type="button">إلغاء</button>
      </div>
      <div style="text-align:center;color:#6f8e94;font-size:12px;margin-top:6px">* كلمة المرور المطلوبة: 1447</div>
    </div>
  </div>

<script>
/* Links (تم تصحيح رابط 2024) */
const SRC_2025='https://drive.google.com/file/d/1s0Rrv8gYkAbbZU3YudxWVC943iU18Df0/view?usp=drive_link';
const SRC_2024='https://drive.google.com/file/d/1YsfKzyjQl1SHuz24LLepZk8lb_ylf1Ar/view?usp=sharing';
const PLAN_LINK='https://drive.google.com/file/d/1O9o7rYNrtVW8gnOQLGd-lSQCiKq4eHne/view?usp=sharing';
const OPS_LINK='https://drive.google.com/file/d/1ItrZpaptSVaR_qFqMLhzHRAduIeJESa2/view?usp=sharing';

/* Helpers */
const fmt=v=>Number(v).toFixed(2);
function perfLevel(pct){
  if(pct>=90) return {name:'التميّز', key:'excel',  color:getComputedStyle(document.documentElement).getPropertyValue('--lv-excel').trim()};
  if(pct>=75) return {name:'التقدّم', key:'progress',color:getComputedStyle(document.documentElement).getPropertyValue('--lv-progress').trim()};
  if(pct>=50) return {name:'الانطلاق', key:'launch', color:getComputedStyle(document.documentElement).getPropertyValue('--lv-launch').trim()};
  return {name:'التهيئة', key:'ready', color:getComputedStyle(document.documentElement).getPropertyValue('--lv-ready').trim()};
}
function levelRowClass(arLevel){
  if(arLevel==='التميّز'||arLevel==='التقدّم') return 'row-excellent';
  if(arLevel==='الانطلاق') return 'row-verygood';
  if(arLevel==='التهيئة') return 'row-good';
  return 'row-medium';
}

/* Supabase */
const SUPABASE_URL  = 'https://vullbssjyyrnoyyxyebq.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ1bGxic3NqeXlybm95eXh5ZWJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2OTQxODEsImV4cCI6MjA3NjI3MDE4MX0.D7o-dAyQbb2cjmp1ooZ0Mw9xoiih1JUarsEMZJVGfGc';
let supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
try{
  if(typeof window.supabase !== 'undefined' && SUPABASE_URL.startsWith('https')){
    supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
  }
}catch(e){ console.warn('Supabase init skipped:', e); }
</script>

<!-- ===== بيانات الحقول والمؤشرات (كما وفّرتها) ===== -->
<script>
const fields={
  management:{name:'الإدارة المدرسية',v2024:75.50,v2025:75.50,subs:[
    {id:'planning',name:'التخطيط',v:54.00},{id:'lead',name:'قيادة العملية التعليمية',v:72.75},
    {id:'soc',name:'المجتمع المدرسي',v:57.25},{id:'dev',name:'التطوير المؤسسي',v:60.25}
  ]},
  teaching:{name:'التعليم والتعلّم',v2024:80.75,v2025:81.50,subs:[
    {id:'assess',name:'تقويم التعلّم',v:82.75},{id:'exp',name:'بناء خبرات التعلّم',v:76.75}
  ]},
  learning:{name:'نواتج التعلّم',v2024:78.50,v2025:78.50,subs:[
    {id:'ach',name:'التحصيل التعليمي',v:80.25},{id:'socdev',name:'التطور الشخصي والصحي والاجتماعي',v:86.25}
  ]},
  environment:{name:'البيئة المدرسية',v2024:64.00,v2025:62.25,subs:[
    {id:'safety',name:'الأمن والسلامة',v:79.00},{id:'building',name:'المبنى المدرسي',v:71.50}
  ]}
};

const detailed={
  management:[
    {code:'1-1-1-1',level:'التقدّم',perf:81.75,indicator:'تضع المدرسة خطة تشغيلية مكتملة العناصر وفق أهداف تطويرية محددة',improve:'تطوير خطة تشغيلية مرنة بأهداف طموحة وبرامج ومبادرات ومؤشرات أداء ومهام ومسؤوليات مُزمّنة، وخطط استدامة وتحسين.',evidence:'خطة تشغيلية معتمدة + محضر لجنة الخطة + مصفوفة KPI'},
    {code:'2-1-1-1',level:'التهيئة',perf:42.00,indicator:'تتابع المدرسة تنفيذ خطتها وتطورها بما يضمن تحقيق أهدافها',improve:'متابعة التنفيذ وتقويمه بانتظام وفق مؤشرات واضحة، وتطوير الخطة لضمان تحقيق الأهداف.',evidence:'تقارير متابعة شهرية + اجتماعات متابعة + إجراءات تصحيح'},
    {code:'1-1-2-1',level:'التقدّم',perf:76.25,indicator:'تعزز المدرسة القيم الإسلامية والهوية الوطنية',improve:'غرس القيم والهوية وتعزيز الانتماء عبر أنشطة ومناسبات وبرامج مبتكرة داخل المدرسة ومع المجتمع.',evidence:'خطة مناسبات وطنية + توثيق التنفيذ + استبانات أثر'},
    {code:'1-2-1-2',level:'التقدّم',perf:81.25,indicator:'تلتزم المدرسة بقيم مهنة التعليم وأخلاقياتها',improve:'تعزيز الالتزام بقواعد السلوك الوظيفي وأخلاقيات المهنة والتوعية بأساليب مبتكرة ودعم العلاقات الإيجابية.',evidence:'تعميم الميثاق + توقيعات اطلاع + برنامج توعوي'},
    {code:'1-2-1-3',level:'التقدّم',perf:83.00,indicator:'توفر المدرسة مناخًا آمنًا للتعلم والنمو نفسيًّا واجتماعيًّا',improve:'مناخ آمن للحوار والتعاون والاحترام، وبرامج علاجية/وقائية لتقليل التنمر.',evidence:'برنامج إرشاد + سجل حالات ومعالجة + حملات توعية'},
    {code:'1-2-1-4',level:'التميّز',perf:94.75,indicator:'تنشر المدرسة قواعد السلوك والمواظبة، وتتابع تطبيقها',improve:'الاستمرار في نشر القواعد وتحديد التوقعات ومتابعة التطبيق بانتظام بأساليب مبتكرة.',evidence:'لائحة منشورة + دلائل نشر + تقارير انضباط'},
    {code:'5-1-2-1',level:'الانطلاق',perf:62.50,indicator:'توفر المدرسة برامج وأنشطة تربوية داعمة للسلوك الإيجابي',improve:'أنشطة علاجية/وقائية شاملة مرتبطة بتشخيص المشكلات، متابعة وتطوير واستثمار الشراكات.',evidence:'خطة تعزيز السلوك + أدوات تشخيص + قياس أثر'},
    {code:'6-1-2-1',level:'التهيئة',perf:45.00,indicator:'برامج وأنشطة إثرائية غير صفية لتطوير مواهب المتعلمين وتهيئتهم للمستقبل',improve:'أساليب كشف الموهبة وتحفيز مقاييس موهبة وأنشطة إثرائية مرتبطة بالاحتياجات وحوافز ومشاركات تنافسية.',evidence:'قاعدة الموهوبين + مشاركات موهبة + خطة إثرائية'},
    {code:'1-3-1-1',level:'الانطلاق',perf:68.25,indicator:'تعزز المدرسة بناء العلاقات الإيجابية والتعاون في المجتمع المدرسي',improve:'مهام تشجع العمل بروح الفريق وتعزيز العلاقات الإنسانية ومتابعة واستدامة وتطوير.',evidence:'محاضر فرق/PLC + توزيع أدوار + استبانة تماسك'},
    {code:'2-1-3-1',level:'الانطلاق',perf:55.25,indicator:'تعزز المدرسة مشاركة الأسرة في تعلم أبنائهم والتحضير لمستقبلهم',improve:'فرص تواصل فعّالة مع الأسرة وبرامج توعوية مبتكرة وإشراكهم في التحضير للمستقبل وتقويم الخدمات.',evidence:'لقاءات أولياء الأمور + قنوات تواصل + تغذية راجعة'},
    {code:'3-1-3-1',level:'التهيئة',perf:39.75,indicator:'تعزز المدرسة الشراكة المجتمعية لدعم التعلم والتأثير الإيجابي',improve:'تواصل متنوع مع المجتمع، استثمار إمكانات المؤسسات الوطنية، فعاليات توعوية وإتاحة الإمكانات.',evidence:'خطابات/اتفاقيات شراكة + فعاليات + قياس أثر'},
    {code:'1-1-4-1',level:'التهيئة',perf:24.75,indicator:'تشجع المدرسة منسوبيها للحصول على الرخصة المهنية',improve:'برامج توعوية/تحفيزية ومتابعة التقدم وفق الرتب المهنية.',evidence:'سجل الرخص + خطة تحفيزية + مواعيد اختبارات'},
    {code:'1-4-1-2',level:'الانطلاق',perf:53.00,indicator:'تدعم المدرسة التطوير المهني وفق نتائج تقويم الأداء واحتياجاتهم',improve:'خطة تطوير مهني مرتبطة بتقويم الأداء، متابعة التنفيذ وقياس الأثر وتشجيع PLC والبحوث الإجرائية.',evidence:'خطة تدريب سنوية + سجلات حضور + قياس أثر'},
    {code:'3-1-4-1',level:'التقدّم',perf:79.25,indicator:'تطبق المدرسة التقويم الذاتيّ المبنيّ على معايير الهيئة',improve:'تنفيذ التقويم الذاتي وفق الإطار، نشر الثقافة، إشراك المجتمع المدرسي، وخطة طموحة لنقل المعرفة.',evidence:'أداة وتقارير تقويم ذاتي + خطة تحسين مشتقة'},
    {code:'1-4-1-4',level:'الانطلاق',perf:74.00,indicator:'تنفذ المدرسة خطة للتحسين بناءً على نتائج التقويم وتتابعها',improve:'تطوير خطة تحسين بأولويات تعالج جوانب مؤثرة في نواتج التعلم ومتابعة التنفيذ.',evidence:'خطة تحسين معتمدة + تقارير تقدم + مواءمة تشغيلية'}
  ],
  teaching:[
    {code:'2-1-1-2',level:'التميّز',perf:97.75,indicator:'تدعم المدرسة تنفيذ المناهج وفق الخطة الدراسية',improve:'الاستمرار في توفير أنشطة ومصادر مبتكرة تدعم تعلم المعارف/المهارات والقيم ومتابعة التنفيذ لتحقيق التوقعات العالية.',evidence:'خطط توزيع + سجلات تطبيق + دروس نموذجية'},
    {code:'2-2-1-3',level:'التميّز',perf:93.25,indicator:'تقدم المدرسة التغذية الراجعة للمتعلمين بانتظام',improve:'الاستمرار في التغذية الراجعة الفورية والبنّاءة بطرق متنوعة لدعم التعلم وتحسين الأداء.',evidence:'نماذج تغذية راجعة + متابعة فردية'},
    {code:'8-1-1-2',level:'التقدّم',perf:88.50,indicator:'تنمي المدرسة المهارات العاطفية والاجتماعية لدى المتعلمين',improve:'بيئة تعلم تعزز التحكم بالعواطف والثقة بالنفس والتعاون والتواصل والحوار والاحترام المتبادل.',evidence:'برامج SEL + جلسات إرشاد + استبانات مهارية'},
    {code:'2-1-2-2',level:'التقدّم',perf:79.50,indicator:'تحلل نتائج التقويم وتوظفها في تحسين نواتج التعلم',improve:'تحليل النتائج وتفسيرها واتخاذ قرارات وبناء خطط علاجية/إثرائية لتحقيق التوقعات المستهدفة.',evidence:'تقارير تحليل + خطط علاج/إثراء + متابعة تقدم'},
    {code:'3-1-1-2',level:'التقدّم',perf:79.25,indicator:'تنوع المدرسة في إستراتيجيات التدريس',improve:'خبرات تعلم ثرية تشجع البحث/التجريب وتراعي الفروق وتلبي الاحتياجات.',evidence:'خطط دروس متنوعة + زيارات صفية'},
    {code:'6-1-1-2',level:'التقدّم',perf:77.50,indicator:'تنمي المدرسة المهارات القرائية والعددية الأساسية',improve:'تعزيز القراءة/الكتابة والمهارات العددية عبر أنشطة صفية ولاصفية وخطة مركزة طويلة المدى.',evidence:'اختبارات تشخيصية + خطة علاج + تتبع فردي'},
    {code:'2-2-1-1',level:'التقدّم',perf:77.25,indicator:'تقوّم المدرسة أداء المتعلمين بأساليب متنوعة',improve:'تشخيصي/تكويني/ختامي ومشاركة المتعلمين في تقويم أدائهم.',evidence:'بنك أسئلة + أدوات تقويم + ملفات إنجاز'},
    {code:'2-1-1-10',level:'التقدّم',perf:77.25,indicator:'تعزز المدرسة دافعية المتعلمين',improve:'بيئة تعلم تحقق الرفاه وتثير الفضول وتحفز وفق الميول.',evidence:'برامج تحفيزية + مسابقات + بطاقات تشجيع'},
    {code:'1-1-1-2',level:'التقدّم',perf:76.75,indicator:'فرص متكافئة للتعلم',improve:'استجابة للاحتياجات المختلفة والوصول الشامل.',evidence:'IEP + تكييفات + قوائم موهوبين'},
    {code:'7-1-1-2',level:'التقدّم',perf:75.25,indicator:'تنمية مهارات التفكير العليا',improve:'أنشطة لتنمية التحليل والاستنتاج والتقويم والإبداع.',evidence:'منتجات تعلم + Rubrics تفكير'},
    {code:'4-1-1-2',level:'الانطلاق',perf:69.75,indicator:'تفعيل التعلم الإلكتروني',improve:'دمج التعلم الصفي والإلكتروني.',evidence:'منصة + دروس رقمية + تقارير دخول'},
    {code:'5-1-1-2',level:'الانطلاق',perf:62.00,indicator:'أنشطة تعلم تطبيقية',improve:'ربط الخبرات بالواقع وتشجيع الاستقصاء.',evidence:'مشاريع/مهام أدائية + سلالم تقدير'},
    {code:'9-1-1-2',level:'الانطلاق',perf:60.75,indicator:'المهارات الرقمية',improve:'تعزيز استخدام التقنية والتعامل مع البيانات.',evidence:'تدريبات تقنية + منتجات رقمية'}
  ],
  learning:[
    {code:'3-2-1-1',level:'التميّز',perf:95.50,indicator:'اعتزاز بالقيم والهوية',improve:'تعزيز القيم واللغة العربية.',evidence:'فعاليات وطنية + أعمال طلابية'},
    {code:'5-1-2-3',level:'التميّز',perf:94.00,indicator:'انضباط مدرسي',improve:'برامج متنوعة ومبتكرة.',evidence:'تقارير انضباط + متابعة حضور'},
    {code:'3-2-1-2',level:'التميّز',perf:91.75,indicator:'اتجاهات إيجابية نحو الذات',improve:'تعزيز الرفاه والسعادة.',evidence:'برامج رفاه + جلسات إرشاد'},
    {code:'7-1-2-3',level:'التميّز',perf:91.75,indicator:'اعتزاز بالثقافة واحترام التنوع',improve:'تعزيز الثوابت الوطنية واحترام التنوع.',evidence:'منتجات ثقافية + فعاليات'},
    {code:'6-1-2-3',level:'التقدّم',perf:84.25,indicator:'بحث وتعلم ذاتي',improve:'مهام أدائية وإدارة وقت وتوظيف التقنية.',evidence:'مشاريع + Rubrics بحوث'},
    {code:'2-1-1-3',level:'التقدّم',perf:82.94,indicator:'نتائج متقدمة في القدرات',improve:'تعزيز التحليل والاستدلال والمنطق.',evidence:'نتائج + خطة تدريب + محاكاة'},
    {code:'3-1-2-3',level:'التقدّم',perf:82.50,indicator:'ممارسات صحية',improve:'نشاط بدني وغذاء صحي.',evidence:'خطة صحة + سجلات'},
    {code:'1-1-1-3',level:'التقدّم',perf:79.04,indicator:'نتائج الاختبارات التحصيلية',improve:'تعزيز الأساسيات والاستعداد.',evidence:'نتائج + خطة رفع + تقوية'},
    {code:'4-1-2-3',level:'الانطلاق',perf:63.25,indicator:'مشاركة مجتمعية وتطوع',improve:'برامج نوعية تعزز المسؤولية.',evidence:'منصة تطوع + شهادات'}
  ],
  environment:[
    {code:'4-2-1-2',level:'التميّز',perf:97.00,indicator:'صيانة منتظمة للمبنى',improve:'استمرار متابعة الصيانة.',evidence:'أوامر عمل + جداول وقائية'},
    {code:'4-2-1-3',level:'التقدّم',perf:79.50,indicator:'نظافة المبنى',improve:'متابعة وتوفير أدوات النظافة.',evidence:'عقد نظافة + بطاقات متابعة'},
    {code:'2-1-1-4',level:'التقدّم',perf:79.00,indicator:'ملاءمة الفصول والمعامل',improve:'تنظيم وتجهيز وفق المعايير.',evidence:'جرد تجهيزات + محاضر تشغيل'},
    {code:'4-1-1-1',level:'الانطلاق',perf:73.25,indicator:'تنظيم المبنى للعدد والمرحلة',improve:'تطوير المبنى وتنظيم الأثاث.',evidence:'مراسلات + مخططات + صور'},
    {code:'4-2-1-1',level:'الانطلاق',perf:64.00,indicator:'متطلبات الأمن والسلامة',improve:'تعزيز ثقافة السلامة والتوعية.',evidence:'كشوف فحص + فرضيات إخلاء'},
    {code:'4-1-1-3',level:'الانطلاق',perf:62.50,indicator:'المرافق والخدمات المساندة',improve:'توفير مرافق ملائمة ومستدامة.',evidence:'استبانات رضا + تقارير جاهزية'}
  ]
};

const drivingSubjects = [
  {key:'math',  name:'الرياضيات', icon:'➗', tips:[
    'خطة مكثفة لمسائل لفظية وكميّة (3 حصص علاجي/أسبوع).',
    'اختبارات قصيرة أسبوعية + بنك أسئلة قدرات.',
    'منصّة محاكاة يومية 20 دقيقة.'
  ]},
  {key:'physics',name:'الفيزياء', icon:'⚛️', tips:[
    'مفاهيم أساسية + تطبيقات حياتية لتعزيز الاستدلال.',
    'مختبر أسبوعي وتجارب سريعة.',
    'خرائط مفاهيم للأسئلة متعددة الخطوات.'
  ]},
  {key:'chem',  name:'الكيمياء', icon:'🧪', tips:[
    'جداول تفاعلية للمعادلات + تدريب موازنة.',
    'مسائل قياسية كروتين.',
    'مشاريع دقيقة 5 دقائق نهاية الحصة.'
  ]},
  {key:'bio',   name:'الأحياء',  icon:'🧬', tips:[
    'ملخصات مرئية للمسارات الحيوية.',
    'بطاقات مفاهيم + أسئلة فهم عميق.',
    'تعلم ذاتي موجّه 15 دقيقة.'
  ]},
  {key:'arabic',name:'اللغة العربية', icon:'📚', tips:[
    'قراءة سريعة + مفردات + تحليل نص.',
    'تمارين تراكيب/إملاء تكرارية.',
    'نماذج قدرات لفظي مرتين أسبوعيًا.'
  ]}
];
</script>

<script>
function renderDashboard(){
  const dash=document.getElementById('dashboard'); dash.innerHTML='';
  Object.entries(fields).forEach(([key,f])=>{
    const lvl=perfLevel(f.v2025);
    const card=document.createElement('div'); card.className='card'; card.id=`card-${key}`;
    card.innerHTML=`
      <h2>${f.name}</h2>
      <div class="kpi"><span>2024: ${fmt(f.v2024)}% → 2025: ${fmt(f.v2025)}%</span></div>
      <div class="progress"><div class="bar" style="width:${Math.max(2,f.v2025)}%;background:${lvl.color}"></div></div>
      <div class="donutWrap">
        <canvas id="donut-${key}" class="donutCanvas" aria-label="تفاصيل ${f.name}"></canvas>
        <div class="donutCenter"><div class="lvl" style="color:${lvl.color}">${lvl.name}</div><div class="pct">${fmt(f.v2025)}%</div></div>
      </div>`;
    dash.appendChild(card);

    const ctx=document.getElementById(`donut-${key}`).getContext('2d');
    new Chart(ctx,{type:'doughnut',
      data:{labels:f.subs.map(s=>s.name),datasets:[{data:f.subs.map(s=>s.v),backgroundColor:f.subs.map(s=>perfLevel(s.v).color),borderWidth:0}]},
      options:{plugins:{legend:{display:false}},cutout:'68%',responsive:true,maintainAspectRatio:false,animation:{animateRotate:true,animateScale:true}}
    });

    card.addEventListener('click',()=>openFieldFullScreen(key));
  });
}

/* Ring helper */
function makeRing(container, valuePercent){
  const v=Math.max(0,Math.min(100,Number(valuePercent)||0));
  const ring=document.createElement('div'); ring.className='ring';
  ring.innerHTML=`
    <svg viewBox="0 0 100 100">
      <defs><linearGradient id="royalGrad" x1="0" x2="1" y1="0" y2="1"><stop offset="0%" stop-color="#16a34a"/><stop offset="50%" stop-color="#22c55e"/><stop offset="100%" stop-color="#2563eb"/></linearGradient></defs>
      <circle class="bg" cx="50" cy="50" r="48"></circle>
      <circle class="fg" cx="50" cy="50" r="48"></circle>
    </svg>
    <div class="ringGlow"></div><div class="ringValue">${v.toFixed(1)}%</div>`;
  container.appendChild(ring);
  requestAnimationFrame(()=>{
    const fg=ring.querySelector('.fg'); const C=2*Math.PI*48;
    fg.style.stroke='url(#royalGrad)'; fg.style.strokeDasharray=C;
    fg.style.transition='stroke-dashoffset 1200ms cubic-bezier(.22,.9,.29,1)';
    fg.style.strokeDashoffset=C*(1 - v/100);
  });
}
function classify(v){ if(v>=90) return 'ممتاز'; if(v>=75) return 'متقدّم'; if(v>=60) return 'مستهدف'; return 'يحتاج تعزيز'; }

function buildMetricCard(title, value, openHandler){
  const card=document.createElement('div'); card.className='metricCard small';
  card.innerHTML=`
    <div class="metricHead"><h3 class="metricTitle">${title}</h3></div>
    <div class="metricBody"><div class="ringWrap" id="ringHere" role="button" aria-label="عرض ${title}"></div></div>
    <div style="text-align:center;font-weight:800;color:#06353b;margin-top:6px">${value.toFixed(2)}% • ${classify(value)}</div>`;
  makeRing(card.querySelector('#ringHere'), value);
  card.querySelector('#ringHere').addEventListener('click', openHandler);
  return card;
}

/* Leadership (middle, wider) */
function buildMiddleLeadership(tahsili, qiyas){
  const card=document.createElement('div'); card.className='metricCard lead';
  card.innerHTML=`
    <div class="metricHead"><h3 class="metricTitle">لوحة قيادة رفع القدرات والتحصيلي</h3></div>
    <div class="metricBody"><div class="ringWrap" id="ringHere"></div></div>
    <div style="font-size:12px;color:#6f8e94;text-align:center;margin-top:6px">أفكار فاعلة</div>
    <ul style="margin:6px 18px;line-height:1.7">
      <li>🗂️ خطة علاجية أسبوعية + إثرائية وفق التشخيص.</li>
      <li>🕒 محاكاة يومية (15–20 دقيقة) + 🧠 بنك أسئلة متدرّج.</li>
      <li>🤝 PLC مركّزة على الأخطاء الشائعة ورفع الإتقان.</li>
    </ul>
    <div style="font-size:12px;color:#6f8e94;text-align:center">مواد الرافعة</div>
    <div class="kbd-icons" id="kbdIcons"></div>`;
  const avg=(tahsili+qiyas)/2; makeRing(card.querySelector('#ringHere'), avg);

  const iconsWrap=card.querySelector('#kbdIcons');
  drivingSubjects.forEach(sub=>{
    const btn=document.createElement('button');
    btn.className='kbd-icon'; btn.innerHTML=`<span>${sub.icon}</span><span>${sub.name}</span>`;
    btn.addEventListener('click',()=>openSubjectPopup(sub));
    iconsWrap.appendChild(btn);
  });
  return card;
}

/* Subject popup */
function openSubjectPopup(sub){
  const sheet=document.createElement('div');
  sheet.style.cssText='position:fixed;inset:0;z-index:10001;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center';
  sheet.innerHTML=`
    <div style="width:min(720px,94vw);background:#fff;border:1px solid #e6efef;border-radius:16px;overflow:hidden">
      <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #eef1f2">
        <strong style="color:#0b7e88">${sub.icon} خطط رفع — ${sub.name}</strong>
        <button class="close" style="border:0;background:#e8eff0;color:#034;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer">إغلاق ✕</button>
      </div>
      <div style="padding:12px">
        <ol style="margin:0 0 10px 18px; line-height:1.9">
          ${sub.tips.map(t=>`<li>${t}</li>`).join('')}
        </ol>
        <div style="display:flex; gap:8px; flex-wrap:wrap;justify-content:center">
          <span class="kbd-icon">🗂️ خطة علاجية</span>
          <span class="kbd-icon">🧠 بنك أسئلة</span>
          <span class="kbd-icon">🕒 محاكاة يومية</span>
          <span class="kbd-icon">📝 ملخصات</span>
        </div>
      </div>
    </div>`;
  sheet.addEventListener('click',(ev)=>{const box=sheet.children[0]; if(!box.contains(ev.target)) document.body.removeChild(sheet);});
  sheet.querySelector('.close').addEventListener('click',()=>document.body.removeChild(sheet));
  document.body.appendChild(sheet);
}

/* Metrics render */
function renderMetricsSection(){
  const wrap=document.getElementById('metricsSection'); wrap.innerHTML='';
  const TAH=66.546, QIY=71.254;
  wrap.appendChild( buildMetricCard('التحصيلي', TAH, ()=>metricModal.open('التحصيلي','tahsili_image.png')) );
  wrap.appendChild( buildMiddleLeadership(TAH, QIY) );
  wrap.appendChild( buildMetricCard('القدرات', QIY, ()=>metricModal.open('القدرات','qiyas_image.png')) );
}
</script>

<script>
/* Evidence store (fallback) */
let eviStore = {}; // { rowId: [ {id?, text, term, week, date, link, fileName} ] }

/* ===== Password mini-modal controller ===== */
const PASSWORD_REQUIRED = '1447';
const pwdModal = {
  el: null, input: null, ok: null, cancel: null, closeBtn: null,
  _resolver: null,
  open(){
    this.input.value='';
    this.el.style.display='flex';
    this.el.setAttribute('aria-hidden','false');
    this.input.focus();
    return new Promise((resolve)=>{ this._resolver=resolve; });
  },
  close(){
    this.el.style.display='none';
    this.el.setAttribute('aria-hidden','true');
    this._resolver && this._resolver(false);
    this._resolver=null;
  },
  confirm(){
    const ok = (this.input.value.trim() === PASSWORD_REQUIRED);
    if(!ok){ alert('كلمة المرور غير صحيحة'); return; }
    this.el.style.display='none';
    this.el.setAttribute('aria-hidden','true');
    this._resolver && this._resolver(true);
    this._resolver=null;
  },
};

/* Supabase helpers */
async function supaFetchRow(rowId){
  if(!supa) return (eviStore[rowId]||[]);
  const { data, error } = await supa.from('evidence').select('*').eq('row_id', rowId).order('created_at',{ascending:true});
  if(error){ console.warn(error); return (eviStore[rowId]||[]); }
  return data.map(d=>({ id:d.id, text:d.text, term:d.term, week:d.week, date:d.date, link:d.link, fileName:d.file_name }));
}

/* رفع ملف (إن وُجد) إلى تخزين Supabase وإرجاع رابط عام */
async function uploadEvidenceFile(rowId, file){
  try{
    if(!file) return null;
    const path = `${rowId}/${Date.now()}_${file.name}`;
    const up = await supa.storage.from('evidence').upload(path, file, { upsert: false });
    if(up.error){ console.warn(up.error); alert('تعذر رفع الملف: '+up.error.message); return null; }
    const pub = supa.storage.from('evidence').getPublicUrl(path);
    return pub?.data?.publicUrl || null;
  }catch(e){ console.warn(e); return null; }
}

async function supaInsert(rowId,item){
  if(!supa){ if(!eviStore[rowId]) eviStore[rowId]=[]; eviStore[rowId].push(item); return true; }
  const { error } = await supa.from('evidence').insert({
    row_id:rowId, text:item.text, term:item.term, week:item.week,
    date:item.date, link:item.link, file_name:item.fileName
  });
  if(error){ alert('تعذّر حفظ الشاهد في القاعدة: '+error.message); return false; }
  return true;
}

async function supaDeleteLast(rowId){
  if(!supa){
    if((eviStore[rowId]||[]).length) eviStore[rowId].pop();
    return true;
  }
  const { data, error } = await supa.from('evidence')
    .select('id')
    .eq('row_id',rowId)
    .order('created_at',{ascending:false})
    .limit(1);
  if(error){ alert('تعذّر الحذف: '+error.message); return false; }
  if(!data.length) return true;
  const { error:delErr } = await supa.from('evidence').delete().eq('id', data[0].id);
  if(delErr){ alert('تعذّر الحذف: '+delErr.message); return false; }
  return true;
}

let currentFieldKey=null;
const eviModalEl = { modal:null, text:null, term:null, week:null, hijri:null, file:null, link:null, owner:null, save:null, cancel:null, rowId:null };

function eviIconsHTML(){
  return `
    <div class="eviActions">
      <span class="eviIcon add" title="إضافة شاهد" aria-label="إضافة شاهد">＋</span>
      <span class="eviIcon delete" title="حذف آخر شاهد" aria-label="حذف آخر شاهد">🗑️</span>
    </div>`;
}

/* فتح اللوحة الكاملة للمجال */
async function openFieldFullScreen(key){
  currentFieldKey=key;
  const panel=document.getElementById('fullPanel');
  const title=document.getElementById('fpTitle');
  const body=document.getElementById('fpBody');
  const f=fields[key]; title.textContent='التحليل التفصيلي – '+f.name;

  const subsHtml=f.subs.map(s=>{
    const lb=perfLevel(s.v);
    return `<div class="subCard" style="border-color:${lb.color}30">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <strong>${s.name}</strong>
        <span class="chip" style="font-size:12px;color:${lb.color}">${fmt(s.v)}% • ${lb.name}</span>
      </div>
    </div>`;
  }).join('');

  const rows=(detailed[key]||[]).map((r,idx)=>{
    const rowId = `${key}-${idx}`;
    const lb=perfLevel(r.perf);
    return `<tr class="${levelRowClass(r.level)}" data-row="${rowId}">
      <td class="col-lvl">
        <div style="display:flex;align-items:center;gap:10px">
          <div class="miniGauge" data-p="${r.perf}" data-color="${lb.color}"></div>
          <div style="line-height:1.1">
            <span style="font-weight:800;color:${lb.color}">${r.level}</span><br/>
            <span style="font-size:12px;color:#6f8e94">${fmt(r.perf)}% • ${r.code}</span>
          </div>
        </div>
      </td>
      <td class="col-crit"><strong>${r.indicator}</strong></td>
      <td class="col-imp">${r.improve}</td>
      <td class="col-evi">
        <div class="eviBar" id="eviBar-${rowId}">—</div>
        ${eviIconsHTML()}
      </td>
    </tr>`;
  }).join('');

  body.innerHTML=`<div class="subgrid">${subsHtml}</div>
  <div class="tableWrap"><table>
    <thead><tr>
      <th class="col-lvl">المستوى/الأداء</th>
      <th class="col-crit">المعيار/المؤشر</th>
      <th class="col-imp">مقترحات التحسين</th>
      <th class="col-evi">الشواهد</th>
    </tr></thead>
    <tbody>${rows}</tbody></table></div>`;

  // mini gauges
  document.querySelectorAll('.miniGauge').forEach(el=>{
    const p=parseFloat(el.dataset.p)||0, color=el.dataset.color||'#0b7e88';
    const r=14, c=2*Math.PI*r;
    el.innerHTML=`
      <svg viewBox="0 0 40 40">
        <circle cx="20" cy="20" r="${r}" stroke="#e6efef" stroke-width="6" fill="none"></circle>
        <circle class="fg" cx="20" cy="20" r="${r}" stroke="${color}" stroke-width="6" fill="none" stroke-linecap="round" style="transform:rotate(-90deg);transform-origin:50% 50%;stroke-dasharray:${c};stroke-dashoffset:${c}"></circle>
        <text x="20" y="20" style="font-size:9px;fill:#345;font-weight:700;dominant-baseline:middle;text-anchor:middle">${Math.round(p)}</text>
      </svg>`;
    requestAnimationFrame(()=>{el.querySelector('.fg').style.transition='.9s ease';el.querySelector('.fg').style.strokeDashoffset=c*(1 - (p/100));});
  });

  // تحميل الشواهد من القاعدة ثم تحديث العرض
  await Promise.all((detailed[key]||[]).map(async (_r,idx)=>{
    const rowId=`${key}-${idx}`;
    const items = await supaFetchRow(rowId);
    eviStore[rowId]=items||[];
    refreshRowEvidence(rowId);
  }));

  // روابط الأيقونات + حماية كلمة المرور
  body.querySelectorAll('tr[data-row]').forEach(tr=>{
    const rowId=tr.getAttribute('data-row');

    // إضافة شاهد (مع كلمة مرور)
    tr.querySelector('.eviIcon.add').addEventListener('click', async ()=>{
      const ok=await pwdModal.open();
      if(!ok) return;
      openEvidenceModal(rowId);
    });

    // حذف آخر شاهد (مع كلمة مرور)
    tr.querySelector('.eviIcon.delete').addEventListener('click', async ()=>{
      const ok=await pwdModal.open();
      if(!ok) return;
      const done = await supaDeleteLast(rowId);
      if(done){
        if(eviStore[rowId]?.length) eviStore[rowId].pop();
        refreshRowEvidence(rowId);
      }
    });
  });

  // أزرار أعلى اللوحة
  document.getElementById('btnFieldReport').onclick=()=>openDocWindow('تقرير المجال',buildFieldReportHTML(key));
  document.getElementById('btnFieldPlan').onclick=()=>openDocWindow('خطة تحسين المجال',buildFieldPlanHTML(key));
  document.getElementById('fpClose').onclick=(e)=>{e.preventDefault(); panel.style.display='none';};
  document.getElementById('fpHome').onclick=(e)=>{e.preventDefault(); panel.style.display='none';window.scrollTo({top:0,behavior:'smooth'})};

  panel.style.display='flex';
}

/* جعل الأرقام روابط (وإظهار العنوان عند المرور) */
function refreshRowEvidence(rowId){
  const bar = document.getElementById(`eviBar-${rowId}`);
  if(!bar) return;
  const items = eviStore[rowId] || [];
  bar.innerHTML = items.length
    ? items.map((ev, i) => {
        const title = (ev.text || '').replace(/"/g, '&quot;');
        const num = i + 1;
        if(ev.link && /^https?:\/\//i.test(ev.link)){
          return `<a class="eviDot" href="${ev.link}" target="_blank" rel="noopener" title="${title}">${num}</a>`;
        }
        return `<span class="eviDot" title="${title}">${num}</span>`;
      }).join('')
    : '—';
}

/* Evidence modal */
function openEvidenceModal(rowId){
  eviModalEl.rowId=rowId;
  eviModalEl.modal.style.display='flex'; eviModalEl.modal.setAttribute('aria-hidden','false');
  eviModalEl.owner.value = 'مجال: ' + (currentFieldKey||'');
}
function closeEvidenceModal(){
  eviModalEl.modal.style.display='none';
  eviModalEl.modal.setAttribute('aria-hidden','true');
  eviModalEl.rowId=null;
}
async function saveEvidence(){
  const id=eviModalEl.rowId; if(!id) return;
  const file = eviModalEl.file.files[0] || null;
  let filePublicUrl = null;
  if(file){ filePublicUrl = await uploadEvidenceFile(id, file); }

  const manualLink = eviModalEl.link.value.trim();
  const finalLink = manualLink || filePublicUrl || '';

  const item={
    text:eviModalEl.text.value.trim(),
    term:eviModalEl.term.value,
    week:eviModalEl.week.value,
    date:eviModalEl.hijri.value.trim(),
    link:finalLink,
    fileName:file?.name || ''
  };

  const ok = await supaInsert(id,item);
  if(ok){
    if(!eviStore[id]) eviStore[id]=[];
    eviStore[id].push(item);
    refreshRowEvidence(id);
  }

  closeEvidenceModal();
  eviModalEl.text.value=''; eviModalEl.hijri.value=''; eviModalEl.link.value=''; eviModalEl.file.value='';
}
</script>

<script>
/* Header (WHITE) for print pages */
function buildPrintHeaderHTML(titleText){
  return `
    <div style="width:100%;padding:10px 0 6px;display:flex;justify-content:center;align-items:center;background:#fff;border-bottom:1px solid #e7eff0">
      <div style="height:90px;width:95%;background:url('lolo.png') center/contain no-repeat"></div>
    </div>
    <h2 style="text-align:center;color:#0b7e88;margin:10px 0 10px;font-size:24px">${titleText}</h2>
  `;
}

/* تقرير المجال */
function buildFieldReportHTML(key){
  const f=fields[key];
  const rows=(detailed[key]||[]).map(r=>`
    <tr class="${levelRowClass(r.level)}">
      <td style="width:160px">${r.level}<br/>${fmt(r.perf)}%<br/><small>${r.code}</small></td>
      <td style="width:42%">${r.indicator}</td>
      <td style="width:auto">${r.improve}</td>
    </tr>`).join('');
  return `${buildPrintHeaderHTML('تقرير المجال: '+f.name)}
  <table><thead><tr><th style="width:160px">المستوى/النسبة/الرمز</th><th style="width:42%">المعيار/المؤشر</th><th>مقترحات التحسين</th></tr></thead><tbody>${rows}</tbody></table>`;
}

/* خطة المجال */
function buildFieldPlanHTML(key){
  const f=fields[key];
  const rows=(detailed[key]||[]).map((r,i)=>{
    const duration = i%2? '٦ أسابيع':'فصل دراسي';
    return `<tr>
      <td style="width:120px"><strong>${r.code}</strong></td>
      <td style="width:auto">${r.indicator}</td>
      <td style="width:auto">${r.improve}</td>
      <td style="width:120px">${duration}</td>
    </tr>`;
  }).join('');
  return `${buildPrintHeaderHTML('خطة تحسين المجال: '+f.name)}
  <table><thead><tr><th style="width:120px">رمز المؤشر</th><th>الهدف/المؤشر</th><th>الإجراء التحسيني</th><th style="width:120px">المدة</th></tr></thead><tbody>${rows}</tbody></table>`;
}

/* Print window */
function openDocWindow(title,contentHTML){
  const w=window.open('','_blank'); if(!w){alert('فضلاً اسمح بالنوافذ المنبثقة.');return;}
  const doc=`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"/><title>${title}</title>
  <style>
    *{box-sizing:border-box} html,body{margin:0;font-family:'Tajawal',sans-serif;color:#06353b;background:#fff}
    @page{size:A4;margin:8mm} html,body{-webkit-print-color-adjust:exact; print-color-adjust:exact}
    .wrap{width:205mm;max-width:100%;margin:0 auto;padding:10px}
    table{width:100%;border-collapse:collapse;table-layout:fixed}
    thead th{background:#0f6f79;color:#fff;padding:10px}
    td,th{padding:10px;border:1px solid #e7eff0;text-align:center;vertical-align:middle}
    .row-excellent{background:#e9fff4}.row-verygood{background:#eef5ff}.row-good{background:#fff6ec}.row-medium{background:#ffefef}
    .toolbar{position:sticky;bottom:0;display:flex;justify-content:center;margin:10px 0}
    .print{padding:8px 12px;border:1px solid #0b7e88;border-radius:10px;background:#0b7e88;color:#fff;cursor:pointer}
    @media print{ .toolbar{display:none} }
  </style></head><body>
    <div class="wrap">${contentHTML}
      <div class="toolbar"><button class="print" onclick="window.print()">طباعة</button></div>
    </div></body></html>`;
  w.document.open(); w.document.write(doc); w.document.close();
}

/* Metric image modal controller */
const metricModal = { el:null, img:null, title:null, open:(title,src)=>{
  metricModal.el.style.display='flex'; metricModal.img.src = src; metricModal.title.textContent = title; metricModal.el.setAttribute('aria-hidden','false');
}, close:()=>{ metricModal.el.style.display='none'; metricModal.el.setAttribute('aria-hidden','true'); }};

/* INIT */
window.addEventListener('DOMContentLoaded',()=>{
  // Top links
  document.getElementById('btnExt2025').onclick=(e)=>{e.preventDefault();window.open(SRC_2025,'_blank','noopener');};
  document.getElementById('btnExt2024').onclick=(e)=>{e.preventDefault();window.open(SRC_2024,'_blank','noopener');};
  document.getElementById('btnFullPlan').onclick=(e)=>{e.preventDefault();window.open(PLAN_LINK,'_blank','noopener');};
  document.getElementById('btnOps').onclick   =(e)=>{e.preventDefault();window.open(OPS_LINK,'_blank','noopener');};
  document.getElementById('btnAnalyze').onclick=(e)=>{e.preventDefault(); renderDashboard(); window.scrollTo({top:document.getElementById('dashboard').offsetTop-10,behavior:'smooth'});};

  // Metric modal
  metricModal.el = document.getElementById('metricModal');
  metricModal.img = document.getElementById('metricModalImg');
  metricModal.title = document.getElementById('metricModalTitle');
  document.getElementById('metricModalClose').onclick=()=>metricModal.close();
  metricModal.el.addEventListener('click',(ev)=>{const sheet=metricModal.el.querySelector('.sheet'); if(!sheet.contains(ev.target)) metricModal.close();});

  // Evidence modal refs
  const m=document.getElementById('eviModal');
  eviModalEl.modal=m;
  eviModalEl.text=document.getElementById('eviText');
  eviModalEl.term=document.getElementById('eviTerm');
  eviModalEl.week=document.getElementById('eviWeek');
  eviModalEl.hijri=document.getElementById('eviHijri');
  eviModalEl.file=document.getElementById('eviFile');
  eviModalEl.link=document.getElementById('eviLink');
  eviModalEl.owner=document.getElementById('eviOwner');
  eviModalEl.save=document.getElementById('eviSave');
  eviModalEl.cancel=document.getElementById('eviCancel');

  // Weeks 1..19
  eviModalEl.week.innerHTML='';
  for(let i=1;i<=19;i++){
    const op=document.createElement('option');
    op.value='W'+i; op.textContent='الأسبوع '+i; eviModalEl.week.appendChild(op);
  }
  document.getElementById('eviClose').onclick=closeEvidenceModal;
  eviModalEl.cancel.onclick=closeEvidenceModal;
  eviModalEl.save.onclick=saveEvidence;

  // Password modal refs
  pwdModal.el = document.getElementById('pwdModal');
  pwdModal.input = document.getElementById('pwdInput');
  pwdModal.ok = document.getElementById('pwdOk');
  pwdModal.cancel = document.getElementById('pwdCancel');
  pwdModal.closeBtn = document.getElementById('pwdClose');
  pwdModal.ok.addEventListener('click',()=>pwdModal.confirm());
  pwdModal.cancel.addEventListener('click',()=>pwdModal.close());
  pwdModal.closeBtn.addEventListener('click',()=>pwdModal.close());
  pwdModal.el.addEventListener('click',(ev)=>{
    const sheet=pwdModal.el.querySelector('.sheet');
    if(!sheet.contains(ev.target)) pwdModal.close();
  });

  // رسم أولي
  renderDashboard();
  renderMetricsSection();
});
</script>
</body>
</html>
