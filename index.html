<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>منصة التحليل والتحسين المدرسي – ثانوية اليعقوبي</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<!-- Supabase (اختياري للسحابة) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{
  --moe:#0b7e88; --ink:#06353b; --bg:#f5f8f8; --card:#ffffff;
  --shine1:#e8fbfb; --shine2:#d9f2f3; --muted:#6f8e94;
  --ok:#e9fff4; --ok2:#f2fff9; --vg:#f1fff9; --gd:#fffbe6; --md:#fff0e7;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:'Tajawal',sans-serif}
.page{max-width:1200px;margin:0 auto;padding:10px 14px}
a{color:#135; text-decoration:none} a:hover{text-decoration:underline}

/* HEADER – شعار فقط */
.header{
  width:100%; aspect-ratio:7/1.6;
  background:linear-gradient(135deg,var(--shine1),var(--shine2));
  border-radius:16px; box-shadow:0 10px 28px rgba(0,0,0,.12);
  position:relative; overflow:hidden; margin:12px auto;
}
.header:after{
  content:""; position:absolute; inset:0;
  background:url('logo.png') center/contain no-repeat;
  opacity:1;
}

/* Buttons */
.controls{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;padding:6px}
.btn{background:var(--moe);color:#fff;border:0;border-radius:12px;padding:10px 16px;font-weight:700;cursor:pointer;box-shadow:0 6px 18px rgba(11,126,136,.25)}
.btn.light{background:#eef6f7;color:#06353b}
.btn.ghost{background:#fff;color:var(--moe);border:1px solid #d7ecec}
.btn:hover{filter:brightness(.97)}

/* Grid cards */
.grid{display:grid;grid-template-columns:repeat(4,minmax(260px,1fr));gap:16px}
@media (max-width:1150px){.grid{grid-template-columns:repeat(3,minmax(260px,1fr))}}
@media (max-width:900px){.grid{grid-template-columns:repeat(2,minmax(260px,1fr))}}
@media (max-width:620px){.grid{grid-template-columns:1fr}}

.card{
  background:linear-gradient(180deg,#ffffff 0%, #f9feff 100%);
  border-radius:16px; padding:14px; position:relative;
  box-shadow:0 10px 24px rgba(0,0,0,.08), inset 0 0 0 1px #e6efef;
}
.card h2{margin:0 0 6px;color:var(--moe);font-size:20px}
.kpi{display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:13px}
.progress{height:10px;background:#e6efef;border-radius:999px;overflow:hidden;margin:8px 0}
.bar{height:100%;background:#2aa897}
.badge{padding:2px 8px;border-radius:999px;background:#eaf6f6;color:#246;font-size:12px}

/* Center buttons under donut */
.centerBar{display:flex;gap:8px;justify-content:center;align-items:center;margin:8px 0}

/* Detail section */
.detail{display:none;margin-top:10px;border-top:1px dashed #e1ecec;padding-top:10px}
.detail.full{position:relative;display:block}
.subgrid{display:grid;grid-template-columns:repeat(2,minmax(160px,1fr));gap:8px}
.subCard{background:#f7fbfb;border:1px solid #e6efef;border-radius:12px;padding:10px}
.small{font-size:12px;color:#567}

/* Tables */
.tableWrap{margin-top:10px}
table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden}
thead th{background:#0f6f79;color:#fff;padding:10px;font-weight:700}
tbody td{padding:10px;border-bottom:1px solid #eef3f3;vertical-align:top}
tbody tr:last-child td{border-bottom:0}

/* Row coloring by level */
.row-excellent{background:var(--ok)}
.row-high{background:var(--ok2)}
.row-verygood{background:var(--vg)}
.row-good{background:var(--gd)}
.row-medium{background:var(--md)}
.level{font-weight:700}

/* Evidence modal */
.modal{position:fixed;inset:0;background:rgba(2,52,59,.6);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:9999}
.sheet{width:min(920px,96vw);max-height:92vh;overflow:auto;background:#fff;border-radius:16px;box-shadow:0 12px 40px rgba(0,0,0,.35);padding:16px}
.sheet h4{margin:0 0 8px}
.row{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.row label{font-size:12px;color:#345}
input[type=text],input[type=file],select{border:1px solid #d7e7e7;border-radius:8px;padding:8px;width:100%}
.sheet .close{position:sticky;top:0;margin-bottom:8px;background:#e8eff0;border:0;color:#034;padding:6px 10px;border-radius:8px;cursor:pointer;font-weight:700}

/* Print A4 window */
@media print{ .no-print{display:none !important} }

.footer{padding:18px 10px;text-align:center;color:#7a9aa0}
</style>
</head>
<body>
<div class="page">

  <!-- Header -->
  <div class="header" aria-label="وزارة التعليم – شعار"></div>

  <!-- Top controls -->
  <div class="controls">
    <button class="btn" id="btnAnalyze">تحليل شامل 🔎</button>
    <button class="btn" id="btnFullReport">التقرير الشامل PDF 📘</button>
    <button class="btn" id="btnFullPlan">الخطة الشاملة PDF 🗂️</button>
  </div>

  <!-- Domains grid -->
  <div id="dashboard" class="grid"></div>

  <div class="footer">© 1447 هـ – ثانوية اليعقوبي – منصة التحليل والتحسين المدرسي</div>
</div>

<!-- Evidence Modal -->
<div class="modal" id="eviModal" aria-hidden="true">
  <div class="sheet">
    <button class="close" id="eviClose">✕ إغلاق</button>
    <h4>إضافة شاهد</h4>
    <div class="row" style="margin-bottom:8px">
      <div><label>اسم/وصف الشاهد</label><input id="eviText" type="text" placeholder="مثال: تقرير زيارة مشرف .."/></div>
      <div><label>الفصل الدراسي</label>
        <select id="eviTerm"><option value="t1">الأول</option><option value="t2">الثاني</option></select>
      </div>
      <div><label>الأسبوع (هجري)</label><select id="eviWeek"></select></div>
      <div><label>التاريخ (هجري أم القرى)</label><input id="eviHijri" type="text" placeholder="1447/03/01"/></div>
    </div>
    <div class="row">
      <div><label>رفع ملف (PDF/صورة)</label><input id="eviFile" type="file" accept="application/pdf,image/*"/></div>
      <div style="grid-column:span 3"><label>يتبع</label><input id="eviOwner" type="text" disabled/></div>
    </div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn" id="eviSave">حفظ الشاهد</button>
      <button class="btn light" id="eviCancel">إلغاء</button>
    </div>
    <div class="small" style="margin-top:6px">* الشواهد تُسحب تلقائياً للتقارير وخطط التحسين. يمكن فتح الملف في نافذة منبثقة للطباعة.</div>
  </div>
</div>

<script>
/* ====== إعداد Supabase (املأ القيم لتفعيل السحابة) ====== */
const SB_URL  = ""; // مثال: "https://YOUR-PROJECT.supabase.co"
const SB_ANON = ""; // مثال: "YOUR-ANON-KEY"
const sb = (SB_URL && SB_ANON && window.supabase) ? window.supabase.createClient(SB_URL, SB_ANON) : null;

/* ====== محوّل بيانات موحّد (سحابي/محلي) ====== */
const Data = (() => {
  const USE_SUPABASE = !!sb;            // يتفعّل تلقائيًا إن وُضعت المفاتيح
  const STORE='yaqoubi_evidence_1447';  // للتخزين المحلي
  const L = {
    async list(field_key,row_index){
      const mem = JSON.parse(localStorage.getItem(STORE)||'{}');
      return mem[`${field_key}::${row_index}`] || [];
    },
    async add(field_key,row_index,payload){
      const mem = JSON.parse(localStorage.getItem(STORE)||'{}');
      const k=`${field_key}::${row_index}`;
      mem[k]=mem[k]||[];
      // عند المحلي، إن كان ملفًا نعمل URL مؤقت
      const url = payload.file ? URL.createObjectURL(payload.file) : (payload.url||'');
      mem[k].push({text:payload.text,term:payload.term,week:payload.week,hijri:payload.hijri,url,ts:Date.now()});
      localStorage.setItem(STORE, JSON.stringify(mem));
      return true;
    }
  };
  const S = {
    async list(field_key,row_index){
      const { data, error } = await sb.from('evidences')
        .select('*')
        .eq('school_id','yaqoubi')
        .eq('field_key', field_key)
        .eq('row_index', row_index)
        .order('created_at', { ascending: true });
      if (error) throw error;
      return (data||[]).map(r=>({ text:r.text, term:r.term, week:r.week_hijri, hijri:r.date_hijri, url:r.file_url, file_type:r.file_type, ts: new Date(r.created_at).getTime() }));
    },
    async add(field_key,row_index,payload){
      let file_url='', file_type='';
      if(payload.file){
        const ext = payload.file.name.split('.').pop();
        const path = `yaqoubi/${crypto.randomUUID()}.${ext}`;
        const up = await sb.storage.from('evidence').upload(path, payload.file, { upsert:false });
        if (up.error) throw up.error;
        const pub = sb.storage.from('evidence').getPublicUrl(path);
        file_url = pub.data.publicUrl; file_type = payload.file.type || '';
      }
      const ins = await sb.from('evidences').insert([{
        school_id:'yaqoubi', field_key, row_index,
        text: payload.text||null, term: payload.term||null,
        week_hijri: payload.week||null, date_hijri: payload.hijri||null,
        file_url, file_type
      }]);
      if (ins.error) throw ins.error;
      return true;
    }
  };
  return {
    listEvidences: (f,i)=> (USE_SUPABASE? S.list(f,i): L.list(f,i)),
    addEvidence : (f,i,p)=> (USE_SUPABASE? S.add(f,i,p):  L.add(f,i,p)),
  };
})();

/* ====== أسابيع الفصلين (حسب ما زودتني) ====== */
const TERM1 = [
  {id:'1447/03/01', name:'الأسبوع 1 – 01/03/1447 إلى 05/03/1447 – بداية العام الدراسي'},
  {id:'1447/03/08', name:'الأسبوع 2 – 08/03/1447 إلى 12/03/1447'},
  {id:'1447/03/15', name:'الأسبوع 3 – 15/03/1447 إلى 19/03/1447'},
  {id:'1447/03/22', name:'الأسبوع 4 – 22/03/1447 إلى 26/03/1447'},
  {id:'1447/03/29', name:'الأسبوع 5 – 29/03/1447 إلى 03/04/1447'},
  {id:'1447/04/06', name:'الأسبوع 6 – 06/04/1447 إلى 10/04/1447'},
  {id:'1447/04/13', name:'الأسبوع 7 – 13/04/1447 إلى 17/04/1447'},
  {id:'1447/04/20', name:'الأسبوع 8 – 20/04/1447 إلى 24/04/1447'},
  {id:'1447/04/27', name:'الأسبوع 9 – 27/04/1447 إلى 01/05/1447'},
  {id:'1447/05/04', name:'الأسبوع 10 – 04/05/1447 إلى 08/05/1447'},
  {id:'1447/05/11', name:'الأسبوع 11 – 11/05/1447 إلى 15/05/1447'},
  {id:'1447/05/18', name:'الأسبوع 12 – 18/05/1447 إلى 22/05/1447'},
  {id:'1447/05/25', name:'الأسبوع 13 – 25/05/1447 إلى 29/05/1447'},
  {id:'1447/06/09', name:'بعد إجازة الخريف – 09/06/1447 إلى 13/06/1447'},
  {id:'1447/06/16', name:'الأسبوع 15 – 16/06/1447 إلى 20/06/1447'},
  {id:'1447/06/23', name:'الأسبوع 16 – 23/06/1447 إلى 27/06/1447'},
  {id:'1447/06/30', name:'الأسبوع 17 – 30/06/1447 إلى 04/07/1447'},
  {id:'1447/07/07', name:'الأسبوع 18 – 07/07/1447 إلى 11/07/1447'},
  {id:'1447/07/14', name:'الأسبوع 19 – 14/07/1447 إلى 18/07/1447 – ختام الفصل الأول'}
];
const TERM2 = [
  {id:'1447/07/29', name:'الأسبوع 1 – 29/07/1447 إلى 03/08/1447 – بداية الفصل الثاني'},
  {id:'1447/08/06', name:'الأسبوع 2 – 06/08/1447 إلى 10/08/1447'},
  {id:'1447/08/13', name:'الأسبوع 3 – 13/08/1447 إلى 17/08/1447'},
  {id:'1447/08/20', name:'الأسبوع 4 – 20/08/1447 إلى 24/08/1447'},
  {id:'1447/08/27', name:'الأسبوع 5 – 27/08/1447 إلى 02/09/1447'},
  {id:'1447/09/05', name:'الأسبوع 6 – 05/09/1447 إلى 09/09/1447'},
  {id:'1447/09/12', name:'الأسبوع 7 – 12/09/1447 إلى 15/09/1447 – آخر أسبوع قبل الإجازة'},
  {id:'1447/10/10', name:'الأسبوع 8 – 10/10/1447 إلى 14/10/1447 – بعد العيد'},
  {id:'1447/10/17', name:'الأسبوع 9 – 17/10/1447 إلى 21/10/1447'},
  {id:'1447/10/24', name:'الأسبوع 10 – 24/10/1447 إلى 28/10/1447'},
  {id:'1447/11/01', name:'الأسبوع 11 – 01/11/1447 إلى 05/11/1447'},
  {id:'1447/11/08', name:'الأسبوع 12 – 08/11/1447 إلى 12/11/1447'},
  {id:'1447/11/15', name:'الأسبوع 13 – 15/11/1447 إلى 19/11/1447'},
  {id:'1447/11/22', name:'الأسبوع 14 – 22/11/1447 إلى 26/11/1447'},
  {id:'1447/11/29', name:'الأسبوع 15 – 29/11/1447 إلى 03/12/1447'},
  {id:'1447/12/15', name:'الأسبوع 16 – 15/12/1447 إلى 19/12/1447 – بعد الأضحى'},
  {id:'1447/12/22', name:'الأسبوع 17 – 22/12/1447 إلى 26/12/1447'},
  {id:'1447/12/29', name:'الأسبوع 18 – 29/12/1447 إلى 03/01/1448'},
  {id:'1448/01/06', name:'الأسبوع 19 – 06/01/1448 إلى 10/01/1448 – ختام أسابيع الفصل'}
];

/* تعبئة قائمة الأسابيع حسب الفصل */
const eviWeekSel=document.getElementById('eviWeek');
const eviTermSel=document.getElementById('eviTerm');
function fillWeeks(){
  const list = (eviTermSel.value==='t1')? TERM1 : TERM2;
  eviWeekSel.innerHTML='';
  list.forEach(w=>{const o=document.createElement('option');o.value=w.id;o.textContent=w.name;eviWeekSel.appendChild(o);});
}
eviTermSel.addEventListener('change', fillWeeks);
fillWeeks();

/* ====== أدوات مساعدة ====== */
const fmt=v=>Number(v).toFixed(2);
function levelBadge(v){ if(v>=90)return {txt:'ممتاز',color:'#10b981'}; if(v>=85)return {txt:'مرتفع',color:'#22b8a0'}; if(v>=80)return {txt:'جيد جدًا',color:'#33c2a9'}; if(v>=75)return {txt:'جيد',color:'#f59e0b'}; return {txt:'متوسط',color:'#f97316'}; }
function mapLevelClass(arLevel){
  if(arLevel==='متميز'||arLevel==='مرتفع') return 'row-excellent';
  if(arLevel==='جيد جدًا') return 'row-verygood';
  if(arLevel==='جيد') return 'row-good';
  return 'row-medium';
}
function todayHijri(){
  try{
    const fmtHijri=new Intl.DateTimeFormat('ar-SA-u-ca-islamic',{year:'numeric',month:'2-digit',day:'2-digit',weekday:'long'});
    return fmtHijri.format(new Date());
  }catch(e){ return '1447/.. /..'; }
}

/* ====== بيانات عليا للمجالات ====== */
const fields={
  management:{ name:'الإدارة المدرسية', v2024:75.50, v2025:75.50, subs:[
    {id:'plans', name:'التخطيط', v:54.00},
    {id:'lead', name:'قيادة العملية التعليمية', v:72.75},
    {id:'soc', name:'المجتمع المدرسي', v:57.25},
    {id:'dev', name:'التطوير المؤسسي', v:60.25}
  ]},
  teaching:{ name:'التعليم والتعلّم', v2024:80.75, v2025:81.50, subs:[
    {id:'assess', name:'تقويم التعلّم', v:82.75},
    {id:'exp', name:'بناء خبرات التعلّم', v:76.75}
  ]},
  learning:{ name:'نواتج التعلّم', v2024:78.50, v2025:78.50, subs:[
    {id:'ach', name:'التحصيل التعليمي', v:80.25},
    {id:'socdev', name:'التطور الشخصي والصحي والاجتماعي', v:86.25}
  ]},
  environment:{ name:'البيئة المدرسية', v2024:64.00, v2025:62.25, subs:[
    {id:'safety', name:'الأمن والسلامة', v:79.00},
    {id:'building', name:'المبنى المدرسي', v:71.50}
  ]}
};

/* ====== الجداول التفصيلية (نفس ما اعتمدناه سابقًا) ====== */
const detailed={ /* نفس المحتوى الطويل كما في نسختك السابقة */ 
  management:[
    {level:'متميز', perf:94.50, indicator:'تنشر المدرسة قواعد السلوك والمواظبة وتتابع تطبيقها بانتظام.', improve:'نشر القواعد رقميًا وربطها بمتابعة أسبوعية للانضباط.', evidence:'لوحات السلوك، تقارير الانضباط، سجلات إشعارات.'},
    {level:'مرتفع', perf:90.25, indicator:'تهيئة وصيانة مرافق المبنى وتجهيزاته.', improve:'نظام صيانة رقمي وتوثيق بالصور والتقارير.', evidence:'أوامر عمل، صور قبل/بعد، محاضر إنجاز.'},
    {level:'مرتفع', perf:89.25, indicator:'مناخ آمن ومحفّز للتعلّم والنمو.', improve:'برامج دعم نفسي وقياس رضا المستفيدين دوريًا.', evidence:'استبانات رضا، سجلات إرشاد، خطط وقائية.'},
    {level:'جيد جدًا', perf:87.00, indicator:'متابعة أداء العاملين ودعم التطوير المهني.', improve:'خطط تطوير فردية مبنية على تقويم سنوي.', evidence:'نماذج تقويم، خطط تحسين، محاضر تغذية راجعة.'},
    {level:'جيد جدًا', perf:85.25, indicator:'متابعة تنفيذ الخطة التشغيلية وتطويرها.', improve:'لوحة مؤشرات أسبوعية وربط المهام بالمخرجات.', evidence:'لوحة أداء، تقارير تقدم، محاضر فرق العمل.'},
    {level:'جيد جدًا', perf:83.75, indicator:'تواصل فعّال مع أولياء الأمور والمجتمع.', improve:'قنوات تواصل موحّدة وجدولة لقاءات دورية.', evidence:'منصة تواصل، محاضر لقاءات، تقارير تفاعل.'},
    {level:'جيد جدًا', perf:82.00, indicator:'تشجيع الحصول على الرخصة المهنية.', improve:'برنامج تحفيزي وجدولة دخول الاختبارات.', evidence:'قوائم تسجيل، شهادات حضور، نتائج الرخصة.'},
    {level:'جيد', perf:80.00, indicator:'تعزيز ثقافة العمل الجماعي.', improve:'فرق تميّز بمهمات واضحة ومتابعة إنجاز.', evidence:'تشكيل الفرق، خطط فرق، تقارير مختصرة.'},
    {level:'جيد', perf:78.00, indicator:'توثيق القيم والهوية الوطنية.', improve:'ملف رقمي للهوية مرتبط بالأنشطة.', evidence:'صور فعاليات، ملفات إنجاز، نماذج توثيق.'},
    {level:'جيد', perf:76.50, indicator:'تفعيل قنوات التواصل الداخلي.', improve:'تنظيم المراسلات والاجتماعات إلكترونيًا.', evidence:'سجلات تعميمات، محاضر، لوائح إجراءات.'},
    {level:'متوسط', perf:75.50, indicator:'تفعيل الشراكات المجتمعية.', improve:'ثلاث شراكات نوعية مرتبطة بالتعلّم.', evidence:'مذكرات تفاهم، تقارير فعاليات، شهادات شراكة.'},
    {level:'متوسط', perf:72.00, indicator:'تطوير أنظمة المتابعة الإلكترونية.', improve:'لوحة مؤشرات ذكية وتحليلات شهرية.', evidence:'تقارير تحليلية، لوحات قياس، أرشيف رقمي.'},
    {level:'متوسط', perf:70.25, indicator:'توظيف التقنية في الإدارة اليومية.', improve:'رفع استخدام (نور/فارس/مدرستي) وتتبع التقارير.', evidence:'سجلات دخول، تقارير استخدام، مصفوفة التزام.'}
  ],
  teaching:[
    {level:'متميز', perf:99.25, indicator:'تنفّذ المدرسة برامج تدريبية نوعية للمعلمين تُطوّر المهارات الصفّية.', improve:'مواءمة التدريب مع الاحتياجات الفعلية وتتبع أثره داخل الحصص.', evidence:'خطط تدريب، تقارير أثر، استمارات متابعة.'},
    {level:'متميز', perf:97.75, indicator:'تهيئة بيئة تعليمية محفّزة لتنمية التفكير الإبداعي/الناقد.', improve:'تضمين مهارات التفكير العليا في الخطط اليومية والتعلم النشط.', evidence:'خطط دروس، ملاحظات صفية، منتجات طلابية.'},
    {level:'متميز', perf:97.50, indicator:'تنمية مهارات التعلّم الذاتي والبحث لدى المتعلمين.', improve:'مشاريع بحث رقمية وتدريب على مصادر المعلومات والتحليل.', evidence:'بحوث طلابية، توثيق إشرافي، منصات مشاركة.'},
    {level:'مرتفع', perf:96.75, indicator:'تطبيق استراتيجيات تدريس حديثة داعمة لمهارات القرن 21.', improve:'توثيق التطبيق عبر زيارات صفية وتعلّم نظير لنظير.', evidence:'تقارير زيارات، تسجيلات قصيرة، استمارات أداء.'},
    {level:'مرتفع', perf:94.75, indicator:'توفير وسائل تعليمية رقمية متنوعة تدعم التعلّم الفعّال.', improve:'إنتاج محتوى رقمي تفاعلي وتدريب على توظيفه.', evidence:'ملفات دروس رقمية، نماذج توظيف تقنية.'},
    {level:'مرتفع', perf:93.25, indicator:'تنوّع أدوات التقويم لقياس نواتج التعلّم.', improve:'تحليل أسبوعي للنتائج وربطها بخطط علاج/إثراء صفّية.', evidence:'سجلات تحليل، خطط علاجية، أدوات تقويم.'},
    {level:'جيد جدًا', perf:91.75, indicator:'تقديم تغذية راجعة بنّاءة لتحسين أداء الطلاب.', improve:'نموذج موحّد للتغذية الراجعة وأنشطة تصحيحية لاحقة.', evidence:'نماذج تغذية راجعة، سجلات متابعة.'},
    {level:'جيد جدًا', perf:89.50, indicator:'توظيف التقنية بفاعلية في التعليم والتعلّم.', improve:'تفعيل أدوات التفاعل (اختبارات قصيرة/نماذج/منصات) بالحصة.', evidence:'تقارير «مدرستي»، أدلة أنشطة رقمية.'},
    {level:'جيد', perf:88.00, indicator:'إتاحة تعلّم تعاوني ومشاريع جماعية.', improve:'تصميم rubrics للمشاريع وتقويم الأدوار والمخرجات.', evidence:'ملفات مشاريع، محاضر تقويم، صور عروض.'},
    {level:'جيد', perf:86.75, indicator:'تنمية مهارات التفكير الناقد لدى المتعلمين.', improve:'أنشطة تحليل ونقاش منظّم في العلوم واللغة.', evidence:'خطط أنشطة، تقارير أداء، عينات أعمال.'},
    {level:'جيد', perf:84.50, indicator:'برامج إثرائية للمتميزين والموهوبين.', improve:'ورش أسبوعية إثرائية ومتابعة مخرجاتهم النوعية.', evidence:'قوائم مشاركين، منتجات، تقارير موهبة.'},
    {level:'متوسط', perf:82.75, indicator:'بناء الدروس وفق نواتج تعلم واضحة ومعلَنة.', improve:'مراجعة الخطط اليومية وضبط مؤشرات الإتقان.', evidence:'خطط محدثة، ملاحظات إشرافية.'},
    {level:'متوسط', perf:76.75, indicator:'تنويع أساليب التعليم بما يلائم الفروق الفردية.', improve:'أنشطة متعددة الأنماط (بصري/سمعي/حسي) داخل الحصة.', evidence:'خطط معدّلة، تقارير صفية، تحليل نتائج.'}
  ],
  learning:[
    {level:'متميز', perf:96.75, indicator:'يظهر المتعلمون اعتزازًا بالقيم والهوية الوطنية.', improve:'ربط الأنشطة الصفية واللاصفية بالقيم الوطنية عبر منصات المدرسة.', evidence:'منتجات طلابية، صور فعاليات، تقارير الهوية.'},
    {level:'متميز', perf:96.25, indicator:'لدى المتعلمين اتجاهات إيجابية ودافعية مرتفعة للتعلّم.', improve:'برامج تحفيزية منهجية وتيسير الإرشاد الأكاديمي لتعزيز الاستمرار.', evidence:'استبانات رضا، خطط إرشاد، تقارير متابعة.'},
    {level:'متميز', perf:95.50, indicator:'نتائج متميزة في الاختبارات الوطنية/الدولية.', improve:'اختبارات معيارية دورية وخطط علاجية للفاقد التعلمي.', evidence:'نتائج اختبارات، تحليلات، خطط علاج.'},
    {level:'متميز', perf:94.00, indicator:'التزام بقواعد السلوك والانضباط المدرسي.', improve:'متابعة يومية للانضباط وتكريم سلوكي دوري.', evidence:'سجلات الانضباط، محاضر تكريم، تقارير متابعة.'},
    {level:'جيد جدًا', perf:91.75, indicator:'اتجاهات إيجابية نحو الذات والنمو الشخصي.', improve:'برامج مهارية «أنا أستطيع» ومسارات قيادة طلابية.', evidence:'قوائم مشاركة، تقارير برامج، استبانات أثر.'},
    {level:'جيد جدًا', perf:89.25, indicator:'مهارات البحث والتعلّم الذاتي.', improve:'مشاريع بحث رقمية وتدريب على التوثيق العلمي.', evidence:'بحوث طلابية، نماذج تقييم، منصة مشاركة.'},
    {level:'جيد جدًا', perf:86.25, indicator:'مهارات اجتماعية وصحية إيجابية.', improve:'حملات توعوية وممارسات صحية داخل المدرسة.', evidence:'نشرات، صور فعاليات، تقارير نشاط.'},
    {level:'جيد', perf:84.25, indicator:'مشاركة في مبادرات مجتمعية وخدمة عامة.', improve:'شراكات نوعية ومبادرات طلابية موثّقة.', evidence:'مذكرات تعاون، تقارير مبادرات، صور.'},
    {level:'جيد', perf:82.94, indicator:'تقدم في نتائج المواد الدراسية.', improve:'تحليل نتائج المواد وبناء خطط دعم للفصول الأقل أداءً.', evidence:'تقارير تحليل، خطط رفع، متابعة إشرافية.'},
    {level:'جيد', perf:79.04, indicator:'تحقق نواتج تعلم في المواد الأساسية.', improve:'تقويم مستمر وربط نتائجه بخطط تحسين صفية.', evidence:'أدوات تقويم، سجلات تحليل، خطط علاج.'},
    {level:'متوسط', perf:63.25, indicator:'مشاركة ثقافية/قيمية (مسابقات وبرامج مجتمعية).', improve:'تحفيز المشاركة في المسابقات الثقافية وبرامج القيم.', evidence:'صور فعاليات، تقارير أنشطة، نشرات مدرسية.'}
  ],
  environment:[
    {level:'متميز', perf:97.50, indicator:'تعمل المدرسة على تهيئة وصيانة مرافق المبنى وتجهيزاته بانتظام.', improve:'سجل رقمي للصيانة الوقائية وتحديث خطة الصيانة الدورية.', evidence:'تقارير صيانة، صور أعمال، محاضر إنجاز.'},
    {level:'متميز', perf:97.00, indicator:'المحافظة على نظافة المبنى والمرافق بصورة مستمرة.', improve:'تعزيز الإشراف اليومي وتحديد مسؤول متابعة للنظافة.', evidence:'تقارير إشرافية، صور توثيق، عقود متابعة.'},
    {level:'جيد جدًا', perf:94.00, indicator:'توافر معايير الأمن والسلامة وتطبيقها بانتظام.', improve:'تنفيذ فرضيات دورية وتحديث أدوات السلامة وفق اللوائح.', evidence:'سجلات الأمن والسلامة، صور الفرضيات، تقارير متابعة.'},
    {level:'جيد جدًا', perf:79.00, indicator:'توافر وصولات آمنة للعملية التعليمية تُمكّن من حركة ميسّرة.', improve:'تهيئة الممرات والمرافق لدعم ذوي الإعاقة.', evidence:'صور تجهيزات، تقارير إشرافية، محاضر متابعة.'},
    {level:'جيد', perf:73.25, indicator:'البيئة المدرسية متوسطة الجاذبية للمتعلمين.', improve:'تطوير البيئة الصفية بالألوان التعليمية والجلسات التفاعلية.', evidence:'صور الفصول، استبانات رضا، تقارير إشرافية.'},
    {level:'متوسط', perf:64.00, indicator:'وجود منافذ آمنة للطوارئ واستيفاء متطلبات السلامة.', improve:'مراجعة مواقع المخارج وتفعيل لوحات الإرشاد والإضاءة الطارئة.', evidence:'تقارير الدفاع المدني، صور المخارج، محاضر تحديث.'},
    {level:'متوسط', perf:62.50, indicator:'كفاية الإضاءة والتهوية بما يحقق بيئة تعليمية صحية.', improve:'تحسين الإضاءة وصيانة أجهزة التهوية شهريًا.', evidence:'تقارير فنية، صور صيانة، تقارير متابعة.'}
  ]
};

/* ====== فتح تبويب A4 بهيدر صورة logo ممتدة (عرض أكبر قليلًا) ====== */
function openDocWindow(title, contentHTML){
  const w=window.open('', '_blank'); if(!w){alert('فضلاً اسمح بالنوافذ المنبثقة.');return;}
  const doc=`
  <!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"/>
  <title>${title}</title>
  <style>
    @page { size: A4; margin: 8mm; }
    body{font-family:'Tajawal',sans-serif;margin:0;background:#fff;color:#06353b}
    /* جعل العرض أوسع قليلًا مع بقاء الطباعة ضمن A4 */
    .a4{width: 220mm; max-width: 100vw; margin: 0 auto; background:#fff;}
    .header{width:100%; height:110px; background:#f2fbfb; position:relative; overflow:hidden}
    .header img{width:100%; height:100%; object-fit:cover; display:block}
    .pad{padding:12px 14px}
    h2{margin:6px 0;color:#0b7e88; font-size:18px}
    h3{color:#0b7e88; font-size:16px}
    p,li,td,th{font-size:13px; line-height:1.6}
    table{width:100%;border-collapse:collapse;margin-top:8px; table-layout:fixed; word-wrap:break-word}
    thead th{background:#0f6f79;color:#fff;padding:8px}
    td,th{padding:8px;border:1px solid #e7eff0;vertical-align:top}
    .row-excellent{background:#e9fff4}.row-verygood{background:#f1fff9}.row-good{background:#fffbe6}.row-medium{background:#fff0e7}
    .toolbar{position:sticky;top:0;background:#fff;padding:8px 16px;margin:0;border-bottom:1px dashed #e1ecec;display:flex;gap:8px;justify-content:flex-start}
    .btn{padding:8px 12px;border:1px solid #0b7e88;border-radius:8px;background:#0b7e88;color:#fff;cursor:pointer}
    .meta{display:flex;justify-content:space-between;align-items:center;margin:6px 0 0 0;font-weight:700}
    @media print{
      .toolbar{display:none}
      .a4{width:210mm}
    }
  </style></head><body>
  <div class="toolbar no-print">
    <button class="btn" onclick="window.print()">طباعة/حفظ PDF</button>
    <button class="btn" onclick="window.close()">إغلاق</button>
  </div>
  <div class="a4">
    <div class="header"><img src="logo.png" alt="Header"></div>
    <div class="pad">
      <div class="meta">
        <div style="text-align:right">${todayHijri()}</div>
        <div></div>
      </div>
      ${contentHTML}
    </div>
  </div>
  </body></html>`;
  w.document.open(); w.document.write(doc); w.document.close();
}

/* ====== عارض الشاهد ====== */
function openEvidenceViewer(url,title='شاهد'){
  const html = `<h2 style="margin:6px 0;color:#0b7e88;font-size:18px">${title}</h2>` + (url?.toLowerCase().endsWith('.pdf')?`<embed src="${url}" type="application/pdf" style="width:100%;height:80vh"/>`:`<img src="${url}" style="max-width:100%;height:auto"/>`);
  openDocWindow('شاهد', html);
}

/* ====== لوحة المجالات ====== */
function renderDashboard(){
  const dash=document.getElementById('dashboard'); dash.innerHTML='';
  Object.entries(fields).forEach(([key,f])=>{
    const lvl=levelBadge(f.v2025);
    const card=document.createElement('div'); card.className='card'; card.id=`card-${key}`;
    card.innerHTML=`
      <h2>${f.name}</h2>
      <div class="kpi"><span>2024: ${fmt(f.v2024)}% → 2025: ${fmt(f.v2025)}%</span>
        <span class="badge" style="background:${lvl.color}22;color:${lvl.color}">${lvl.txt}</span></div>
      <div class="progress"><div class="bar" style="width:${Math.max(2,f.v2025)}%"></div></div>

      <div style="display:flex;justify-content:center">
        <canvas id="donut-${key}" height="130" style="cursor:pointer" title="عرض تفاصيل المجال"></canvas>
      </div>
      <div class="centerBar">
        <button class="btn ghost" onclick="openFieldReport('${key}')">تقرير المجال PDF</button>
        <button class="btn ghost" onclick="openFieldPlan('${key}')">خطة تحسين المجال PDF</button>
      </div>

      <div class="detail" id="detail-${key}"></div>
    `;
    dash.appendChild(card);

    // الدونت (اضغط داخل الدائرة لفتح التفاصيل بملء الصفحة)
    const donut = new Chart(document.getElementById(`donut-${key}`).getContext('2d'),{
      type:'doughnut',
      data:{labels:f.subs.map(s=>s.name),datasets:[{data:f.subs.map(s=>s.v),backgroundColor:['#2aa897','#5d9ed6','#f1ad5b','#7ac6b7','#91a7ff','#a5d8a6']}]},
      options:{plugins:{legend:{display:false}},cutout:'70%'}
    });
    document.getElementById(`donut-${key}`).addEventListener('click',()=>toggleDetail(key,true));

    // النقر خارج الدائرة (العنوان/المحتوى) يفتح/يغلق أيضًا ولكن بدون ملء
    card.addEventListener('click', (e)=>{
      if(e.target.tagName==='CANVAS' || e.target.closest('button')) return;
      toggleDetail(key,false);
    });
  });
}

/* ====== تفاصيل المجال (ملء الصفحة عند fromCanvas=true) ====== */
async function toggleDetail(key, fromCanvas=false){
  const dash=document.getElementById('dashboard');
  const box=document.getElementById(`detail-${key}`);
  const isOpen=box.style.display==='block';

  if(isOpen){ // إغلاق
    box.classList.remove('full');
    box.style.display='none';
    Array.from(dash.children).forEach(c=>c.style.display='');
    window.scrollTo({top:0,behavior:'smooth'});
    return;
  }

  // إخفاء بقية البطاقات
  Array.from(dash.children).forEach(c=>{ if(c.id!==`card-${key}`) c.style.display='none'; });
  // إعداد المحتوى
  const f=fields[key];
  const subsHtml=f.subs.map(s=>`
    <div class="subCard">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>${s.name}</strong>
        <span class="badge" style="background:${levelBadge(s.v).color}22;color:${levelBadge(s.v).color}">${fmt(s.v)}%</span>
      </div>
      <div class="small">مستوى المؤشر الفرعي لهذا المجال</div>
    </div>`).join('');

  const det = detailed[key]||[];
  let rowsHTML='';
  for(let i=0;i<det.length;i++){
    const r=det[i];
    const evis = await Data.listEvidences(key,i);
    const evisHTML = evis.map((e,idx)=>`<div class="small">• ${e.hijri||''} — <a href="${e.url||'#'}" target="_blank" onclick="event.preventDefault();openEvidenceViewer('${e.url||'#'}','${(e.text||('شاهد '+(idx+1))).replace(/'/g,"&#39;")}');">${e.text||('شاهد '+(idx+1))}</a></div>`).join('');
    rowsHTML += `<tr class="${mapLevelClass(r.level)}">
      <td class="level">${r.level}<div class="small">${fmt(r.perf)}%</div></td>
      <td>${r.indicator}</td>
      <td>${r.improve}</td>
      <td>${r.evidence}${evisHTML?`<div style="margin-top:6px">${evisHTML}</div>`:''}
        <div style="margin-top:8px"><button class="btn light" onclick="openEvidence('${key}',${i})">إضافة شاهد +</button></div>
      </td>
    </tr>`;
  }

  box.innerHTML=`
    <div class="subgrid">${subsHtml}</div>
    <div class="tableWrap">
      <table>
        <thead><tr><th>المستوى/الأداء</th><th>المؤشر</th><th>مقترحات التحسين</th><th>الشواهد</th></tr></thead>
        <tbody>${rowsHTML}</tbody>
      </table>
      <div style="display:flex;justify-content:flex-end;margin-top:10px">
        <button class="btn light" onclick="resetView()">رجوع إلى جميع المجالات ↩︎</button>
      </div>
    </div>`;

  box.style.display='block';
  if(fromCanvas){
    // ملء الصفحة (تكبير الحاوية)
    box.classList.add('full');
    // اجعل عرض البطاقة نفسها 100%
    const card = document.getElementById(`card-${key}`);
    card.style.gridColumn = '1 / -1';
    window.scrollTo({top:card.offsetTop-8, behavior:'smooth'});
  }
}

/* ====== رجوع للشبكة ====== */
function resetView(){
  const dash=document.getElementById('dashboard');
  Array.from(dash.children).forEach(c=>{
    c.style.display='';
    c.style.gridColumn='';
  });
  document.querySelectorAll('.detail').forEach(d=>{ d.style.display='none'; d.classList.remove('full'); });
  window.scrollTo({top:0,behavior:'smooth'});
}

/* ====== شواهد (نافذة) ====== */
let currentEvi={key:'',idx:0};
function openEvidence(fieldKey,rowIdx){
  currentEvi={key:fieldKey,idx:rowIdx};
  document.getElementById('eviOwner').value=`${fields[fieldKey].name} — بند ${rowIdx+1}`;
  document.getElementById('eviText').value='';
  document.getElementById('eviHijri').value=todayHijri().replace(/\s/g,'');
  document.getElementById('eviFile').value='';
  document.getElementById('eviTerm').value='t1';
  fillWeeks();
  document.getElementById('eviModal').style.display='flex';
}
function closeEvidence(){ document.getElementById('eviModal').style.display='none'; }
document.getElementById('eviClose').onclick=closeEvidence;
document.getElementById('eviCancel').onclick=closeEvidence;

document.getElementById('eviSave').onclick=async ()=>{
  const text=document.getElementById('eviText').value.trim();
  const term=document.getElementById('eviTerm').value;
  const week=document.getElementById('eviWeek').value;
  const hijri=document.getElementById('eviHijri').value.trim()||todayHijri();
  const fileInput=document.getElementById('eviFile');
  const file=(fileInput.files&&fileInput.files[0])?fileInput.files[0]:null;

  if(!text && !file){ alert('أدخل اسم الشاهد وارفع ملفًا (اختياري).'); return; }
  try{
    await Data.addEvidence(currentEvi.key, currentEvi.idx, {text,term,week,hijri,file});
    closeEvidence();
    // أعِد فتح التفاصيل لتنعكس الإضافة فورًا
    await toggleDetail(currentEvi.key,true); await toggleDetail(currentEvi.key,true);
  }catch(e){ alert('تعذر الحفظ: '+(e.message||e)); }
};

/* ====== تقارير/خطط المجال (الهوية كما هي) ====== */
function buildFieldReportHTML(key){
  const f=fields[key], lvl=levelBadge(f.v2025);
  const rows=(detailed[key]||[]).map(r=>`<tr class="${mapLevelClass(r.level)}"><td>${r.level}</td><td>${fmt(r.perf)}%</td><td>${r.indicator}</td><td>${r.improve}</td><td>${r.evidence}</td></tr>`).join('');
  return `
  <h2>تقرير المجال: ${f.name}</h2>
  <div style="margin-bottom:6px">الأداء 2024: ${fmt(f.v2024)}% — الأداء 2025: ${fmt(f.v2025)}% — المستوى: ${lvl.txt}</div>
  <table><thead><tr><th>المستوى</th><th>نسبة الأداء</th><th>المؤشر</th><th>مقترحات التحسين</th><th>الشواهد</th></tr></thead><tbody>${rows}</tbody></table>
  <div style="margin-top:10px;font-weight:700">مدير المدرسة: فهد حامد علي الزهراني — التاريخ: ${todayHijri()}</div>`;
}
function buildFieldPlanHTML(key){
  const f=fields[key];
  const rows=(detailed[key]||[]).slice(0,6).map(r=>`<tr><td>${r.indicator}</td><td>${r.improve}</td><td>${(eviTermSel.value==='t2'?TERM2[0].id:TERM1[0].id)}</td><td>${r.evidence}</td></tr>`).join('');
  return `<h2>خطة تحسين المجال: ${f.name}</h2>
  <table><thead><tr><th>الهدف/المؤشر</th><th>الإجراء التحسيني</th><th>المدة (أسبوع هجري)</th><th>الشواهد</th></tr></thead><tbody>${rows}</tbody></table>
  <div style="margin-top:10px;font-weight:700">مدير المدرسة: فهد حامد علي الزهراني — التاريخ: ${todayHijri()}</div>`;
}
function openFieldReport(key){ openDocWindow('تقرير المجال', buildFieldReportHTML(key)); }
function openFieldPlan(key){ openDocWindow('خطة تحسين المجال', buildFieldPlanHTML(key)); }

/* ====== التقرير الشامل (إزالة "إعداد" من الأعلى وإضافتها في الأسفل) ====== */
function buildComprehensiveReport(){
  return `
  <h2>🟩 التقرير الشامل لخطة التحسين المؤسسي – ثانوية اليعقوبي بالخبر (1447هـ)</h2>

  <h3>🟦 أولاً: المقدمة</h3>
  <p>في ضوء توجهات وزارة التعليم نحو رفع كفاءة الأداء المدرسي وتحقيق مؤشرات التميز المؤسسي،
  تم تحليل نتائج التقويم المدرسي الخارجي للفصلين الدراسيين الأول والثاني لعام 1447هـ،
  والتي شملت أربعة مجالات رئيسة هي: القيادة والإدارة المدرسية، التعليم والتعلّم، نواتج التعلّم، البيئة المدرسية.
  وقد بُنيت هذه الخطة لتكون تحسينية وقابلة للقياس وفق نموذج SMART، بما يسهم في رفع جودة المخرجات التعليمية وتحقيق مستهدفات رؤية المملكة 2030 في التعليم.</p>

  <h3>🟦 ثانيًا: ملخص نتائج التحليل العام</h3>
  <table>
    <thead><tr><th>المجال</th><th>متوسط الأداء</th><th>مستوى الأداء</th><th>أبرز نقاط القوة</th><th>أبرز فرص التحسين</th></tr></thead>
    <tbody>
      <tr class="row-verygood"><td>القيادة والإدارة المدرسية</td><td>86%</td><td>جيد جدًا</td><td>خطة تشغيلية فعّالة – رخص مهنية – متابعة ميدانية.</td><td>ضعف التوثيق الرقمي – محدودية الشراكات المجتمعية.</td></tr>
      <tr class="row-verygood"><td>التعليم والتعلّم</td><td>88%</td><td>جيد جدًا</td><td>بيئة تعلم محفزة – استراتيجيات حديثة – تغذية راجعة فعالة.</td><td>ضعف تنويع الأساليب – ضعف توظيف التقنية في بعض المواد.</td></tr>
      <tr class="row-excellent"><td>نواتج التعلّم</td><td>91%</td><td>متميز</td><td>التزام سلوكي – اعتزاز بالهوية – تحصيل دراسي مرتفع.</td><td>تفاوت بين المواد الدراسية – ضعف المبادرات المجتمعية.</td></tr>
      <tr class="row-verygood"><td>البيئة المدرسية</td><td>84%</td><td>جيد جدًا</td><td>مرافق مهيأة – تطبيق معايير السلامة – بيئة نظيفة.</td><td>ضعف تجهيز مرافق ذوي الإعاقة وتحسين الإضاءة.</td></tr>
    </tbody>
  </table>

  <h3>🟦 ثالثًا: خطة التحسين الشاملة (SMART)</h3>
  <table>
    <thead><tr><th>المجال</th><th>الهدف العام</th><th>الإجراء التنفيذي</th><th>المدة الزمنية</th><th>مؤشر القياس</th><th>جهة التنفيذ والمتابعة</th></tr></thead>
    <tbody>
      <tr class="row-verygood"><td>القيادة والإدارة المدرسية</td><td>رفع كفاءة الإدارة المدرسية في التوثيق الرقمي والشراكات.</td><td>إنشاء نظام إلكتروني لمتابعة الأداء وربط الخطة التشغيلية بالمؤشرات، وتفعيل ثلاث شراكات مجتمعية نوعية.</td><td>6 أسابيع</td><td>ارتفاع عدد الشراكات 50% وتحسن المؤشرات الأسبوعية.</td><td>مدير المدرسة وفريق التميز.</td></tr>
      <tr class="row-verygood"><td>التعليم والتعلّم</td><td>تحسين جودة الممارسات الصفية وتنويع أساليب التعليم.</td><td>تدريب 80% من المعلمين على أدوات التعليم الإلكتروني وتطبيقها في الدروس.</td><td>8 أسابيع</td><td>زيادة تطبيق الاستراتيجيات التفاعلية إلى 85%.</td><td>وكيل الشؤون التعليمية وفريق التطوير المهني.</td></tr>
      <tr class="row-excellent"><td>نواتج التعلّم</td><td>رفع التحصيل الدراسي وتعزيز الاتجاهات الإيجابية.</td><td>تنفيذ برامج دعم أكاديمي للمواد الحرجة وإطلاق مبادرة "مدرستي مسؤوليتي".</td><td>10 أسابيع</td><td>تحسن نتائج التحصيل 10%، مشاركة طلابية 30%.</td><td>فريق التحصيل الدراسي والنشاط الطلابي.</td></tr>
      <tr class="row-verygood"><td>البيئة المدرسية</td><td>تطوير البيئة التعليمية لتكون آمنة وجاذبة ومهيأة للجميع.</td><td>تنفيذ مشروع “بيئة تعليمية مهيأة” لتطوير الفصول وتحسين الإضاءة والتهوية والممرات.</td><td>8 أسابيع</td><td>تحقيق 100% لمعايير السلامة واستيفاء المرافق.</td><td>مدير المدرسة وفريق الصيانة والإشراف.</td></tr>
    </tbody>
  </table>

  <h3>🟦 رابعًا: آلية المتابعة والتقويم</h3>
  <ul>
    <li>اجتماعات أسبوعية لفريق التميز لقياس التقدم حسب الجدول الزمني.</li>
    <li>تحديث لوحة الأداء المؤسسي إلكترونيًا وتوثيق الإنجاز بالصور والتقارير.</li>
    <li>تحليل نصف فصلي للأداء باستخدام أدوات القياس المعتمدة.</li>
    <li>متابعة الأثر التحسيني على التحصيل الدراسي والانضباط السلوكي.</li>
    <li>إعداد تقرير ختامي موثّق يرفع إلى إدارة التعليم.</li>
  </ul>

  <h3>🟦 خامسًا: مؤشرات قياس التحسين</h3>
  <table>
    <thead><tr><th>المجال</th><th>المؤشر الكمي</th><th>المستهدف</th><th>أداة القياس</th><th>دورة القياس</th></tr></thead>
    <tbody>
      <tr><td>القيادة والإدارة</td><td>نسبة تفعيل الشراكات المجتمعية</td><td>50% ↑</td><td>قاعدة بيانات – تقارير</td><td>شهريًا</td></tr>
      <tr><td>التعليم والتعلّم</td><td>نسبة تطبيق التعليم الإلكتروني في الدروس</td><td>85% ↑</td><td>زيارات صفية – استبانات</td><td>شهريًا</td></tr>
      <tr><td>نواتج التعلّم</td><td>متوسط التحصيل الدراسي العام</td><td>10% ↑</td><td>تحليل نتائج – اختبارات معيارية</td><td>فصليًا</td></tr>
      <tr><td>البيئة المدرسية</td><td>نسبة استيفاء معايير السلامة والمرافق</td><td>100% ↑</td><td>استمارات ميدانية – تقارير فنية</td><td>شهريًا</td></tr>
    </tbody>
  </table>

  <div style="margin-top:10px;font-weight:700">مدير المدرسة: فهد حامد علي الزهراني — التاريخ: ${todayHijri()}</div>
  `;
}

/* ====== الخطة الشاملة (إزالة "إعداد" من الأعلى وإضافتها في الأسفل) ====== */
function buildComprehensivePlan(){
  return `
  <h2>🟩 خطة التحسين الشاملة – ثانوية اليعقوبي بالخبر (العام الدراسي 1447هـ)</h2>
  <table>
    <thead>
      <tr><th>المجال</th><th>الهدف العام</th><th>نقاط القوة</th><th>فرص التحسين</th><th>الإجراء التحسيني (SMART)</th><th>المدة الزمنية</th><th>مؤشر القياس</th><th>جهة التنفيذ والمتابعة</th></tr>
    </thead>
    <tbody>
      <tr class="row-verygood"><td>القيادة والإدارة المدرسية</td><td>رفع كفاءة الإدارة المدرسية في التوثيق الرقمي والشراكات.</td><td>وجود خطة تشغيلية فعّالة، تفعيل الرخصة المهنية.</td><td>ضعف التوثيق الرقمي وقلة الشراكات النوعية.</td><td>إنشاء نظام متابعة إلكتروني وربطه بالمؤشرات أسبوعيًا، وتفعيل 3 شراكات مجتمعية نوعية.</td><td>6 أسابيع</td><td>ارتفاع عدد الشراكات الموثقة بنسبة 50% وتحسن مؤشرات الأداء.</td><td>مدير المدرسة وفريق التميز.</td></tr>
      <tr class="row-verygood"><td>التعليم والتعلّم</td><td>تحسين جودة الممارسات الصفية وتنويع أساليب التعليم.</td><td>تطبيق استراتيجيات حديثة – تغذية راجعة فعالة.</td><td>ضعف توظيف التقنية وقلة التنوع في طرق التعليم.</td><td>تدريب 80% من المعلمين على أدوات التعلم الإلكتروني وتفعيلها في خطط الدروس الأسبوعية.</td><td>8 أسابيع</td><td>ارتفاع نسبة تطبيق التعليم النشط والتقني إلى 85%.</td><td>وكيل الشؤون التعليمية وفريق التطوير المهني.</td></tr>
      <tr class="row-excellent"><td>نواتج التعلّم</td><td>رفع التحصيل الدراسي وتعزيز الاتجاهات الإيجابية لدى الطلاب.</td><td>التزام سلوكي، اعتزاز بالهوية الوطنية.</td><td>تفاوت النتائج وضعف المشاركة المجتمعية.</td><td>تنفيذ برنامج دعم أكاديمي للمواد منخفضة الأداء، وإطلاق مبادرات مجتمعية “مدرستي مسؤوليتي”.</td><td>10 أسابيع</td><td>تحسن نتائج التحصيل بنسبة 10%، وارتفاع المشاركة الطلابية بنسبة 30%.</td><td>فريق التحصيل الدراسي والنشاط الطلابي.</td></tr>
      <tr class="row-verygood"><td>البيئة المدرسية</td><td>تطوير البيئة التعليمية لتكون آمنة وجاذبة ومهيأة للجميع.</td><td>بيئة نظيفة وآمنة، تطبيق اشتراطات السلامة.</td><td>ضعف تجهيز مرافق ذوي الإعاقة والتهوية في بعض الفصول.</td><td>تنفيذ مشروع “بيئة تعليمية مهيأة” لصيانة الفصول وتحسين الإضاءة والتهوية والممرات.</td><td>8 أسابيع</td><td>تحقيق استيفاء 100% لمعايير الأمن والسلامة وجودة المرافق.</td><td>مدير المدرسة وفريق الصيانة والإشراف.</td></tr>
    </tbody>
  </table>
  <div style="margin-top:10px;font-weight:700">مدير المدرسة: فهد حامد علي الزهراني — التاريخ: ${todayHijri()}</div>
  `;
}

/* ====== أزرار عليا ====== */
document.getElementById('btnFullReport').addEventListener('click',()=>openDocWindow('التقرير الشامل',buildComprehensiveReport()));
document.getElementById('btnFullPlan').addEventListener('click',()=>openDocWindow('الخطة الشاملة',buildComprehensivePlan()));
document.getElementById('btnAnalyze').addEventListener('click',renderDashboard);

/* بدء التشغيل */
renderDashboard();
</script>
</body>
</html>
